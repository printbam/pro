<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrintBam | Terminal de Commande</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://checkout.flutterwave.com/v3.js"></script>
    
    <script type="text/javascript">
        emailjs.init("thg5rkoV_YE3VuWnU"); 
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        :root { --glass-bg: rgba(255, 255, 255, 0.015); --glass-border: rgba(255, 255, 255, 0.08); --accent-blue: #3b82f6; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #02040a; color: #ffffff; overflow-x: hidden; min-height: 100vh; }
        .bg-glow { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at 50% -20%, #1e3a8a 0%, transparent 45%); }
        .glass { background: var(--glass-bg); backdrop-filter: blur(30px); border: 1px solid var(--glass-border); border-radius: 28px; }
        .input-crystal { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; color: white; transition: 0.3s; }
        .input-crystal:focus { border-color: var(--accent-blue); outline: none; background: rgba(255, 255, 255, 0.08); }
        .text-gradient { background: linear-gradient(to bottom, #fff 40%, rgba(255,255,255,0.4)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .hidden-step { display: none; }
        .progress-bar-fill { width: 0%; transition: width 0.4s; background: linear-gradient(90deg, #3b82f6, #60a5fa); box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }
        .option-card { cursor: pointer; transition: all 0.3s ease; border: 1px solid rgba(255, 255, 255, 0.05); }
        .option-card.active { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .input-error { animation: shake 0.3s ease-in-out; border-color: #ef4444 !important; }
    </style>
</head>
<body class="p-4 md:p-10">
    <div class="bg-glow"></div>

    <div class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-12 gap-6">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-2xl shadow-blue-500/40 italic font-black text-white">P</div>
                <span class="text-2xl font-extrabold tracking-tighter">Print<span class="text-blue-500">bam</span></span>
            </div>
            
            <div class="flex gap-2 p-1.5 glass border-white/5 rounded-full">
                <div id="pill-1" class="px-6 py-2 rounded-full text-[10px] font-black uppercase transition-all duration-300 bg-blue-600 text-white">1. Config</div>
                <div id="pill-2" class="px-6 py-2 rounded-full text-[10px] font-black uppercase transition-all duration-300 text-white/30">2. Envoi</div>
                <div id="pill-3" class="px-6 py-2 rounded-full text-[10px] font-black uppercase transition-all duration-300 text-white/30">3. Pay</div>
            </div>
        </header>

        <div class="grid lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 glass p-8 md:p-12">
                
                <div id="step-1" class="space-y-8">
                    <h2 class="text-3xl font-black tracking-tighter text-gradient">Configuration</h2>
                    
                    <div id="uploadWrapper" class="relative">
                        <div id="uploadContainer" class="relative border border-dashed border-white/20 bg-white/5 rounded-3xl p-10 text-center group hover:border-blue-500/50 transition-all">
                            <input type="file" id="fileUpload" accept=".pdf,image/jpeg,image/png" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                            <div id="uploadUI">
                                <i class="fas fa-file-contract text-4xl text-blue-500 mb-4"></i>
                                <p id="fileNameDisplay" class="text-sm font-bold text-white/60">Cliquez ou glissez votre document ici</p>
                            </div>
                        </div>

                        <div id="previewBox" class="hidden absolute inset-0 z-20 glass bg-slate-900/95 border-blue-500/30 flex items-center justify-between px-6 py-4 rounded-3xl">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-20 bg-white rounded shadow-lg overflow-hidden flex items-center justify-center">
                                    <img id="imagePreview" class="hidden w-full h-full object-contain" />
                                    <canvas id="pdfPreview" class="hidden w-full h-full"></canvas>
                                </div>
                                <div class="text-left">
                                    <p class="text-[9px] font-black text-blue-500 uppercase tracking-widest tracking-tighter">Document détecté</p>
                                    <p id="previewName" class="text-sm text-white truncate w-40 font-bold"></p>
                                </div>
                            </div>
                            <button onclick="resetUpload()" class="w-12 h-12 rounded-full bg-red-500/10 border border-red-500/20 text-red-500 hover:bg-red-500 hover:text-white transition-all">
                                <i class="fas fa-trash-can"></i>
                            </button>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="text-[10px] uppercase font-black tracking-widest text-white/30 ml-2">Format</label>
                            <select id="format" onchange="calculatePrice()" class="w-full input-crystal p-4 font-bold bg-slate-900">
                                <option value="A5">A5</option><option value="A4" selected>A4</option><option value="A3">A3</option>
                                <option value="A2">A2</option><option value="A1">A1</option><option value="A0">A0</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] uppercase font-black tracking-widest text-white/30 ml-2">Couleur</label>
                            <select id="couleur" onchange="calculatePrice()" class="w-full input-crystal p-4 font-bold bg-slate-900">
                                <option value="NB">Noir & Blanc</option><option value="CL">Couleur HD</option>
                            </select>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <label class="text-[10px] uppercase font-black tracking-widest text-white/30 ml-2">Finition & Protection</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div onclick="toggleOption('reliure')" id="opt-reliure" class="option-card p-4 rounded-2xl glass flex items-center gap-4">
                                <div class="w-10 h-10 rounded-lg bg-blue-500/10 flex items-center justify-center text-blue-500">
                                    <i class="fas fa-book"></i>
                                </div>
                                <div>
                                    <p class="text-xs font-black">Reliure</p>
                                    <p class="text-[10px] text-white/40">+1.500 FC</p>
                                </div>
                            </div>
                            <div onclick="toggleOption('plastique')" id="opt-plastique" class="option-card p-4 rounded-2xl glass flex items-center gap-4">
                                <div class="w-10 h-10 rounded-lg bg-emerald-500/10 flex items-center justify-center text-emerald-500">
                                    <i class="fas fa-layer-group"></i>
                                </div>
                                <div>
                                    <p class="text-xs font-black">Plastifier</p>
                                    <p class="text-[10px] text-white/40">+1.000 FC / p</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 space-y-2">
                            <label class="text-[10px] uppercase font-black tracking-widest text-white/30 ml-2">Pages</label>
                            <input type="number" id="nbPages" value="1" min="1" oninput="calculatePrice()" class="w-full input-crystal p-4 font-bold bg-blue-500/5">
                        </div>
                        <div class="md:col-span-1 space-y-2">
                            <label class="text-[10px] uppercase font-black tracking-widest text-white/30 ml-2">Exemplaires</label>
                            <input type="number" id="nbExemplaires" value="1" min="1" oninput="calculatePrice()" class="w-full input-crystal p-4 font-bold">
                        </div>
                        <div class="md:col-span-1 space-y-2">
                            <label class="text-[10px] uppercase font-black tracking-widest text-white/30 ml-2">Type</label>
                            <button onclick="toggleRectoVerso()" id="btnRV" class="w-full input-crystal p-4 font-bold text-xs uppercase tracking-tighter">Recto Seul</button>
                            <input type="hidden" id="rectoVerso" value="false">
                        </div>
                    </div>
                </div>

                <div id="step-2" class="hidden-step space-y-8">
                    <h2 class="text-3xl font-black tracking-tighter text-gradient">Destination</h2>
                    <div class="space-y-4">
                        <input type="text" id="custName" placeholder="Nom complet" class="w-full input-crystal p-4 font-bold">
                        <input type="tel" id="custTel" placeholder="WhatsApp (ex: +243...)" class="w-full input-crystal p-4 font-bold">
                        <textarea id="custAddr" placeholder="Adresse complète de livraison" class="w-full input-crystal p-4 font-bold h-32"></textarea>
                    </div>
                </div>

                <div id="step-3" class="hidden-step space-y-8 text-center">
                    <h2 class="text-3xl font-black tracking-tighter text-gradient mb-10">Paiement</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="paymentMethods">
                        <button onclick="selectMethod(this, 'Orange')" class="payment-btn glass p-4 flex flex-col items-center gap-3 grayscale opacity-50 transition-all"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c8/Orange_logo.svg/1200px-Orange_logo.svg.png" class="h-6"><span class="font-black text-[8px]">ORANGE</span></button>
                        <button onclick="selectMethod(this, 'Mpesa')" class="payment-btn glass p-4 flex flex-col items-center gap-3 grayscale opacity-50 transition-all"><img src="https://upload.wikimedia.org/wikipedia/commons/a/a2/M-Pesa_Logo.png" class="h-6"><span class="font-black text-[8px]">M-PESA</span></button>
                        <button onclick="selectMethod(this, 'Airtel')" class="payment-btn glass p-4 flex flex-col items-center gap-3 grayscale opacity-50 transition-all"><div class="text-red-500 font-bold">airtel</div><span class="font-black text-[8px]">AIRTEL</span></button>
                        <button onclick="selectMethod(this, 'Cashbam')" class="payment-btn glass p-4 flex flex-col items-center gap-3 grayscale opacity-50 transition-all border-dashed"><i class="fas fa-vault text-xl text-emerald-500"></i><span class="font-black text-[8px] text-emerald-500">CASHBAM</span></button>
                    </div>
                    <input type="hidden" id="selectedOperator" value="">
                </div>

                <div class="mt-12 flex justify-between items-center">
                    <button id="prevBtn" onclick="prevStep()" class="invisible text-xs font-black uppercase text-white/30 hover:text-white transition">Retour</button>
                    <button id="nextBtn" onclick="handleNavigation()" class="px-10 py-5 bg-blue-600 rounded-2xl font-black text-xs uppercase tracking-[0.2em] shadow-2xl shadow-blue-500/20 hover:scale-105 transition-all">Continuer</button>
                </div>
            </div>

            <div class="glass p-8 h-fit lg:sticky lg:top-10 border-blue-500/20">
                <span class="text-[10px] font-black uppercase tracking-[0.3em] text-blue-500">Total Commande</span>
                <div class="text-5xl font-extrabold text-white tracking-tighter my-6"><span id="totalDisplay">0</span> <span class="text-sm font-light text-white/40">FC</span></div>
                <div class="space-y-4 border-t border-white/5 pt-6 text-[11px] font-bold uppercase text-white/40">
                    <div class="flex justify-between"><span>Impression</span> <span id="resImpression" class="text-white">-</span></div>
                    <div class="flex justify-between"><span>Finitions</span> <span id="resFinition" class="text-white">0 FC</span></div>
                </div>
            </div>
        </div>
    </div>

    <div id="uploadModal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-xl"></div>
        <div class="relative glass p-10 text-center max-w-sm w-full border-blue-500/30">
            <i class="fas fa-cloud-arrow-up text-4xl text-blue-500 animate-bounce mb-6"></i>
            <h2 class="text-xl font-black text-white mb-6">Envoi sécurisé...</h2>
            <div class="w-full bg-white/5 h-2 rounded-full overflow-hidden mb-2">
                <div id="progressBar" class="progress-bar-fill h-full w-0"></div>
            </div>
            <div id="progressPercent" class="text-[10px] font-black text-blue-500 uppercase">0%</div>
        </div>
    </div>

    <div id="successModal" class="fixed inset-0 z-[110] flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-2xl"></div>
        <div class="relative glass p-10 text-center max-w-sm w-full border-emerald-500/30">
            <div class="w-20 h-20 bg-emerald-600 rounded-full flex items-center justify-center mx-auto mb-6 text-white text-3xl"><i class="fas fa-check"></i></div>
            <h2 class="text-2xl font-black text-white tracking-tighter">Confirmé !</h2>
            <p class="text-white/40 text-sm mt-2">Redirection vers l'accueil...</p>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let options = { reliure: false, plastique: false };
        const prices = { 
            "A5": { "NB": 200, "CL": 400 }, "A4": { "NB": 400, "CL": 700 }, 
            "A3": { "NB": 1000, "CL": 1800 }, "A2": { "NB": 4500, "CL": 7500 },
            "A1": { "NB": 9000, "CL": 15000 }, "A0": { "NB": 18000, "CL": 25000 }
        };

        // --- PREVIEW LOGIC ---
        document.getElementById('fileUpload').addEventListener('change', async function(e) {
            const file = e.target.files[0]; if (!file) return;
            document.getElementById('previewBox').classList.remove('hidden');
            document.getElementById('previewName').innerText = file.name;
            const imgT = document.getElementById('imagePreview'), canT = document.getElementById('pdfPreview');
            imgT.classList.add('hidden'); canT.classList.add('hidden');

            if (file.type.startsWith('image/')) {
                const r = new FileReader(); r.onload = (e) => { imgT.src = e.target.result; imgT.classList.remove('hidden'); };
                r.readAsDataURL(file); document.getElementById('nbPages').value = 1;
            } else if (file.type === "application/pdf") {
                const r = new FileReader(); r.onload = async function() {
                    const pdf = await pdfjsLib.getDocument(new Uint8Array(this.result)).promise;
                    document.getElementById('nbPages').value = pdf.numPages;
                    const page = await pdf.getPage(1); const vp = page.getViewport({ scale: 0.3 });
                    canT.height = vp.height; canT.width = vp.width; canT.classList.remove('hidden');
                    await page.render({canvasContext: canT.getContext('2d'), viewport: vp}).promise;
                    calculatePrice();
                }; r.readAsArrayBuffer(file);
            }
            calculatePrice();
        });

        function resetUpload() { document.getElementById('fileUpload').value = ""; document.getElementById('previewBox').classList.add('hidden'); calculatePrice(); }

        // --- CALCULE LOGIQUE ---
        function toggleOption(opt) {
            options[opt] = !options[opt];
            document.getElementById(`opt-${opt}`).classList.toggle('active');
            calculatePrice();
        }

        function toggleRectoVerso() {
            const val = document.getElementById('rectoVerso').value === "true";
            document.getElementById('rectoVerso').value = !val;
            document.getElementById('btnRV').innerText = !val ? "Recto / Verso" : "Recto Seul";
            calculatePrice();
        }

        function calculatePrice() {
            const f = document.getElementById('format').value, c = document.getElementById('couleur').value;
            const isV = document.getElementById('rectoVerso').value === "true";
            const p = parseInt(document.getElementById('nbPages').value) || 1, e = parseInt(document.getElementById('nbExemplaires').value) || 1;
            
            // Base Impression
            let unitP = prices[f][c]; if(isV) unitP = Math.round(unitP * 1.6);
            const totalImp = unitP * p * e;

            // Finitions
            let totalFin = 0;
            if(options.reliure) totalFin += 1500 * e; // 1500 FC par exemplaire relié
            if(options.plastique) totalFin += (1000 * p) * e; // 1000 FC par page plastifiée

            const totalGlobal = totalImp + totalFin;
            
            document.getElementById('totalDisplay').innerText = totalGlobal.toLocaleString('fr-FR');
            document.getElementById('resImpression').innerText = `${f} ${c} (${p}p x ${e})`;
            document.getElementById('resFinition').innerText = totalFin.toLocaleString('fr-FR') + " FC";
        }

        // --- NAVIGATION ---
        function handleNavigation() { if (currentStep < 3) nextStep(); else validateFinalProcess(); }

        function nextStep() {
            if (currentStep === 1 && !document.getElementById('fileUpload').files[0]) return showErrorAnimation(document.getElementById('uploadContainer'));
            if (currentStep === 2 && !['custName', 'custTel', 'custAddr'].every(id => document.getElementById(id).value.trim())) return;
            document.getElementById(`step-${currentStep}`).classList.add('hidden-step');
            document.getElementById(`pill-${currentStep}`).classList.replace('bg-blue-600', 'text-white/30');
            currentStep++;
            document.getElementById(`step-${currentStep}`).classList.remove('hidden-step');
            document.getElementById(`pill-${currentStep}`).className = "px-6 py-2 rounded-full text-[10px] font-black bg-blue-600 text-white";
            updateControls();
        }

        function prevStep() {
            document.getElementById(`step-${currentStep}`).classList.add('hidden-step');
            document.getElementById(`pill-${currentStep}`).className = "px-6 py-2 rounded-full text-[10px] font-black text-white/30";
            currentStep--;
            document.getElementById(`step-${currentStep}`).classList.remove('hidden-step');
            document.getElementById(`pill-${currentStep}`).className = "px-6 py-2 rounded-full text-[10px] font-black bg-blue-600 text-white";
            updateControls();
        }

        function updateControls() {
            document.getElementById('prevBtn').style.visibility = currentStep === 1 ? 'hidden' : 'visible';
            document.getElementById('nextBtn').innerText = currentStep === 3 ? 'Confirmer le Paiement' : 'Continuer';
        }

        function selectMethod(el, op) {
            document.querySelectorAll('.payment-btn').forEach(b => b.classList.add('grayscale', 'opacity-50'));
            el.classList.remove('grayscale', 'opacity-50'); el.classList.add('border-blue-500', 'bg-blue-600/10');
            document.getElementById('selectedOperator').value = op;
        }

        // --- UPLOAD & FINISH ---
        async function validateFinalProcess() {
            const op = document.getElementById('selectedOperator').value; if (!op) return;
            let prog = 0; document.getElementById('uploadModal').classList.remove('hidden');
            const timer = setInterval(() => { if(prog < 90) { prog += 10; document.getElementById('progressBar').style.width = prog + "%"; document.getElementById('progressPercent').innerText = prog + "%"; } }, 400);

            try {
                const url = await uploadToDrive(document.getElementById('fileUpload').files[0]);
                clearInterval(timer); document.getElementById('progressBar').style.width = "100%";
                setTimeout(() => {
                    document.getElementById('uploadModal').classList.add('hidden');
                    if (op === "Cashbam") finalizeOrder(url, "CASHBAM"); else startFlutterwave(url, op);
                }, 500);
            } catch (err) { clearInterval(timer); document.getElementById('uploadModal').classList.add('hidden'); alert("Erreur d'envoi"); }
        }

        async function uploadToDrive(file) {
            return new Promise((resolve) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = async () => {
                    const response = await fetch("https://script.google.com/macros/s/AKfycbzgcKmfauYb0i0hC2c72-WyBIsmL-gM__mJ4ESton4fHkWDBN07GGbLWflyuaHz-JK9/exec", {
                        method: "POST", body: JSON.stringify({ base64: reader.result.split(',')[1], fileName: file.name, mimeType: file.type })
                    });
                    const res = await response.json(); resolve(res.url || "Erreur");
                };
            });
        }

        function startFlutterwave(url, op) {
            FlutterwaveCheckout({
                public_key: "FLWPUBK_TEST-025d82a383d1f6849351abbd725ffbe2-X",
                tx_ref: "BAM-" + Date.now(),
                amount: parseFloat(document.getElementById('totalDisplay').innerText.replace(/\s/g, '')),
                currency: "CDF",
                customer: { email: "cloud@printbam.com", phone_number: document.getElementById('custTel').value, name: document.getElementById('custName').value },
                callback: (d) => { if (d.status === "successful") finalizeOrder(url, op); }
            });
        }

        function finalizeOrder(url, m) {
            const params = {
                nom: document.getElementById('custName').value, telephone: document.getElementById('custTel').value, adresse: document.getElementById('custAddr').value,
                details: `${document.getElementById('resImpression').innerText} | Reliure: ${options.reliure} | Plastique: ${options.plastique}`,
                total: document.getElementById('totalDisplay').innerText + " FC", file_link: url 
            };
            emailjs.send("service_jecwp3m", "template_znjxx9s", params).then(() => {
                document.getElementById('successModal').classList.remove('hidden');
                setTimeout(() => window.location.href = "index.html", 3000);
            });
        }

        function showErrorAnimation(el) { el.classList.add('input-error'); setTimeout(() => el.classList.remove('input-error'), 400); }
        calculatePrice();
    </script>
</body>
</html>
