<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#f8fafc">
    <title>Printbam v3.5 Pro | Enterprise Cloud Printing</title>
    <link rel="apple-touch-icon" href="logo-printbam-icon2.png">
    <link rel="icon" type="image/png" href="print.png">
    <link rel="manifest" href="./manifest.json">
    <meta name="color-scheme" content="light dark">
    <meta name="description" content="Printbam est l'infrastructure d'impression cloud leader.">
    
    <!-- PRECHARGEMENT -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://checkout.flutterwave.com/v3.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --glass-bg: #ffffff;
            --glass-border: rgba(0, 0, 0, 0.08);
            --accent-blue: #38bdf8; /* Bleu Ciel */
            --text-main: #000000; /* Noir Pur */
            --text-muted: #6b7280;
            --bg-body: #ffffff; /* Blanc Pur */
            --panel-bg: #ffffff;
            --input-bg: #f9fafb;
            --btn-secondary-bg: #f1f1f1;
            --shadow-soft: 0 2px 8px rgba(0, 0, 0, 0.05);
            --shadow-hover: 0 10px 25px rgba(0, 0, 0, 0.08);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            transition: background-color 0.4s cubic-bezier(0.4, 0, 0.2, 1), color 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding-bottom: 90px;
        }
        @media (min-width: 769px) { body { padding-bottom: 0; } }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .bg-grid {
            position: fixed; inset: 0; z-index: -2;
            background-image: linear-gradient(to right, #e2e8f0 1px, transparent 1px), linear-gradient(to bottom, #e2e8f0 1px, transparent 1px);
            background-size: 48px 48px;
            mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
            opacity: 0.6;
            transition: opacity 0.5s ease;
        }

        .bg-glow {
            position: fixed; top: -20%; left: -10%; right: -10%; bottom: 0; z-index: -1;
            background: radial-gradient(circle at 50% 0%, #e0e7ff 0%, transparent 60%);
            opacity: 0.6;
            pointer-events: none;
        }

        .glass-header {
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: var(--shadow-soft);
            transition: padding 0.3s ease, box-shadow 0.3s ease;
        }

        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            border-radius: 16px;
            transition: transform 0.3s var(--ease-elastic), box-shadow 0.3s ease, border-color 0.3s ease;
            box-shadow: var(--shadow-soft);
        }

        .glass:hover { transform: translateY(-5px); border-color: #cbd5e1; box-shadow: var(--shadow-hover); }

        .btn-glow:focus-visible { box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.3); outline: none; }

        .nav-link-pro {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 16px; border-radius: 12px;
            color: #475569; font-size: 14px; font-weight: 500;
            text-decoration: none; transition: all 0.2s ease;
            cursor: pointer;
        }
        .nav-link-pro:hover { background: #f1f5f9; color: #0f172a; transform: translateX(4px); }
        .nav-link-pro.active { background: #eff6ff; color: #4f46e5; font-weight: 600; }

        .text-gradient {
            background: linear-gradient(135deg, #1e293b 0%, #4f46e5 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        #typewriter { border-right: 2px solid #4f46e5; animation: blink 1s step-end infinite; padding-right: 4px; }
        @keyframes blink { 50% { border-color: transparent; } }

        .reveal-up { opacity: 0; transform: translateY(30px); transition: all 0.8s cubic-bezier(0.5, 0, 0, 1); }
        .reveal-up.active { opacity: 1; transform: translateY(0); }

        .page-view { display: none; animation: fadeIn 0.4s ease-in-out; }
        .page-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* SKELETON LOADING */
        .skeleton {
            background: #e2e8f0;
            background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* DARK MODE */
        body.dark-mode {
            background: #000000 !important; /* Noir Pur */
            color: #ffffff !important; /* Blanc Pur */
            --glass-bg: #0a0a0a;
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-muted: #a1a1aa;
            --bg-body: #000000;
            --panel-bg: #0a0a0a;
            --input-bg: #111111;
            --btn-secondary-bg: #1a1a1a;
        }
        body.dark-mode .bg-grid { background-image: linear-gradient(to right, rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(to bottom, rgba(255,255,255,0.03) 1px, transparent 1px); opacity: 0.4; }
        body.dark-mode .bg-glow { background: radial-gradient(circle at 50% 0%, rgba(79, 70, 229, 0.15) 0%, transparent 60%); }
        body.dark-mode .glass-header { background: rgba(15, 23, 42, 0.85); border-bottom: 1px solid rgba(255,255,255,0.05); }
        body.dark-mode .glass { background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); }
        body.dark-mode .glass:hover { border-color: rgba(79, 70, 229, 0.3); background: rgba(30, 41, 59, 0.9); }
        body.dark-mode .text-gradient { background: linear-gradient(135deg, #fff 0%, #818cf8 100%) !important; -webkit-background-clip: text !important; -webkit-text-fill-color: transparent !important; }
        body.dark-mode .nav-link-pro { color: #94a3b8; }
        body.dark-mode .nav-link-pro:hover { background: rgba(255,255,255,0.05); color: #fff; }
        body.dark-mode .nav-link-pro.active { background: rgba(79, 70, 229, 0.2); color: #818cf8; }

        /* THEME ADAPTATIONS (FORCE VARIABLES ON ALL COMPONENTS) */
#sidebar-panel, #settings-panel, #orders-panel, #support-panel, 
#track-modal div:last-child, .mobile-dock, #invoice-modal, #stats-dashboard {
    background-color: var(--panel-bg) !important;
    border-color: var(--glass-border) !important;
    color: var(--text-main) !important;
}

/* Inputs et Formulaires */
input, select, textarea, .input-crystal {
    background-color: var(--input-bg) !important;
    border: 1px solid var(--glass-border) !important;
    color: var(--text-main) !important;
}

/* Boutons secondaires */
body.dark-mode button.bg-white, 
body.dark-mode button.bg-slate-100 {
    background-color: var(--btn-secondary-bg) !important;
    color: var(--text-main) !important;
    border-color: var(--glass-border);
}

        /* TRACKING TIMELINE */
        .timeline { position: relative; padding-left: 30px; border-left: 2px solid #e2e8f0; }
        body.dark-mode .timeline { border-left-color: rgba(255,255,255,0.1); }
        .timeline-item { position: relative; margin-bottom: 24px; }
        .timeline-item::before { content: ''; position: absolute; left: -37px; top: 4px; width: 12px; height: 12px; background: #cbd5e1; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 0 1px #cbd5e1; }
        body.dark-mode .timeline-item::before { border-color: #0f172a; box-shadow: 0 0 0 1px #475569; }
        .timeline-item.active::before { background: #4f46e5; box-shadow: 0 0 0 1px #4f46e5; }
        .timeline-item.active .timeline-date { color: #4f46e5; font-weight: 700; }
        .timeline-date { font-size: 12px; color: #94a3b8; margin-bottom: 4px; }
        .timeline-content { font-size: 14px; font-weight: 500; color: var(--text-main); }

        /* TOASTS & TERMINAL & LOADER */
        .toast-container { position: fixed; bottom: 100px; right: 24px; z-index: 10000; display: flex; flex-direction: column; gap: 12px; }
        @media (max-width: 768px) { .toast-container { bottom: 100px; right: 12px; left: 12px; } }
        .toast { min-width: 300px; padding: 16px; border-radius: 12px; background: white; border-left: 4px solid; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between; animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); font-size: 14px; font-weight: 500; }
        .toast.success { border-color: #10b981; } .toast.error { border-color: #ef4444; }
        body.dark-mode .toast { background: #1e293b; color: white; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { to { transform: translateX(100%); opacity: 0; } }

        #loader { position: fixed; inset: 0; z-[99999]; background: #ffffff; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.8s ease-out, visibility 0.8s; }
        body.dark-mode #loader { background: #0f172a; }
        .loader-content { text-align: center; display: flex; flex-direction: column; align-items: center; animation: elasticZoom 1.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: scale(0.8); }
        .loader-icon { width: 64px; height: 64px; background: #4f46e5; border-radius: 16px; display: flex; align-items: center; justify-content: center; color: white; font-size: 28px; box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.3); }
        .loader-text { margin-top: 24px; font-size: 18px; font-weight: 800; color: #0f172a; letter-spacing: -0.5px; }
        body.dark-mode .loader-text { color: #f8fafc; }
        @keyframes elasticZoom { 0% { opacity: 0; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 1; transform: scale(1); } }
        .loader-dots { display: flex; gap: 8px; margin-top: 32px; }
        .dot { width: 8px; height: 8px; background-color: #cbd5e1; border-radius: 50%; animation: bounce 0.6s infinite alternate; }
        body.dark-mode .dot { background-color: #475569; }
        .dot:nth-child(2) { animation-delay: 0.1s; } .dot:nth-child(3) { animation-delay: 0.2s; }
        @keyframes bounce { from { transform: translateY(0); opacity: 0.4; } to { transform: translateY(-8px); opacity: 1; } }

        #main-content { transition: filter 0.3s ease; will-change: filter; }

        /* TERMINAL STYLES */
        /* --- TERMINAL WRAPPER PRINCIPAL --- */
#terminal-wrapper { 
    display: none; 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100vw; 
    height: 100vh; 
    z-index: 20000; 
    background-color: var(--bg-body); 
    color: var(--text-main); 
    font-family: 'Plus Jakarta Sans', sans-serif; 
    overflow-y: auto; 
    overflow-x: hidden; 
    transition: background-color 0.4s ease, color 0.4s ease; 
    outline: none; /* Empêche le contour bleu sur le wrapper lui-même */
}

/* --- BOUTON FERMER --- */
#close-terminal-btn { 
    position: absolute; 
    top: 20px; 
    right: 20px; 
    z-index: 20050; 
    width: 40px; 
    height: 40px; 
    background: var(--glass-bg); 
    border: 1px solid var(--glass-border); 
    backdrop-filter: blur(10px); 
    -webkit-backdrop-filter: blur(10px); /* Pour Safari */
    border-radius: 50%; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    color: var(--text-main); 
    cursor: pointer; 
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
    box-shadow: var(--shadow-soft); 
}

#close-terminal-btn:hover { 
    background: rgba(239, 68, 68, 0.1); /* Rouge plus doux */
    color: #ef4444; 
    transform: rotate(90deg) scale(1.1); 
    border-color: rgba(239, 68, 68, 0.2);
}

/* --- ÉLÉMENTS VISUELS (Glassmorphism & Glow) --- */
#terminal-wrapper .bg-glow { 
    position: fixed; 
    inset: 0; 
    z-index: -1; 
    background: radial-gradient(circle at 50% -20%, var(--accent-blue) 0%, transparent 45%); 
    opacity: 0.1; 
    pointer-events: none; /* Sécurité : ne bloque pas les clics */
}

#terminal-wrapper .glass { 
    background: var(--glass-bg); 
    backdrop-filter: blur(30px); 
    -webkit-backdrop-filter: blur(30px);
    border: 1px solid var(--glass-border); 
    border-radius: 28px; 
    box-shadow: var(--shadow-soft); 
}

#terminal-wrapper .input-crystal { 
    background: rgba(255, 255, 255, 0.05); /* Plus subtil en mode sombre */
    border: 1px solid var(--glass-border); 
    border-radius: 16px; 
    color: var(--text-main); 
    transition: all 0.3s ease; 
    padding: 12px 16px;
}

#terminal-wrapper .input-crystal:focus {
    outline: none;
    border-color: var(--accent-blue);
    background: rgba(255, 255, 255, 0.1);
    box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
}

/* --- TYPOGRAPHIE --- */
#terminal-wrapper .text-gradient { 
    background: linear-gradient(to bottom, var(--text-main) 40%, var(--text-muted)); 
    -webkit-background-clip: text; 
    -webkit-text-fill-color: transparent; 
    background-clip: text;
}

body.dark-mode #terminal-wrapper .text-gradient { 
    background: linear-gradient(to bottom, #fff 40%, rgba(255,255,255,0.4)); 
}

/* --- LOGIQUE DE STEPS & PROGRESSION --- */
#terminal-wrapper .hidden-step { display: none; }

#terminal-wrapper .progress-bar-fill { 
    width: 0%; 
    height: 100%;
    transition: width 0.6s cubic-bezier(0.65, 0, 0.35, 1); 
    background: var(--accent-blue); 
    box-shadow: 0 0 15px rgba(79, 130, 246, 0.5); 
}

/* --- CARTES D'OPTIONS --- */
#terminal-wrapper .option-card { 
    cursor: pointer; 
    transition: all 0.3s ease; 
    border: 1px solid var(--glass-border); 
    background: var(--glass-bg); 
    user-select: none;
}

#terminal-wrapper .option-card:hover {
    transform: translateY(-2px);
    border-color: var(--accent-blue);
    background: rgba(79, 70, 229, 0.02);
}

#terminal-wrapper .option-card.active { 
    border-color: var(--accent-blue); 
    background: rgba(79, 70, 229, 0.05); 
    box-shadow: 0 0 20px rgba(79, 70, 229, 0.1);
}

/* --- ANIMATIONS D'ERREUR --- */
@keyframes terminalShake { 
    0%, 100% { transform: translateX(0); } 
    25% { transform: translateX(-5px); } 
    75% { transform: translateX(5px); } 
}

#terminal-wrapper .input-error { 
    animation: terminalShake 0.3s ease-in-out; 
    border-color: #ef4444 !important; 
    background: rgba(239, 68, 68, 0.05) !important;
}

/* --- FORMULAIRES & BOUTONS --- */
#terminal-wrapper input, 
#terminal-wrapper select, 
#terminal-wrapper textarea { 
    width: 100%; 
    display: block; 
    appearance: none; /* Nettoyage sur mobile */
}

#terminal-wrapper button { 
    cursor: pointer; 
    display: inline-flex; 
    align-items: center; 
    justify-content: center; 
    transition: all 0.2s ease;
}

#terminal-wrapper button:active { transform: scale(0.97); }

#terminal-wrapper .payment-btn { 
    background: var(--glass-bg); 
    border: 1px solid var(--glass-border); 
    font-weight: 600;
}
        /* PROFESSIONAL INVOICE MODAL */
        #invoice-modal { display: none; position: fixed; inset: 0; z-index: [9500]; backdrop-filter: blur(8px); background: rgba(0,0,0,0.6); align-items: center; justify-content: center; padding: 20px; }
        #invoice-modal.active { display: flex; }
        .invoice-paper { background: white; width: 100%; max-width: 800px; max-height: 90vh; overflow-y: auto; padding: 40px; border-radius: 4px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); position: relative; }
        .invoice-header { display: flex; justify-content: space-between; margin-bottom: 40px; border-bottom: 2px solid #f1f5f9; padding-bottom: 20px; }
        .invoice-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .invoice-table th { text-align: left; padding: 12px; background: #f8fafc; color: #64748b; font-size: 12px; text-transform: uppercase; }
        .invoice-table td { padding: 12px; border-bottom: 1px solid #e2e8f0; color: #0f172a; }
        .invoice-total { margin-top: 20px; text-align: right; font-size: 24px; font-weight: 800; color: #4f46e5; }
        @media print {
            body * { visibility: hidden; }
            #invoice-modal, #invoice-modal * { visibility: visible; }
            #invoice-modal { position: absolute; left: 0; top: 0; background: white; backdrop-filter: none; }
            .invoice-paper { box-shadow: none; max-width: 100%; padding: 0; }
            .no-print { display: none !important; }
        }
        /* STYLES POUR LE PROFIL UTILISATEUR */
        #profile-panel {
            /* Assure la transition et le fond glass */
            background-color: var(--glass-bg);
            border-color: var(--glass-border);
            color: var(--text-main);
        }
        
        /* Override Dark Mode spécifique pour le panneau profil */
        body.dark-mode #profile-panel {
            background-color: var(--glass-bg) !important;
            border-color: var(--glass-border) !important;
            color: var(--text-main) !important;
        }
        
        body.dark-mode #profile-panel h2, 
        body.dark-mode #profile-panel label,
        body.dark-mode #profile-panel p {
            color: var(--text-main) !important;
        }
        
        body.dark-mode #profile-panel input,
        body.dark-mode #profile-panel textarea {
            background-color: rgba(15, 23, 42, 0.5) !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
            color: var(--text-main) !important;
        }
        
        body.dark-mode #profile-role-display {
            color: #818cf8 !important; /* Indigo clair en mode sombre */
        }

/* --- ULTRA PRO CHAT STYLES --- */

/* Le panneau principal : Effet verre et bordure fine */
#chat-panel {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    box-shadow: -10px 0 40px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    height: 100%;
    border-left: 1px solid rgba(255, 255, 255, 0.5);
}

/* Header du chat */
#chat-panel .p-4 {
    background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
    box-shadow: 0 4px 20px -5px rgba(79, 70, 229, 0.4);
}

/* Container des messages */
#chat-messages {
    background-image: 
        radial-gradient(#e0e7ff 1px, transparent 1px), 
        radial-gradient(#e0e7ff 1px, transparent 1px);
    background-size: 20px 20px;
    background-position: 0 0, 10px 10px;
    background-color: #f8fafc;
    scroll-behavior: smooth;
}

/* Scrollbar fine et stylisée */
#chat-messages::-webkit-scrollbar { width: 6px; }
#chat-messages::-webkit-scrollbar-track { background: transparent; }
#chat-messages::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
#chat-messages::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

/* Structure de la ligne de message */
.chat-row {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
    align-items: flex-end; /* Aligne les bulles en bas */
    animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

@keyframes slideUpFade {
    from { opacity: 0; transform: translateY(15px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

/* Avatar */
.chat-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #e2e8f0;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 700;
    color: #64748b;
    border: 2px solid white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    overflow: hidden;
}
.chat-avatar img { width: 100%; height: 100%; object-fit: cover; }

/* Conteneur du contenu du message */
.chat-content {
    max-width: 75%;
    display: flex;
    flex-direction: column;
}

/* En-tête du message (Nom + Heure) */
.chat-header {
    display: flex;
    align-items: baseline;
    gap: 8px;
    margin-bottom: 4px;
    font-size: 0.75rem;
    font-weight: 600;
}

/* Bulle de message Autre (Gris/Blanc) */
.chat-bubble.other {
    background: white;
    color: #334155;
    padding: 12px 16px;
    border-radius: 4px 18px 18px 18px; /* Coin gauche plat */
    box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.1);
    border: 1px solid #f1f5f9;
    line-height: 1.5;
    font-size: 0.95rem;
}

/* Bulle de message Moi (Dégradé Pro) */
.chat-bubble.me {
    background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
    color: white;
    padding: 12px 16px;
    border-radius: 18px 4px 18px 18px; /* Coin droit plat */
    box-shadow: 0 4px 15px -3px rgba(79, 70, 229, 0.4);
    line-height: 1.5;
    font-size: 0.95rem;
    position: relative;
}

/* Petit indicateur de réception (optionnel) */
.chat-bubble.me::after {
    content: '';
    position: absolute;
    bottom: 8px;
    right: 8px;
    width: 6px;
    height: 6px;
    background: rgba(255,255,255,0.4);
    border-radius: 50%;
}

/* Zone de saisie (Style Search Bar) */
#chat-input {
    background: #f1f5f9;
    border: none;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
    transition: all 0.3s;
}
#chat-input:focus {
    background: white;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1), 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

/* Bouton d'envoi */
#chat-form button {
    background: linear-gradient(135deg, #4f46e5, #4338ca);
    transition: transform 0.2s;
}
#chat-form button:hover { transform: scale(1.05); }
#chat-form button:active { transform: scale(0.95); }

/* Dark Mode Adaptation */
body.dark-mode #chat-panel {
    background: rgba(15, 23, 42, 0.95);
    border-left-color: rgba(255,255,255,0.1);
}
body.dark-mode #chat-messages {
    background-color: #0f172a;
    background-image: radial-gradient(rgba(255,255,255,0.05) 1px, transparent 1px);
}
body.dark-mode .chat-bubble.other {
    background: #1e293b;
    color: #e2e8f0;
    border-color: #334155;
}
body.dark-mode #chat-input {
    background: #1e293b;
    color: white;
}
body.dark-mode .chat-header { color: #94a3b8; }
        /* Classe pour forcer le masquage du Dock (priorité maximale) */
.mobile-dock.dock-hidden {
    display: none !important; 
}
        /* --- ÉTAT DE CHARGEMENT GLOBAL --- */
/* Quand la classe .app-loading est présente, on cache tout sauf le loader */

.app-loading #main-content,
.app-loading .nav-desktop-container,
.app-loading #mobile-header,
.app-loading .mobile-dock,
.app-loading .bg-grid,
.app-loading .bg-glow,
.app-loading .page-view {
    opacity: 0 !important;
    visibility: hidden !important;
    pointer-events: none !important;
}

/* S'assurer que le Loader est bien au-dessus de tout */
#loader {
    z-index: 99999 !important; 
}
        /* SHORT VIDEO CONTAINER */
.short-video-container {
    position: relative;
    width: 100%;
    max-width: 300px; /* Largeur max sur mobile */
    aspect-ratio: 9 / 16; /* Ratio vertical TikTok/Insta */
    margin: 0 auto;
    background: #000;
    border-radius: 12px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
}

.short-video-container video {
    width: 100%;
    height: 100%;
    object-fit: contain; /* Garde la vidéo entière */
}
        /* --- ANIMATION AUTO-HIDE (STYLE TWITTER) --- */

/* Pour la Barre "Explorer" (Header) */
.feed-sticky-header {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Quand on ajoute la classe, ça remonte vers le haut */
/* Quand on ajoute la classe nav-hidden au header */
.feed-sticky-header.nav-hidden {
    transform: translateY(-500px) !important; 
}

/* Pour le Dock Mobile */
.mobile-dock {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s;
}

/* Quand on ajoute la classe, ça descend vers le bas */
.mobile-dock.nav-hidden {
    transform: translateY(100%);
    opacity: 0; /* Optionnel : pour qu'il disparaisse en fondu en même temps */
}
        /* --- SKELETON LOADING (Effet Pro) --- */

/* L'animation de brillance */
@keyframes shimmer {
    0% { background-position: -1000px 0; }
    100% { background-position: 1000px 0; }
}

/* La classe de base pour les blocs gris */
.skeleton {
    background-color: #e2e8f0; /* Slate-200 */
    background-image: linear-gradient(90deg, #e2e8f0 0%, #f1f5f9 50%, #e2e8f0 100%);
    background-size: 1000px 100%; /* Largeur pour l'animation */
    animation: shimmer 1.5s infinite linear; /* Durée et type d'animation */
}

/* Variante pour l'Avatar (Rond) */
.skeleton-avatar {
    width: 100%;
    height: 100%;
    border-radius: 50%;
}

/* Variante pour les Textes (Barres rectangulaires) */
.skeleton-text {
    height: 12px;
    margin-bottom: 6px;
    border-radius: 4px;
}
.skeleton-text.short { width: 30%; } /* Texte court */
.skeleton-text.long { width: 80%; } /* Texte long */
.skeleton-text.medium { width: 60%; }

/* Variante pour les Boutons (Forme de pilule) */
.skeleton-btn {
    height: 32px;
    width: 100px;
    border-radius: 16px;
}
        @keyframes heartPop {
    0% { transform: scale(1); }
    50% { transform: scale(1.4); }
    100% { transform: scale(1); }
}

.animate-heart-pop {
    animation: heartPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
        /* Bouton suivre type LinkedIn/Facebook */
.btn-follow-pro {
    @apply text-xs font-bold px-5 py-2 rounded-full transition-all duration-300
    bg-indigo-50 text-indigo-600 hover:btn-sky-yellow hover:text-white border border-indigo-100;
}

.btn-follow-pro.following {
    @apply bg-slate-100 text-slate-500 border-slate-200 hover:bg-red-50 hover:text-red-600 hover:border-red-100;
}

/* Scrollbar discrète pour les commentaires */
.custom-scrollbar::-webkit-scrollbar {
    width: 4px;
}
.custom-scrollbar::-webkit-scrollbar-thumb {
    @apply bg-slate-200 dark:bg-slate-700 rounded-full;
}

/* Animation de like */
.fa-heart.text-red-500 {
    animation: heartPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes heartPop {
    0% { transform: scale(1); }
    50% { transform: scale(1.4); }
    100% { transform: scale(1.1); }
}

        /* --- OPTIMISATION SCROLL (GPU) --- */

/* 2. Optimisation des cartes (Glassmorphism gourmand en ressources) */
.glass {
    /* Fond plus clair pour laisser passer les couleurs du média derrière */
    background: rgba(255, 255, 255, 0.75);
    
    /* Augmentation du flou pour un effet "givré" plus luxueux */
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    
    /* Bordure ultra-fine et Noir Pur très transparent */
    border: 0.5px solid rgba(0, 0, 0, 0.1);
    
    /* Rayon de bordure Instagram (plus carré que rond) */
    border-radius: 12px; 
    
    transition: all 0.2s ease-in-out;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

/* Version Mode Sombre pour votre Noir Pur #242526 ou Pur Black */
.dark .glass {
    background: rgba(0, 0, 0, 0.8); /* Noir pur transparent */
    border: 0.5px solid rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(25px);
}

/* 3. Optimisation des éléments Sticky (Header et Dock) */
.feed-sticky-header, .mobile-dock {
    /* Empêche le scintillement lors du scroll sur mobile */
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
    will-change: transform;
}

/* 4. Images : Empêche le saut de mise en page au chargement */
img {
    /* Laisse de l'espace pour l'image avant qu'elle ne charge */
    aspect-ratio: attr(width) / attr(height); 
}
        /* --- 1. REDUCTION DE L'ESPACE --- */
#home-view section {
    /* On réduit le padding en haut (pt-6 devient pt-2) */
    padding-top: 1rem; 
    padding-bottom: 80px;
    z-index: 99999 !important;
}

/* --- 2. LAYOUT AUTEUR OVERLAY (Style TikTok/Insta Pro) --- */
article {
    position: relative; /* Important pour positionner l'avatar par-dessus */
}

/* Conteneur de l'Avatar et du Nom (Superposition) */
.post-header-overlay {
    position: absolute;
    top: 12px;
    left: 12px;
    display: flex;
    align-items: flex-end; /* Aligner le texte en bas de l'avatar */
    gap: 8px;
    z-index: 10;
    pointer-events: none; /* Laisser passer le clic sur l'image si besoin */
}

/* L'Avatar avec un fond sombre pour la lisibilité */
.avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid white; /* Bordure blanche pour le détacher */
    overflow: hidden;
    background: rgba(0, 0, 0, 0.5); /* Fond semi-transparent */
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    flex-shrink: 0;
}

/* Le Nom superposé */
.author-info-overlay {
    color: white;
    text-shadow: 0 1px 3px rgba(0,0,0,0.8);
    margin-bottom: 2px;
    pointer-events: auto; /* On réactive le clic sur le nom */
}

.author-name-overlay {
    font-weight: 700;
    font-size: 14px;
    line-height: 1.1;
    display: block;
}

.author-time-overlay {
    font-size: 11px;
    opacity: 0.9;
}

/* Image du post */
.post-media-img {
    width: 100%;
    height: auto;
    display: block;
    border-radius: 5px 5px 0 0; /* Coins arrondis en haut seulement */
}

        /* --- MENTIONS & TAGS --- */
.mention-highlight {
    color: #4f46e5; /* Indigo */
    font-weight: 700;
    cursor: pointer;
    background: rgba(79, 70, 229, 0.05);
    padding: 0 2px;
    border-radius: 4px;
}
.hashtag-highlight {
    color: #ec4899; /* Pink */
    font-weight: 700;
    cursor: pointer;
}

/* --- PREVIEW LIEN (Link Preview) --- */
.link-preview-card {
    margin: 0 1rem 1rem 0;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    overflow: hidden;
    display: flex;
    flex-direction: row;
    text-decoration: none;
    color: inherit;
    transition: transform 0.2s;
}
.link-preview-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}
.link-preview-image {
    width: 100px;
    height: 100px;
    object-fit: cover;
    flex-shrink: 0;
}
.link-preview-content {
    padding: 12px;
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
}
.link-preview-title {
    font-weight: 700;
    font-size: 0.9rem;
    margin-bottom: 4px;
    line-height: 1.2;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
.link-preview-desc {
    font-size: 0.75rem;
    color: #64748b;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
.link-preview-domain {
    font-size: 0.7rem;
    color: #94a3b8;
    margin-top: auto;
    text-transform: uppercase;
    font-weight: 600;
}

/* --- MODE ZEN (FULLSCREEN VIDEO) --- */
#zen-mode-modal {
    position: fixed;
    inset: 0;
    background: #000;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}
#zen-mode-modal.active {
    opacity: 1;
    pointer-events: auto;
}
.zen-video-container {
    width: 100%;
    max-height: 80vh;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}
.zen-video-container video {
    max-width: 100%;
    max-height: 80vh;
    object-fit: contain;
}
.zen-controls-overlay {
    position: absolute;
    right: 20px;
    bottom: 30px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    align-items: center;
}
.zen-close-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 40px;
    height: 40px;
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    cursor: pointer;
    z-index: 100;
}
      /* --- STYLE PRO (Minimaliste & Élégant) --- */

/* 1. BOUTONS (Plus petits, plus fins) */
.reaction-btn {
    /* Taille réduite (Au lieu de 48px, on met 36px) */
    width: 36px;
    height: 36px;
    
    /* Taille de l'icône réduite (1.25rem = 20px) */
    font-size: 1.25rem; 
    
    /* Fond très léger (Presque blanc, pas gris foncé) */
    background-color: #f1f5f9; /* Très clair */
    color: #64748b;
    
    /* Forme ronde standard */
    border-radius: 50%;
    
    /* Centrage parfait */
    display: flex; 
    align-items: center; 
    justify-content: center;
    
    /* Animation fluide */
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border: 1px solid transparent; /* Prêt pour le gradient */
}

/* 2. Survol (Hover) */
.reaction-btn:hover {
    /* Légère agrandissement */
    transform: scale(1.15); 
    
    /* Fond légèrement plus foncé pour le contraste */
    background-color: #e2e8f0;
    color: #0f172a;
}

/* 3. État ACTIF (Réaction sélectionnée) */
.reaction-btn.active {
    /* Taille active légèrement plus grande */
    transform: scale(1.25);
    
    /* --- STYLE GRADIENT PRO (Instagram-like) --- */
    /* Fond blanc + Ombre portée + Élégance */
    background-color: #ffffff;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    
    /* Dégradé de bordure (Bordure colorée) */
    /* Rose/Pink pour le cœur par défaut, ou autre selon le type */
    border-image: linear-gradient(to right, #f43f5e, #ec4899); 
    /* Définit l'image de fond comme bordure */
    -webkit-background-clip: border-box; 
    -webkit-background-origin: border-box; 
    
    /* On force la couleur de l'icône (pour éviter qu'elle soit transparente) */
    color: #64748b; /* Gris foncé par défaut */
}
.reaction-btn.active i {
    /* Si vous voulez que l'icône prenne la couleur du dégradé (ex: Rose) */
    /* -webkit-text-fill-color: transparent; */ 
    /* background-image: ... (complexe, gardons simple pour l'instantanéité) */
}

/* 4. LE MENU POPUP (Plus propre) */
.reactions-popup {
    position: absolute;
    bottom: 110%;
    left: 0;
    /* Fond blanc + Effet verre (Glassmorphism Pro) */
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    
    box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); /* Ombre douce */
    border-radius: 16px; /* Coins moins arrondis pour le style Pro */
    padding: 6px; /* Espace réduit */
    gap: 6px; /* Espace entre boutons réduit */
    
    display: flex;
    z-index: 50;
    
    animation: popIn 0.2s cubic-bezier(0.16, 1, 0.3, 1);
    border: 1px solid rgba(226, 232, 240, 0.5);
}

/* Animation popIn (déjà défini mais gardé pour rappel) */
@keyframes popIn {
    from { opacity: 0; transform: scale(0.95) translateY(10px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}
        /* Limite le texte à 2 lignes */
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Style du bouton "Voir plus" */
.btn-voir-plus {
    display: inline-block;
    font-size: 0.75rem; /* text-xs */
    font-weight: 700;
    color: #64748b; /* text-slate-500 */
    cursor: pointer;
    margin-top: 4px;
}
.btn-voir-plus:hover {
    color: #4f46e5; /* text-indigo-600 */
}
       /* --- FOND UNIFIÉ POUR LE HEADER (MÊME STYLE QUE EXPLORER) --- */
.header-bg-extension {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 120px; 
    
    /* COPIE EXACTE DU STYLE DE LA BARRE EXPLORER */
    /* Blanc légèrement transparent */
    background-color: rgba(255, 255, 255, 0.95); 
    /* Effet de flou (Glassmorphism) */
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    
    z-index: 5; 
    pointer-events: none; 
    transition: background-color 0.3s ease;
}

/* --- ADAPTATION MODE SOMBRE --- */
/* Force la même couleur que la barre Explorer en mode sombre */
body.dark-mode .header-bg-extension {
    /* Gris foncé légèrement transparent */
    background-color: rgba(15, 23, 42, 0.95);
}
        /* --- MENU ACTIONS (3 POINTS) --- */

/* Conteneur du bouton et du menu */
.post-menu-container {
    position: relative;
}

/* Le menu déroulant (caché par défaut) */
.post-dropdown-menu {
    position: absolute;
    top: 100%; /* Juste sous le bouton */
    right: 0;
    width: 200px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px -10px rgba(0,0,0,0.2);
    border: 1px solid rgba(0,0,0,0.05);
    z-index: 100;
    display: none; /* Caché par défaut */
    overflow: hidden;
    animation: fadeInScale 0.2s ease;
}

/* Animation d'apparition */
@keyframes fadeInScale {
    from { opacity: 0; transform: scale(0.95) translateY(-5px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

/* Style des liens dans le menu */
.post-dropdown-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    font-size: 13px;
    font-weight: 500;
    color: #334155;
    cursor: pointer;
    transition: background 0.2s;
}
.post-dropdown-item:hover {
    background: #f8fafc; /* Slate-50 */
}
.post-dropdown-item.danger {
    color: #ef4444; /* Rouge pour signaler */
}
.post-dropdown-item.danger:hover {
    background: #fef2f2; /* Rouge très clair */
}

/* Mode Sombre */
body.dark-mode .post-dropdown-menu {
    background: #1e293b;
    border-color: rgba(255,255,255,0.1);
    box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5);
}
body.dark-mode .post-dropdown-item { color: #cbd5e1; }
body.dark-mode .post-dropdown-item:hover { background: #334155; }
body.dark-mode .post-dropdown-item.danger { color: #f87171; }
body.dark-mode .post-dropdown-item.danger:hover { background: rgba(239, 68, 68, 0.1); }

        /* --- MODAL VUE DÉTAILLÉE (FACEBOOK STYLE) --- */

#post-modal-overlay {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    display: none; /* Caché par défaut */
    align-items: center;
    justify-content: center;
    padding: 20px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.post-modal-card {
    background: white;
    width: 100%;
    max-width: 1000px; /* Grand écran */
    height: 90vh;
    max-height: 800px;
    display: flex;
    overflow: hidden;
    box-shadow: 0 20px 60px -10px rgba(0,0,0,0.4);
    animation: zoomIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

/* Layout Gauche (Image/Video) */
.post-modal-media {
    flex: 1.5;
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}
.post-modal-media img, .post-modal-media video {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}

/* Layout Droite (Infos & Commentaires) */
.post-modal-details {
    flex: 1;
    display: flex;
    flex-direction: column;
    max-width: 400px;
    background: white;
}

/* Header Modal */
.post-modal-header {
    padding: 16px 20px;
    border-bottom: 1px solid #f1f5f9;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.post-modal-header .menu-container { position: relative; }

/* Corps Modal (Scrollable) */
.post-modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 16px 20px;
}

/* Footer Modal (Input) */
.post-modal-footer {
    padding: 16px 20px;
    border-top: 1px solid #f1f5f9;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .post-modal-card {
        flex-direction: column;
        height: 100%;
        max-height: 100%;
        border-radius: 0;
    }
    .post-modal-media {
        min-height: 40%;
        max-height: 50%;
    }
    .post-modal-details {
        max-width: 100%;
        flex: 1;
    }
}

/* Dark Mode */
body.dark-mode #post-modal-overlay { background: rgba(0,0,0,0.9); }
body.dark-mode .post-modal-card { background: #1e293b; }
body.dark-mode .post-modal-details { background: #1e293b; }
body.dark-mode .post-modal-header { border-color: #334155; }
body.dark-mode .post-modal-footer { border-color: #334155; }

/* Caché par défaut */
#post-modal-overlay {
    display: none; 
    opacity: 0;
    pointer-events: none; /* Empêche les clics quand invisible */
}

        /* --- CORRECTION FORCEE MODALE --- */
/* Force l'affichage peu importe les autres classes */
#post-modal-overlay.active {
    display: flex !important;
    opacity: 1 !important;
    z-index: 99999 !important;
    pointer-events: auto !important;
}

/* S'assure que le fond est bien visible */
#post-modal-overlay {
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(8px);
}
 /* Supprime les marges parasites du body sur mobile */
body, html {
    margin: 0 !important;
    padding: 0 !important;
    overflow-x: hidden;
}

/* Force la barre à ignorer les paddings des parents */
.mobile-dock {
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    margin: 0 !important;
    border-radius: 0 !important; /* Enlève les coins arrondis */
    width: 100vw !important; /* Prend toute la largeur de l'écran */
    
    /* Pour les iPhones récents (gestion de la barre home) */
    padding-bottom: env(safe-area-inset-bottom);
    height: calc(60px + env(safe-area-inset-bottom));
}     
        
/* 1. Supprimer TOUS les espaces automatiques entre les posts */
#global-feed-container > * {
    margin-top: 0 !important;
    margin-bottom: 2 !important;
}
        /* --- STYLE MENU FACEBOOK --- */

/* Conteneur utilisateur */
#sidebar-user-card {
    transition: background 0.2s;
}
#sidebar-user-card:hover {
    background-color: rgba(0, 0, 0, 0.03); /* Gris très léger */
}

/* Liens du menu */
.nav-link-pro {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    margin: 2px 8px; /* Espacement aéré */
    border-radius: 10px; /* Arrondi Facebook */
    color: #050505; /* Noir Facebook */
    font-size: 15px; /* Taille standard FB */
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    transition: background 0.2s;
}
.dark-mode .nav-link-pro { color: #e4e6eb; }

.nav-link-pro:hover {
    background-color: #f2f2f2;
}
.dark-mode .nav-link-pro:hover {
    background-color: rgba(255, 255, 255, 0.08);
}

.nav-link-pro.active {
    background-color: transparent; /* Pas de fond bleu lourd */
    font-weight: 700; /* Juste plus gras */
}
.nav-link-pro.active span {
    color: #0866ff; /* Bleu Facebook pour le texte actif */
}

/* Icônes dans le cercle coloré */
.nav-link-pro .w-8 {
    flex-shrink: 0;
}

/* Correction largeur Sidebar sur mobile */
@media (max-width: 768px) {
    #sidebar-panel {
        width: 85vw !important; /* Prend 85% de la largeur sur mobile */
        max-width: 320px !important; /* Mais dépasse pas 320px */
    }
}
        /* BOUTON DÉGRADÉ PRO */
.btn-sky-yellow {
    background: linear-gradient(to right, #38bdf8, #facc15) !important; 
    color: #000000 !important; /* Texte noir obligatoire pour contraste */
    font-weight: 800;
    border: none;
    box-shadow: 0 4px 14px rgba(56, 189, 248, 0.4);
    transition: all 0.3s ease;
}
.btn-sky-yellow:hover {
    opacity: 0.9;
    box-shadow: 0 6px 20px rgba(250, 204, 21, 0.5);
}
        /* --- ADAPTATION CARTES PUB / MARKETPLACE --- */
.market-item, .market-item.glass {
    background-color: var(--surface-bg) !important;
    border: 1px solid var(--glass-border) !important;
}

/* Titre de la carte */
.market-item h3 {
    color: var(--text-main) !important;
}

/* Description */
.market-item p {
    color: var(--text-muted) !important;
}

/* Prix */
.market-item .font-black {
    color: var(--text-main) !important;
}

/* Fond de l'icône (ex: le cercle violet/bleu derrière l'icône) */
.market-item .bg-indigo-50, .market-item .bg-emerald-50 {
    background-color: var(--input-bg) !important;
}

/* En mode Sombre, on rend les fonds d'icônes très discrets */
body.dark-mode .market-item .bg-indigo-50, 
body.dark-mode .market-item .bg-emerald-50 {
    background-color: rgba(255, 255, 255, 0.05) !important;
}
        /* Menu Contextuel Flottant */
.context-menu {
    position: fixed;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    z-index: 100000;
    padding: 8px 0;
    min-width: 180px;
    animation: popIn 0.15s ease-out;
    border: 1px solid rgba(0,0,0,0.05);
}
.dark .context-menu {
    background: #1e293b;
    border-color: rgba(255,255,255,0.1);
}
.context-menu-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 16px;
    font-size: 14px;
    color: #334155;
    cursor: pointer;
    transition: background 0.1s;
}
.dark .context-menu-item { color: #e2e8f0; }
.context-menu-item:hover { background: #f1f5f9; }
.dark .context-menu-item:hover { background: #334155; }
.context-menu-item.danger { color: #ef4444; }
.context-menu-item.danger:hover { background: #fef2f2; }

        /* Rendre les clics instantanés sur mobile */
.list-item-chat, 
[onclick], 
button {
    touch-action: manipulation; /* Supprime le délai de 300ms */
}
    </style>
</head>
<body>

    <!-- PROFESSIONAL LOADER -->
    <div id="loader">
        <div class="loader-content">
            <div class="loader-icon"><i class="fab fa-linkedin text-slate-400 hover:text-indigo-600 transition-colors cursor-pointer"></i></div>
            <div class="loader-text">Linko</div>
        </div>
        <div class="loader-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-container" class="toast-container"></div>

    <!-- BACKGROUNDS -->
    <div class="bg-grid" id="parallax-bg"></div>
    <div class="bg-glow"></div>
    <!-- Fond blanc/noir unifié derrière le header -->
<div class="header-bg-extension"></div>

    <!-- SIDEBAR OVERLAY -->
    <div id="sidebar-overlay" class="fixed inset-0 z-[5000] invisible transition-all duration-500" aria-hidden="true">
        <div id="sidebar-bg" class="absolute inset-0 bg-slate-900/20 backdrop-blur-sm opacity-0 transition-opacity duration-500" onclick="toggleSidebar()"></div>
        
       <div id="sidebar-panel" class="fixed top-0 left-0 h-full w-[280px] md:w-[300px] bg-white dark:bg-slate-900 z-[5001] -translate-x-full opacity-0 transition-all duration-500 ease-[cubic-bezier(0.32,0.72,0,1)] flex flex-col shadow-2xl border-r border-slate-100 dark:border-slate-800 overflow-y-auto">
    
    <!-- HEADER FERMETURE (Mobile) -->
    <div class="p-4 flex items-center justify-between border-b border-slate-100 dark:border-slate-700/50 md:hidden">
        <div class="flex items-center gap-2 text-xl font-black text-slate-900 dark:text-white">
            Link<span class="text-indigo-600">o</span>
        </div>
        <button onclick="toggleSidebar()" class="w-9 h-9 rounded-full btn-sky-yellow dark:bg-slate-800 flex items-center justify-center">
            <i class="fas fa-times text-slate-500"></i>
        </button>
    </div>

    <!-- 1. PROFIL UTILISATEUR (Style Facebook) -->
    <div id="sidebar-user-card" onclick="switchPage('profile-social'); toggleSidebar();" 
     class="p-3 flex items-center gap-3 hover:btn-sky-yellow dark:hover:bg-slate-800/60 cursor-pointer transition-all mx-2 mt-3 rounded-lg group">
    
    <div class="relative">
        <img id="sidebar-avatar" src="https://ui-avatars.com/api/?name=Guest&background=e2e8f0&color=64748b" 
             class="w-10 h-10 rounded-full object-cover border border-slate-200 dark:border-slate-700 shadow-sm">
        <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white dark:border-slate-900 rounded-full"></div>
    </div>
    
    <div class="flex-1 overflow-hidden">
        <h4 id="sidebar-username" class="font-bold text-[15px] text-black dark:text-white leading-tight truncate">
            Chargement...
        </h4>
        <span class="text-[13px] text-slate-500 dark:text-slate-400 font-normal group-hover:underline">
            Voir votre profil
        </span>
    </div>

    <i class="fas fa-chevron-right text-[10px] text-slate-400"></i>
</div>

    <!-- LISTE MENU -->
    <nav class="flex-1 p-2 space-y-1">
        
        <!-- MENU PRINCIPAL -->
        <a onclick="switchPage('home'); toggleSidebar();" class="nav-link-pro active group">
            <div class="w-8 h-8 rounded-lg bg-indigo-50 dark:bg-indigo-900/30 flex items-center justify-center mr-3 transition-colors group-hover:bg-indigo-100 dark:group-hover:bg-indigo-900/50">
                <i class="fas fa-house text-indigo-600 dark:text-indigo-400 text-sm"></i>
            </div>
            <span>Accueil</span>
        </a>

        <a onclick="switchPage('messages'); toggleSidebar();" class="nav-link-pro group">
            <div class="w-8 h-8 rounded-lg bg-blue-50 dark:bg-blue-900/30 flex items-center justify-center mr-3 transition-colors group-hover:bg-blue-100 dark:group-hover:bg-blue-900/50">
                <i class="fas fa-comment-dots text-blue-500 dark:text-blue-400 text-sm"></i>
            </div>
            <span>Messenger</span>
        </a>

        <a onclick="switchPage('notifications'); toggleSidebar();" class="nav-link-pro group">
            <div class="w-8 h-8 rounded-lg bg-pink-50 dark:bg-pink-900/30 flex items-center justify-center mr-3 transition-colors group-hover:bg-pink-100 dark:group-hover:bg-pink-900/50">
                <i class="fas fa-bell text-pink-500 dark:text-pink-400 text-sm"></i>
            </div>
            <span>Notifications</span>
        </a>

        <a onclick="switchPage('marketplace'); toggleSidebar();" class="nav-link-pro group">
            <div class="w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-800 flex items-center justify-center mr-3 transition-colors group-hover:bg-slate-200 dark:group-hover:bg-slate-700">
                <i class="fas fa-store text-slate-600 dark:text-slate-400 text-sm"></i>
            </div>
            <span>Marketplace</span>
        </a>

        <!-- SÉPARATEUR -->
        <div class="border-t border-slate-100 dark:border-slate-800 my-3 mx-2"></div>

        <!-- RACCOURCIS (Nouveau Design) -->
        <!-- RACCOURCIS (Style Grille Facebook) -->
<div class="flex items-center justify-between px-4 mb-3">
    <p class="text-[13px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-tight">Raccourcis</p>
    <button class="text-blue-600 dark:text-blue-400 text-[12px] font-medium">Modifier</button>
</div>

<div class="grid grid-cols-3 gap-y-4 gap-x-2 px-2 mb-6">
    
    <a href="javascript:void(0)" onclick="switchPage('saved'); toggleSidebar();" class="flex flex-col items-center group">
        <div class="w-12 h-12 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center mb-1 group-active:scale-90 transition-transform">
            <i class="fas fa-bookmark text-blue-600 text-[20px]"></i>
        </div>
        <span class="text-[12px] font-medium text-slate-900 dark:text-slate-200">Enregistrés</span>
    </a>

    <a href="javascript:void(0)" onclick="switchPage('pages'); toggleSidebar();" class="flex flex-col items-center group">
        <div class="w-12 h-12 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center mb-1 group-active:scale-90 transition-transform">
            <i class="fas fa-flag text-orange-500 text-[20px]"></i>
        </div>
        <span class="text-[12px] font-medium text-slate-900 dark:text-slate-200">Pages</span>
    </a>

    <a href="javascript:void(0)" onclick="switchPage('groups'); toggleSidebar();" class="flex flex-col items-center group">
        <div class="w-12 h-12 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center mb-1 group-active:scale-90 transition-transform">
            <i class="fas fa-users text-cyan-500 text-[20px]"></i>
        </div>
        <span class="text-[12px] font-medium text-slate-900 dark:text-slate-200">Canaux</span>
    </a>

    <a href="javascript:void(0)" onclick="switchPage('events'); toggleSidebar();" class="flex flex-col items-center group">
        <div class="w-12 h-12 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center mb-1 group-active:scale-90 transition-transform">
            <i class="fas fa-calendar-day text-red-500 text-[20px]"></i>
        </div>
        <span class="text-[12px] font-medium text-slate-900 dark:text-slate-200">Événements</span>
    </a>

    <a href="javascript:void(0)" onclick="switchPage('stats'); toggleSidebar();" class="flex flex-col items-center group">
        <div class="w-12 h-12 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center mb-1 group-active:scale-90 transition-transform">
            <i class="fas fa-chart-simple text-emerald-500 text-[20px]"></i>
        </div>
        <span class="text-[12px] font-medium text-slate-900 dark:text-slate-200">Tableau bord</span>
    </a>

</div>

        <div class="flex items-center justify-between px-4 mb-3">
    <p class="text-[13px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-tight">Outils professionnels</p>
    <button class="text-blue-600 dark:text-blue-400 text-[12px] font-medium hover:underline">Voir tout</button>
</div>

<div class="grid grid-cols-3 gap-1 px-2 mb-6">

    <a href="javascript:void(0)" onclick="switchPage('certification'); toggleSidebar();" class="flex flex-col items-center p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-all group">
        <div class="w-11 h-11 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center mb-2 group-active:scale-95 transition-transform">
            <i class="fas fa-check-circle text-sky-500 text-[18px]"></i>
        </div>
        <span class="text-[12px] font-medium text-slate-900 dark:text-slate-200">Vérifié</span>
    </a>

</div>

    <!-- FOOTER -->
    <div class="p-4 border-t border-slate-100 dark:border-slate-800 mt-auto">
    
    <a onclick="switchPage('settings'); toggleSidebar();" 
       class="flex items-center gap-3 p-2 rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 transition-all cursor-pointer">
        <div class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center">
            <i class="fas fa-cog text-sm"></i>
        </div>
        <span class="text-[13px] font-semibold">Paramètres et confidentialité</span>
    </a>

    <a onclick="confirmSocialLogout()" 
       class="flex items-center gap-3 p-2 rounded-lg text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all cursor-pointer mt-1">
        <div class="w-8 h-8 rounded-full bg-red-50 dark:bg-red-900/30 flex items-center justify-center">
            <i class="fas fa-sign-out-alt text-sm"></i>
        </div>
        <span class="text-[13px] font-semibold">Se déconnecter</span>
    </a>
    
    <div class="mt-4 flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl shadow-inner">
        <button onclick="setTheme('light')" id="btn-light-menu" 
            class="flex-1 flex items-center justify-center gap-2 py-2 text-[11px] font-bold rounded-lg transition-all
            bg-white dark:bg-transparent text-slate-900 dark:text-slate-400 shadow-sm dark:shadow-none">
            <i class="fas fa-sun"></i> Clair
        </button>
        
        <button onclick="setTheme('dark')" id="btn-dark-menu" 
            class="flex-1 flex items-center justify-center gap-2 py-2 text-[11px] font-bold rounded-lg transition-all
            bg-transparent dark:bg-[#242526] text-slate-500 dark:text-white dark:shadow-sm">
            <i class="fas fa-moon"></i> Sombre
        </button>
    </div>
</div>
</div>
        </div>

    <!-- HEADERS -->
    <!-- MOBILE HEADER -->
    <div class="sm:hidden fixed top-0 w-full z-[4000] px-4 py-1 transition-all duration-300" id="mobile-header">
        <div class="flex items-center justify-between gap-3">
            <button onclick="toggleSidebar()" class="flex items-center justify-center w-11 h-11 bg-white/90 border border-slate-200 rounded-xl shadow-sm backdrop-blur-md active:scale-95 transition-all group" aria-label="Menu"><i class="fas fa-bars text-slate-700 group-hover:text-indigo-600 transition-colors"></i></button>
            <div class="flex-1 h-11 bg-white/90 border border-slate-200 rounded-xl flex items-center justify-center px-4 shadow-sm backdrop-blur-md"><span class="font-bold text-lg tracking-tight"><span class="text-indigo-600">Print</span>bam</span></div>
            <!-- BOUTON NOTIFICATIONS (Remplace le bouton menu hamburger) -->
<button onclick="switchPage('notifications')" class="flex items-center justify-center w-11 h-11 bg-white/90 border border-slate-200 rounded-xl shadow-sm backdrop-blur-md active:scale-95 transition-all group relative" aria-label="Notifications">
    <i class="fas fa-bell text-slate-700 group-hover:text-indigo-600 transition-colors"></i>
    
    <!-- BADGE ROUGE (Caché par défaut) -->
    <span id="notif-badge-count" class="hidden absolute top-0 right-0 w-5 h-5 bg-red-500 text-white text-[10px] font-bold flex items-center justify-center rounded-full border-2 border-white shadow-sm">0</span>
</button>
        </div>
    </div>

    <!-- MOBILE DOCK -->
    <div class="mobile-dock md:hidden fixed bottom-0 left-0 w-full bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 h-[47px] flex items-center justify-around z-[9999] m-0 p-0">
    
    <a onclick="switchPage('home')" class="flex flex-col items-center justify-center w-full h-full cursor-pointer">
        <i class="fas fa-house text-[20px] text-slate-900 dark:text-white"></i>
    </a>

    <a onclick="switchPage('marketplace')" class="flex flex-col items-center justify-center w-full h-full cursor-pointer">
        <i class="far fa-compass text-[20px] text-slate-500"></i>
    </a>

    <div class="flex items-center justify-center w-full h-full">
        <a href="javascript:void(0)" onclick="openNewPostModal()" class="flex items-center justify-center border-2 border-slate-900 dark:border-white rounded-[8px] w-[22px] h-[22px]">
            <i class="fas fa-plus text-slate-900 dark:text-white text-[10px]"></i>
        </a>
    </div>

    <a href="javascript:void(0)" onclick="switchPage('messages')" class="flex flex-col items-center justify-center w-full h-full cursor-pointer relative">
        <i class="far fa-paper-plane text-[20px] text-slate-500"></i>
        <span id="msg-badge-count" class="hidden absolute top-1 right-4 bg-red-500 text-white text-[10px] font-bold px-1 rounded-full min-w-[15px] h-4 border-2 border-white dark:border-slate-900">0</span>
    </a>

    <a href="javascript:void(0)" onclick="switchPage('profile-social')" class="flex flex-col items-center justify-center w-full h-full cursor-pointer">
        <div class="w-6 h-6 rounded-full border border-slate-300 overflow-hidden">
            <img id="dock-avatar-img" src="" alt="" class="w-full h-full object-cover hidden">
            <i id="dock-avatar-icon" class="fas fa-user text-slate-500 flex items-center justify-center h-full text-xs"></i>
        </div>
    </a>
</div>

    <!-- MAIN CONTENT WRAPPER -->
   <!-- PAGE 1: ACCUEIL (FEED GLOBAL) -->
<div id="home-view" class="page-view">
    <section class="max-w-2xl mx-auto px-4 pt-10 pb-20 ">
        
        <!-- NOUVEAU WRAPPER STICKY MODIFIÉ -->
<div class="sticky top-[50px] z-[3500] mb-10 py-1 -mx-4 px-4 border-b border-black/10 dark:border-white/10">
    
    <!-- HEADER DU FEED -->
    <div class="flex items-center justify-between mb-1"> <!-- mb-4 devient mb-1 -->
        <h1 class="text-2xl font-black text-slate-900 dark:text-white tracking-tight">
            Explorez
        </h1>
        
        <!-- BOUTON RECHERCHE (Remplace le bouton Publier) -->
        <button onclick="toggleSearch()" class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 px-4 py-2 rounded-full text-sm font-bold shadow-sm hover:bg-slate-200 transition flex items-center gap-2">
            <i class="fas fa-search"></i>
        </button>
    </div>

    <!-- BARRE DE RECHERCHE (Cachée par défaut) -->
    <div id="feed-search-bar" class="hidden mb-3 overflow-hidden transition-all duration-300">
        <div class="relative">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
            <input type="text" id="feed-search-input" placeholder="Rechercher des publications..." class="w-full bg-slate-100 dark:bg-slate-800 border-none rounded-full py-2 pl-9 pr-4 text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none transition-all placeholder-slate-400">
        </div>
    </div>

    <!-- BOUTONS DE TRI -->
    <div class="flex gap-2 pb-1 overflow-x-auto no-scrollbar" id="sort-container">
    
    <button onclick="handleSortClick(this, 'recent')" 
        title="Actualités"
        class="sort-btn flex items-center gap-2 px-3 py-1.5 rounded-full bg-blue-50 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400 text-[14px] font-semibold transition-all duration-300">
        <i class="fas fa-bolt-lightning text-sm"></i>
        <span class="btn-text">Actualités</span>
    </button>

    <button onclick="handleSortClick(this, 'popular')" 
        title="Tendances"
        class="sort-btn flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-300 text-[14px] font-semibold transition-all duration-300">
        <i class="fas fa-arrow-trend-up text-sm text-indigo-500"></i>
        <span class="btn-text hidden">Tendances</span>
    </button>

    <button onclick="handleSortClick(this, 'shorts')" 
        title="Shorts"
        class="sort-btn flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-300 text-[14px] font-semibold transition-all duration-300">
        <i class="fas fa-clapperboard text-sm text-pink-500"></i>
        <span class="btn-text hidden">Shorts</span>
    </button>
</div>
</div> 
        <!-- FIN DU WRAPPER STICKY -->

        <!-- CONTENEUR DES POSTS -->
        <div id="global-feed-container">
             <!-- ... les posts ... -->
        </div>
        <!-- AJOUTEZ CE BLOC ICI (Le sentinelle de chargement) -->
<div id="feed-loader" class="hidden py-8 flex justify-center">
    <div class="flex items-center gap-2 text-slate-400 text-sm font-bold">
        <i class="fas fa-circle-notch fa-spin text-indigo-500"></i>
        Chargement...
    </div>
</div>
    </section>
</div>


        <!-- PAGE : PROFIL SOCIAL (DESIGN FLAT STYLE CAPTURE) -->
<div id="profile-social-view" class="page-view">
    <!-- Container principal fond blanc pour cacher le fond de l'app -->
    <div class="bg-white min-h-screen max-w-lg mx-auto shadow-sm relative z-20 pb-20">
        
        <!-- HEADER : Avatar + Nom + Stats -->
<div class="p-5 flex items-start gap-5 border-b border-gray-100">
   <!-- BOUTON DÉCONNEXION (Haut Droit) -->
    <!-- Il s'affiche en gris, devient rouge au survol -->
    <button onclick="confirmSocialLogout()" class="absolute top-4 right-4 w-10 h-10 flex items-center justify-center rounded-full hover:bg-red-50 text-gray-400 hover:text-red-500 transition-all" title="Déconnexion">
        <i class="fas fa-sign-out-alt text-lg"></i>
    </button> 
    <!-- 1. AVATAR (Sans le badge absolu dedans) -->
    <div class="relative">
        <div class="w-20 h-20 md:w-24 md:h-24 rounded-full border border-gray-200 p-1 bg-white">
            <img id="social-avatar" src="" alt="Profile" class="w-full h-full object-cover rounded-full hidden">
            <div id="social-avatar-placeholder" class="w-full h-full bg-gray-100 rounded-full flex items-center justify-center text-gray-300">
                <i class="fas fa-user text-2xl"></i>
            </div>
        </div>
    </div>

    <!-- 2. INFOS PRINCIPALES -->
    <div class="flex-1 pt-1">
        
        <!-- Conteneur Flex pour aligner le NOM et le BADGE -->
        <div class="flex items-center gap-1 mb-1">
            <h1 id="social-fullname" class="text-xl font-bold text-black leading-none">Chargement...</h1>
            
            <!-- LE BADGE EST MAINTENANT ICI (Style Facebook : Rond bleu + Check blanc) -->
            <span id="social-badge-inline" class="hidden ml-1">
    <!-- Couleur officielle Instagram : #0095F6 -->
    <i class="fas fa-check-circle text-[#0095F6] text-lg"></i>
</span>
        </div>
        
        <!-- Stats -->
        <div class="text-sm text-gray-600 font-medium mb-2">
            <span id="stat-following">0</span> suivis • 
            <span id="stat-followers">0</span> abonnés
        </div>
        
        <!-- Bouton Modifier -->
        <button onclick="toggleProfile()" class="px-3 py-1 bg-gray-100 text-xs font-bold text-gray-700 rounded hover:bg-gray-200 transition">
            Modifier le profil
        </button>
        <!-- NOUVEAU CONTENEUR POUR LE BOUTON FOLLOW (Caché par défaut) -->
        <div id="profile-follow-container" class="hidden">
            <!-- Le bouton sera injecté ici par JS -->
        </div>
    </div>
</div>

        <!-- SECTION INFOS (Liste grise comme sur la capture) -->
        <div class="bg-gray-50 px-5 py-4 space-y-3 border-b border-gray-200">
            <!-- Téléphone -->
            <div class="flex items-center gap-3">
                <i class="fas fa-phone text-gray-400 w-4 text-center"></i>
                <span id="social-phone" class="text-sm text-gray-700 font-medium">...</span>
            </div>
            <!-- Username -->
            <div class="flex items-center gap-3">
                <i class="fas fa-at text-gray-400 w-4 text-center"></i>
                <span id="social-username" class="text-sm text-gray-700 font-medium">...</span>
            </div>
            <!-- Date de naissance -->
            <div class="flex items-center gap-3">
                <i class="fas fa-birthday-cake text-gray-400 w-4 text-center"></i>
                <span id="social-dob" class="text-sm text-gray-700 font-medium">...</span>
            </div>
        </div>

        <!-- ONGLETS (Publications / Archivées) -->
        <div class="flex border-b border-gray-200">
            <button onclick="switchSocialTab('publications')" class="social-tab-btn flex-1 py-4 text-sm font-bold text-black border-b-2 border-black transition-colors">
                Publications
            </button>
            <button onclick="switchSocialTab('archives')" class="social-tab-btn flex-1 py-4 text-sm font-bold text-gray-400 border-b-2 border-transparent hover:text-gray-600 transition-colors">
                Publications archivées
            </button>
        </div>

        <!-- GRILLE DES PHOTOS (3 Colonnes, écart minime) -->
        <div id="social-posts-grid" class="grid grid-cols-3 gap-1 bg-gray-100">
            <!-- Les photos seront injectées ici par JS -->
            <div class="col-span-3 flex flex-col items-center justify-center py-20 text-gray-400">
                <i class="fas fa-camera text-3xl mb-2"></i>
                <p class="text-xs">Aucune publication</p>
            </div>
        </div>

        <!-- BOUTON AJOUTER FLOTTANT (En bas à droite ou fixe en bas) -->
        <!-- La capture montre un bouton en bas. Je le place fixe en bas à droite pour l'effet moderne -->
        <button onclick="openNewPostModal()" class="fixed bottom-6 right-6 md:absolute md:bottom-6 md:right-6 w-14 h-14 btn-sky-yellow text-white rounded-full shadow-lg flex items-center justify-center hover:bg-blue-700 transition-all z-50">
            <i class="fas fa-plus text-xl"></i>
        </button>

    </div>
</div>

<!-- MODALE AJOUT PHOTO (Simple et blanche) -->
<div id="new-post-modal" class="fixed inset-0 z-[9500] hidden bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl">
        <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
            <h3 class="font-bold text-black">Nouvelle publication</h3>
            <button onclick="closeNewPostModal()" class="text-blue-500 font-bold text-sm">Annuler</button>
        </div>
        <div class="p-4">
          <form id="new-post-form" onsubmit="handleNewPost(event)" class="space-y-4">
    
    <!-- SÉLECTEUR DE TYPE -->
    <div class="flex p-1 bg-slate-100 rounded-lg mb-2">
        <button type="button" onclick="setPostType('image')" id="btn-type-image" class="flex-1 py-2 text-xs font-bold rounded-md bg-white shadow-sm text-slate-900 transition">
            Photo
        </button>
        <button type="button" onclick="setPostType('short')" id="btn-type-short" class="flex-1 py-2 text-xs font-bold rounded-md text-slate-500 hover:text-slate-900 transition">
            Short Vidéo
        </button>
    </div>

    <!-- INPUT IMAGE -->
    <div id="upload-image-box" class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:bg-gray-50 transition cursor-pointer" onclick="document.getElementById('post-file-input').click()">
        <input type="file" id="post-file-input" accept="image/*" class="hidden" onchange="previewFile(this, 'image')">
        <i class="fas fa-images text-3xl text-gray-400 mb-2"></i>
        <p class="text-xs text-gray-500 font-medium">Choisir une photo</p>
    </div>

    <!-- INPUT VIDÉO (Caché par défaut) -->
    <div id="upload-video-box" class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:bg-gray-50 transition cursor-pointer hidden" onclick="document.getElementById('post-video-input').click()">
        <input type="file" id="post-video-input" accept="video/mp4,video/quicktime,video/x-msvideo" class="hidden" onchange="previewFile(this, 'video')">
        <i class="fas fa-video text-3xl text-gray-400 mb-2"></i>
        <p class="text-xs text-gray-500 font-medium">Choisir une vidéo (Max 10 min)</p>
        <p id="video-error-msg" class="text-[10px] text-red-500 font-bold mt-2 hidden"></p>
    </div>

    <!-- ZONE DE PRÉVISUALISATION -->
    <div id="preview-area" class="w-full aspect-video bg-black rounded-lg hidden overflow-hidden relative flex items-center justify-center mb-2">
        <img id="preview-img-el" class="max-h-full object-contain hidden">
        <video id="preview-video-el" class="max-h-full object-contain hidden" controls></video>
    </div>
<!-- Ajoutez ceci DANS le formulaire, avant le bouton de publication -->
<div class="mb-4">
    <label class="text-xs font-bold text-slate-500 mb-1 block">Visibilité</label>
    <select id="post-visibility" class="w-full bg-slate-100 dark:bg-slate-800 rounded-lg p-2.5 text-sm border-none">
        <option value="public">🌍 Public</option>
        <option value="friends">👥 Abonnés uniquement</option>
        <option value="private">🔒 Privé (Moi uniquement)</option>
    </select>
</div>
    <textarea id="post-caption" rows="3" placeholder="Écrivez une légende..." class="w-full text-sm p-3 border border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 resize-none"></textarea>
    
    <input type="hidden" id="current-post-type" value="image">
    
   <button onclick="handleNewPost(e)" type="submit" class="w-full py-3 font-bold rounded-lg transition">Publier</button>
</form>
        </div>
    </div>
</div>

    <!-- VUE : CENTRE DE NOTIFICATIONS -->
<div id="notifications-view" class="page-view">
    <section class="max-w-2xl mx-auto h-screen flex flex-col bg-white dark:bg-slate-900">
        
        <!-- Header -->
        <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center sticky top-0 bg-white/95 dark:bg-slate-900/95 backdrop-blur z-10">
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Notifications</h2>
            <button onclick="markAllNotificationsRead()" class="text-xs font-bold text-indigo-600 hover:underline">Tout marquer comme lu</button>
        </div>

        <!-- Liste des notifications -->
        <div id="notifications-list-container" class="flex-1 overflow-y-auto">
            <!-- Injecté par JS -->
        </div>
    </section>
</div>
        
    <!-- VUE 1 : LISTE DES MESSAGES (Style Photo 1) -->
<div id="messages-view" class="page-view">
    <section class="fixed inset-0 z-50 max-w-2xl mx-auto h-screen flex flex-col bg-white dark:bg-slate-900 translate-y-12">
        
        <!-- Header -->
        <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-white dark:bg-slate-900 sticky top-0 z-10">
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Discussions</h2>
            <button class="text-indigo-600"><i class="far fa-edit text-lg"></i></button>
        </div>

        <!-- Liste des conversations -->
        <div id="chat-list-container" class="flex-1 overflow-y-auto">
            <!-- Les éléments seront injectés ici par JS -->
            <div class="flex flex-col items-center justify-center h-full text-slate-400">
                <i class="fas fa-comments text-4xl mb-3 opacity-20"></i>
                <p>Aucune discussion pour le moment.</p>
            </div>
        </div>

        <!-- Barre de recherche (Optionnelle) -->
        <div class="px-4 -translate-y-14 bg-transparent">
            <div class="relative">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 z-10"></i>
            
            <input type="text" 
                   placeholder="Rechercher une discussion..." 
                   class="w-full pl-10 pr-4 py-2 rounded-full 
                          bg-white/70 dark:bg-slate-800/60 
                          backdrop-blur-md 
                          border border-white/20 dark:border-slate-700/50
                          text-sm shadow-xl 
                          focus:outline-none focus:ring-2 focus:ring-indigo-500/50 
                          dark:text-white transition-all">
        </div>
</div>
    </section>
</div>

<!-- VUE 2 : DISCUSSION (Structure Fixe) -->
<div id="chat-view" class="page-view">
    <!-- Wrapper plein écran -->
    <section class="fixed inset-0 max-w-2xl mx-auto w-full flex flex-col z-[10000] bg-white dark:bg-slate-900 shadow-2xl">
        
        <!-- HEADER FIXE -->
        <div class="wa-header p-3 flex items-center gap-3 shadow-sm z-20 flex-shrink-0 bg-[#00a884] dark:bg-slate-900 border-b border-slate-700">
            <button onclick="switchPage('messages')" class="text-white/80 hover:text-white">
                <i class="fas fa-arrow-left text-lg"></i>
            </button>
            
            <div class="flex items-center gap-3 flex-1 cursor-pointer" onclick="viewUserProfile(currentTargetUserId)">
                <div class="relative">
                    <img id="chat-header-avatar" src="" class="w-10 h-10 rounded-full object-cover border-2 border-white/20">
                    <div id="chat-status-dot" class="absolute bottom-0 right-0 w-3 h-3 bg-white rounded-full border-2 border-[#00a884]"></div>
                </div>
                <div class="flex flex-col justify-center">
                    <h3 id="chat-header-name" class="text-sm font-semibold text-white leading-tight">...</h3>
                    <p id="chat-header-status-text" class="text-[11px] text-emerald-100">En ligne</p>
                </div>
            </div>
            
            <div class="flex gap-4 text-white/90">
                <i class="fas fa-video cursor-pointer hover:text-white"></i>
                <i class="fas fa-phone cursor-pointer hover:text-white"></i>
            </div>
        </div>

        <!-- MESSAGES (Flex-1 pour prendre l'espace restant) -->
        <div id="chat-messages-container" class="flex-1 overflow-y-auto p-4 scroll-smooth bg-[#efeae2] dark:bg-[#0b141a]" style="background-image: url('data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%23000000\' fill-opacity=\'0.03\'%3E%3Cpath d=\'M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');">
            <!-- Messages injectés ici -->
        </div>

        <!-- Zone de Réponse (Cachée par défaut) -->
        <div id="reply-container" class="hidden bg-white dark:bg-slate-800 px-4 py-2 border-t border-slate-200 dark:border-slate-700 flex items-center justify-between">
            <div class="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-300">
                <i class="fas fa-reply text-indigo-500"></i>
                <span id="reply-preview-text" class="truncate max-w-[200px]"></span>
            </div>
            <button onclick="cancelReply()" class="text-slate-400 hover:text-slate-600">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- ZONE DE SAISIE -->
<div class="p-2 bg-[#f0f2f5] dark:bg-slate-800 flex items-end gap-2 z-20 border-t border-slate-200 dark:border-slate-700">
    
    <!-- Boutons Gauche (Smileys / Fichier) -->
    <div class="flex gap-1 text-slate-500">
        <button type="button" class="p-2 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full transition">
            <i class="far fa-smile text-xl"></i>
        </button>
        <button type="button" class="p-2 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full transition">
            <i class="fas fa-paperclip text-xl"></i>
        </button>
    </div>
    
    <!-- Formulaire de saisie -->
    <form id="chat-form" onsubmit="sendChatMessage(event)" class="flex-1 relative">
        <input type="text" id="chat-input" placeholder="Écrivez un message..." autocomplete="off"
               oninput="toggleChatSendButton()" 
               class="w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
    </form>

    <!-- CONTENEUR DU BOUTON DYNAMIQUE -->
    <div id="chat-action-btn-wrapper">
        <!-- BOUTON VOCAL (Par défaut) -->
        <button type="button" id="voice-btn" 
                class="w-10 h-10 rounded-full flex items-center justify-center shadow-md transition-all duration-300 btn-sky-yellow"
                style="color: white !important;"> 
            <i class="fas fa-microphone text-lg"></i>
        </button>
        
        <!-- BOUTON ENVOYER (Caché par défaut) -->
        <button type="submit" form="chat-form" id="send-btn" 
                class="w-10 h-10 rounded-full flex items-center justify-center shadow-md transition-all duration-300 btn-sky-yellow hidden"
                style="color: white !important;">
            <i class="fas fa-paper-plane text-lg"></i>
        </button>
    </div>
</div>
    </section>
</div>
    <!-- deuxième donné en haut -->

        <!-- MODAL MODE ZEN -->
<div id="zen-mode-modal">
    <!-- Bouton Fermer -->
    <button onclick="closeZenMode()" class="zen-close-btn">
        <i class="fas fa-times text-xl"></i>
    </button>

    <!-- Conteneur Vidéo -->
    <div class="zen-video-container">
        <video id="zen-video-player" controls></video>
    </div>

    <!-- Contrôles superposés (Style TikTok) -->
    <div class="zen-controls-overlay">
        <div class="flex flex-col gap-4">
            <button class="text-white text-2xl hover:text-indigo-400 transition"><i class="fas fa-heart"></i></button>
            <button class="text-white text-2xl hover:text-indigo-400 transition"><i class="fas fa-comment-dots"></i></button>
            <button class="text-white text-2xl hover:text-indigo-400 transition"><i class="fas fa-share"></i></button>
        </div>
        <div class="mt-4 bg-black/50 px-4 py-2 rounded-full text-white text-xs font-bold">
            Mode Lecture Zen
        </div>
    </div>
</div>
        <!-- STRUCTURE HTML DE LA MODALE -->
<div id="post-modal-overlay" class="fixed inset-0 z-[99999] bg-black/80 backdrop-blur-sm hidden items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-900 w-full max-w-5xl h-[90vh] rounded-2xl flex flex-col md:flex-row overflow-hidden shadow-2xl relative">
        
        <!-- Gauche : Média -->
        <div id="modal-media-area" class="flex-1 bg-black flex items-center justify-center">
             <!-- Injecté par JS -->
        </div>

        <!-- Droite : Infos -->
        <div class="w-full md:w-[400px] flex flex-col border-l border-slate-100 dark:border-slate-700">
            <!-- Header -->
            <div class="p-4 border-b dark:border-slate-700 flex justify-between items-center">
                <div id="modal-user-info" class="flex items-center gap-3"></div>
                <div class="flex items-center gap-2 relative">
                    <button onclick="window.toggleModalMenu()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full text-slate-500">
                        <i class="fas fa-ellipsis-h"></i>
                    </button>
                    <div id="modal-dropdown-menu" class="post-dropdown-menu hidden absolute top-10 right-0 bg-white dark:bg-slate-800 shadow-xl rounded-lg w-48 py-1 border dark:border-slate-700 z-50"></div>
                    <button onclick="window.closePostModal()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full text-slate-500">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <!-- Corps -->
            <div id="modal-comments-container" class="flex-1 overflow-y-auto p-4"></div>
            <!-- Footer -->
            <div class="p-4 border-t dark:border-slate-700">
                <form onsubmit="window.submitModalComment(event)" class="flex gap-2">
                    <input type="text" id="modal-comment-input" placeholder="Commenter..." class="flex-1 text-sm outline-none bg-transparent">
                    <button type="submit" class="text-indigo-600 font-bold text-xs">Envoyer</button>
                </form>
            </div>
        </div>
    </div>
</div>
        <script>
// --- DÉBUT DU SCRIPT ---

// 1. Configuration Supabase (Déjà présente, gardez-la)
const SUPABASE_URL = 'https://lqqtvumwdixlhamwmqii.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxcXR2dW13ZGl4bGhhbXdtcWlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyOTQ1NjMsImV4cCI6MjA4NTg3MDU2M30.QKTBQbZ78iRVyM1o-hhtAPkWP23h_vXAMA3zrfuzipY'; // Votre clé
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            // --- STORE GLOBAL (CENTRALISÉ) ---
const AppState = {
    user: null,
    profile: null,
    blockedUsers: new Set(),
    chats: [],
    reactions: new Map(), // postId -> reactionType
    
    // Méthode pour mettre à jour et notifier (basique)
    update(key, value) {
        this[key] = value;
        // Ici vous pourriez déclencher des événements personnalisés si nécessaire
        console.log(`[AppState] Mis à jour: ${key}`);
    }
};
            
// 2. Variables Globales de gestion (CRUCIAL : Doivent être définies ici)
const userReactions = new Map(); // Stocke les réactions de l'utilisateur (postId -> type)
let chatInterval = null;
let currentTargetUserId = null;
let searchDebounceTimer = null;
let globalMessageListener = null;
let globalNotifListener = null;
let myChatIdsCache = new Set(); // Cache des IDs de chat de l'utilisateur
let chatStatusInterval = null;
            
// 3. Configuration des Réactions (Doit être accessible pour le Feed)
const REACTIONS = [
    { type: 'like', icon: 'fa-heart', color: 'text-red-500' },
    { type: 'support', icon: 'fa-hand-holding-heart', color: 'text-pink-500' },
    { type: 'curious', icon: 'fa-eye', color: 'text-blue-500' },
    { type: 'bravo', icon: 'fa-trophy', color: 'text-yellow-500' }
];

const REACTION_STYLES = {
    like: { icon: 'fa-heart', color: 'text-red-500' },
    support: { icon: 'fa-hand-holding-heart', color: 'text-pink-500' },
    curious: { icon: 'fa-eye', color: 'text-blue-500' },
    bravo: { icon: 'fa-trophy', color: 'text-yellow-500' }
};

// --- Suite du code (Variables Feed, etc.) ---
let feedOffset = 0;
const FEED_BATCH_SIZE = 10;
let isLoadingFeed = false;
let hasMorePosts = true;
let feedObserver = null;
// ... Le reste de votre code existant suit ici ...

// --- VARIABLES DU TERMINAL (Si elles n'existent pas déjà) ---
let currentStep = 1;
let options = { reliure: false, plastique: false };

// --- FONCTION MANQUANTE À AJOUTER ---
function updateControls() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    // On récupère la langue actuelle pour les textes
    const lang = localStorage.getItem('printbam-lang') || 'fr';

    // Gestion du bouton RETOUR
    if (prevBtn) {
        prevBtn.style.visibility = currentStep === 1 ? 'hidden' : 'visible';
    }

    // Gestion du bouton SUIVANT / CONFIRMER
    if (nextBtn) {
        if (currentStep === 3) {
            nextBtn.innerText = translations[lang]?.term_confirm || "Confirmer le Paiement";
        } else {
            nextBtn.innerText = translations[lang]?.term_continue || "Continuer";
        }
    }
}
            function setTheme(theme) {
    if (theme === 'dark') {
        document.documentElement.classList.add('dark');
    } else {
        document.documentElement.classList.remove('dark');
    }
}
    
        /* --- PRO FEATURES VARIABLES --- */
        let currentInvoiceData = null;

        /* --- NAVIGATION SPA --- */
        function switchPage(pageId) {
            document.querySelectorAll('.nav-link-pro').forEach(link => link.classList.remove('active'));
            const links = document.querySelectorAll(`a[onclick="switchPage('${pageId}')"]`);
            links.forEach(l => l.classList.add('active'));
            document.querySelectorAll('.page-view').forEach(view => {
                view.classList.remove('active');
                setTimeout(() => { if(!view.classList.contains('active')) view.style.display = 'none'; }, 400);
            });
            const target = document.getElementById(pageId + '-view');
            if (target) {
                target.style.display = 'block'; setTimeout(() => target.classList.add('active'), 10); window.scrollTo(0, 0);
            }
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            if (!sidebarOverlay.classList.contains('invisible')) toggleSidebar();

            // --- AJOUTEZ CECI : GESTION DU DOCK (BARRE DU BAS) ---
    const dock = document.querySelector('.mobile-dock');

    if (pageId === 'messages' || pageId === 'chat') {
        // Si on est sur Messages ou Chat, on cache le dock
        dock.classList.add('dock-hidden');
    } else {
        // Sinon (Accueil, Profil, etc.), on l'affiche
        dock.classList.remove('dock-hidden');
    }
            
            if (pageId === 'admin') {
            loadAdminArticles(); // Charge les articles
            loadAdminUsers();   // <--- AJOUTEZ CETTE LIGNE C'EST CRUCIAL
        }
            if (pageId === 'profile-social') {
            loadSocialProfile();
        }
            // Chargement Notifications
    if (pageId === 'notifications') {
        loadNotifications();
    }
             // Charger le Feed si on va sur l'accueil
    if (pageId === 'home') {
        loadGlobalFeed();
    }

    // Charger le Profil Social si on va sur le profil
    if (pageId === 'profile-social') {
        loadSocialProfile();
    }

            // --- AJOUTEZ CECI POUR LES MESSAGES ---
    if (pageId === 'messages') {
        loadChatList(); // Charge la liste des discussions (Style Photo 1)
    }
        }

        /* --- MARKETPLACE LOGIC --- */
        function filterMarket(category) {
            const items = document.querySelectorAll('.market-item');
            const btns = document.querySelectorAll('.filter-btn');
            
            btns.forEach(btn => {
                btn.classList.remove('btn-sky-yellow', 'text-white', 'shadow-md');
                btn.classList.add('bg-white', 'border', 'border-slate-200', 'text-slate-600');
            });
            
            event.target.classList.remove('bg-white', 'border', 'border-slate-200', 'text-slate-600');
            event.target.classList.add('btn-sky-yellow', 'text-white', 'shadow-md');

            items.forEach(item => {
                if (category === 'all' || item.getAttribute('data-category') === category) {
                    item.style.display = 'flex';
                    setTimeout(() => item.style.opacity = '1', 10);
                } else {
                    item.style.display = 'none';
                    item.style.opacity = '0';
                }
            });
        }

        function searchMarketplace(query) {
            const items = document.querySelectorAll('.market-item');
            const lowerQuery = query.toLowerCase();
            
            items.forEach(item => {
                const title = item.querySelector('h3').innerText.toLowerCase();
                const desc = item.querySelector('p').innerText.toLowerCase();
                
                if (title.includes(lowerQuery) || desc.includes(lowerQuery)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        /* --- TRACKING ORDER (AVEC DATE & WHATSAPP) --- */
        function openTrackModal(id, date) {
            // Store ID for invoice generation
            currentInvoiceData = orders.find(o => o.id === id);
            
            document.getElementById('track-id').innerText = id;
            document.getElementById('track-date').innerText = date;
            
            // CALCUL DE LA DATE DE LIVRAISON ESTIMÉE (+2 jours)
            try {
                // Conversion de la date FR (DD/MM/YYYY) vers ISO
                const orderDate = new Date(date.split('/').reverse().join('-')); 
                const estDate = new Date(orderDate);
                estDate.setDate(estDate.getDate() + 2); 
                
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('estimated-delivery-date').innerText = estDate.toLocaleDateString('fr-FR', options);
                
                // Mise à jour visuelle de la timeline
                document.getElementById('est-date-label').innerText = estDate.toLocaleDateString('fr-FR');
            } catch (e) {
                document.getElementById('estimated-delivery-date').innerText = "En attente de confirmation";
            }

            const modal = document.getElementById('track-modal');
            const bg = modal.querySelector('div:first-child');
            const panel = modal.querySelector('div:last-child');
            
            modal.classList.remove('invisible');
            setTimeout(() => {
                bg.classList.replace('opacity-0', 'opacity-100');
                panel.classList.replace('translate-x-full', 'translate-x-0');
            }, 10);
        }

        function closeTrackModal() {
            const modal = document.getElementById('track-modal');
            const bg = modal.querySelector('div:first-child');
            const panel = modal.querySelector('div:last-child');
            
            bg.classList.replace('opacity-100', 'opacity-0');
            panel.classList.replace('translate-x-0', 'translate-x-full');
            setTimeout(() => { modal.classList.add('invisible'); }, 500);
        }

        /* --- WHATSAPP INTEGRATION --- */
        function shareOrderOnWhatsApp() {
            // Numéro commercial par défaut
            const supportPhone = "243810000000"; 
            
            const orderId = document.getElementById('track-id').innerText;
            const clientName = currentInvoiceData ? currentInvoiceData.item : "Client";
            
            const message = `Bonjour Printbam,%0A%0AJe suis le client "${clientName}" concernant la commande *#${orderId}*.%0A%0APourriez-vous me donner des news sur l'avancement ?%0AMerci.`;
            
            const url = `https://wa.me/${supportPhone}?text=${message}`;
            window.open(url, '_blank');
        }

        /* --- INVOICE GENERATION --- */
        function openInvoice() {
            if(!currentInvoiceData) return;
            document.getElementById('inv-id').innerText = currentInvoiceData.id;
            document.getElementById('inv-date').innerText = currentInvoiceData.date;
            
            const detailStr = currentInvoiceData.details;
            let itemsHtml = '';
            let unitPrice = Math.round(currentInvoiceData.amount / 2); 
            
            itemsHtml += `<tr><td class="font-bold">${detailStr}</td><td class="text-center">1</td><td class="text-right">${unitPrice} FC</td><td class="text-right font-bold">${currentInvoiceData.amount} FC</td></tr>`;
            
            document.getElementById('inv-items').innerHTML = itemsHtml;
            document.getElementById('inv-total').innerText = currentInvoiceData.amount.toLocaleString() + " FC";
            
            const modal = document.getElementById('invoice-modal');
            modal.classList.add('active');
        }

        function closeInvoice() {
            document.getElementById('invoice-modal').classList.remove('active');
        }

        /* --- INPUT MASKING --- */
        function formatPhone(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 0 && !value.startsWith('243')) value = '243' + value;
            if (value.length > 12) value = value.substring(0, 12);
            
            let formatted = '';
            if (value.length > 0) formatted = '+' + value.substring(0, 3);
            if (value.length > 3) formatted += ' ' + value.substring(3, 6);
            if (value.length > 6) formatted += ' ' + value.substring(6, 9);
            if (value.length > 9) formatted += ' ' + value.substring(9, 12);
            
            input.value = formatted;
        }

        /* --- TERMINAL --- */
       function openTerminal() {
            const term = document.getElementById('terminal-wrapper');
            if (!term) return;
        
            // 1. On affiche et on débloque les interactions
            term.style.display = 'block';
            term.removeAttribute('inert'); 
            term.setAttribute('aria-hidden', 'false');
        
            // 2. On bloque le scroll du site derrière
            document.body.style.overflow = 'hidden';
        
            // 3. Sécurité : on force le focus sur le bouton de fermeture
            setTimeout(() => {
                const closeBtn = document.getElementById('close-terminal-btn');
                if (closeBtn) closeBtn.focus();
            }, 100);
        }
        
        function closeTerminal() {
            const term = document.getElementById('terminal-wrapper');
            if (!term) return;
        
            // 1. On cache et on verrouille
            term.style.display = 'none';
            term.setAttribute('inert', '');
            term.setAttribute('aria-hidden', 'true');
        
            // 2. On rend le scroll au site
            document.body.style.overflow = 'auto';
        
            // 3. On nettoie le focus pour éviter l'erreur console
            if (document.activeElement) document.activeElement.blur();
        }
        /* --- TRANSLATIONS --- */
        const translations = {
            fr: {
                nav_navigation: "Navigation", nav_home: "Accueil", nav_market: "Marketplace", nav_services: "Services", nav_account: "Compte", nav_orders: "Mes Commandes", nav_settings: "Paramètres", nav_help: "Aide", nav_login: "Connexion", btn_start: "Démarrer",
                hero_title_part1: "L'infrastructure", hero_title_part2: "documentaire", hero_title_highlight: "haute performance.", hero_desc: "Digitalisez vos flux, nous matérialisons l'excellence avec une", btn_print_now: "Imprimer maintenant", btn_demo: "Voir la démo", nav_about: "À propos",
                feat_arch_title: "Architecture Documentaire", feat_arch_desc: "Traitement architectural de vos documents. Précision au millimètre pour vos manuscrits exigeants et mémoires académiques.", feat_delivery: "Livraison Express", feat_badge_title: "Badges PVC", feat_badge_desc: "Cartes de service haute définition avec protection thermique et codage magnétique.", feat_cloud_title: "Infrastructure Cloud", feat_cloud_desc: "Envoyez vos fichiers de n'importe où. Notre réseau sécurisé s'occupe du traitement et de l'impression.",
                portfolio_title: "Standards d'Excellence.", card1_cat: "Rapports", card1_title: "Rapports Institutionnels", card1_desc: "Papier couché 120g avec reliure thermique invisible pour une finition premium.", card2_cat: "Identité Visuelle", card2_title: "Cartes de Membre", card2_desc: "Impression sublimation haute résistance avec hologramme de sécurité personnalisé.", card3_cat: "Technique", card3_title: "Plans & Blueprints", card3_desc: "Traçage grand format A0/A1 haute précision sur papier technique translucide.",
                cta_title: "Prêt pour l'impression ?", btn_launch_order: "Lancer une commande", footer_about: "L'infrastructure d'impression cloud leader en Afrique centrale. Fiabilité, rapidité et sécurité pour vos documents.", footer_services: "Services", footer_company: "Entreprise", footer_contact: "Contact", settings_profile: "Votre Profil", settings_notifs: "Notifications push", settings_lang: "Langue", settings_save: "Sauvegarder", btn_send: "Envoyer",
                market_desc: "Découvrez nos packs pré-configurés pour vos besoins professionnels et académiques. Une qualité constante, une livraison rapide.", mkt_item1_title: "Pack Mémoire Standard", mkt_item1_desc: "Impression N&B + Reliure Spirale + 2 Exemplaires.", mkt_item2_title: "Pack Badges Pro", mkt_item2_desc: "50 Cartes PVC recto-verso avec personnalisation.", mkt_item3_title: "Kit Communication", mkt_item3_desc: "100 Affiches A3 + 500 Flyers A5.", mkt_item4_title: "Personnalisation", mkt_item4_desc: "T-shirts, Mugs et Objets publicitaires.",
                services_title: "Services & Tarifs", services_desc: "Une tarification transparente et compétitive pour tous vos projets d'impression.", srv_pricing: "Grille Tarifaire (Prix unitaire)", srv_format: "Format", srv_bw: "Noir & Blanc", srv_color: "Couleur", srv_premium: "Premium", srv_binding: "Reliure", srv_binding_desc: "Spirale métallique, Thermocollée ou Cannelée.", srv_laminate: "Plastification", srv_laminate_desc: "Protection matte ou brillante.", srv_cut: "Découpe & Massicot", srv_cut_desc: "Découpe précise au millimètre.",
                term_config: "1. Config", term_send: "2. Envoi", term_pay: "3. Pay", term_config_title: "Configuration", term_upload_placeholder: "Cliquez ou glissez votre document ici", term_doc_detected: "Document détecté", term_format: "Format", term_color: "Couleur", term_bw: "Noir & Blanc", term_color_hd: "Couleur HD", term_finish: "Finition & Protection", term_binding: "Reliure", term_laminate: "Plastifier", term_pages: "Pages", term_copies: "Exemplaires", term_type: "Type", term_recto: "Recto Seul", term_recto_verso: "Recto / Verso", term_dest_title: "Destination", term_ph_name: "Nom complet", term_ph_phone: "WhatsApp (ex: +243...)", term_ph_addr: "Adresse complète de livraison", term_payment: "Paiement", term_total: "Total Commande", term_currency: "FC", term_printing: "Impression", term_finishes: "Finitions", term_back: "Retour", term_continue: "Continuer", term_confirm: "Confirmer le Paiement", term_uploading: "Envoi sécurisé...", term_confirmed: "Confirmé !", term_redirect: "Redirection vers l'accueil..."
            },
            en: {
                nav_navigation: "Navigation", nav_home: "Home", nav_market: "Marketplace", nav_services: "Services", nav_account: "Account", nav_orders: "My Orders", nav_settings: "Settings", nav_help: "Help", nav_login: "Login", btn_start: "Get Started",
                hero_title_part1: "The high-performance", hero_title_part2: "document", hero_title_highlight: "infrastructure.", hero_desc: "Digitize your workflows, we materialize excellence with", btn_print_now: "Print Now", btn_demo: "View Demo",
                feat_arch_title: "Document Architecture", feat_arch_desc: "Architectural processing of your documents. Millimeter precision for demanding manuscripts and academic theses.", feat_delivery: "Express Delivery", feat_badge_title: "PVC Badges", feat_badge_desc: "High definition service cards with thermal protection and magnetic coding.", feat_cloud_title: "Cloud Infrastructure", feat_cloud_desc: "Send files from anywhere. Our secure network takes care of processing and printing.",
                portfolio_title: "Standards of Excellence.", card1_cat: "Reports", card1_title: "Institutional Reports", card1_desc: "120g coated paper with invisible thermal binding for a premium finish.", card2_cat: "Visual Identity", card2_title: "Membership Cards", card2_desc: "High resistance sublimation printing with personalized security hologram.", card3_cat: "Technical", card3_title: "Plans & Blueprints", card3_desc: "Large format A0/A1 high precision tracing on translucent technical paper.",
                cta_title: "Ready to print?", btn_launch_order: "Launch an Order", footer_about: "The leading cloud printing infrastructure in Central Africa. Reliability, speed and security for your documents.", footer_services: "Services", footer_company: "Company", footer_contact: "Contact", settings_profile: "Your Profile", settings_notifs: "Push Notifications", settings_lang: "Language", settings_save: "Save", btn_send: "Send", nav_about: "About", 
                market_desc: "Discover our pre-configured packs for your professional and academic needs. Constant quality, rapid delivery.", mkt_item1_title: "Standard Thesis Pack", mkt_item1_desc: "B&W Printing + Spiral Binding + 2 Copies.", mkt_item2_title: "Pro Badges Pack", mkt_item2_desc: "50 Double-sided PVC cards with customization.", mkt_item3_title: "Communication Kit", mkt_item3_desc: "100 A3 Posters + 500 A5 Flyers.", mkt_item4_title: "Customization", mkt_item4_desc: "T-shirts, Mugs and Promotional items.",
                services_title: "Services & Pricing", services_desc: "Transparent and competitive pricing for all your printing projects.", srv_pricing: "Price Grid (Unit Price)", srv_format: "Format", srv_bw: "Black & White", srv_color: "Color", srv_premium: "Premium", srv_binding: "Binding", srv_binding_desc: "Metal spiral, Thermal or Canneled binding.", srv_laminate: "Lamination", srv_laminate_desc: "Matte or Glossy protection.", srv_cut: "Cutting & Guillotine", srv_cut_desc: "Precise cutting to millimeter.",
                term_config: "1. Config", term_send: "2. Send", term_pay: "3. Pay", term_config_title: "Configuration", term_upload_placeholder: "Click or drag your document here", term_doc_detected: "Document Detected", term_format: "Format", term_color: "Color", term_bw: "Black & White", term_color_hd: "Color HD", term_finish: "Finish & Protection", term_binding: "Binding", term_laminate: "Laminate", term_pages: "Pages", term_copies: "Copies", term_type: "Type", term_recto: "Single Sided", term_recto_verso: "Double Sided", term_dest_title: "Destination", term_ph_name: "Full Name", term_ph_phone: "WhatsApp (ex: +243...)", term_ph_addr: "Full Delivery Address", term_payment: "Payment", term_total: "Total Order", term_currency: "FC", term_printing: "Printing", term_finishes: "Finishes", term_back: "Back", term_continue: "Continue", term_confirm: "Confirm Payment", term_uploading: "Secure upload...", term_confirmed: "Confirmed!", term_redirect: "Redirecting to home..."
            },
            ln: { nav_navigation: "Boluki", nav_home: "Esika", nav_market: "Bisika", nav_services: "Misala", nav_account: "Bokomi", nav_orders: "Mikanda", nav_about: "Na ntina na biso", nav_settings: "Ndimi", nav_help: "Lisungi", nav_login: "Kokota", btn_start: "Yuka", hero_title_part1: "Bokoli ya", hero_title_part2: "bukundu", hero_title_highlight: "ya makasi.", hero_desc: "Botia bisusu na nzela ya électronique, biso tokobi kobimisa eloko ya makasi na", btn_print_now: "Kobima Sika", btn_demo: "Tala", feat_arch_title: "Bokoli ya Mbete", feat_arch_desc: "Botia ya mbete ya mikanda na yo.", feat_delivery: "Komesa Mbote", feat_badge_title: "Ba Badge PVC", feat_badge_desc: "Ba carte ya service.", feat_cloud_title: "Sistème ya Cloud", feat_cloud_desc: "Tinda ba fichier awa.", portfolio_title: "Ndimi ya Makasi.", cta_title: "Oyo ozali kokoba ?", btn_launch_order: "Sima Commande", term_config: "1. Config", term_send: "2. Tinda", term_pay: "3. Kobimisa", term_config_title: "Configuration", term_upload_placeholder: "Kokota kobimisa buku na awa", term_doc_detected: "Buku ekomi", term_format: "Format", term_color: "Couleur", term_bw: "Noir & Blanc", term_color_hd: "Couleur HD", term_finish: "Mikongo & Protection", term_binding: "Reliure", term_laminate: "Plastifier", term_pages: "Pages", term_copies: "Exemplaires", term_type: "Type", term_recto: "Recto Seul", term_recto_verso: "Recto / Verso", term_dest_title: "Destination", term_ph_name: "Nkombo mobimba", term_ph_phone: "WhatsApp", term_ph_addr: "Adrese", term_payment: "Kobimisa", term_total: "Total Commande", term_currency: "FC", term_printing: "Kobima", term_finishes: "Mikongo", term_back: "Kozwa", term_continue: "Kosukola", term_confirm: "Kobimisa", term_uploading: "Tinda...", term_confirmed: "Confirmé !", term_redirect: "Kozwa...", market_desc: "Bolia ba packs...", services_title: "Services & Tarifs", services_desc: "Prix transparente...", srv_pricing: "Grille Tarifaire", srv_format: "Format", srv_bw: "Noir & Blanc", srv_color: "Couleur", srv_premium: "Premium", srv_binding: "Reliure", srv_binding_desc: "Spirale, etc...", srv_laminate: "Plastification", srv_laminate_desc: "Protection...", srv_cut: "Découpe", srv_cut_desc: "Découpe...", mkt_item1_title: "Pack Mémoire", mkt_item1_desc: "Kobima + Reliure...", mkt_item2_title: "Pack Badges", mkt_item2_desc: "50 Cartes...", mkt_item3_title: "Kit Comm", mkt_item3_desc: "Affiches...", mkt_item4_title: "Perso", mkt_item4_desc: "T-shirts...", nav_orders: "Mikanda", nav_settings: "Ndimi", nav_help: "Aide", settings_lang: "Lokota", settings_save: "Tia", btn_send: "Tinda", settings_profile: "Lingomba na yo", settings_notifs: "Notifications", footer_about: "Bokoli...", footer_services: "Misala", footer_company: "Kompani", footer_contact: "Komisa" },
            tu: { nav_navigation: "Buvui", nav_about: "Bidi bitangila benu", nav_home: "Kadi", nav_market: "Kabuadi", nav_services: "Miyila", nav_account: "Ditumbu", nav_orders: "Babui", nav_settings: "Mwididi", nav_help: "Lubulayi", nav_login: "Kuluka", btn_start: "Yuka", term_config: "1. Config", term_send: "2. Tuma", term_pay: "3. Dija", term_config_title: "Configuration", term_upload_placeholder: "Kokota tuma buku na awa", term_doc_detected: "Buku dijwidi", term_format: "Format", term_color: "Couleur", term_bw: "Noir & Blanc", term_color_hd: "Couleur HD", term_finish: "Midi & Dija", term_binding: "Reliure", term_laminate: "Lamina", term_pages: "Makon", term_copies: "Kadisadi", term_type: "Mutundu", term_recto: "Tshitshi", term_recto_verso: "Tshitshi / Mutundu", term_dest_title: "Muadi", term_ph_name: "Dina mobimba", term_ph_phone: "WhatsApp", term_ph_addr: "Adrese", term_payment: "Kulipa", term_total: "Total Commande", term_currency: "FC", term_printing: "Kubaja", term_finishes: "Midi", term_back: "Kubajikula", term_continue: "Kosuka", term_confirm: "Kulipa", term_uploading: "Kutuma...", term_confirmed: "Bwakaji !", term_redirect: "Kujikula...", hero_title_part1: "Buvui ya", hero_title_part2: "mutundu", hero_title_highlight: "wa bule.", hero_desc: "Dija masalu a eletronique, twa ku buka butashi wa bule na", btn_print_now: "Bubaja Ubu", btn_demo: "Laja", portfolio_title: "Ndimi wa Bule.", cta_title: "Waba udi bubaja ?", btn_launch_order: "Simula Babui", term_config_title: "Configuration", term_upload_placeholder: "Kokota tuma buku na awa", term_doc_detected: "Buku dijwidi", term_format: "Format", term_color: "Couleur", term_bw: "Noir & Blanc", term_color_hd: "Couleur HD", term_finish: "Midi & Dija", term_binding: "Reliure", term_laminate: "Lamina", term_pages: "Makon", term_copies: "Kadisadi", term_type: "Mutundu", term_recto: "Tshitshi", term_recto_verso: "Tshitshi / Mutundu", term_dest_title: "Muadi", term_ph_name: "Dina mobimba", term_ph_phone: "WhatsApp", term_ph_addr: "Adrese", term_payment: "Kulipa", term_total: "Total Commande", term_currency: "FC", term_printing: "Kubaja", term_finishes: "Midi", term_back: "Kubajikula", term_continue: "Kosuka", term_confirm: "Kulipa", term_uploading: "Kutuma...", term_confirmed: "Bwakaji !", term_redirect: "Kujikula..." },
            sw: { nav_navigation: "Miondoko", nav_home: "Nyumbani", nav_about: "Kuhusu sisi", nav_market: "Soko", nav_services: "Huduma", nav_account: "Akaunti", nav_orders: "Oda", nav_settings: "Mipangilio", nav_help: "Msaada", nav_login: "Ingia", btn_start: "Anza", term_config: "1. Config", term_send: "2. Tuma", term_pay: "3. Lipia", term_config_title: "Mipangilio", term_upload_placeholder: "Bofya au paka faili hapa", term_doc_detected: "Faili Imeibainwa", term_format: "Ukubwa", term_color: "Rangi", term_bw: "Nyeusi & Njivu", term_color_hd: "Rangi HD", term_finish: "Maliza & Kinga", term_binding: "Uunganishaji", term_laminate: "Lamine", term_pages: "Ukurasa", term_copies: "Nakala", term_type: "Aina", term_recto: "Upande Mmoja", term_recto_verso: "Upande Wote", term_dest_title: "Mahali", term_ph_name: "Jina Kamili", term_ph_phone: "WhatsApp", term_ph_addr: "Anwani ya Kupokelea", term_payment: "Lipa", term_total: "Jumla ya Oda", term_currency: "FC", term_printing: "Uchapishaji", term_finishes: "Mikwabo", term_back: "Nyuma", term_continue: "Endelea", term_confirm: "Thibitisha Lipa", term_uploading: "Kutuma salama...", term_confirmed: "Imethibitishwa!", term_redirect: "Kurudi nyumbani...", hero_title_part1: "Miundombinu ya", hero_title_part2: "waraka", hero_title_highlight: "ya nguvu.", hero_desc: "Badilisha mtiririko wako, sisi tunato ubora wa", btn_print_now: "Chapisha Sasa", btn_demo: "Tazama Demo", portfolio_title: "Vigezo vya Ubora.", cta_title: "Uko tayari kuchapisha?", btn_launch_order: "Anza Oda", term_config_title: "Mipangilio", term_upload_placeholder: "Bofya au paka faili hapa", term_doc_detected: "Faili Imeibainwa", term_format: "Ukubwa", term_color: "Rangi", term_bw: "Nyeusi & Njivu", term_color_hd: "Rangi HD", term_finish: "Maliza & Kinga", term_binding: "Uunganishaji", term_laminate: "Lamine", term_pages: "Ukurasa", term_copies: "Nakala", term_type: "Aina", term_recto: "Upande Mmoja", term_recto_verso: "Upande Wote", term_dest_title: "Mahali", term_ph_name: "Jina Kamili", term_ph_phone: "WhatsApp", term_ph_addr: "Anwani ya Kupokelea", term_payment: "Lipa", term_total: "Jumla ya Oda", term_currency: "FC", term_printing: "Uchapishaji", term_finishes: "Mikwabo", term_back: "Nyuma", term_continue: "Endelea", term_confirm: "Thibitisha Lipa", term_uploading: "Kutuma salama...", term_confirmed: "Imethibitishwa!", term_redirect: "Kurudi nyumbani..." },
            kg: { nav_navigation: "Zina", nav_home: "Mboka", nav_market: "Mpemba", nav_services: "Nsadila", nav_account: "Ntangu", nav_orders: "Bisalu", nav_settings: "Nkidila", nav_help: "Lusadisu", nav_login: "Vata", btn_start: "Yuka", term_config: "1. Config", term_send: "2. Tuma", term_pay: "3. Lipa", term_config_title: "Configuration", term_upload_placeholder: "Kokota tuma buku na awa", term_doc_detected: "Buku dijwidi", term_format: "Format", term_color: "Couleur", term_bw: "Noir & Blanc", term_color_hd: "Couleur HD", term_finish: "Kusala & Kinga", term_binding: "Reliure", term_laminate: "Lamina", term_pages: "Makon", term_copies: "Kadisadi", term_type: "Aina", term_recto: "Tshitshi", term_recto_verso: "Tshitshi / Mutundu", term_dest_title: "Muadi", term_ph_name: "Dina mobimba", term_ph_phone: "WhatsApp", term_ph_addr: "Adrese", term_payment: "Lipa", term_total: "Total Commande", term_currency: "FC", term_printing: "Kubaja", term_finishes: "Midi", term_back: "Kubajikula", term_continue: "Kosuka", term_confirm: "Kulipa", term_uploading: "Kutuma...", term_confirmed: "Bwakaji !", term_redirect: "Kujikula...", hero_title_part1: "Bukundu wa", hero_title_part2: "nkandu", hero_title_highlight: "wa nene.", hero_desc: "Tia zina a eletronique, biso twa ku kanga mpete wa nene na", btn_print_now: "Buka Mboka", btn_demo: "Vata", portfolio_title: "Nkidila wa Nene.", cta_title: "Yaka udi buka ?", btn_launch_order: "Yuka Bisalu", term_config_title: "Configuration", term_upload_placeholder: "Kokota tuma buku na awa", term_doc_detected: "Buku dijwidi", term_format: "Format", term_color: "Couleur", term_bw: "Noir & Blanc", term_color_hd: "Couleur HD", term_finish: "Kusala & Kinga", term_binding: "Reliure", term_laminate: "Lamina", term_pages: "Makon", term_copies: "Kadisadi", term_type: "Aina", term_recto: "Tshitshi", term_recto_verso: "Tshitshi / Mutundu", term_dest_title: "Muadi", term_ph_name: "Dina mobimba", term_ph_phone: "WhatsApp", term_ph_addr: "Adrese", term_payment: "Lipa", term_total: "Total Commande", term_currency: "FC", term_printing: "Kubaja", term_finishes: "Midi", term_back: "Kubajikula", term_continue: "Kosuka", term_confirm: "Kulipa", term_uploading: "Kutuma...", term_confirmed: "Bwakaji !", term_redirect: "Kujikula..." }
        };

        // Initialisation de l'observateur au chargement de la page
function setupInfiniteScroll() {
    const loader = document.getElementById('feed-loader');
    
    // Si un observateur existe déjà, on le déconnecte
    if (feedObserver) {
        feedObserver.disconnect();
    }

    if (loader) {
        // Création de l'observateur
        feedObserver = new IntersectionObserver((entries) => {
            // Si le loader est visible dans l'écran
            if (entries[0].isIntersecting) {
                loadMoreFeed();
            }
        }, {
            rootMargin: '300px' // Déclenche 200px avant le vrai bas de page
        });

        feedObserver.observe(loader);
    }
}
        function changeLanguage(lang) {
            localStorage.setItem('printbam-lang', lang);
            updateLanguage(lang);
            const langNames = { 'fr': 'Français', 'en': 'English', 'ln': 'Lingala', 'tu': 'Tshiluba', 'sw': 'Swahili', 'kg': 'Kikongo' };
            showToast(`Langue : ${langNames[lang]}`, 'success');
        }

        function updateLanguage(lang) {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) el.textContent = translations[lang][key];
            });
            document.querySelectorAll('[data-placeholder]').forEach(el => {
                const key = el.getAttribute('data-placeholder');
                if (translations[lang] && translations[lang][key]) el.placeholder = translations[lang][key];
            });
            const terminalWrapper = document.getElementById('terminal-wrapper');
            if(terminalWrapper) {
                terminalWrapper.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (translations[lang] && translations[lang][key]) el.textContent = translations[lang][key];
                });
                const btnRV = document.getElementById('btnRV');
                if(btnRV) {
                     const isV = document.getElementById('rectoVerso').value === "true";
                     btnRV.innerText = isV ? (translations[lang]?.term_recto_verso || "Recto / Verso") : (translations[lang]?.term_recto || "Recto Seul");
                }
                updateControls();
            }
            if (translations[lang] && translations[lang].typewriter_words) window.currentWords = translations[lang].typewriter_words;
        }

        function setTheme(theme, save = true) {
            const btnLight = document.getElementById('btn-light');
            const btnDark = document.getElementById('btn-dark');
            const body = document.body;
            if (theme === 'dark') {
                body.classList.add('dark-mode');
                if(btnDark) { btnDark.classList.remove('text-slate-500', 'bg-transparent'); btnDark.classList.add('bg-white', 'text-slate-800', 'shadow-sm'); }
                if(btnLight) { btnLight.classList.add('text-slate-500', 'bg-transparent'); btnLight.classList.remove('bg-white', 'text-slate-800', 'shadow-sm'); }
            } else {
                body.classList.remove('dark-mode');
                if(btnLight) { btnLight.classList.remove('text-slate-500', 'bg-transparent'); btnLight.classList.add('bg-white', 'text-slate-800', 'shadow-sm'); }
                if(btnDark) { btnDark.classList.add('text-slate-500', 'bg-transparent'); btnDark.classList.remove('bg-white', 'text-slate-800', 'shadow-sm'); }
            }
            if (save) localStorage.setItem('printbam-theme', theme);
        }

        function toggleSidebar() {
            const mainContent = document.getElementById('main-content'); const panel = document.getElementById('sidebar-panel'); const overlay = document.getElementById('sidebar-overlay'); const bg = document.getElementById('sidebar-bg'); const dock = document.querySelector('.mobile-dock'); const isOpen = !overlay.classList.contains('invisible');
            if (!isOpen) {
                overlay.classList.remove('invisible');
                setTimeout(() => { bg.classList.replace('opacity-0', 'opacity-100'); panel.classList.replace('-translate-x-full', 'translate-x-0'); panel.classList.replace('opacity-0', 'opacity-100'); }, 10);
                // --- NOUVEAU CODE ---
if(mainContent) { 
    // On retire 'transform' pour que 'position: sticky' fonctionne !
    // mainContent.style.transform = 'translateX(280px) scale(0.95)'; // <-- Supprimez ou commentezz ceci
    
    mainContent.style.filter = 'blur(2px) brightness(0.9)'; 
    mainContent.style.pointerEvents = 'none'; // Important : empêche de cliquer sur le contenu flouté
}
                if(dock) dock.style.setProperty('display', 'none', 'important');
            } else {
                bg.classList.replace('opacity-100', 'opacity-0'); panel.classList.replace('translate-x-0', '-translate-x-full'); panel.classList.replace('opacity-100', 'opacity-0');
                if(mainContent) { mainContent.style.transform = ''; mainContent.style.filter = ''; mainContent.style.borderRadius = ''; mainContent.style.pointerEvents = 'auto'; }
                if(dock) dock.style.removeProperty('display');
                setTimeout(() => { overlay.classList.add('invisible'); }, 500);
            }
        }
        function genericToggle(overlayId, panelId, bgClass) {
            const overlay = document.getElementById(overlayId); const panel = document.getElementById(panelId); const bg = overlay.querySelector(bgClass);
            if (overlay.classList.contains('invisible')) {
                overlay.classList.remove('invisible');
                setTimeout(() => { bg.classList.replace('opacity-0', 'opacity-100'); panel.classList.replace('translate-x-full', 'translate-x-0'); }, 10);
            } else {
                bg.classList.replace('opacity-100', 'opacity-0'); panel.classList.replace('translate-x-0', 'translate-x-full');
                setTimeout(() => overlay.classList.add('invisible'), 500);
            }
        }
        function toggleSettings() { genericToggle('settings-overlay', 'settings-panel', 'div:first-child'); updateStats(); } 
        function toggleSupport() { genericToggle('support-overlay', 'support-panel', 'div:first-child'); }
        function toggleOrders() { renderOrders(); genericToggle('orders-overlay', 'orders-panel', 'div:first-child'); }
        function toggleAbout() {
            genericToggle('about-overlay', 'about-panel', 'div:first-child');
        }
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container'); const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            let icon = type === 'success' ? 'fa-check-circle text-green-500' : 'fa-exclamation-circle text-red-500';
            toast.innerHTML = `<div class="flex items-center gap-3"><i class="fas ${icon} text-lg"></i><span class="font-medium text-slate-700">${message}</span></div><button onclick="this.parentElement.remove()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.animation = 'slideOut 0.3s forwards'; setTimeout(() => toast.remove(), 300); }, 4000);
        }

        window.currentWords = window.currentWords || ["précision chirurgicale.", "vitesse absolue.", "sécurité bancaire.", "design élégant."];
        const typeTarget = document.getElementById('typewriter');
        if (typeTarget) {
            let wordIndex = 0, charIndex = 0, deleting = false;
            function typeLoop() {
                const words = window.currentWords; const word = words[wordIndex];
                typeTarget.textContent = deleting ? word.substring(0, --charIndex) : word.substring(0, ++charIndex);
                let delay = deleting ? 50 : 100;
                if (!deleting && charIndex === word.length) { deleting = true; delay = 2000; }
                if (deleting && charIndex === 0) { deleting = false; wordIndex = (wordIndex + 1) % words.length; delay = 500; }
                setTimeout(typeLoop, delay);
            }
            typeLoop();
        }

        function initScrollReveal() {
            const observer = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting) entry.target.classList.add('active'); }); }, { threshold: 0.1 });
            document.querySelectorAll('.reveal-up').forEach(el => observer.observe(el));
        }

        window.addEventListener('scroll', () => {
            const current = window.scrollY; const nav = document.getElementById('nav-main'); const mobileHeader = document.getElementById('mobile-header');
            if (nav) {
                if(current > 20) { nav.classList.add('py-3'); nav.classList.remove('py-6'); nav.style.boxShadow = "0 10px 15px -3px rgba(0,0,0,0.1)"; }
                else { nav.classList.remove('py-3'); nav.classList.add('py-6'); nav.style.boxShadow = "var(--shadow-soft)"; }
            }
            if(mobileHeader) { if(current > 20) mobileHeader.classList.add('header-scrolled'); else mobileHeader.classList.remove('header-scrolled'); }
        });

        const bgGrid = document.getElementById('parallax-bg');
        if(bgGrid) {
            window.addEventListener('mousemove', e => {
                const moveX = (e.clientX - window.innerWidth / 2) * 0.01;
                const moveY = (e.clientY - window.innerHeight / 2) * 0.01;
                bgGrid.style.transform = `translate(${moveX}px, ${moveY}px)`;
            });
        }

        let orders = JSON.parse(localStorage.getItem('printbam_orders')) || [];
        function saveNewOrder(docName, price) {
            const newOrder = { id: 'PB-' + Math.floor(Math.random() * 9000 + 1000), date: new Date().toLocaleDateString('fr-FR'), item: docName, amount: price, status: 'En cours' };
            orders.unshift(newOrder); localStorage.setItem('printbam_orders', JSON.stringify(orders));
        }
        function renderOrders() {
            const list = document.getElementById('orders-list'); const totalDisplay = document.getElementById('total-spent');
            if (orders.length === 0) { list.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-center space-y-4 opacity-40 pt-10"><i class="fas fa-box-open text-4xl text-slate-800"></i><p class="text-xs font-bold uppercase tracking-widest text-slate-800">Aucune commande</p></div>`; totalDisplay.innerText = "0 FC"; return; }
            list.innerHTML = ''; let total = 0;
            orders.forEach((order, index) => {
                total += order.amount;
                list.innerHTML += `
                    <div class="glass p-4 flex items-center justify-between group hover:border-indigo-200 transition-all cursor-pointer" onclick="openTrackModal('${order.id}', '${order.date}')" style="animation: slideIn 0.3s ease ${index * 0.1}s forwards; opacity: 0; transform: translateY(10px);">
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] font-black text-indigo-600 uppercase">${order.id}</span>
                            <span class="text-sm font-bold text-slate-900">${order.item}</span>
                            <span class="text-[10px] text-slate-400">${order.date}</span>
                        </div>
                        <div class="flex flex-col items-end gap-2">
                            <span class="text-sm font-black text-slate-900">${order.amount.toLocaleString()} FC</span>
                            <span class="px-2 py-0.5 rounded-md bg-indigo-50 text-indigo-700 text-[8px] font-bold uppercase tracking-tighter border border-indigo-100">${order.status}</span>
                        </div>
                    </div>`;
            });
            totalDisplay.innerText = total.toLocaleString() + " FC";
        }
        
        function updateStats() {
            const countDisplay = document.getElementById('stats-orders-count');
            const spentDisplay = document.getElementById('stats-total-spent');
            
            if(countDisplay) countDisplay.innerText = orders.length;
            
            let total = 0;
            orders.forEach(o => total += o.amount);
            if(spentDisplay) spentDisplay.innerText = total.toLocaleString('fr-FR');
        }

        let clearStep = 0;
        function confirmClearHistory() {
            const btn = document.getElementById('btn-clear-history');
            if (clearStep === 0) { clearStep = 1; btn.innerText = "Confirmer ?"; btn.classList.add('bg-red-50', 'border-red-200'); setTimeout(() => { if(clearStep === 1) resetClearBtn(); }, 3000); }
            else { orders = []; localStorage.removeItem('printbam_orders'); renderOrders(); showToast('Historique vidé', 'success'); resetClearBtn(); }
        }
        function resetClearBtn() {
            const btn = document.getElementById('btn-clear-history'); clearStep = 0;
            btn.innerText = "Vider l'historique"; btn.classList.remove('bg-red-50', 'border-red-200');
        }
        function handleSupportSubmit(event) {
            event.preventDefault(); const btn = document.getElementById('btn-send-support'); const form = document.getElementById('support-form'); const successMsg = document.getElementById('support-success');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-circle-notch animate-spin"></i> <span>Transmission...</span>';
            setTimeout(() => { form.classList.add('hidden'); successMsg.classList.remove('hidden'); form.reset(); btn.disabled = false; btn.innerHTML = '<span data-i18n="btn_send">Envoyer</span><i class="fas fa-paper-plane text-[10px]"></i>'; showToast("Message envoyé au support !", "success"); }, 1500);
        }

       /* --- GESTION DU PROFIL UTILISATEUR (AVEC SUPABASE) --- */

// Fonction pour ouvrir/fermer le panneau
async function toggleProfile() {
    // Vérification de sécurité via Supabase Auth
    const isConnected = await checkAuth();
    if (!isConnected) return;
    
    genericToggle('profile-overlay', 'profile-panel', 'div:first-child');
    
    // Charger les données si on ouvre le panneau
    const overlay = document.getElementById('profile-overlay');
    if (!overlay.classList.contains('invisible')) {
        await loadUserProfile();
    }
}

// Vérifie si l'utilisateur est connecté via Supabase
async function checkAuth() {
    const { data: { user }, error } = await supabaseClient.auth.getUser();
    
    if (error || !user) {
        showToast("Veuillez vous connecter pour accéder à cette page.", "error");
        setTimeout(() => { window.location.href = "login.html"; }, 1000);
        return false;
    }
    return true;
}

// Charger les infos du profil depuis Supabase
async function loadUserProfile() {
    try {
        // 1. Récupérer l'utilisateur connecté depuis la session
        const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
        
        if (authError || !user) {
            console.log("Utilisateur non connecté");
            return;
        }
        checkAdminStatus();

        // 2. Récupérer les données de la table 'profiles'
        // On utilise 'profile' comme nom de variable pour correspondre à votre suite de code
        const { data: profile, error } = await supabaseClient
            .from('profiles')
            .select('*')
            .eq('id', user.id) // CORRECTION : On utilise user.id ici
            .maybeSingle(); 

        if (error) {
            console.error("Erreur lors de la récupération :", error.message);
            return;
        }

        // 3. Mise à jour de l'interface (DOM)
        if (profile) {
            console.log("Profil trouvé :", profile);
            
            // Remplissage des champs (avec repli sur les métadonnées si profil incomplet)
            if (document.getElementById('p-name'))
                document.getElementById('p-name').value = profile.full_name || user.user_metadata.full_name || '';
            
            if (document.getElementById('p-email'))
                document.getElementById('p-email').value = user.email || '';
            
            if (document.getElementById('p-phone')) // Remplacez 'else if' par 'if'
                document.getElementById('p-phone').value = profile.phone || '';
                        
            if (document.getElementById('p-bio'))
                document.getElementById('p-bio').value = profile.bio || '';

            // Gestion de l'avatar (Image vs Icon)
            const imgDisplay = document.getElementById('profile-avatar-img');
            const iconDisplay = document.getElementById('profile-avatar-icon');

            if (profile.is_certified) {
                // Afficher l'icône bleue
                if(imgDisplay) imgDisplay.classList.remove('hidden');
                iconDisplay.classList.add('hidden');
            } else {
                imgDisplay.classList.add('hidden');
                iconDisplay.classList.remove('hidden');
            }
        } else {
            console.log("Aucun profil trouvé dans la table 'profiles' pour cet ID.");
        }
    } catch (err) {
        console.error("Erreur inattendue :", err);
    }
}

// Gestion de l'image de profil (Upload Supabase Storage)
let avatarFile = null; // Variable temporaire pour stocker le fichier choisi

function handleProfileImage(input) {
    if (input.files && input.files[0]) {
        avatarFile = input.files[0]; // On stocke le fichier pour l'upload plus tard
        const reader = new FileReader();
        reader.onload = function(e) {
            const imgDisplay = document.getElementById('profile-avatar-img');
            const iconDisplay = document.getElementById('profile-avatar-icon');
            
            imgDisplay.src = e.target.result;
            imgDisplay.classList.remove('hidden');
            iconDisplay.classList.add('hidden');
        }
        reader.readAsDataURL(input.files[0]);
    }
}
        
// Sauvegarder le profil (Upload image + Update BDD)
async function saveProfile(e) {
    e.preventDefault();
    
    // 1. Gestion de l'état du bouton
    const btn = e.target.querySelector('button[type="submit"]');
    const originalText = btn.innerHTML; // Utiliser innerHTML au cas où il y aurait des icônes
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';

    try {
        // 2. Vérification de l'utilisateur
        const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
        if (userError || !user) throw new Error("Session expirée. Veuillez vous reconnecter.");

        let avatarUrl = null;

        // 3. Gestion de l'Upload (si avatarFile existe dans votre scope global)
        // Note : assurez-vous que 'avatarFile' est bien défini quand l'utilisateur choisit un fichier
        if (typeof avatarFile !== 'undefined' && avatarFile) {
            const fileExt = avatarFile.name.split('.').pop();
            const fileName = `${user.id}/${Date.now()}.${fileExt}`;

            const { data: uploadData, error: uploadError } = await supabaseClient.storage
                .from('avatars')
                .upload(fileName, avatarFile, {
                    upsert: true
                });

            if (uploadError) throw new Error("Erreur d'upload : " + uploadError.message);

            // Récupérer l'URL publique
            const { data: publicUrlData } = supabaseClient.storage
                .from('avatars')
                .getPublicUrl(fileName);
            
            avatarUrl = publicUrlData.publicUrl;
        }

        // 4. Préparation des données pour la table 'profiles'
        const updates = {
            id: user.id,
            // Ne pas mettre à jour l'email si votre table 'profiles' ne le gère pas (l'email est déjà dans auth.users)
            full_name: document.getElementById('p-name').value.trim(),
            phone: document.getElementById('p-phone').value.trim(),
            bio: document.getElementById('p-bio').value.trim(),
            updated_at: new Date().toISOString()
        };

        if (avatarUrl) {
            updates.avatar_url = avatarUrl;
        }

        // 5. Mise à jour dans la base de données
        const { error: updateError } = await supabaseClient
            .from('profiles')
            .upsert(updates, { onConflict: 'id' }); 

        if (updateError) throw updateError;

        // 6. Succès
        showToast("Profil mis à jour avec succès ! ✅", "success");
        
        // Rafraîchir l'interface si la fonction existe
        if (typeof loadUserProfile === 'function') await loadUserProfile();
        if (typeof toggleProfile === 'function') toggleProfile();

    } catch (error) {
        console.error("Erreur saveProfile:", error);
        showToast(error.message, "error");
    } finally {
        // 7. Reset de l'état
        btn.innerHTML = originalText;
        btn.disabled = false;
        if (typeof avatarFile !== 'undefined') avatarFile = null; 
    }
}
        
        // Déconnexion
        async function logout() {
            if(confirm("Êtes-vous sûr de vouloir vous déconnecter ?")) {
                await supabaseClient.auth.signOut();
                showToast("Déconnexion...", "success");
                setTimeout(() => {
                    window.location.href = "login.html";
                }, 1000);
            }
        }
    
        /* --- MISE À JOUR DES BLOCAGES D'ACCÈS --- */
        
        // Surcharge de la fonction openTerminal
        const originalOpenTerminal = openTerminal;
        openTerminal = async function() {
            const isConnected = await checkAuth();
            if (!isConnected) return;
            originalOpenTerminal();
        }
        
        // Surcharge de toggleOrders
        const originalToggleOrders = toggleOrders;
        toggleOrders = async function() {
            const isConnected = await checkAuth();
            if (!isConnected) return;
            originalToggleOrders();
        }

               /* --- GESTION DE L'ESPACE ADMIN --- */

async function checkAdminStatus() {
    try {
        // Correction de la parenthèse et de l'accolade ici :
        const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
        
        if (authError || !user) return;

        const { data: profile, error } = await supabaseClient
            .from('profiles')
            .select('is_admin')
            .eq('id', user.id)
            .maybeSingle(); 

        if (profile && profile.is_admin) {
            isCurrentUserAdmin = true;
            const adminLink = document.getElementById('nav-admin-link');
            if (adminLink) adminLink.classList.remove('hidden');
        }
    } catch (error) {
        console.error("Erreur vérification admin :", error);
    }
}

// 2. Charger les articles dans la vue Admin
async function loadAdminArticles() {
    const list = document.getElementById('admin-articles-list');
    if (!list) return;

    // Loader initial
    list.innerHTML = '<div class="col-span-full text-center py-10"><i class="fas fa-circle-notch fa-spin text-2xl text-indigo-600"></i></div>';

    const { data: articles, error } = await supabaseClient
        .from('articles')
        .select('*')
        .order('created_at', { ascending: false });

    if (error) {
        list.innerHTML = `<p class="col-span-full text-red-500 text-center py-10">Erreur de chargement: ${error.message}</p>`;
        return;
    }

    if (!articles || articles.length === 0) {
        list.innerHTML = '<div class="col-span-full text-center py-10 text-slate-400">Aucun article pour le moment.</div>';
        return;
    }

    list.innerHTML = articles.map(art => {
        // Préparation de l'image pour éviter les erreurs de backticks imbriqués
        const imageContent = art.image_url 
            ? `<img src="${art.image_url}" class="w-20 h-20 object-cover rounded-lg bg-slate-100 shadow-sm">` 
            : `<div class="w-20 h-20 bg-slate-100 rounded-lg flex items-center justify-center text-slate-300 border border-slate-200"><i class="fas fa-image text-xl"></i></div>`;

        // Nettoyage du contenu (enlève les balises HTML si présentes)
        const plainText = art.content.replace(/<[^>]*>/g, '');
        const excerpt = plainText.length > 80 ? plainText.substring(0, 80) + '...' : plainText;

        return `
        <div class="glass p-6 flex flex-col sm:flex-row gap-4 items-start group hover:shadow-lg transition-all border border-white/20">
            <div class="flex-shrink-0">
                ${imageContent}
            </div>
            
            <div class="flex-1 flex flex-col h-full">
                <div class="mb-2">
                    <span class="text-[10px] font-bold text-indigo-600 uppercase bg-indigo-50 px-2 py-1 rounded-full border border-indigo-100 italic">
                        ${art.category || 'Général'}
                    </span>
                    <h3 class="text-lg font-extrabold text-slate-900 mt-2 leading-tight group-hover:text-indigo-600 transition-colors">
                        ${art.title}
                    </h3>
                </div>
                
                <p class="text-xs text-slate-500 mb-4 line-clamp-2">
                    ${excerpt}
                </p>
                
                <div class="flex items-center justify-between mt-auto pt-2 border-t border-slate-100/50">
                    <span class="text-xs font-medium text-slate-400">
                        <i class="far fa-calendar-alt mr-1"></i> 
                        ${new Date(art.created_at).toLocaleDateString('fr-FR')}
                    </span>
                    <a href="javascript:void(0)" 
                       onclick="editArticle('${art.id}')"
                       class="w-8 h-8 rounded-full bg-slate-900 text-white flex items-center justify-center hover:btn-sky-yellow hover:scale-110 transition-all">
                        <i class="fas fa-pencil-alt text-[10px]"></i>
                    </a>
                </div>
            </div>
        </div>
        `;
    }).join('');
}

// 3. Ouvrir/Fermermer la modale
function openArticleModal() {
    document.getElementById('article-modal').classList.remove('hidden');
    document.getElementById('article-form').reset();
}
function closeArticleModal() {
    document.getElementById('article-modal').classList.add('hidden');
}

// 4. Sauvegarder un nouvel article
async function saveArticle(e) {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    
    // État de chargement "Ultra Pro"
    const originalText = btn.innerText;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> Publication...';

    try {
        const title = document.getElementById('art-title').value;
        const content = document.getElementById('art-content').value;
        const category = document.getElementById('art-category').value;
        const image_url = document.getElementById('art-image').value;

        // CORRECTION : Ajout de la fermeture de l'objet et de la parenthèse
        const { data: { user }, error: authError } = await supabaseClient.auth.getUser();

        if (authError || !user) {
            throw new Error("Session expirée ou utilisateur non trouvé.");
        }

        // Insertion dans Supabase
        const { error } = await supabaseClient.from('articles').insert([{
            title,
            content,
            category,
            image_url,
            author_id: user.id,
            created_at: new Date().toISOString() // Bonne pratique pour le tri
        }]);

        if (error) throw error;

        // Succès
        showToast("Article publié avec succès !", "success");
        
        // Nettoyage et rafraîchissement
        if (typeof closeArticleModal === 'function') closeArticleModal();
        if (typeof loadAdminArticles === 'function') loadAdminArticles();
        
        e.target.reset(); // Vide le formulaire

    } catch (error) {
        console.error("Erreur publication:", error);
        alert("Erreur lors de la publication : " + error.message);
    } finally {
        // Dans tous les cas (succès ou erreur), on réactive le bouton
        btn.disabled = false;
        btn.innerText = originalText;
    }
}

// 5. Supprimer un article
async function deleteArticle(id) {
    if(!confirm("Êtes-vous sûr de vouloir supprimer cet article ?")) return;
    
    const { error } = await supabaseClient.from('articles').delete().eq('id', id);
    
    if (error) {
        showToast("Erreur de suppression", "error");
    } else {
        showToast("Article supprimé", "success");
        loadAdminArticles();
    }
}
        /* --- AFFICHER LES ARTICLES ADMIN DANS LA MARKETPLACE --- */

async function loadMarketplaceArticles() {
    try {
        // 1. Récupérer les articles depuis Supabase
        const { data: articles, error } = await supabaseClient
            .from('articles')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) {
            console.error("Erreur chargement articles marketplace :", error);
            return;
        }

        if (!articles || articles.length === 0) return;

        // 2. Le conteneur où l'on va mettre les articles
        const grid = document.getElementById('products-grid');
        
        // 3. Créer le HTML pour chaque article
        articles.forEach(art => {
            // Définition des couleurs d'arrière-plan selon la catégorie (comme vos produits fixes)
            let bgClass = 'btn-sky-yellow'; 
            let iconClass = 'fas fa-newspaper text-slate-200';
            
            if (art.category === 'academique') {
                bgClass = 'bg-indigo-50'; iconClass = 'fas fa-graduation-cap text-indigo-200';
            } else if (art.category === 'corporate') {
                bgClass = 'bg-emerald-50'; iconClass = 'fas fa-briefcase text-emerald-200';
            } else if (art.category === 'marketing') {
                bgClass = 'bg-orange-50'; iconClass = 'fa-bullhorn text-orange-200';
            }

            // Création de la Carte
            const articleHTML = `
        <div class="market-item glass flex flex-col group overflow-hidden" data-category="${art.category || 'all'}">
            <div class="h-48 ${bgClass || 'bg-slate-100'} relative overflow-hidden">
                ${art.image_url 
                    ? `<img src="${art.image_url}" class="w-full h-full object-cover transition-all duration-700 group-hover:scale-110">` 
                    : `<div class="absolute inset-0 flex items-center justify-center text-slate-300 text-5xl">
                         <i class="fas fa-image"></i>
                       </div>`
                }
                <span class="absolute top-4 left-4 btn-sky-yellow text-white text-[10px] font-bold px-2 py-1 rounded uppercase shadow-lg z-10">
                    Pub
                </span>
            </div>

            <div class="p-6 flex-1 flex flex-col">
                <h3 class="font-bold text-lg mb-2 text-slate-900 group-hover:text-indigo-600 transition-colors line-clamp-1">
                    ${art.title}
                </h3>
                
                <p class="text-sm text-slate-500 mb-4 flex-1 line-clamp-2">
                    ${art.content ? art.content.replace(/<[^>]*>/g, '').substring(0, 80) + '...' : ''}
                </p>

                <div class="flex items-center justify-between mt-auto pt-4 border-t border-slate-100">
                    <span class="text-xs font-bold uppercase tracking-wider text-slate-400 italic">Détails</span>
                    <a href="javascript:void(0)" 
                       onclick="openTerminal()" 
                       class="w-10 h-10 rounded-full btn-sky-yellow text-white flex items-center justify-center hover:scale-110 transition-all shadow-md">
                        <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>
    `;

    // Injection au début de la grille
    grid.insertAdjacentHTML('afterbegin', articleHTML);
    
    });

} catch (err) {
        console.error("Erreur marketplace :", err);
        
        // Rendu visuel de l'erreur pour l'utilisateur
        const grid = document.getElementById('products-grid'); // Remplacez par votre ID réel
        if (grid) {
            grid.innerHTML = `
                <div class="col-span-full flex flex-col items-center py-12 text-slate-400">
                    <i class="fas fa-exclamation-circle text-3xl mb-3 opacity-20"></i>
                    <p class="text-sm font-medium">Impossible de charger les produits pour le moment.</p>
                    <button onclick="location.reload()" class="mt-4 text-xs font-bold text-indigo-600 hover:text-indigo-500 underline uppercase tracking-widest">
                        Réessayer
                    </button>
                </div>
            `;
        }
        
        // Optionnel : Notification Toast
        if (typeof showToast === 'function') {
            showToast("Problème de connexion à la marketplace", "error");
        }
    }
}
       /**
 * Génère le HTML de l'avatar de manière élégante
 * @param {string} userEmail - Email de l'utilisateur pour les initiales et la couleur
 * @param {string} avatarUrl - URL optionnelle de la photo de profil
 * @param {boolean} isMe - Optionnel : permet de styliser différemment mon propre avatar
 */
function getAvatarHtml(userEmail, avatarUrl, isMe = false) {
    // 1. Si on a une URL d'image valide
    if (avatarUrl && avatarUrl.trim() !== '') {
        return `<img src="${avatarUrl}" class="w-full h-full object-cover rounded-full" onerror="this.parentElement.innerHTML='${getAvatarHtml(userEmail, null, isMe)}'">`;
    }
    
    // 2. Préparation des initiales
    const initials = userEmail && userEmail.includes('@') 
        ? userEmail.split('@')[0].substring(0, 2).toUpperCase() 
        : (userEmail ? userEmail.substring(0, 2).toUpperCase() : '??');

    // 3. Palette de couleurs "Modern Business" (plus sobres et pros)
    const colors = [
        '#6366f1', // Indigo
        '#8b5cf6', // Violet
        '#ec4899', // Rose
        '#3b82f6', // Bleu
        '#06b6d4', // Cyan
        '#10b981', // Emeraude
        '#f59e0b', // Ambre
        '#64748b'  // Ardoise
    ];

    // Génération d'un index de couleur constant pour le même utilisateur
    const charCodeSum = userEmail ? userEmail.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) : 0;
    const colorIndex = charCodeSum % colors.length;
    const bgColor = colors[colorIndex];
    
    // 4. Retourne le span avec centrage Flexbox parfait
    return `
        <div class="w-full h-full flex items-center justify-center font-bold text-[11px] tracking-tighter rounded-full text-white shadow-inner" 
             style="background: linear-gradient(135deg, ${bgColor}CC, ${bgColor}); text-shadow: 0 1px 2px rgba(0,0,0,0.2);">
            ${initials}
        </div>
    `;
}

/* --- METTRE À JOUR L'AVATAR DU DOCK --- */
function updateDockAvatar(avatarUrl) {
    const img = document.getElementById('dock-avatar-img');
    const icon = document.getElementById('dock-avatar-icon');
    
    if (!img || !icon) return;

    if (avatarUrl && avatarUrl.trim() !== '') {
        // Si on a une photo : on l'affiche et on cache l'icône
        img.src = avatarUrl;
        img.classList.remove('hidden');
        icon.classList.add('hidden');
    } else {
        // Si pas de photo : on cache l'image et on affiche l'icône
        img.classList.add('hidden');
        icon.classList.remove('hidden');
    }
}
        /* --- GESTION DE L'OUVERTURE DU CHAT (MODIFIÉ) --- */
/* --- GESTION DE L'OUVERTURE DU CHAT (CORRIGÉ POUR LE DOCK) --- */

window.toggleChat = async function() {
    const { data: authData } = await supabaseClient.auth.getUser();
    const user = authData?.user;

    if (!user) {
        showToast("Veuillez vous connecter pour accéder au chat", "error");
        return;
    }

    const overlay = document.getElementById('chat-overlay');
    const panel = document.getElementById('chat-panel');
    const dock = document.querySelector('.mobile-dock');
    
    if (!overlay || !panel) return;
    
    if (overlay.classList.contains('invisible')) {
        // --- OUVERTURE ---
        overlay.classList.remove('invisible');
        setTimeout(() => {
            overlay.querySelector('div:first-child').classList.replace('opacity-0', 'opacity-100');
            panel.classList.replace('translate-x-full', 'translate-x-0');
        }, 10);

        loadChatMessages();
        if (!chatInterval) chatInterval = setInterval(loadChatMessages, 3000);

        // --- CACHER LE DOCK ---
        if (dock) dock.classList.add('dock-hidden');

        setTimeout(() => {
            const input = document.getElementById('chat-input');
            if (input) input.focus();
        }, 500);
    } else {
        // --- FERMETURE ---
        overlay.querySelector('div:first-child').classList.replace('opacity-100', 'opacity-0');
        panel.classList.replace('translate-x-0', 'translate-x-full');
        setTimeout(() => overlay.classList.add('invisible'), 500);

        if (chatInterval) {
            clearInterval(chatInterval);
            chatInterval = null;
        }

        // --- RÉAFFICHER LE DOCK ---
        if (dock) dock.classList.remove('dock-hidden');
    }
};

async function loadChatMessages() {
    const container = document.getElementById('chat-messages');
    if (!container) return;

    const { data: authData } = await supabaseClient.auth.getUser();
    const user = authData?.user;
    if(!user) return;

    const { data: messages, error } = await supabaseClient
        .from('messages')
        .select('*')
        .order('created_at', { ascending: true })
        .limit(50);

    if (error) return console.error("Erreur chat:", error);
    if (container.querySelectorAll('.chat-row').length === messages.length) return;

    container.innerHTML = '<div class="text-center my-6"><span class="inline-block bg-indigo-50 text-indigo-600 text-[10px] font-bold uppercase tracking-wider px-3 py-1 rounded-full border border-indigo-100">Discussion en direct</span></div>';

    messages.forEach(msg => {
        const isMe = msg.user_id === user.id;
        const row = document.createElement('div');
        row.className = `chat-row ${isMe ? 'flex-row-reverse' : 'flex-row'}`;
        
        const time = new Date(msg.created_at).toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
        const name = isMe ? 'Moi' : (msg.user_email?.split('@')[0] || 'Anonyme');

        row.innerHTML = `
            <div class="chat-avatar shadow-md border-2 ${isMe ? 'border-indigo-100' : 'border-white'}">
                ${getAvatarHtml(msg.user_email, null, isMe)}
            </div>
            <div class="chat-content ${isMe ? 'items-end' : 'items-start'}">
                <div class="chat-header ${isMe ? 'flex-row-reverse text-indigo-100' : 'text-indigo-600'}">
                    <span>${name}</span>
                    <span class="opacity-60 font-normal">${time}</span>
                </div>
                <div class="chat-bubble ${isMe ? 'me' : 'other'} shadow-sm">
                    ${msg.content}
                </div>
            </div>`;
        container.appendChild(row);
    });

    container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
}

/* --- GESTION DES BADGES (ADMIN) --- */

async function loadAdminUsers() {
    const list = document.getElementById('admin-users-list');
    if (!list) return;

    const { data: profiles, error } = await supabaseClient
        .from('profiles')
        .select('*')
        .order('created_at', { ascending: false });

    if (error) {
        list.innerHTML = `<tr><td colspan="4">Erreur: ${error.message}</td></tr>`;
        return;
    }

    list.innerHTML = profiles.map(p => {
        const isCert = Boolean(p.is_certified);
        return `
        <tr class="hover:bg-slate-50 border-b border-slate-100">
            <td class="px-6 py-4 flex items-center gap-3">
                <div class="w-8 h-8 rounded-full overflow-hidden border shadow-sm">
                     ${p.avatar_url ? `<img src="${p.avatar_url}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center bg-slate-100 text-slate-400"><i class="fas fa-user text-xs"></i></div>`}
                </div>
                <span class="font-bold text-slate-900">${p.full_name || 'Sans nom'}</span>
            </td>
            <td class="px-6 py-4 text-slate-500 text-xs">${p.email || 'N/A'}</td>
            <td class="px-6 py-4 text-center">
                ${isCert ? '<span class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full text-xs font-bold"><i class="fas fa-check-circle"></i> Certifié</span>' : '<span class="text-slate-400 text-xs">Standard</span>'}
            </td>
            <td class="px-6 py-4 text-center">
                <button onclick="toggleUserBadge('${p.id}', ${isCert})" class="px-3 py-1 text-xs font-bold border rounded ${isCert ? 'text-red-600 border-red-200' : 'text-green-600 border-green-200'}">
                    ${isCert ? 'Révoquer' : 'Certifier'}
                </button>
            </td>
        </tr>`;
    }).join('');
}

async function toggleUserBadge(userId, currentStatus) {
    const newStatus = !currentStatus;
    const { error } = await supabaseClient.from('profiles').update({ is_certified: newStatus, certification_badge: newStatus ? 'Vérifié' : null }).eq('id', userId);

    if (error) {
        showToast("Erreur: " + error.message, "error");
    } else {
        showToast(newStatus ? "Utilisateur certifié !" : "Badge révoqué.", "success");
        loadAdminUsers();
    }
}

/* --- MISE À JOUR DU JS POUR LE NOUVEAU DESIGN --- */

/* --- CHARGEMENT PROFIL (OPTIMISÉ) --- */
async function loadSocialProfile(targetUserId = null) {
    try {
        const { data: { user: currentUser }, error: authError } = await supabaseClient.auth.getUser();
        if (authError || !currentUser) return;

        let profileId = targetUserId || currentUser.id;
        let isMyProfile = (profileId === currentUser.id);

        // 1. Charger le profil
        const { data: profile, error } = await supabaseClient
            .from('profiles')
            .select('*')
            .eq('id', profileId)
            .maybeSingle();

        if (error) throw error;

        if (!profile) {
            const container = document.querySelector('#profile-social-view .max-w-2xl'); 
            if (container) container.innerHTML = `<div class="text-center py-20"><h2 class="text-xl font-bold text-slate-900">Profil introuvable</h2></div>`;
            return;
        }

        // 2. Mise à jour du DOM de base
        const updateText = (id, text) => {
            const el = document.getElementById(id);
            if(el) el.textContent = text;
        };

        updateText('social-fullname', profile.full_name || 'Utilisateur');
        updateText('social-username', profile.username ? `@${profile.username}` : '@utilisateur');

        // 3. Stats (Optimisation : Lancement des deux requêtes en même temps)
        const [followersRes, followingRes] = await Promise.all([
            supabaseClient.from('follows').select('*', { count: 'exact', head: true }).eq('following_id', profileId),
            supabaseClient.from('follows').select('*', { count: 'exact', head: true }).eq('follower_id', profileId)
        ]);
        
        // 4. Gestion des éléments UI
        const editBtn = document.querySelector('button[onclick="toggleProfile()"]');
        const logoutBtn = document.querySelector('button[onclick="confirmSocialLogout()"]');
        const followContainer = document.getElementById('profile-follow-container');

        if (isMyProfile) {
            if(editBtn) editBtn.style.display = 'inline-block';
            if(logoutBtn) logoutBtn.style.display = 'flex';
            if(followContainer) {
                followContainer.style.display = 'none';
                followContainer.innerHTML = ''; 
            }
            updateDockAvatar(profile.avatar_url);
        } else {
            if(editBtn) editBtn.style.display = 'none';
            if(logoutBtn) logoutBtn.style.display = 'none';
            
            if (followContainer) {
                followContainer.style.display = 'flex';
                followContainer.innerHTML = ''; // On vide pour laisser la fonction suivante remplir
                
                // Appel de ta fonction de création de boutons (Abonnement + Message)
                // Assure-toi que cette fonction utilise followContainer pour injecter le HTML
                await initFollowButtonOnProfile(profileId, currentUser.id); 
            }
        }

        // 5. Avatar principal (Correction fallback)
        const imgEl = document.getElementById('social-avatar');
        const placeholder = document.getElementById('social-avatar-placeholder');
        
        if (imgEl && placeholder) {
            if (profile.avatar_url) {
                imgEl.src = profile.avatar_url;
                imgEl.classList.remove('hidden');
                placeholder.classList.add('hidden');
            } else {
                imgEl.classList.add('hidden');
                placeholder.classList.remove('hidden');
                // Optionnel : Mettre une initiale dans le placeholder
                placeholder.innerText = (profile.full_name || 'U').charAt(0).toUpperCase();
            }
        }

        // 6. Badge de certification
        const badgeInline = document.getElementById('social-badge-inline');
        if(badgeInline) {
            profile.is_certified ? badgeInline.classList.remove('hidden') : badgeInline.classList.add('hidden');
        }

        // 7. Charger les posts du profil
        loadSocialPosts(profileId);

    } catch (err) {
        if (err.name !== 'AbortError') {
            console.error("Erreur profil social:", err);
    loadSocialPosts(userId);
        }
    }
}

async function initFollowButtonOnProfile(targetUserId, myId) {
    const container = document.getElementById('profile-follow-container');
    if (!container) return;

    // 1. Sécurité : On définit cleanMyId proprement
    let cleanMyId = (typeof myId === 'object' && myId !== null) ? myId.id : myId;
    
    // Si cleanMyId est toujours invalide, on le récupère via la session
    if (!cleanMyId || typeof cleanMyId !== 'string') {
        const { data: { user } } = await supabaseClient.auth.getUser();
        cleanMyId = user?.id;
    }

    if (!cleanMyId || !targetUserId) return;

    try {
        // 2. Vérification de l'abonnement
        const { data: followCheck } = await supabaseClient
            .from('follows')
            .select('*')
            .eq('follower_id', cleanMyId)
            .eq('following_id', targetUserId)
            .maybeSingle();

        const isFollowing = !!followCheck;

        // 3. Rendu HTML (Bouton Follow + Bouton Message)
        container.style.display = 'flex';
        container.className = "flex items-center gap-2 w-full mt-4";
        
        container.innerHTML = `
            <button id="main-follow-btn" 
                onclick="toggleFollow('${targetUserId}', this)" 
                class="flex-1 text-xs font-bold px-6 py-2.5 rounded-full transition-all active:scale-95 ${
                    isFollowing 
                    ? 'bg-slate-100 text-slate-600 border border-slate-200' 
: 'btn-sky-yellow shadow-md'
                }">
                ${isFollowing ? 'Abonné' : 'S\'abonner'}
            </button>
            
            <button onclick="startChat('${targetUserId}')" 
                class="w-10 h-10 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center hover:bg-indigo-100 transition-all active:scale-90 shadow-sm border border-indigo-100">
                <i class="fas fa-comment-dots"></i>
            </button>
        `;
    } catch (err) {
        console.error("Erreur initFollowButton:", err);
    }
}

// 3. Chargement des Photos (Grille 3 colonnes)
// 3. Chargement des Photos (Grille 3 colonnes) - VERSION CORRIGÉE
async function loadSocialPosts(userId) {
    const grid = document.getElementById('social-posts-grid');
    if (!grid) return;

    try {
        // --- CORRECTION : Récupération de l'utilisateur connecté (myId) ---
        const { data: { user } } = await supabaseClient.auth.getUser();
        const myId = user?.id || null; // Si pas connecté, myId est null

        // Récupération des posts du profil visité
        const { data: posts, error } = await supabaseClient
            .from('posts')
            .select('*')
            .eq('user_id', userId)
            .order('created_at', { ascending: false });

        if (error) throw error;

        if (!posts || posts.length === 0) {
            grid.innerHTML = `
                <div class="col-span-3 flex flex-col items-center justify-center py-20 text-gray-400">
                    <i class="fas fa-camera text-3xl mb-2"></i>
                    <p class="text-xs">Aucune publication</p>
                </div>`;
            return;
        }

        // Génération HTML pour la grille (carrés parfaits)
        grid.innerHTML = posts.map(post => {
            // Logique de confidentialité (Optionnel : masquer les posts privés si ce n'est pas le propriétaire)
            if (post.visibility === 'private' && myId !== userId) {
                return ''; // Ne pas afficher les posts privés des autres
            }
            
            // Déterminer le média (Image ou Vidéo)
            const mediaUrl = post.image_url || post.video_url;
            const isVideo = post.is_short || post.video_url;

            return `
            <div class="aspect-square bg-gray-200 relative group cursor-pointer overflow-hidden" onclick="openPostModal('${post.id}')">
                ${mediaUrl 
                    ? (isVideo 
                        ? `<video src="${mediaUrl}" class="w-full h-full object-cover" muted></video>
                           <div class="absolute top-2 right-2 text-white drop-shadow-lg"><i class="fas fa-play-circle"></i></div>`
                        : `<img src="${mediaUrl}" decoding="async" class="w-full h-full object-cover" loading="lazy">`
                      )
                    : `<div class="w-full h-full flex items-center justify-center bg-slate-100 text-slate-300"><i class="fas fa-image text-2xl"></i></div>`
                }
                <!-- Overlay au survol (Style Instagram) -->
                <div class="absolute inset-0 bg-black/30 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-4 text-white text-sm font-bold">
                    ${post.image_url ? `<span class="flex items-center gap-1"><i class="fas fa-heart"></i> 0</span>` : '<i class="fas fa-play fa-2x"></i>'}
                </div>
            </div>
            `;
        }).join('');

    } catch (err) {
        console.error("Erreur posts:", err);
    }
}

// 4. Gestion de la Modale de Publication
function openNewPostModal() { 
    // Afficher la modale
    const modal = document.getElementById('new-post-modal');
    if (modal) modal.classList.remove('hidden'); 

    // NOUVEAU : Cacher le Dock mobile pour libérer l'espace
    const dock = document.querySelector('.mobile-dock');
    if (dock) dock.classList.add('nav-hidden');
}

function closeNewPostModal() { 
    // Cacher la modale
    const modal = document.getElementById('new-post-modal');
    if (modal) modal.classList.add('hidden'); 

    // NOUVEAU : Réafficher le Dock mobile
    const dock = document.querySelector('.mobile-dock');
    if (dock) dock.classList.remove('nav-hidden');
}


        
// --- GESTION DU TYPE DE POST (IMAGE / SHORT) ---

let currentPostFile = null; // Stocke le fichier (image ou vidéo)

function setPostType(type) {
    const imgBox = document.getElementById('upload-image-box');
    const vidBox = document.getElementById('upload-video-box');
    const btnImg = document.getElementById('btn-type-image');
    const btnVid = document.getElementById('btn-type-short');
    const hiddenInput = document.getElementById('current-post-type');

    hiddenInput.value = type;
    currentPostFile = null; // Reset file
    resetPreview();

    if (type === 'image') {
        imgBox.classList.remove('hidden');
        vidBox.classList.add('hidden');
        btnImg.className = "flex-1 py-2 text-xs font-bold rounded-md bg-white shadow-sm text-slate-900 transition";
        btnVid.className = "flex-1 py-2 text-xs font-bold rounded-md text-slate-500 hover:text-slate-900 transition";
    } else {
        imgBox.classList.add('hidden');
        vidBox.classList.remove('hidden');
        btnImg.className = "flex-1 py-2 text-xs font-bold rounded-md text-slate-500 hover:text-slate-900 transition";
        btnVid.className = "flex-1 py-2 text-xs font-bold rounded-md bg-pink-50 shadow-sm text-pink-600 transition";
    }
}

function previewFile(input, type) {
    const file = input.files[0];
    if (!file) return;
    
    const errorMsg = document.getElementById('video-error-msg');
    const previewArea = document.getElementById('preview-area');
    const imgEl = document.getElementById('preview-img-el');
    const vidEl = document.getElementById('preview-video-el');

    errorMsg.classList.add('hidden');
    currentPostFile = file;
    previewArea.classList.remove('hidden');

    if (type === 'image') {
        const reader = new FileReader();
        reader.onload = (e) => {
            imgEl.src = e.target.result;
            imgEl.classList.remove('hidden');
            vidEl.classList.add('hidden');
        };
        reader.readAsDataURL(file);
    } else {
        // LOGIQUE VIDÉO : Vérifier la durée MAX 10 MIN
        const videoURL = URL.createObjectURL(file);
        vidEl.src = videoURL;
        
        vidEl.onloadedmetadata = function() {
            if (this.duration > 600) { // 600 secondes = 10 minutes
                errorMsg.innerText = "Erreur : La vidéo dépasse 10 minutes !";
                errorMsg.classList.remove('hidden');
                input.value = ""; // Reset
                currentPostFile = null;
                previewArea.classList.add('hidden');
            } else {
                // Durée OK
                vidEl.classList.remove('hidden');
                imgEl.classList.add('hidden');
            }
        };
    }
}

function resetPreview() {
    document.getElementById('preview-area').classList.add('hidden');
    document.getElementById('preview-img-el').src = '';
    document.getElementById('preview-video-el').src = '';
}// <--- C'est cette accolade qui ferme la fonction

        async function filterFeed(filter) {
    // Mise à jour visuelle des boutons
    const btnRecent = document.getElementById('btn-sort-recent');
    const btnPopular = document.getElementById('btn-sort-popular');
    const btnShorts = document.getElementById('btn-filter-shorts');

    // Reset classes
    [btnRecent, btnPopular, btnShorts].forEach(btn => {
        btn.className = "text-sm font-bold pb-2 px-2 border-b-2 border-transparent text-slate-400 hover:text-slate-600 transition-colors whitespace-nowrap";
    });

    // Active class pour le bouton cliqué
    if (filter === 'shorts') {
        btnShorts.className = "text-sm font-bold pb-2 px-2 border-b-2 border-pink-600 text-pink-600 transition-colors whitespace-nowrap flex items-center gap-1";
    } else if (filter === 'recent') {
        btnRecent.className = "text-sm font-bold pb-2 px-2 border-b-2 border-indigo-600 text-indigo-600 transition-colors whitespace-nowrap";
    } else if (filter === 'popular') {
        btnPopular.className = "text-sm font-bold pb-2 px-2 border-b-2 border-indigo-600 text-indigo-600 transition-colors whitespace-nowrap flex items-center gap-1";
    }

    // Charger le feed avec le filtre
    loadGlobalFeed('recent', filter);
}

        /* --- FONCTION DÉCONNEXION SOCIALE --- */
function confirmSocialLogout() {
    // 1. Demander confirmation
    if (confirm("Voulez-vous vraiment vous déconnecter ?")) {
        
        // 2. Appeler Supabase pour déconnecter
        supabaseClient.auth.signOut().then(({ error }) => {
            if (error) {
                console.error("Erreur déconnexion:", error.message);
                showToast("Erreur lors de la déconnexion", "error");
            } else {
                // 3. Rediriger vers la page de login
                showToast("Déconnexion !", "success");
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1000);
            }
        });
    }
}

        /* --- ALGORITHME DE TRI DES POSTS --- */

// Fonction pour calculer le score d'un post
function calculatePostScore(likes, comments, createdAt) {
    // 1. Score d'engagement (1 Like = 10pts, 1 Comment = 5pts)
    const engagementScore = (likes * 10) + (comments * 5);
    
    // 2. Calcul du temps écoulé (en heures)
    const now = new Date();
    const postDate = new Date(createdAt);
    const diffTime = Math.abs(now - postDate);
    const diffHours = diffTime / (1000 * 60 * 60);

    // 3. Formule de désintégration temporelle (Gravity)
    // Plus diffHours est grand, plus le dénominateur est grand, donc le score baisse.
    const gravity = 1.8;
    const timeDecay = Math.pow(diffHours + 2, gravity);

    // 4. Score final
    return engagementScore / timeDecay;
}

// Fonction de tri principal
// Fonction pour le TRI (Tendances)
function sortFeed(type) {
    // Mise à jour visuelle des boutons
    const btnRecent = document.getElementById('btn-sort-recent');
    const btnPopular = document.getElementById('btn-sort-popular');

    // Reset des styles
    if(btnRecent) { btnRecent.className = "text-sm font-bold pb-2 px-2 border-b-2 border-transparent text-slate-400 hover:text-slate-600 transition-colors whitespace-nowrap"; }
    if(btnPopular) { btnPopular.className = "text-sm font-bold pb-2 px-2 border-b-2 border-transparent text-slate-400 hover:text-slate-600 transition-colors whitespace-nowrap"; }

    // Activation du style du bouton cliqué
    if (type === 'popular') {
        if(btnPopular) btnPopular.className = "text-sm font-bold pb-2 px-2 border-b-2 border-indigo-600 text-indigo-600 transition-colors whitespace-nowrap flex items-center gap-1";
    } else {
        if(btnRecent) btnRecent.className = "text-sm font-bold pb-2 px-2 border-b-2 border-indigo-600 text-indigo-600 transition-colors whitespace-nowrap";
    }

    // --- LOGIQUE DE CHARGEMENT ---
    // Si on clique sur Tendances, on trie par popularité
    // Sinon on trie par Récent
    const sortMode = (type === 'popular') ? 'popular' : 'recent';
    
    // On recharge le feed avec le tri voulu (appendMode = false pour reset)
    loadGlobalFeed(sortMode, 'all', false);
}

// Fonction pour le FILTRE (Shorts)
function filterFeed(filterType) {
    const btnShorts = document.getElementById('btn-filter-shorts');
    
    // Reset style bouton Shorts
    if(btnShorts) btnShorts.className = "text-sm font-bold pb-2 px-2 border-b-2 border-transparent text-slate-400 hover:text-pink-600 transition-colors whitespace-nowrap flex items-center gap-1";

    // Activation style
    if (filterType === 'shorts') {
        if(btnShorts) btnShorts.className = "text-sm font-bold pb-2 px-2 border-b-2 border-pink-600 text-pink-600 transition-colors whitespace-nowrap flex items-center gap-1";
        
        // --- LOGIQUE DE CHARGEMENT ---
        // On charge le feed en filtrant uniquement les vidéos
        loadGlobalFeed('recent', 'shorts', false);
    }
}
        
/**
 * CHARGEMENT DU FLUX GLOBAL (VERSION ULTRA PRO)
 */
async function loadGlobalFeed(sortBy = 'recent', filterType = 'all', appendMode = false) {
    const container = document.getElementById('global-feed-container');
    const loader = document.getElementById('feed-loader');
    if (!container) return;

    // --- 1. GESTION DU LOADER ET PAGINATION ---
    if (!appendMode) {
        container.innerHTML = `<div class="flex justify-center py-12"><i class="fas fa-circle-notch animate-spin text-3xl text-indigo-600 opacity-20"></i></div>`;
        feedOffset = 0;
        hasMorePosts = true;
    } else {
        if (loader) loader.classList.remove('hidden');
    }

    if (appendMode) isLoadingFeed = true;

    try {
        // --- 2. AUTHENTIFICATION & DATA INIT ---
        const { data: userData } = await supabaseClient.auth.getUser();
        const myId = userData?.user?.id || null;

        // A. Récupération des utilisateurs bloqués
        let blockedIds = [];
        if (myId) {
            const { data: blocked } = await supabaseClient
                .from('blocked_users')
                .select('blocked_id')
                .eq('blocker_id', myId);
            blockedIds = blocked ? blocked.map(b => b.blocked_id) : [];
        }

        // B. Récupération de mes abonnements (Pour la confidentialité "Friends")
        let myFollowingSet = new Set();
        if (myId) {
            const { data: followingData } = await supabaseClient
                .from('follows')
                .select('following_id')
                .eq('follower_id', myId);
            if (followingData) myFollowingSet = new Set(followingData.map(f => f.following_id));
        }

        // --- 3. RÉCUPÉRATION DES POSTS (Query principale) ---
        const { data: posts, error } = await supabaseClient
            .from('posts')
            .select(`
                *,
                profiles ( id, full_name, username, avatar_url, is_certified ),
                post_likes(count),
                post_comments(count)
            `)
            .order('created_at', { ascending: false })
            .range(feedOffset, feedOffset + FEED_BATCH_SIZE - 1);

        if (error) throw error;

        if (!posts || posts.length === 0) {
            if (!appendMode) {
                container.innerHTML = `<div class="text-center py-20 text-slate-400"><i class="fas fa-newspaper text-4xl mb-3 opacity-20"></i><p>Aucune publication pour le moment.</p></div>`;
            } else {
                hasMorePosts = false;
                if (loader) loader.classList.add('hidden');
            }
            return;
        }

        // --- 4. FILTRAGE CÔTÉ CLIENT (Confidentialité & Blocage) ---
        const visiblePosts = posts.filter(post => {
            if (blockedIds.includes(post.user_id)) return false;
            if (post.user_id === myId) return true;

            const visibility = post.visibility || 'public';

            if (visibility === 'public') return true;
            if (visibility === 'private') return false;
            
            if (visibility === 'friends') {
                return myFollowingSet.has(post.user_id);
            }
            return false;
        });

        // --- 5. RÉACTIONS UTILISATEUR ---
        let myLikedPostIds = new Set();
        const postIds = visiblePosts.map(p => p.id);

        if (myId && postIds.length > 0) {
            const { data: myLikes } = await supabaseClient
                .from('post_likes')
                .select('post_id, reaction_type')
                .eq('user_id', myId)
                .in('post_id', postIds);

            if (myLikes) {
                myLikedPostIds = new Set(myLikes.map(l => l.post_id));
                if (typeof userReactions !== 'undefined') {
                    myLikes.forEach(like => {
                        userReactions.set(like.post_id, like.reaction_type);
                    });
                }
            }
        }

        // --- 6. FILTRE SECONDaire (Shorts) & TRI ---
        let processedPosts = filterType === 'shorts' ? visiblePosts.filter(p => p.is_short) : visiblePosts;

        if (sortBy === 'popular' && typeof calculatePostScore === 'function') {
            processedPosts = processedPosts.map(post => ({
                ...post,
                calculatedScore: calculatePostScore(post.post_likes?.[0]?.count || 0, post.post_comments?.[0]?.count || 0, post.created_at)
            })).sort((a, b) => b.calculatedScore - a.calculatedScore);
        }

        // --- 7. GÉNÉRATION HTML (AVEC DOCUMENTFRAGMENT) ---
        // Création d'un fragment mémoire (hors DOM) pour optimiser le rendu
        const fragment = document.createDocumentFragment();

        processedPosts.forEach(post => {
            const profile = post.profiles || {};
            const avatarUrl = profile.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${profile.username || 'user'}`; 
            const userName = profile.full_name || 'Utilisateur';
            const isCertified = profile.is_certified;
            const timeAgo = typeof getTimeAgo === 'function' ? getTimeAgo(new Date(post.created_at)) : 'Récemment';
            
            const likeCount = post.post_likes?.[0]?.count || 0;
            const commentCount = post.post_comments?.[0]?.count || 0;
            const isMyPost = (post.user_id === myId);

            let formattedCaption = "";
            if (post.caption) {
                formattedCaption = typeof formatTextWithHighlights === 'function' ? formatTextWithHighlights(post.caption) : post.caption;
            }

            // Bouton Suivre
            let followBtn = '';
            if (!isMyPost && myId) {
                const isFollowing = myFollowingSet.has(post.user_id);
                followBtn = `
                    <button onclick="toggleFollow('${post.user_id}', this)" 
                            class="text-xs font-bold px-4 py-1.5 rounded-full transition-all ${isFollowing ? 'border border-slate-200 text-slate-500' : 'btn-sky-yellow text-white hover:bg-indigo-700 shadow-sm'}">
                        ${isFollowing ? 'Abonné' : 'Suivre'}
                    </button>`;
            }

            // Menu Contextuel
            let menuItemsHtml = '';
            if (isMyPost) {
                menuItemsHtml = `
                    <div onclick="editPost('${post.id}')" class="post-dropdown-item"><i class="fas fa-pencil-alt"></i> Modifier</div>
                    <div onclick="deletePostModal('${post.id}')" class="post-dropdown-item danger"><i class="fas fa-trash-alt"></i> Supprimer</div>`;
            } else {
                menuItemsHtml = `
                    <div onclick="savePost('${post.id}')" class="post-dropdown-item"><i class="far fa-bookmark"></i> Enregistrer</div>
                    <div onclick="sharePost('${post.id}')" class="post-dropdown-item"><i class="fas fa-link"></i> Copier le lien</div>
                    <div onclick="reportPost('${post.id}')" class="post-dropdown-item danger"><i class="fas fa-flag"></i> Signaler</div>`;
            }

            // Média HTML
            let mediaHtml = '';
            if (post.is_short && post.video_url) {
                mediaHtml = `
                    <div onclick="openPostModal('${post.id}')" class="relative bg-slate-900 flex justify-center overflow-hidden group rounded-2xl mb-4 shadow-lg border border-slate-200/10 cursor-pointer" 
                         onmouseenter="if(this.querySelector('video')) this.querySelector('video').play()"
                         onmouseleave="if(this.querySelector('video')) { this.querySelector('video').pause(); this.querySelector('video').currentTime = 0; }">
                        <div class="absolute top-3 left-3 z-10 flex items-center gap-1.5 px-2 py-1 bg-black/50 backdrop-blur-md rounded-lg text-white text-[10px] font-bold tracking-wider uppercase">
                            <i class="fas fa-bolt text-yellow-400"></i> Short
                        </div>
                        <video src="${post.video_url}" class="w-full aspect-[9/16] max-h-[650px] object-cover transition-transform duration-700 group-hover:scale-105" loop muted playsinline preload="metadata"></video>
                        <div class="absolute inset-0 flex items-center justify-center bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                            <div class="w-16 h-16 flex items-center justify-center rounded-full bg-white/20 backdrop-blur-md border border-white/30 text-white shadow-2xl">
                                <i class="fas fa-expand text-2xl"></i>
                            </div>
                        </div>
                    </div>`;
            } else if (post.image_url) {
                mediaHtml = `<img src="${post.image_url}" onclick="openPostModal('${post.id}')" class="w-full h-auto object-cover rounded-lg mb-1 cursor-pointer hover:opacity-95 transition" loading="lazy" alt="Post">`;
            }

            // Création de l'élément Article (Node DOM)
            const article = document.createElement('article');
            article.className = 'bg-white dark:bg-black border border-black/5 dark:border-white/10 rounded-lg overflow-hidden mb-2 transition-all hover:shadow-xl hover:shadow-black/5 dark:hover:shadow-white/5';
            
            // Injection du HTML dans le node (Design préservé)
            article.innerHTML = `
                <div class="p-4 flex items-center justify-between">
                    <div class="flex items-center gap-3 cursor-pointer" onclick="viewUserProfile('${post.user_id}')">
                        <img src="${avatarUrl}" class="w-11 h-11 rounded-full border-2 border-indigo-50 shadow-sm">
                        <div>
                            <div class="flex items-center gap-1 font-bold text-sm text-slate-900 dark:text-white">
                                ${userName} ${isCertified ? '<i class="fas fa-check-circle text-blue-500 text-[10px]"></i>' : ''}
                            </div>
                            <div class="text-[11px] text-slate-400 font-medium">${timeAgo}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-1">
                        ${followBtn}
                        <div class="post-menu-container ml-1">
                            <button onclick="togglePostMenu('${post.id}', event)" class="w-25 h-9 flex items-center justify-center text-slate-400 hover:text-slate-600 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-all active:scale-90">
                                <i class="fas fa-ellipsis-v text-[18px] text-black dark:text-white"></i>
                            </button>
                            <div id="menu-${post.id}" class="post-dropdown-menu">${menuItemsHtml}</div>
                        </div>
                    </div>
                </div>
                <div class="px-4 pb-2">
                    ${formattedCaption ? `<div><p id="caption-${post.id}" class="text-sm text-slate-700 dark:text-slate-300 leading-relaxed line-clamp-2"><span class="font-extrabold text-slate-900 dark:text-white"></span>${formattedCaption}</p>${formattedCaption.length > 50 ? `<span id="btn-more-${post.id}" onclick="toggleCaptionExpand('${post.id}')" class="btn-voir-plus">Voir plus</span>` : ''}</div>` : ''}
                </div>
                ${mediaHtml}
                <div class="px-4 pb-2 pt-1">
                    <div class="flex items-center gap-5">
                        <div style="position: relative;">
                            <button onclick="toggleReactionPopup('${post.id}', this)" class="flex items-center gap-1.5 group">
                                <i id="icon-react-${post.id}" class="text-xl group-active:scale-125 transition-transform ${
                                    (() => {
                                        const type = userReactions.get(post.id);
                                        const style = type ? REACTION_STYLES[type] : null;
                                        return style ? `fas ${style.icon} ${style.color}` : 'far fa-heart text-slate-400';
                                    })()
                                }"></i>
                                <span id="count-like-${post.id}" class="text-xs font-bold text-slate-500">${formatNumber(likeCount)}</span>
                            </button>
                            <div id="reactions-popup-${post.id}" class="reactions-popup" style="display:none"></div>
                        </div>
                        <button onclick="toggleCommentSection('${post.id}')" class="flex items-center gap-1.5 group">
                            <i class="fas fa-comment-dots text-slate-400 text-xl group-hover:text-indigo-500 transition-colors"></i>
                            <span id="count-comment-${post.id}" class="text-xs font-bold text-slate-500">${formatNumber(commentCount)}</span>
                        </button>
                        <button onclick="sharePost('${post.id}')" class="ml-auto text-slate-400 hover:text-indigo-600 transition-colors flex items-center gap-1">
                            <i class="fas fa-arrows-rotate text-xl"></i>
                        </button>
                    </div>
                </div>
                <div id="comments-${post.id}" class="hidden p-4 border-t border-slate-50 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-800/50">
                    <div id="comment-list-${post.id}" class="space-y-3 mb-4 max-h-48 overflow-y-auto no-scrollbar"></div>
                    <form onsubmit="submitComment(event, '${post.id}')" class="relative">
                        <input type="text" name="content" placeholder="Ajouter un commentaire..." class="w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-full px-4 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                        <button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 btn-sky-yellow px-3 py-1 rounded-full text-xs font-bold">Envoyer</button>
                    </form>
                </div>`;

            // Ajout de l'article au fragment (en mémoire, pas encore visible)
            fragment.appendChild(article);
        });

        // --- 8. INJECTION DOM (UNE SEULE FOIS) ---
        
        // Si on remplace tout (pas appendMode), on vide le container
        if (!appendMode) {
            container.innerHTML = '';
        }
        
        // On injecte tout le fragment d'un coup (Ultra performant)
        container.appendChild(fragment);

        // Gestion du scroll infini
        feedOffset += posts.length;
        
        if (processedPosts.length === 0 && posts.length === FEED_BATCH_SIZE) {
             loadMoreFeed(); 
             return;
        }

        if (posts.length < FEED_BATCH_SIZE) {
            hasMorePosts = false;
            if (loader) loader.classList.add('hidden');
        }

    } catch (error) {
        if (error.name !== 'AbortError') {
            console.error("Erreur Feed:", error);
            if (!appendMode) {
                container.innerHTML = `<div class="p-8 text-center bg-red-50 text-red-600 rounded-2xl"><i class="fas fa-exclamation-triangle mb-2 text-xl"></i><p class="text-sm font-bold">Verifier votre connexion</p></div>`;
            }
        }
    } finally {
        isLoadingFeed = false;
        if (loader && !hasMorePosts) loader.classList.add('hidden');
        else if (loader) loader.classList.remove('hidden');
    }
}

            // 1. Ouvrir/Fermer le menu spécifique
function togglePostMenu(postId, event) {
    event.stopPropagation(); // Empêche le clic de se propager
    const menu = document.getElementById(`menu-${postId}`);
    const isVisible = menu.style.display === 'block';

    // Fermer tous les autres menus ouverts
    document.querySelectorAll('.post-dropdown-menu').forEach(m => m.style.display = 'none');

    // Basculer l'affichage du menu actuel
    if (!isVisible) {
        menu.style.display = 'block';
    }
}

// 2. Fermer le menu si on clique ailleurs sur la page
document.addEventListener('click', () => {
    document.querySelectorAll('.post-dropdown-menu').forEach(m => m.style.display = 'none');
});

// 3. Fonction pour "Enregistrer" (placeholder)
async function savePost(postId) {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return showToast("Connectez-vous", "error");

    // Vérifier si déjà enregistré
    const { data: existing } = await supabaseClient
        .from('saved_posts')
        .select('*')
        .eq('user_id', user.id)
        .eq('post_id', postId)
        .maybeSingle();

    if (existing) {
        // Supprimer
        await supabaseClient.from('saved_posts').delete().eq('id', existing.id);
        showToast("Retiré des enregistrements", "success");
    } else {
        // Ajouter
        await supabaseClient.from('saved_posts').insert([{ user_id: user.id, post_id: postId }]);
        showToast("Post enregistré !", "success");
    }
    
    // Mettre à jour l'icône visuellement (Optionnel)
    const btn = document.querySelector(`[onclick="savePost('${postId}')"] i`);
    if (btn) btn.classList.toggle('fas'); // Change l'icône en plein
}
        // Fonction déclenchée par l'observateur quand on arrive en bas
async function loadMoreFeed() {
    if (isLoadingFeed || !hasMorePosts) return;
    
    // On réutilise les filtres actuels (ou 'recent' par défaut)
    // On passe 'true' pour le mode append (ajout)
    await loadGlobalFeed('recent', 'all', true);
}
        
function initVideoObserver() {
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            const video = entry.target;
            if (entry.isIntersecting) {
                if (!video.src && video.dataset.src) video.src = video.dataset.src;
                video.play().catch(() => {});
            } else {
                video.pause();
            }
        });
    }, { threshold: 0.6 });

    document.querySelectorAll('.lazy-video').forEach(v => observer.observe(v));
}

function toggleCommentSection(postId) {
    const commentSection = document.getElementById(`comments-${postId}`);
    
    if (commentSection) {
        // On bascule la classe 'hidden' pour afficher ou cacher la section
        commentSection.classList.toggle('hidden');
        
        // Petit bonus : si on ouvre la section, on scrolle doucement vers elle
        if (!commentSection.classList.contains('hidden')) {
            commentSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }
}
        
        /* --- ACTIONS : LIKE, COMMENT, SHARE --- */

// 1. Gérer le Like
// 1. LIKE : Optimisé et robuste
// 1. Gérer le Like
// Variable pour empêcher le spamming de clics
const likeLocks = new Set();

async function toggleLike(postId, btnElement) {
    // Empêche le double-clic
    if (likeLocks.has(postId)) return;

    const icon = document.getElementById(`icon-like-${postId}`);
    const countSpan = document.getElementById(`count-like-${postId}`);
    
    if (!icon || !countSpan) return;

    try {
        // Vérification utilisateur
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
            showToast("Connectez-vous pour liker", "warning");
            return;
        }

        // --- CALCUL INTELLIGENT DU NOMBRE ACTUEL ---
        // 1. On essaie de lire l'attribut caché (le plus fiable)
        let currentCount = parseInt(countSpan.getAttribute('data-raw-count'));

        // 2. SECURITE : Si l'attribut est absent (null), on lit le texte affiché à l'écran
        if (isNaN(currentCount)) {
            const textVisible = countSpan.innerText || "0";
            // Si le texte contient "K" (ex: 1.2K), on convertit en chiffre
            if (textVisible.includes('K')) {
                currentCount = parseFloat(textVisible) * 1000;
            } else {
                // Sinon on prend le chiffre brut
                currentCount = parseInt(textVisible.replace(/[^0-9]/g, '')) || 0;
            }
        }

        // 3. Logique de changement d'état
        const isCurrentlyLiked = icon.classList.contains('fas');
        
        if (isCurrentlyLiked) {
            // ON RETIRE LE LIKE
            icon.classList.replace('fas', 'far');
            icon.classList.remove('text-red-500', 'animate-heart-pop');
            currentCount = Math.max(0, currentCount - 1);
        } else {
            // ON MET UN LIKE
            icon.classList.replace('far', 'fas');
            icon.classList.add('text-red-500', 'animate-heart-pop');
            currentCount += 1;
        }
        
        // 4. Mise à jour visuelle IMMEDIATE
        countSpan.innerText = formatNumber(currentCount);
        // On met à jour l'attribut caché pour la prochaine fois
        countSpan.setAttribute('data-raw-count', currentCount);

        // 5. Action en Base de Données
        if (isCurrentlyLiked) {
            await supabaseClient
                .from('post_likes')
                .delete()
                .match({ post_id: postId, user_id: user.id });
        } else {
            await supabaseClient
                .from('post_likes')
                .insert([{ post_id: postId, user_id: user.id }]);
        }

    } catch (err) {
        console.error("Erreur Like:", err);
        // On ne fait rien de visuel, l'état optimiste reste
    } finally {
        likeLocks.delete(postId);
    }
}

// 2. COMMENTAIRE : Corrigé
async function submitComment(e, postId) {
    e.preventDefault();
    const form = e.target;
    const content = form.content.value.trim();
    const listElement = document.getElementById(`comment-list-${postId}`);
    const countSpan = document.getElementById(`count-comment-${postId}`);

    // --- VÉRIFICATION CONTENU ---
    if (containsInappropriateContent(content)) {
        showToast("Commentaire refusé : Langage inapproprié.", "error");
        if(input) {
            input.classList.add('border-red-500', 'bg-red-50');
            setTimeout(() => input.classList.remove('border-red-500', 'bg-red-50'), 2000);
        }
        return;
    }

    const { data: { user } } = await supabaseClient.auth.getUser();

    const { error } = await supabaseClient
        .from('post_comments')
        .insert([{ user_id: user.id, post_id: postId, content: content }]);

    if (!error) {
        // Ajout visuel
        const newComment = document.createElement('div');
        newComment.className = 'text-sm animate-fade-in'; // Petite animation si tu as le CSS
        newComment.innerHTML = `<span class="font-bold text-indigo-700">Vous</span> <span class="text-slate-600">${content}</span>`;
        listElement.appendChild(newComment);
        form.reset();
        
        // Mise à jour du compteur
        let rawText = countSpan.innerText.toUpperCase().replace(',', '.');
        let currentCount = rawText.includes('K') ? parseFloat(rawText) * 1000 : parseInt(rawText);
        countSpan.innerText = formatNumber(currentCount + 1);
    } else {
        console.error("Erreur Commentaire:", error);
    }
}
        // AVANT : function ajouterCommentaire() {
// APRÈS :
async function ajouterCommentaire(postId, content) {
    
    // Maintenant 'await' est autorisé ici
    const { data: postData, error: postError } = await supabaseClient
        .from('posts')
        .select('user_id')
        .eq('id', postId)
        .single();

    if (postData?.user_id && !postError) {
        sendNotification(postData.user_id, 'comment', postId, content);
    }
}

// 3. FONCTION FORMATNUMBER (Indispensable pour que le code ci-dessus fonctionne)
function formatNumber(num) {
    // Si la donnée est vide, null ou undefined, on affiche 0
    if (num === undefined || num === null) return '0';
    
    if (num >= 1000) {
        return (num / 1000).toFixed(1).replace('.0', '') + 'K';
    }
    return num.toString();
}
// 5. Partager (Simulation)
function sharePost(postId) {
    // Récupérer l'URL actuelle
    const url = window.location.href.split('#')[0] + '?post=' + postId;
    
    if (navigator.share) {
        navigator.share({
            title: 'Regarde cette publication sur Printbam',
            url: url,
        }).catch(console.error);
    } else {
        // Fallback : copier dans le presse-papier
        navigator.clipboard.writeText(url);
        showToast("Lien copié !", "success");
    }
}

// Fonction utilitaire pour le temps relatif (ex: 2h)
function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    let interval = seconds / 31536000;
    if (interval > 1) return Math.floor(interval) + " an";
    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + " mois";
    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + " j";
    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + " h";
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + " min";
    return "À l'instant";
}
       /* --- SYSTÈME D'ABONNEMENT (CORRIGÉ POUR ERREUR 409) --- */

/* --- SYSTÈME D'ABONNEMENT (VERSION FINALE) --- */

async function toggleFollow(targetUserId, btnElement) {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return showToast("Connectez-vous", "error");
    if (user.id === targetUserId) return;

    // On vérifie l'état actuel grâce à la classe CSS 'following'
    const isFollowing = btnElement.classList.contains('following');

    try {
        if (isFollowing) {
            // --- ACTION : SE DÉSABONNER ---
            const { error } = await supabaseClient
                .from('follows')
                .delete()
                .eq('follower_id', user.id)
                .eq('following_id', targetUserId);
            
            if (!error) {
                updateFollowButton(btnElement, false); // Repasse en "S'abonner"
                showToast("Désabonné", "success");
            }

        } else {
            // --- ACTION : S'ABONNER ---
            const { error } = await supabaseClient
                .from('follows')
                .insert([{ follower_id: user.id, following_id: targetUserId }]);

            if (error) {
                // Si erreur "Déjà abonné", on synchronise l'affichage
                if (error.code === '23505' || error.status === 409) {
                    updateFollowButton(btnElement, true); // Force l'état "Abonné"
                } else {
                    throw error;
                }
            } else {
                updateFollowButton(btnElement, true); // Passe en "Abonné"
                showToast("Abonné !", "success");
            }
        }
        
        // Rafraîchir les chiffres du profil
        loadSocialProfile(); 

    } catch (err) {
        console.error("Erreur:", err);
        showToast("Erreur", "error");
    }
}

// Fonction de mise à jour visuelle
function updateFollowButton(btn, isFollowing) {
    if (isFollowing) {
        // ÉTAT : ABONNÉ (Gris)
        btn.innerText = "Abonné";
        // On ajoute la classe 'following' pour que le bouton sache qu'il est actif
        btn.classList.add('following');
        btn.className = "text-xs font-bold px-4 py-1.5 rounded-full transition-all ${isFollowing ? 'border border-slate-200 text-slate-500' : 'btn-sky-yellow shadow-sm'}";
    } else {
        // ÉTAT : S'ABONNER (Bleu)
        btn.innerText = "S'abonner";
        // On retire la classe
        btn.classList.remove('following');
        btn.className = "text-xs font-bold px-4 py-1.5 rounded-full btn-sky-yellow text-white hover:bg-blue-700 transition shadow";
    }
}

function resetProfileUI() {
    // On cible le conteneur blanc principal à l'intérieur de #profile-social-view
    const profileContainer = document.querySelector('#profile-social-view > div');
    
    if (profileContainer) {
        // On injecte le code HTML du Skeleton (L'animation CSS va faire le reste)
        profileContainer.innerHTML = getProfileSkeletonHTML();
    }
}

function getProfileSkeletonHTML() {
    return `
    <!-- CONTENEUR PRINCIPAL BLANC -->
    <div class="bg-white min-h-screen max-w-lg mx-auto shadow-sm relative z-20 pb-20">
        
        <!-- HEADER -->
        <div class="p-5 flex items-start gap-5 border-b border-gray-100">
            
            <!-- 1. AVATAR (Doit avoir l'ID 'social-avatar') -->
            <div class="relative">
                <div class="w-20 h-20 md:w-24 md:h-24 rounded-full border border-gray-200 p-1 bg-white">
                    <!-- On met l'ID sur l'image, le placeholder sera caché après -->
                    <img id="social-avatar" src="" alt="Profile" class="w-full h-full object-cover rounded-full hidden">
                    
                    <!-- Le placeholder affiché par défaut -->
                    <div id="social-avatar-placeholder" class="w-full h-full bg-gray-200 rounded-full flex items-center justify-center text-gray-300">
                        <!-- On met une fausse image animée dedans pour le loader -->
                        <div class="w-full h-full bg-gray-200 skeleton skeleton-avatar"></div>
                    </div>
                </div>
            </div>

            <!-- 2. INFOS PRINCIPALES (Doit avoir l'ID 'social-fullname') -->
            <div class="flex-1 pt-1">
                <div class="flex items-center gap-1 mb-1">
                    <!-- IMPORTANT : id="social-fullname" -->
                    <!-- On met le texte gris animé dans la balise H1 pour qu'il soit remplacé par le vrai nom -->
                    <h1 id="social-fullname" class="text-xl font-bold text-black leading-none opacity-50">
                        <div class="skeleton skeleton-text short" style="height: 20px; width: 140px; display: block;"></div>
                    </h1>
                    
                    <span id="social-badge-inline" class="hidden ml-1">
                        <!-- Contenu vide, il sera caché de toute façon -->
                    </span>
                </div>
                
                <!-- Stats (Doivent avoir les IDs 'stat-following' et 'stat-followers') -->
                <div class="text-sm text-gray-600 font-medium mb-2">
                    <span id="stat-following">
                         <div class="skeleton skeleton-text medium" style="display:inline-block; width: 20px;"></div>
                    </span> suivis • 
                    <span id="stat-followers">
                         <div class="skeleton skeleton-text medium" style="display:inline-block; width: 20px;"></div>
                    </span> abonnés
                </div>
                
                <!-- Bouton Modifier -->
                <button class="px-3 py-1 bg-gray-100 text-xs font-bold text-gray-700 rounded hover:bg-gray-200 transition skeleton-btn"></button>
                
                <!-- Conteneur Follow -->
                <div id="profile-follow-container" class="hidden"></div>
            </div>
        </div>

        <!-- SECTION INFOS (Doivent avoir les IDs 'social-phone', 'social-username', 'social-dob') -->
        <div class="bg-gray-50 px-5 py-4 space-y-3 border-b border-gray-200">
            <!-- Téléphone -->
            <div class="flex items-center gap-3">
                <div class="skeleton skeleton-avatar" style="width: 16px; height: 16px;"></div>
                <span id="social-phone" class="text-sm text-gray-700 font-medium">
                     <div class="skeleton skeleton-text long"></div>
                </span>
            </div>
            <!-- Username -->
            <div class="flex items-center gap-3">
                <div class="skeleton skeleton-avatar" style="width: 16px; height: 16px;"></div>
                <span id="social-username" class="text-sm text-gray-700 font-medium">
                     <div class="skeleton skeleton-text medium"></div>
                </span>
            </div>
            <!-- Date de naissance -->
            <div class="flex items-center gap-3">
                <div class="skeleton skeleton-avatar" style="width: 16px; height: 16px;"></div>
                <span id="social-dob" class="text-sm text-gray-700 font-medium">
                     <div class="skeleton skeleton-text short"></div>
                </span>
            </div>
        </div>

        <!-- ONGLETS -->
        <div class="flex border-b border-gray-200">
            <button onclick="switchSocialTab('publications')" class="social-tab-btn flex-1 py-4 text-sm font-bold text-black border-b-2 border-black transition-colors">
                Publications
            </button>
            <button onclick="switchSocialTab('archives')" class="social-tab-btn flex-1 py-4 text-sm font-bold text-gray-400 border-b-2 border-transparent hover:text-gray-600 transition-colors">
                Publications archivées
            </button>
        </div>

        <!-- GRILLE DES PHOTOS (Doit avoir l'ID 'social-posts-grid') -->
        <div id="social-posts-grid" class="grid grid-cols-3 gap-1 bg-gray-100">
             <!-- 6 Blocs animés -->
             ${Array(6).fill(0).map(() => `
                <div class="aspect-square bg-gray-200 skeleton"></div>
             `).join('')}
        </div>

        <!-- BOUTON AJOUTER FLOTTANT -->
        <button class="fixed bottom-6 right-6 md:absolute md:bottom-6 md:right-6 w-14 h-14 btn-sky-yellow text-white rounded-full shadow-lg flex items-center justify-center hover:bg-blue-700 transition-all z-50 skeleton" style="border-radius: 50%; width: 56px; height: 56px;">
            <div style="width: 20px; height: 20px; background: rgba(255,255,255,0.4); border-radius: 50%;"></div>
        </button>

    </div>
    `;
}
        
        /* --- NAVIGATION VERS UN AUTRE PROFIL --- */
// Fonction globale pour voir un profil
function viewUserProfile(userId) {
    // 1. On change de vue vers "profile-social"
    switchPage('profile-social');
    
    // 2. On force l'affichage de la vue (sécurité)
    const view = document.getElementById('profile-social-view');
    if (view) {
        view.style.display = 'block';
        setTimeout(() => view.classList.add('active'), 10);
    }

    // 3. On charge les données de CET utilisateur spécifique
    // On passe l'ID en paramètre
    loadSocialProfile(userId);
}
        /* --- SYSTÈME DE MESSAGERIE --- */
let lastMessageCount = 0; // Pour éviter le clignotement au rechargement

// 1. Démarrer une conversation
/* --- DÉMARRER OU CRÉER UNE DISCUSSION (VERSION OPTIMISÉE) --- */
async function startChat(targetUserId) {
    if (!targetUserId) return;

    // 1. ACTION IMMÉDIATE (Optimiste)
    // On change de page tout de suite pour ne pas avoir l'impression que ça bug
    switchPage('chat');

    // On affiche un loader dans la zone de message pendant le chargement
    const container = document.getElementById('chat-messages-container');
    if (container) {
        container.innerHTML = `<div class="flex justify-center items-center h-full">
            <div class="text-center text-slate-400">
                <i class="fas fa-spinner fa-spin text-2xl text-indigo-500 mb-2"></i>
                <p class="text-xs">Chargement...</p>
            </div>
        </div>`;
    }

    // 2. Vérification utilisateur (en arrière-plan)
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) {
        showToast("Veuillez vous connecter", "error");
        switchPage('messages'); // Retour si erreur
        return;
    }
    if (user.id === targetUserId) return;

    try {
        // 3. Recherche ou création du chat
        const { data: existingChat } = await supabaseClient
            .from('chats')
            .select('id')
            .or(`and(user_1_id.eq.${user.id},user_2_id.eq.${targetUserId}),and(user_1_id.eq.${targetUserId},user_2_id.eq.${user.id})`)
            .maybeSingle();

        let chatId;

        if (existingChat) {
            chatId = existingChat.id;
        } else {
            // Création si inexistant
            const { data: newChat, error } = await supabaseClient
                .from('chats')
                .insert([{ user_1_id: user.id, user_2_id: targetUserId }])
                .select('id')
                .single();
            
            if (error) throw error;
            chatId = newChat.id;

            // Mise à jour du cache global
            if (typeof myChatIdsCache !== 'undefined') {
                myChatIdsCache.add(chatId);
            }
        }

        // 4. Ouuration finale de la salle (charge les vrais messages)
        openChatRoom(chatId, targetUserId);

    } catch (err) {
        console.error("Erreur startChat:", err);
        showToast("Erreur de chargement", "error");
        // Retour à la liste en cas d'erreur grave
        switchPage('messages'); 
    }
}

/* --- CHARGEMENT LISTE CHAT (OPTIMISÉ 1 REQUÊTE) --- */
async function loadChatList() {
    const container = document.getElementById('chat-list-container');
    if (!container) return;

    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return;

    try {
        // 1. UNE SEULE requête pour tout récupérer (Chats + Profils des autres)
        // On suppose que vous avez une vue ou une Foreign Key configurée.
        // Sinon, on fait 2 requêtes parallèles optimisées :
        
        const [chatsRes, profilesRes] = await Promise.all([
            supabaseClient.from('chats')
                .select('*')
                .or(`user_1_id.eq.${user.id},user_2_id.eq.${user.id}`)
                .order('updated_at', { ascending: false }),
            supabaseClient.from('profiles').select('id, full_name, avatar_url, is_certified')
        ]);

        const chats = chatsRes.data;
        const profilesMap = new Map(profilesRes.data.map(p => [p.id, p]));

        if (!chats || chats.length === 0) {
             container.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-slate-400 p-8 text-center"><i class="fas fa-comments text-4xl mb-3 opacity-20"></i><p>Aucune discussion.</p></div>`;
             return;
        }

        // 2. Récupération des derniers messages en 1 batch (au lieu de 1 par chat)
        const chatIds = chats.map(c => c.id);
        // Utilisation d'une fonction RPC optimisée ou d'une requête simple groupée
        // Ici, on simplifie pour la démo : on charge les derniers messages visibles
        // Pour une vraie app, créez une fonction SQL `get_last_messages` dans Supabase.
        
        // Rendu optimisé avec DocumentFragment
        const fragment = document.createDocumentFragment();

        chats.forEach(chat => {
            const otherId = chat.user_1_id === user.id ? chat.user_2_id : chat.user_1_id;
            const profile = profilesMap.get(otherId) || { full_name: 'Inconnu' };
            
            // Création d'éléments via JS (Plus rapide que innerHTML +=)
            const div = document.createElement('div');
            div.className = 'flex items-center gap-4 p-4 hover:bg-slate-50 cursor-pointer border-b border-slate-100 transition';
            div.onclick = () => startChat(otherId);
            
            div.innerHTML = `
                <img src="${profile.avatar_url || `https://ui-avatars.com/api/?name=${profile.full_name}`}" class="w-12 h-12 rounded-full object-cover bg-slate-200">
                <div class="flex-1 min-w-0">
                    <h4 class="font-semibold text-slate-900 truncate">${profile.full_name}</h4>
                    <p class="truncate text-sm text-slate-500">Appuyez pour voir les messages...</p>
                </div>
            `;
            fragment.appendChild(div);
        });
        
        container.innerHTML = ''; // Vider une seule fois
        container.appendChild(fragment); // Injecter une seule fois

    } catch (err) {
        console.error("Erreur loadChatList:", err);
    }
}

/* --- OUVERTURE D'UNE DISCUSSION (VERSION CORRIGÉE) --- */
async function openChatRoom(chatId, targetUserId) {
    currentChatId = chatId;
    currentTargetUserId = targetUserId;

    // 1. Récupérer l'utilisateur UNE SEULE FOIS
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return;

    switchPage('chat');

    // 2. Charger le Header
    const { data: profile } = await supabaseClient
        .from('profiles')
        .select('full_name, avatar_url, is_certified')
        .eq('id', targetUserId)
        .maybeSingle();

    if (profile) {
        const nameEl = document.getElementById('chat-header-name');
        const badge = profile.is_certified ? '<i class="fas fa-check-circle text-blue-500 text-xs ml-1"></i>' : '';
        nameEl.innerHTML = `${profile.full_name} ${badge}`;

        const avatarEl = document.getElementById('chat-header-avatar');
        const defaultAvatar = `https://api.dicebear.com/7.x/identicon/svg?seed=${encodeURIComponent(profile.full_name)}`;
        avatarEl.src = profile.avatar_url || defaultAvatar;
    }

    // 3. Charger l'historique
    await loadChatMessages(chatId);
    
    // 4. Marquer comme LU immédiatement
    markChatAsRead(chatId);

    // 5. Nettoyer l'ancien channel
    if (window.currentChatChannel) {
        await supabaseClient.removeChannel(window.currentChatChannel);
    }

    // 6. CONNEXION WEBSOCKET (INSERT + UPDATE)
    window.currentChatChannel = supabaseClient
        .channel(`realtime:chat:${chatId}`)
        
        // ÉCOUTEUR A : Nouveaux Messages
        .on('postgres_changes', {
            event: 'INSERT',
            schema: 'public',
            table: 'messages',
            filter: `chat_id=eq.${chatId}`
        }, (payload) => {
            handleRealtimeMessage(payload.new);
        })
        
        // ÉCOUTEUR B : CONFIRMATION DE LECTURE (UPDATE)
        .on('postgres_changes', {
            event: 'UPDATE',
            schema: 'public',
            table: 'messages',
            filter: `chat_id=eq.${chatId}`
        }, (payload) => {
            const msg = payload.new;
            
            // Condition : Le message est lu (is_read=true) ET c'est MOI l'expéditeur
            if (msg.is_read === true && msg.sender_id === user.id) {
                updateMessageReadStatusUI(msg.id, true);
            }
        })
        .subscribe();

    // 7. Statut "En ligne"
    if (chatStatusInterval) clearInterval(chatStatusInterval);
    refreshChatStatus(targetUserId);
    chatStatusInterval = setInterval(() => {
        if (currentTargetUserId === targetUserId) {
            refreshChatStatus(targetUserId);
        } else {
            clearInterval(chatStatusInterval);
        }
    }, 30000);
}

            /* --- MISE À JOUR VISUELLE DE L'ÉTAT "LU" --- */
function updateMessageReadStatusUI(msgId, isRead) {
    // On cherche l'élément du message par son ID réel
    const msgElement = document.querySelector(`[data-msg-id="${msgId}"]`);
    if (!msgElement) return;

    // On cherche l'icône de statut
    const icon = msgElement.querySelector('.fa-check'); // Cible la coche simple
    
    if (icon && isRead) {
        // TRANSFORMATION : 1 coche grise -> 2 coches bleues
        icon.classList.remove('fa-check');        // Retire "1 coche"
        icon.classList.add('fa-check-double');    // Ajoute "2 coches"
        
        icon.classList.remove('text-white/60');   // Retire gris
        icon.classList.add('text-blue-300');      // Met en bleu
    }
}
            
            /* --- SERVICE GLOBAL D'ÉCOUTE (TEMPS RÉEL) --- */
async function initGlobalRealtimeListeners() {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return;

    console.log("🚀 Initialisation du service global Realtime...");

    // 1. Préparer le cache des chats existants
    const { data: chats } = await supabaseClient
        .from('chats')
        .select('id')
        .or(`user_1_id.eq.${user.id},user_2_id.eq.${user.id}`);
    
    if (chats) {
        chats.forEach(c => myChatIdsCache.add(c.id));
    }

    // 2. NETTOYER LES ANCIENS CHANNELS (Évite les doublons)
    if (globalMessageListener) await supabaseClient.removeChannel(globalMessageListener);
    if (globalNotifListener) await supabaseClient.removeChannel(globalNotifListener);

    // 3. ÉCOUTEUR A : NOUVEAUX MESSAGES
    globalMessageListener = supabaseClient
        .channel('global-messages-channel')
        .on('postgres_changes', {
            event: 'INSERT',
            schema: 'public',
            table: 'messages'
        }, async (payload) => {
            const msg = payload.new;

            // A. Si c'est MOI qui envoie le message, on ne notifie pas
            if (msg.sender_id === user.id) return;

            // B. Vérifier si ce chat nous appartient (ou si c'est un nouveau chat)
            // Si le chat n'est pas dans le cache, on vérifie en BD (cas d'un nouveau chat créé par l'autre)
            if (!myChatIdsCache.has(msg.chat_id)) {
                 const { data: chatCheck } = await supabaseClient
                    .from('chats')
                    .select('id')
                    .eq('id', msg.chat_id)
                    .or(`user_1_id.eq.${user.id},user_2_id.eq.${user.id}`)
                    .maybeSingle();
                 
                 if (!chatCheck) return; // Ce n'est pas mon chat
                 
                 // C'est un nouveau chat pour moi, on l'ajoute au cache
                 myChatIdsCache.add(msg.chat_id);
                 console.log("Nouveau chat détecté et ajouté au cache :", msg.chat_id);
            }

            // --- LOGIQUE D'AFFICHAGE ---
            
            // 1. Si on est DÉJÀ dans ce chat spécifique -> On ne fait rien (géré par le listener local)
            if (window.currentChatId === msg.chat_id) {
                return; 
            }

            // 2. Récupérer les infos de l'expéditeur
            const { data: senderProfile } = await supabaseClient
                .from('profiles')
                .select('full_name, avatar_url')
                .eq('id', msg.sender_id)
                .single();

            // 3. Afficher le Toast Facebook Style
            if (senderProfile) {
                showIncomingMessageToast(
                    senderProfile.full_name,
                    msg.content.substring(0, 30) + '...',
                    senderProfile.avatar_url,
                    msg.chat_id,
                    msg.sender_id
                );
            }

            // 4. Mettre à jour le badge rouge du Dock
            updateMessageBadge();

            // 5. MISE À JOUR AUTOMATIQUE DE LA LISTE (NOUVEAU)
            // Si l'utilisateur est sur la page "Messages", on rafraîchit la liste
            const messagesView = document.getElementById('messages-view');
            if (messagesView && messagesView.classList.contains('active')) {
                console.log("Mise à jour de la liste des discussions...");
                loadChatList(); // Recharge la liste pour montrer le nouveau message / déplacer le chat
            }

        })
        .subscribe();

    // 4. ÉCOUTEUR B : NOUVELLES NOTIFICATIONS
    globalNotifListener = supabaseClient
        .channel('global-notifs-channel')
        .on('postgres_changes', {
            event: 'INSERT',
            schema: 'public',
            table: 'notifications',
            filter: `recipient_id=eq.${user.id}`
        }, (payload) => {
            const notif = payload.new;
            
            // Mettre à jour le badge
            updateNotificationBadge();
            // Afficher un Toast simple
            showToast(`🔔 Nouvelle notification !`, "success");
        })
        .subscribe();
}
            
// --- FONCTION HELPER POUR L'INJECTION DIRECTE ---
async function handleRealtimeMessage(newMessage) {
    const container = document.getElementById('chat-messages-container');
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user || !container) return;

    const isMe = newMessage.sender_id === user.id;

    // --- CAS 1 : C'est MON message (Confirmation du serveur) ---
    if (isMe) {
        // On cherche le message temporaire par son attribut 'data-temp-id'
        const pendingEl = container.querySelector('[data-temp-id]');

        if (pendingEl) {
            // 1. On remplace l'ID temporaire par le VRAI ID (CRUCIAL pour la lecture)
            pendingEl.setAttribute('data-msg-id', newMessage.id);
            
            // 2. On nettoie les attributs et classes temporaires
            pendingEl.removeAttribute('data-temp-id');
            pendingEl.classList.remove('opacity-60', 'animate-pulse'); // Styles d'envoi en cours
            
            // 3. Mise à jour de l'icône de statut
            const statusIcon = pendingEl.querySelector('.status-icon');
            if (statusIcon) {
                // On remplace l'horloge par 1 coche (Envoyé) ou 2 coches (Lu) selon l'état
                if (newMessage.is_read) {
                     statusIcon.className = 'fas fa-check-double text-[10px] ml-1 text-blue-300 status-icon';
                } else {
                     // Par défaut à la confirmation : 1 coche grise/blanche
                     statusIcon.className = 'fas fa-check text-[10px] ml-1 text-white/60 status-icon';
                }
            }
        }
        return; 
    }

    // --- CAS 2 : C'est un message de L'AUTRE (Nouveau message) ---
    
    // On utilise createMessageBubble pour garder le style et le menu contextuel
    const row = createMessageBubble(newMessage, false, user.id);

    container.appendChild(row);
    container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
    
    // Petite vibration si l'app est en arrière-plan
    if (document.hidden && navigator.vibrate) navigator.vibrate(200);
    
    // Mise à jour du badge global
    updateMessageBadge();
}

/* ==========================================================
   SECTION 1 : CHAT MESSAGING (ULTRA OPTIMISÉ)
   ========================================================== */

// 1. Charger l'historique (Version Performance avec DocumentFragment)
async function loadChatMessages(chatId) {
    const container = document.getElementById('chat-messages-container');
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user || !container) return;

    // Sauvegarder la position de scroll pour ne pas perturber la lecture
    const isScrolledToBottom = container.scrollHeight - container.clientHeight <= container.scrollTop + 50;
    
    try {
        const { data: messages, error } = await supabaseClient
            .from('messages')
            .select('*')
            .eq('chat_id', chatId)
            .order('created_at', { ascending: true });

        if (error) throw error;

        // Utilisation d'un Fragment pour performances optimales (1 seul repaint DOM)
        const fragment = document.createDocumentFragment();
        let lastDate = null;

        if (!messages || messages.length === 0) {
            container.innerHTML = '<div class="text-center py-10 text-slate-400 text-xs">Commencez la conversation !</div>';
            return;
        }

        container.innerHTML = ''; // Vider une seule fois

        messages.forEach(msg => {
            const msgDate = new Date(msg.created_at).toLocaleDateString('fr-FR');

            // Séparateur de date
            if (lastDate !== msgDate) {
                const dateEl = document.createElement('div');
                dateEl.className = 'text-center my-4';
                dateEl.innerHTML = `<span class="text-[10px] font-bold text-slate-400 uppercase bg-slate-200 dark:bg-slate-800 px-3 py-1 rounded-full">${msgDate}</span>`;
                fragment.appendChild(dateEl);
                lastDate = msgDate;
            }

            // Bulle de message
            const isMe = msg.sender_id === user.id;
            const row = createMessageBubble(msg, isMe);
            fragment.appendChild(row);
        });

        container.appendChild(fragment);

        // Auto-scroll uniquement si on était déjà en bas
        if (isScrolledToBottom) {
            container.scrollTop = container.scrollHeight;
        }

    } catch (err) {
        console.error("Erreur loadMessages:", err);
    }
}

// Helper pour créer une bulle de message (À placer en dehors des autres fonctions)
function createMessageBubble(msg, isMe) {
    const row = document.createElement('div');
    row.className = `flex w-full mb-3 px-4 ${isMe ? 'justify-end' : 'justify-start'}`;
    row.setAttribute('data-msg-id', msg.id);

    // Styles adaptatifs
    const bubbleClass = isMe 
        ? 'bg-gradient-to-r from-indigo-600 to-blue-600 text-white rounded-2xl rounded-br-sm shadow-md' 
        : 'bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200 rounded-2xl rounded-bl-sm shadow-sm border border-slate-100 dark:border-slate-700';

    const time = new Date(msg.created_at).toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
    
    // Icônes de statut
    let statusIconHtml = '';
    if (isMe) {
        if (msg.is_read) {
            statusIconHtml = '<i class="fas fa-check-double text-[10px] ml-1 text-blue-300"></i>';
        } else {
            statusIconHtml = '<i class="fas fa-check text-[10px] ml-1 text-white/60"></i>';
        }
    }

    row.innerHTML = `
        <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} max-w-[75%]">
            <div class="${bubbleClass} px-4 py-2 text-sm leading-relaxed break-words">
                ${msg.content}
            </div>
            <span class="text-[10px] text-slate-400 dark:text-slate-500 mt-1 mx-1 flex items-center">
                ${time} ${statusIconHtml}
            </span>
        </div>
    `;
    
    // Ajout des écouteurs pour le menu contextuel (Voir point 3)
    addContextMenuListeners(row, msg);
    
    return row;
}

// 2. Envoyer un message (UI Optimiste)
async function sendChatMessage(e) {
    if(e) e.preventDefault();
    
    const input = document.getElementById('chat-input');
    const content = input.value.trim();
    
    // Sécurité : pas de contenu ou pas de chat ouvert
    if (!content || !currentChatId) return;

    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return;

    // --- 1. GESTION DU MODE ÉDITION ---
    // Si on est en train de modifier un message existant
    if (window.isEditingId) {
        const { error } = await supabaseClient
            .from('messages')
            .update({ content: content })
            .eq('id', window.isEditingId);

        if (!error) {
            // Mise à jour visuelle immédiate dans le chat
            const msgEl = document.querySelector(`[data-msg-id="${window.isEditingId}"] .break-words`);
            if (msgEl) {
                msgEl.innerText = content;
                // Ajouter indicateur "modifié" si nécessaire
            }
            showToast("Message modifié", "success");
        } else {
            showToast("Erreur modification", "error");
        }
        
        // Reset du mode édition et champ
        window.isEditingId = null;
        input.value = '';
        toggleChatSendButton(); // Remet l'icône micro
        return;
    }

    // --- 2. GESTION DU MODE RÉPONSE ---
    const replyContainer = document.getElementById('reply-container');
    const isReplying = replyContainer && !replyContainer.classList.contains('hidden');
    
    // Réinitialisation immédiate de l'UI (Input + Bouton + Réponse)
    input.value = ''; 
    toggleChatSendButton(); // Remet l'icône micro
    if (isReplying) cancelReply(); // Cache la barre de réponse

    // --- 3. AFFICHAGE OPTIMISTE (Message temporaire) ---
    const tempId = 'temp-' + Date.now();
    const tempMsg = {
        id: tempId,
        sender_id: user.id, // Nécessaire pour createMessageBubble
        content: content,
        created_at: new Date().toISOString(),
        is_read: false
    };

    const container = document.getElementById('chat-messages-container');
    
    // Appel correct de createMessageBubble avec les 3 arguments
    const row = createMessageBubble(tempMsg, true, user.id); 
    
    // Style "En cours d'envoi"
    row.classList.add('opacity-60', 'animate-pulse'); 
    row.setAttribute('data-temp-id', tempId); // Marqueur pour le retrouver via le Realtime
    
    container.appendChild(row);
    container.scrollTop = container.scrollHeight;

    // --- 4. ENVOI RÉEL SUPABASE ---
    const { error } = await supabaseClient
        .from('messages')
        .insert([{
            chat_id: currentChatId,
            sender_id: user.id,
            content: content,
            // Si vous avez une colonne 'reply_to' dans votre table :
            // reply_to: isReplying ? selectedMessageForContext?.id : null 
        }]);

    if (error) {
        console.error("Erreur envoi:", error);
        showToast("Erreur d'envoi", "error");
        
        // En cas d'erreur, on arrête l'animation et on marque le message
        row.classList.remove('opacity-60', 'animate-pulse');
        row.classList.add('bg-red-100', 'dark:bg-red-900/30'); // Couleur erreur
        row.querySelector('.break-words').innerHTML += '<br><span class="text-red-500 text-xs">Échec de l\'envoi</span>';
    }
    
    // Si succès, le Listener Realtime (INSERT) détectera le nouveau message,
    // remplacera l'ID temporaire par le vrai ID et enlèvera l'opacité.
}

/* ==========================================================
   SECTION 2 : NOTIFICATIONS (TEMPS RÉEL & BADGES)
   ========================================================== */

// 1. Initialisation du Listener Temps Réel (À appeler au démarrage de l'app)
function initRealtimeNotifications() {
    supabaseClient
        .channel('realtime:notifications')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications' }, payload => {
            const notif = payload.new;
            // Vérifier si c'est pour moi
            if (notif.recipient_id === supabaseClient.auth.user()?.id) {
                updateNotificationBadge(); // MAJ badge
                showToast("🔔 Nouvelle notification !", "success");
            }
        })
        .subscribe();
}

// 2. Charger les notifications (Render Optimisé)
async function loadNotifications() {
    const container = document.getElementById('notifications-list-container');
    if (!container) return;

    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return;

    // Loader simple
    container.innerHTML = `<div class="text-center py-10 text-slate-400"><i class="fas fa-spinner fa-spin"></i></div>`;

    try {
        const { data: notifs, error } = await supabaseClient
            .from('notifications')
            .select(`*, profiles ( full_name, avatar_url )`)
            .eq('recipient_id', user.id)
            .order('created_at', { ascending: false })
            .limit(50); // Limite pour perf

        if (error) throw error;

        if (!notifs || notifs.length === 0) {
            container.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-slate-400"><i class="far fa-bell-slash text-4xl mb-3 opacity-20"></i><p>Aucune notification.</p></div>`;
            return;
        }

        container.innerHTML = notifs.map(notif => {
            const actor = notif.profiles || {};
            const avatar = actor.avatar_url || 'https://api.dicebear.com/7.x/avataaars/svg?seed=Felix';
            const name = actor.full_name || 'Utilisateur';
            
            // Logique d'icône et message
            const config = {
                'like': { icon: 'fa-heart', color: 'text-red-500', msg: 'a aimé votre publication.' },
                'comment': { icon: 'fa-comment', color: 'text-blue-500', msg: `a commenté : "${notif.content_preview || '...'}"` },
                'follow': { icon: 'fa-user-plus', color: 'text-green-500', msg: 'a commencé à vous suivre.' }
            };
            const { icon, color, msg } = config[notif.type] || { icon: 'fa-bell', color: 'text-slate-500', msg: 'Nouvelle interaction.' };

            const bgClass = notif.is_read ? 'bg-white dark:bg-slate-900' : 'bg-indigo-50 dark:bg-slate-800 border-l-4 border-indigo-500';

            return `
            <div class="flex items-center gap-4 p-4 border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer transition ${bgClass}">
                <img src="${avatar}" class="w-12 h-12 rounded-full object-cover shadow-sm">
                <div class="flex-1">
                    <p class="text-sm text-slate-800 dark:text-slate-200">
                        <span class="font-bold">${name}</span> ${msg}
                    </p>
                    <span class="text-[10px] text-slate-400">${getTimeAgo(new Date(notif.created_at))}</span>
                </div>
                <i class="fas ${icon} ${color} opacity-50"></i>
            </div>`;
        }).join('');

    } catch (err) {
        console.error("Erreur notifs:", err);
    }
}

// 3. Badge de Notification (Lecture rapide HEAD)
async function updateNotificationBadge() {
    const badge = document.getElementById('notif-badge-count');
    if (!badge) return;
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return;

    const { count } = await supabaseClient
        .from('notifications')
        .select('*', { count: 'exact', head: true })
        .eq('recipient_id', user.id)
        .eq('is_read', false);

    if (count && count > 0) {
        badge.innerText = count > 99 ? '99+' : count;
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
}

/* ==========================================================
   SECTION 3 : UTILITAIRES & CONTENU
   ========================================================== */

// Validation de contenu (Version améliorée avec liste)
function containsInappropriateContent(text) {
    if (!text) return false;
    const lowerText = text.toLowerCase();
    // Liste simple (à enrichir ou utiliser une API externe pour un vrai projet)
    const forbiddenWords = ['connard', 'merde', 'putain', 'idiot', 'bastard', 'asshole']; 
    return forbiddenWords.some(word => lowerText.includes(word));
}

/* --- RAFRAÎCHISSEMENT DU STATUT EN LIGNE --- */
/* --- LIRE LE STATUT DE L'AUTRE --- */
async function refreshChatStatus(userId) {
    const statusText = document.getElementById('chat-header-status-text');
    const statusDot = document.getElementById('chat-status-dot');
    
    if (!statusText || !userId) return;

    try {
        // On récupère ONLY last_seen pour la performance
        const { data: profile, error } = await supabaseClient
            .from('profiles')
            .select('last_seen')
            .eq('id', userId)
            .maybeSingle();

        if (error || !profile) {
             statusText.innerText = "Hors ligne";
             statusText.className = "text-[11px] text-slate-400";
             if(statusDot) statusDot.classList.add('hidden');
             return;
        }

        const lastSeen = profile.last_seen;
        
        // Si pas de date, on considère hors ligne
        if (!lastSeen) {
             statusText.innerText = "Hors ligne";
             if(statusDot) statusDot.classList.add('hidden');
             return;
        }

        const now = new Date();
        const lastDate = new Date(lastSeen);
        const diffSeconds = Math.floor((now - lastDate) / 1000);

        // LOGIQUE STRICTE : Si actif il y a moins de 2 min (120s)
        if (diffSeconds < 120) { 
            statusText.innerText = "En ligne";
            statusText.className = "text-[11px] text-emerald-400 font-semibold"; // Vert
            if(statusDot) {
                statusDot.classList.remove('hidden');
                statusDot.className = "absolute bottom-0 right-0 w-3 h-3 bg-emerald-400 rounded-full border-2 border-white dark:border-slate-900 animate-pulse";
            }
        } else {
            statusText.innerText = getTimeAgoSimple(lastDate);
            statusText.className = "text-[11px] text-slate-400";
            if(statusDot) statusDot.classList.add('hidden');
        }

    } catch (err) {
        console.error("Erreur refreshChatStatus:", err);
    }
}

// Helper pour le temps (ex: "il y a 5 min")
function getTimeAgoSimple(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    if (seconds < 60) return "À l'instant";
    if (seconds < 3600) return `il y a ${Math.floor(seconds / 60)} min`;
    if (seconds < 86400) return `il y a ${Math.floor(seconds / 3600)} h`;
    return `le ${date.toLocaleDateString('fr-FR')}`;
}

// Recherche Toggle (UX Pro)
function toggleSearch() {
    const searchBar = document.getElementById('feed-search-bar');
    const searchInput = document.getElementById('feed-search-input');
    
    if (searchBar.classList.contains('hidden')) {
        searchBar.classList.remove('hidden');
        searchBar.style.opacity = '0';
        searchBar.style.transform = 'translateY(-10px)';
        // Animation d'apparition
        requestAnimationFrame(() => {
            searchBar.style.transition = 'all 0.3s ease';
            searchBar.style.opacity = '1';
            searchBar.style.transform = 'translateY(0)';
            searchInput.focus();
        });
    } else {
        searchBar.style.opacity = '0';
        searchBar.style.transform = 'translateY(-10px)';
        setTimeout(() => {
            searchBar.classList.add('hidden');
            searchInput.value = ''; 
            searchFeed(''); // Reset feed
        }, 300);
    }
}

            /* --- METTRE À JOUR MA PRÉSENCE --- */
/* --- METTRE À JOUR MA PRÉSENCE (JE SUIS EN LIGNE) --- */
async function updateMyPresence() {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return;

    // On met à jour notre profil avec l'heure actuelle
    try {
        await supabaseClient
            .from('profiles')
            .update({ last_seen: new Date().toISOString() })
            .eq('id', user.id);
    } catch (err) {
        console.warn("Impossible de mettre à jour la présence :", err.message);
    }
}

// Lancer cette mise à jour toutes les 30 secondes pour rester "En ligne"
setInterval(updateMyPresence, 30000); 
// Et l'appeler une fois au chargement
updateMyPresence(); 
            /* ==========================================================
   FONCTIONS MANQUANTES POUR LE CHAT (BADGE & LECTURE)
   ========================================================== */

// 1. Mettre à jour le badge rouge de message (Dock & Header)
async function updateMessageBadge() {
    const badge = document.getElementById('msg-badge-count');
    if (!badge) return;

    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return;

    try {
        // A. Récupérer tous mes chats
        const { data: myChats } = await supabaseClient
            .from('chats')
            .select('id')
            .or(`user_1_id.eq.${user.id},user_2_id.eq.${user.id}`);

        if (!myChats || myChats.length === 0) {
            badge.classList.add('hidden');
            return;
        }

        const myChatIds = myChats.map(c => c.id);

        // B. Compter les messages NON LUS envoyés par les AUTRES
        const { count } = await supabaseClient
            .from('messages')
            .select('*', { count: 'exact', head: true }) // head: true pour perf (pas de body)
            .in('chat_id', myChatIds)
            .neq('sender_id', user.id) // Pas les miens
            .eq('is_read', false);     // Non lus

        const unreadCount = count || 0;

        // C. Affichage du badge
        if (unreadCount > 0) {
            badge.innerText = unreadCount > 99 ? '99+' : unreadCount;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }

    } catch (err) {
        console.error("Erreur updateMessageBadge:", err);
    }
}

// 2. Marquer une conversation comme lue (quand on l'ouvre)
async function markChatAsRead(chatId) {
    const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
    
    if (authError || !user) {
        console.error("Utilisateur non authentifié");
        return;
    }

    try {
        const { error } = await supabaseClient
            .from('messages')
            .update({ is_read: true })
            .match({ 
                chat_id: chatId, 
                is_read: false 
            })
            .neq('sender_id', user.id);

        if (error) throw error;

        // Mise à jour de l'UI locale
        if (typeof updateMessageBadge === 'function') {
            await updateMessageBadge();
        }
        
    } catch (err) {
        console.error("Erreur markChatAsRead:", err.message);
    }
}

            /* --- FONCTION TOAST POUR MESSAGE ENTRANT (STYLE FACEBOOK) --- */
function showIncomingMessageToast(senderName, messagePreview, avatarUrl, chatId, senderId) {
    const container = document.getElementById('toast-container');
    
    // Création du toast spécial
    const toast = document.createElement('div');
    toast.className = 'toast incoming-message cursor-pointer hover:scale-[1.02] transition-transform';
    toast.style.background = 'white';
    toast.style.borderLeft = '4px solid #3b82f6'; // Bleu pour message
    toast.style.minWidth = '280px';
    
    // Date formatée
    const time = new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});

    // HTML interne du Toast
    toast.innerHTML = `
        <div class="flex items-center gap-3 p-2" onclick="handleToastClick('${chatId}', '${senderId}')">
            <div class="relative">
                <img src="${avatarUrl}" class="w-12 h-12 rounded-full object-cover border-2 border-slate-100 shadow-sm">
                <div class="absolute -bottom-1 -right-1 bg-blue-500 text-white rounded-full p-1">
                    <i class="fas fa-comment text-[8px]"></i>
                </div>
            </div>
            <div class="flex-1 overflow-hidden">
                <p class="text-sm font-bold text-slate-900 truncate">${senderName}</p>
                <p class="text-xs text-slate-500 truncate">${messagePreview}</p>
                <span class="text-[10px] text-slate-400">${time}</span>
            </div>
        </div>
    `;

    container.appendChild(toast);

    // Auto-suppression après 5 secondes
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s forwards';
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

// Fonction utilitaire pour gérer le clic sur le Toast
async function handleToastClick(chatId, senderId) {
    // 1. Fermer le toast cliqué
    event.currentTarget.closest('.toast').remove();
    
    // 2. Ouvrir la discussion
    // Si la fonction startChat existe (pour créer/récupérer le chat)
    if (typeof startChat === 'function') {
        await startChat(senderId);
    } else {
        // Sinon ouvrir directement la room si on a déjà l'ID
        openChatRoom(chatId, senderId);
    }
}
            
// Initialisation à ajouter dans votre DOMContentLoaded
// initRealtimeNotifications(); // Lancer le realtime au démarrage

// 2. Fonction pour filtrer les posts en temps réel (Recherche Facebook-like)
document.getElementById('feed-search-input')?.addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();
    searchFeed(query);
});

// REMPLACEZ L'ANCIENNE FONCTION PAR CECI
async function searchFeed(query) {
    const container = document.getElementById('global-feed-container');
    
    // 1. Gestion du Debounce (Anti-spam)
    // On annule la recherche précédente si l'utilisateur tape vite
    clearTimeout(searchDebounceTimer);
    
    searchDebounceTimer = setTimeout(async () => {
        // 2. Si le champ est vide, on recharge le feed normal
        if (!query || query.trim() === '') {
            return loadGlobalFeed('recent', 'all', false);
        }

        // 3. Affichage du Loader
        container.innerHTML = `
            <div class="col-span-full flex justify-center py-20">
                <div class="flex items-center gap-2 text-slate-400 text-sm font-bold">
                    <i class="fas fa-circle-notch fa-spin text-indigo-500"></i>
                    Recherche en cours...
                </div>
            </div>`;

        try {
            // 4. Requête Supabase (Recherche dans le CAPTION)
            // Le symbole % est un joker SQL : %mot% signifie "contient mot"
            const { data: posts, error } = await supabaseClient
                .from('posts')
                .select(`
                    *,
                    profiles ( id, full_name, username, avatar_url, is_certified ),
                    post_likes(count),
                    post_comments(count)
                `)
                .ilike('caption', `%${query}%`) // Recherche insensible à la casse
                .order('created_at', { ascending: false })
                .limit(30);

            if (error) throw error;

            // 5. Gestion "Aucun résultat"
            if (!posts || posts.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-20 text-slate-400">
                        <i class="fas fa-search text-4xl mb-3 opacity-20"></i>
                        <p class="font-bold">Aucun résultat pour "<span class="text-indigo-600">${query}</span>"</p>
                        <p class="text-xs mt-1">Essayez avec d'autres mots-clés.</p>
                    </div>`;
                return;
            }

            // 6. Rendu des résultats (Pro)
            const { data: { user } } = await supabaseClient.auth.getUser();
            const myId = user?.id;

            container.innerHTML = posts.map(post => {
                const profile = post.profiles || {};
                const avatarUrl = profile.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${profile.username || 'user'}`;
                const userName = profile.full_name || 'Utilisateur';
                const timeAgo = typeof getTimeAgo === 'function' ? getTimeAgo(new Date(post.created_at)) : '';
                const likeCount = post.post_likes?.[0]?.count || 0;
                const commentCount = post.post_comments?.[0]?.count || 0;
                
                // Sécurité pour l'affichage du texte
                const safeCaption = post.caption ? post.caption.replace(/</g, "&lt;").replace(/>/g, "&gt;") : '';

                return `
                <article class="bg-white dark:bg-black border border-black/5 dark:border-white/10 rounded-lg overflow-hidden mb-2 transition-all hover:shadow-xl">
                    <!-- HEADER -->
                    <div class="p-4 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <img src="${avatarUrl}" class="w-11 h-11 rounded-full border-2 border-indigo-50 shadow-sm">
                            <div>
                                <div class="flex items-center gap-1 font-bold text-sm text-slate-900 dark:text-white">
                                    ${userName} ${profile.is_certified ? '<i class="fas fa-check-circle text-blue-500 text-[10px]"></i>' : ''}
                                </div>
                                <div class="text-[11px] text-slate-400 font-medium">${timeAgo}</div>
                            </div>
                        </div>
                    </div>

                    <!-- CAPTION -->
                    <div class="px-4 pb-2">
                        <p class="text-sm text-slate-700 dark:text-slate-300 leading-relaxed">
                            ${safeCaption}
                        </p>
                    </div>

                    <!-- MEDIA -->
                    ${post.image_url ? `<img src="${post.image_url}" class="w-full h-auto object-cover" loading="lazy">` : ''}

                    <!-- ACTIONS SIMPLIFIEES (Pour un resultat de recherche, on peut simplifier) -->
                    <div class="px-4 py-2 flex items-center justify-between border-t border-slate-50 dark:border-slate-800">
                        <div class="flex items-center gap-4 text-slate-500 text-xs font-bold">
                            <span><i class="far fa-heart text-red-500 mr-1"></i> ${likeCount}</span>
                            <span><i class="far fa-comment text-blue-500 mr-1"></i> ${commentCount}</span>
                        </div>
                        <button onclick="openPostModal('${post.id}')" class="text-xs font-bold text-indigo-600 hover:underline">Voir détails</button>
                    </div>
                </article>
                `;
            }).join('');

        } catch (err) {
            console.error("Erreur recherche:", err);
            container.innerHTML = `<div class="col-span-full text-center py-10 text-red-500"><p>Erreur lors de la recherche.</p></div>`;
        }

    }, 400); // Délai de 400ms avant de lancer la recherche
}
        async function reportPost(postId) {
    const reason = prompt("Pourquoi signalez-vous cette publication ? (Haine, Arnaque, Pornographie, Autre)");
    if (!reason) return;

    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return showToast("Connectez-vous pour signaler.", "error");

    // Envoi dans une table 'reports' (à créer dans Supabase)
    await supabaseClient.from('reports').insert([{
        reporter_id: user.id,
        post_id: postId,
        reason: reason,
        status: 'pending' // En attente de modération
    }]);

    showToast("Signalement envoyé aux modérateurs.", "success");
}

let openReactionsPopupId = null;

function toggleReactionPopup(postId, btnElement) {
    // Si on clique sur un bouton du menu (dans le cas d'une sélection directe via le menu)
    if (btnElement && btnElement.dataset.type) {
        setReaction(postId, btnElement.dataset.type);
        closeReactionPopup(postId);
        return;
    }

    // Logique d'ouverture/fermeture standard...
    const popup = document.getElementById(`reactions-popup-${postId}`);
    
    if (popup.style.display === 'flex') {
        closeReactionPopup(postId);
    } else {
        document.querySelectorAll('.reactions-popup').forEach(el => el.style.display = 'none');
        
        // Génération HTML (Boutons Facebook Style)
        popup.innerHTML = REACTIONS.map(r => `
            <div class="reaction-btn" data-type="${r.type}" onclick="setReaction('${postId}', '${r.type}', this)">
                <i class="fas ${r.icon}"></i>
            </div>
        `).join('');
        
        popup.style.display = 'flex';
        openReactionsPopupId = postId;
    }
}

function closeReactionPopup(postId) {
    const popup = document.getElementById(`reactions-popup-${postId}`);
    if (popup) popup.style.display = 'none';
    openReactionsPopupId = null;
}

// Fonction de mise à jour du style (Remplacez l'ancienne setReaction)
async function setReaction(postId, reactionType, btnElement) {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) {
        showToast("Connectez-vous pour réagir", "warning");
        return;
    }

    try {
        // 1. Vérifier si une réaction existe déjà
        const { data: existingReaction } = await supabaseClient
            .from('post_likes')
            .select('*')
            .eq('post_id', postId)
            .eq('user_id', user.id)
            .maybeSingle();

        // 2. Logique de changement
        if (existingReaction) {
            if (existingReaction.reaction_type === reactionType) {
                // On annule la réaction (Toggle OFF)
                const { error } = await supabaseClient
                    .from('post_likes')
                    .delete()
                    .match({ post_id: postId, user_id: user.id });
                
                if (error) throw error;

                // On supprime de la mémoire locale
                userReactions.delete(postId);
                updateMainIcon(postId, null);
            } else {
                // On change de type (ex: Heart -> Support)
                const { error } = await supabaseClient
                    .from('post_likes')
                    .update({ reaction_type: reactionType })
                    .match({ id: existingReaction.id });
                
                if (error) throw error;

                // On met à jour la mémoire locale
                userReactions.set(postId, reactionType);
                updateMainIcon(postId, reactionType);
            }
            
            // ---> C'EST ICI LE POINT CRITIQUE <---
            // On ferme le menu dès que l'action est réussie
            closeReactionPopup(postId);
            // --------------------------------
            
            showToast("Mise à jour effectuée", "success");

        } else {
            // Nouvelle réaction (Insertion)
            const { error } = await supabaseClient
                .from('post_likes')
                .insert([{
                    post_id: postId,
                    user_id: user.id,
                    reaction_type: reactionType
                }]);

            if (error) throw error;

            // On sauvegarde dans la Map
            userReactions.set(postId, reactionType);
            updateMainIcon(postId, reactionType);
            
            // ---> C'EST ICI LE POINT CRITIQUE <---
            // On ferme le menu dès que l'action est réussie
            closeReactionPopup(postId); // Note: postId suffit comme argument si la fonction gère l'ID
            // ----------------------------------
            
            showToast("Réaction enregistrée", "success");
        }

    } catch (err) {
        console.error("Erreur Réaction:", err);
        showToast("Erreur lors de la mise à jour", "danger");
    }
}

// Fonction helper pour mettre à jour l'icône principale
function updateMainIcon(postId, reactionType) {
    const icon = document.getElementById(`icon-react-${postId}`);
    
    if (!icon) return;
    
    // Si reactionType est null, on revient au style par défaut (Cœur vide ou Plein selon votre logique de likes)
    // Ici, pour simplifier, on revient à "Cœur Vide" (far fa-heart)
    if (!reactionType) {
        // Note : Si vous voulez qu'il affiche un cœur PLEIN quand l'user a liké, il faudrait vérifier 'like' explicitement
        icon.className = "far fa-heart text-slate-400 text-xl group-active:scale-125 transition-transform";
    } else {
        // Récupérer le style associé au type (Ex: Support -> Pink Heart)
        const style = REACTION_STYLES[reactionType];
        // On applique la nouvelle classe (Icon + Couleur)
        icon.className = `fas ${style.icon} ${style.color} text-xl group-active:scale-125 transition-transform`;
    }
}
/* --- 3. TAGS & MENTIONS (Highlighting) --- */
function formatTextWithHighlights(text) {
    if (!text) return '';

    // 1. Protection XSS basique (Remplacer < et > par des entités HTML)
    let safeText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");

    // 2. Remplacer les Mentions (@user)
    safeText = safeText.replace(/@(\w+)/g, '<span class="mention-highlight">@$1</span>');

    // 3. Remplacer les Tags (#hashtag)
    safeText = safeText.replace(/#(\w+)/g, '<span class="hashtag-highlight">#$1</span>');

    return safeText;
}

/* --- 4. MODE ZEN (LECTURE VIDÉO) --- */
function openZenMode(url) {
    // On utilise l'élément HTML existant au lieu d'en créer un nouveau
    const modal = document.getElementById('zen-mode-modal');
    const video = document.getElementById('zen-video-player');
    
    if (!modal || !video) {
        console.error("Element Zen Mode introuvable");
        return;
    }

    video.src = url;
    modal.classList.add('active'); // Affiche le modal via CSS
    document.body.style.overflow = 'hidden'; // Bloque le scroll du corps
    
    // Lecture automatique
    video.play().catch(e => console.log("Autoplay bloqué par le navigateur", e));
}

function closeZenMode() {
    const modal = document.getElementById('zen-mode-modal');
    const video = document.getElementById('zen-video-player');
    
    if (video) {
        video.pause();
        video.src = ''; // Vide la source pour arrêter le chargement
    }
    
    if (modal) {
        modal.classList.remove('active');
    }
    
    document.body.style.overflow = 'auto'; // Réactive le scroll
}

// --- VARIABLES GLOBALES MODALE ---
let currentModalPostId = null;

// --- NOUVELLE VERSION ROBUSTE OPEN POST MODAL ---
async function openPostModal(postId) {
    console.log("Ouverture modale pour:", postId);
    const overlay = document.getElementById('post-modal-overlay');
    if (!overlay) return;

    // 1. On affiche le conteneur immédiatement avec un style inline fort
    overlay.classList.remove('hidden');
    overlay.classList.add('active');
    overlay.style.cssText = "display: flex !important; opacity: 1 !important; z-index: 99999 !important; pointer-events: auto !important;";
    
    // 2. On bloque le scroll du body
    document.body.style.overflow = 'hidden';

    // 3. On injecte un loader le temps du chargement
    overlay.innerHTML = `<div class="w-full h-full flex items-center justify-center bg-black/90"><i class="fas fa-spinner fa-spin text-4xl text-white"></i></div>`;

    try {
        // Récupération des données
        const { data: { user } } = await supabaseClient.auth.getUser();
        const { data: post, error } = await supabaseClient.from('posts').select('*').eq('id', postId).single();
        if (error) throw error;

        const { data: profile } = await supabaseClient.from('profiles').select('*').eq('id', post.user_id).single();
        currentModalPostId = postId;
        const isMyPost = (user && user.id === post.user_id);

        // 4. Injection du HTML final
        // Note: J'ai réduit les arrondis ici aussi pour la modale (rounded-2xl au lieu de 3xl)
        overlay.innerHTML = `
            <div class="bg-white dark:bg-slate-900 w-full max-w-5xl h-[90vh] rounded-2xl flex flex-col md:flex-row overflow-hidden shadow-2xl relative" onclick="event.stopPropagation()">
                
                <!-- PARTIE GAUCHE : MEDIA -->
                <div class="flex-1 bg-black flex items-center justify-center relative">
                    ${post.is_short && post.video_url 
                        ? `<video src="${post.video_url}" controls autoplay class="max-h-full max-w-full"></video>` 
                        : `<img src="${post.image_url}" class="max-h-full max-w-full object-contain">`
                    }
                </div>

                <!-- PARTIE DROITE : INFOS -->
                <div class="w-full md:w-[400px] flex flex-col border-l border-slate-100 dark:border-slate-700">
                    <!-- Header -->
                    <div class="p-4 border-b dark:border-slate-700 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <img src="${profile?.avatar_url || 'https://api.dicebear.com/7.x/avataaars/svg'}" class="w-10 h-10 rounded-full">
                            <div>
                                <div class="font-bold text-sm text-slate-900 dark:text-white">${profile?.full_name || 'Utilisateur'}</div>
                                <div class="text-xs text-slate-400">${typeof getTimeAgo === 'function' ? getTimeAgo(new Date(post.created_at)) : ''}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 relative">
                            <button onclick="toggleModalMenu()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                            <div id="modal-dropdown-menu" class="post-dropdown-menu hidden absolute top-10 right-0 bg-white dark:bg-slate-800 shadow-xl rounded-lg w-48 py-1 border dark:border-slate-700 z-50"></div>
                            <button onclick="closePostModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <!-- Corps -->
                    <div id="modal-comments-container" class="flex-1 overflow-y-auto p-4">
                        <p class="text-sm mb-4 text-slate-700 dark:text-slate-300">
                            <span class="font-bold text-slate-900 dark:text-white mr-2">${profile?.full_name || 'User'}</span> 
                            ${post.caption || ''}
                        </p>
                        <div id="modal-comments-list" class="space-y-3 text-sm"></div>
                    </div>
                    <!-- Footer -->
                    <div class="p-4 border-t dark:border-slate-700">
                        <form onsubmit="submitModalComment(event)" class="flex items-center gap-2">
                            <input type="text" id="modal-comment-input" placeholder="Commenter..." class="flex-1 text-sm outline-none bg-transparent">
                            <button type="submit" class="text-indigo-600 font-bold text-xs">Envoyer</button>
                        </form>
                    </div>
                </div>
            </div>
        `;
        
        renderModalMenu(isMyPost, post.user_id);

    } catch (err) {
        console.error("Erreur modale:", err);
        closePostModal();
        showToast("Impossible de charger cette publication", "error");
    }
}

// 2. Fermer la modale
function closePostModal() {
    const overlay = document.getElementById('post-modal-overlay');
    if (overlay) {
        overlay.classList.remove('active');
        overlay.classList.add('hidden');
        overlay.innerHTML = ''; 
    }
    document.body.style.overflow = 'auto';
}

// 3. Générer le menu (FONCTION MANQUANTE CORRIGÉE)
function renderModalMenu(isOwner, targetUserId) {
    const menu = document.getElementById('modal-dropdown-menu');
    if (!menu) return;

    if (isOwner) {
        menu.innerHTML = `
            <div onclick="deletePostAction()" class="post-dropdown-item danger">
                <i class="fas fa-trash-alt"></i> Supprimer
            </div>`;
    } else {
        menu.innerHTML = `
            <div onclick="reportPostAction()" class="post-dropdown-item danger">
                <i class="fas fa-flag"></i> Signaler
            </div>`;
    }
}

// 4. Actions simples
function toggleModalMenu() {
    const menu = document.getElementById('modal-dropdown-menu');
    if(menu) menu.classList.toggle('hidden');
}

async function deletePostAction() {
    if (!confirm("Supprimer ?")) return;
    await supabaseClient.from('posts').delete().eq('id', currentModalPostId);
    showToast("Supprimé", "success");
    closePostModal();
    if(typeof loadGlobalFeed === 'function') loadGlobalFeed();
}

function reportPostAction() {
    showToast("Signalé", "success");
    closePostModal();
}

async function submitModalComment(e) {
    e.preventDefault();
    const input = document.getElementById('modal-comment-input');
    const content = input.value.trim();
    if(!content) return;
    
    const { data: { user } } = await supabaseClient.auth.getUser();
    await supabaseClient.from('post_comments').insert([{ user_id: user.id, post_id: currentModalPostId, content: content }]);
    input.value = '';
    showToast("Commenté", "success");
    openPostModal(currentModalPostId); // Recharge
}

// 5. Attacher les fonctions au window pour être sûr qu'elles sont accessibles globalement
window.openPostModal = openPostModal;
window.closePostModal = closePostModal;
window.toggleModalMenu = toggleModalMenu;
window.deletePostAction = deletePostAction;
window.reportPostAction = reportPostAction;
window.submitModalComment = submitModalComment;

            function handleSortClick(element, filterType) {
    const allButtons = document.querySelectorAll('.sort-btn');
    
    allButtons.forEach(btn => {
        // Reset Styles : Gris + Carré/Cercle (px-3 pour icône seule)
        btn.classList.remove('bg-blue-50', 'text-blue-600', 'dark:bg-blue-900/30', 'dark:text-blue-400');
        btn.classList.add('bg-slate-100', 'text-slate-600', 'dark:bg-slate-800', 'dark:text-slate-300');
        btn.classList.replace('px-4', 'px-3'); 
        
        const textSpan = btn.querySelector('.btn-text');
        if (textSpan) textSpan.classList.add('hidden');
    });

    // Active Style : Bleu + Largeur auto (px-4 pour texte + icône)
    element.classList.remove('bg-slate-100', 'text-slate-600', 'dark:bg-slate-800', 'dark:text-slate-300');
    element.classList.add('bg-blue-50', 'text-blue-600', 'dark:bg-blue-900/30', 'dark:text-blue-400');
    element.classList.replace('px-3', 'px-4');

    const activeText = element.querySelector('.btn-text');
    if (activeText) activeText.classList.remove('hidden');

    // Appel des fonctions de tri
    filterType === 'shorts' ? filterFeed('shorts') : sortFeed(filterType);
}
            // --- CHARGER LES INFOS DANS LE MENU SIDEBAR ---
async function loadSidebarUser() {
    try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { data: profile } = await supabaseClient
            .from('profiles')
            .select('full_name, avatar_url')
            .eq('id', user.id)
            .single();

        if (profile) {
            const imgEl = document.getElementById('sidebar-avatar');
            const nameEl = document.getElementById('sidebar-username');

            if (imgEl) {
                imgEl.src = profile.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(profile.full_name || 'User')}&background=e2e8f0&color=64748b`;
            }
            if (nameEl) {
                nameEl.innerText = profile.full_name || 'Utilisateur';
            }
        }
    } catch (e) {
        console.error("Erreur chargement sidebar user:", e);
    }
}
            async function blockUser(targetUserId) {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return;

    const { error } = await supabaseClient
        .from('blocked_users')
        .insert([{ blocker_id: user.id, blocked_id: targetUserId }]);

    if (!error) {
        showToast("Utilisateur bloqué", "success");
        // Optionnel : Retirer ses posts du feed actuel
        document.querySelectorAll(`[data-user-id="${targetUserId}"]`).forEach(el => el.remove());
    }
}
            /* --- GESTION DU BOUTON DYNAMIQUE (VOIX / ENVOI) --- */
function toggleChatSendButton() {
    const input = document.getElementById('chat-input');
    const voiceBtn = document.getElementById('voice-btn');
    const sendBtn = document.getElementById('send-btn');

    if (!input || !voiceBtn || !sendBtn) return;

    // Si du texte est tapé (longueur > 0)
    if (input.value.trim().length > 0) {
        voiceBtn.classList.add('hidden');      // Cache Micro
        sendBtn.classList.remove('hidden');    // Affiche Envoi
    } else {
        voiceBtn.classList.remove('hidden');   // Affiche Micro
        sendBtn.classList.add('hidden');       // Cache Envoi
    }
}
            async function sendChatMessage(e) {
    if(e) e.preventDefault();
    const input = document.getElementById('chat-input');
    const content = input.value.trim();
    
    if (!content || !currentChatId) return;

    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return;

    input.value = ''; 

    const tempId = 'temp-' + Date.now();
    
    // Création du message optimiste
    const tempMsg = {
        id: tempId,
        content: content,
        created_at: new Date().toISOString(),
        is_read: false // Forcé à false
    };

    const container = document.getElementById('chat-messages-container');
    
    // On utilise createMessageBubble, mais on ajoute une classe spéciale pour le retrouver
    const row = createMessageBubble(tempMsg, true); 
    row.classList.add('opacity-70'); // Légèrement transparent (envoi en cours)
    row.setAttribute('data-temp-id', tempId); // Marqueur temporaire
    
    container.appendChild(row);
    container.scrollTop = container.scrollHeight;

    // Envoi réel
    const { error } = await supabaseClient
        .from('messages')
        .insert([{
            chat_id: currentChatId,
            sender_id: user.id,
            content: content
        }]);

    if (error) {
        showToast("Erreur d'envoi", "error");
        row.classList.add('bg-red-50'); // Erreur visuelle
    } else {
        // Succès : on enlève la transparence.
        // Note: Le listener Realtime (INSERT) va remplacer cette bulle par la version définitive.
        row.classList.remove('opacity-70');
    }
}
            let longPressTimer = null;
let selectedMessage = null;

// 1. Fonction pour attacher les écouteurs (à appeler dans createMessageBubble)
function addContextMenuListeners(element, msg) {
    // Événements tactiles (Mobile)
    element.addEventListener('touchstart', (e) => {
        longPressTimer = setTimeout(() => {
            showContextMenu(e.touches[0].clientX, e.touches[0].clientY, msg);
            navigator.vibrate(50); // Petit retour haptique
        }, 500); // 500ms pour un appui long
    }, { passive: true });

    element.addEventListener('touchend', () => clearTimeout(longPressTimer));
    element.addEventListener('touchmove', () => clearTimeout(longPressTimer));
    
    // Événement souris (Desktop - Clic droit)
    element.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        showContextMenu(e.clientX, e.clientY, msg);
    });
}

// 2. Afficher le menu
function showContextMenu(x, y, msg) {
    selectedMessage = msg;
    
    // Supprimer l'ancien menu s'il existe
    const existing = document.querySelector('.context-menu');
    if (existing) existing.remove();

    const menu = document.createElement('div');
    menu.className = 'context-menu';
    
    // Positionnement intelligent (éviter de sortir de l'écran)
    menu.style.left = `${Math.min(x, window.innerWidth - 200)}px`;
    menu.style.top = `${Math.min(y, window.innerHeight - 200)}px`;

    // Contenu du menu
    menu.innerHTML = `
        <div class="context-menu-item" onclick="replyToMessage()">
            <i class="fas fa-reply text-blue-500"></i> Répondre
        </div>
        <div class="context-menu-item" onclick="copyMessage()">
            <i class="fas fa-copy text-slate-500"></i> Copier
        </div>
        <div class="context-menu-item" onclick="forwardMessage()">
            <i class="fas fa-share text-indigo-500"></i> Transférer
        </div>
        ${msg.sender_id === myId ? `
        <div class="context-menu-item" onclick="editMessage()">
            <i class="fas fa-pencil-alt text-orange-500"></i> Modifier
        </div>
        <div class="context-menu-item danger" onclick="deleteMessage()">
            <i class="fas fa-trash"></i> Supprimer
        </div>
        ` : ''}
    `;

    document.body.appendChild(menu);

    // Fermer si on clique ailleurs
    setTimeout(() => {
        document.addEventListener('click', closeContextMenu, { once: true });
    }, 10);
}

function closeContextMenu() {
    const menu = document.querySelector('.context-menu');
    if (menu) menu.remove();
}

// 3. Actions du Menu

// A. Répondre
function replyToMessage() {
    closeContextMenu();
    if (!selectedMessage) return;

    // Afficher la barre de réponse
    const replyContainer = document.getElementById('reply-container');
    const replyPreview = document.getElementById('reply-preview-text');
    
    replyPreview.innerText = selectedMessage.content.substring(0, 50);
    replyContainer.classList.remove('hidden');
    
    // Focus sur l'input
    document.getElementById('chat-input').focus();
}
function cancelReply() {
    document.getElementById('reply-container').classList.add('hidden');
    selectedMessage = null; // On réinitialise la sélection pour l'envoi
}

// B. Copier
function copyMessage() {
    closeContextMenu();
    if (!selectedMessage) return;
    navigator.clipboard.writeText(selectedMessage.content);
    showToast("Message copié", "success");
}

// C. Supprimer
async function deleteMessage() {
    closeContextMenu();
    if (!selectedMessage) return;

    if (confirm("Supprimer ce message ?")) {
        // Option 1 : Suppression réelle (si autorisé par RLS)
        const { error } = await supabaseClient
            .from('messages')
            .delete()
            .eq('id', selectedMessage.id);
        
        if (!error) {
            // Suppression visuelle
            const el = document.querySelector(`[data-msg-id="${selectedMessage.id}"]`);
            if (el) el.innerHTML = '<div class="text-center text-slate-400 italic text-xs p-2">Message supprimé</div>';
            showToast("Supprimé", "success");
        } else {
            showToast("Erreur suppression", "error");
        }
    }
}

// D. Modifier (Basique - ouvre l'input avec le texte)
function editMessage() {
    closeContextMenu();
    if (!selectedMessage) return;
    
    const input = document.getElementById('chat-input');
    input.value = selectedMessage.content;
    input.focus();
    
    // On sauvegarde qu'on est en mode édition
    window.isEditing = selectedMessage.id;
    
    showToast("Modifiez le message et envoyez", "info");
}

// E. Transférer (Ouvre la liste des contacts)
function forwardMessage() {
    closeContextMenu();
    if (!selectedMessage) return;
    
    // Logique simple : on sauvegarde le message et on va sur la liste des chats
    window.forwardContent = selectedMessage.content;
    showToast("Sélectionnez un destinataire", "info");
    switchPage('messages');
}
          /* ==========================================================
   DÉFINITION DE LA FONCTION D'INITIALISATION (GLOBALE)
   ========================================================== */
/* ==========================================================
   DÉFINITION DE LA FONCTION D'INITIALISATION (CORRIGÉE)
   ========================================================== */
async function initialiserApplication() {
    try {
        console.log("Démarrage progressif...");

        // 1. Afficher la page d'accueil immédiatement
        const homeView = document.getElementById('home-view');
        if (homeView) {
            homeView.style.display = 'block'; 
            setTimeout(() => homeView.classList.add('active'), 50);
        }

        // 2. Fonction utilitaire d'attente
        const wait = ms => new Promise(res => setTimeout(res, ms));

        // 3. Fonction de chargement cadencé ET SÉCURISÉE
        const charger = async (nom, fonction, delai) => {
            try {
                await wait(delai);
                await fonction();
                console.log(`✅ ${nom} chargé`);
            } catch (e) {
                // CORRECTION : On ignore l'erreur 'AbortError' (signifie juste qu'on a quitté la page)
                if (e.name === 'AbortError') {
                    console.log(`ℹ️ Chargement ${nom} annulé (navigation).`);
                    return;
                }
                console.warn(`⚠️ Échec ${nom}:`, e.message);
            }
        };

        // 4. Lancement des chargements
        await Promise.allSettled([
            charger("Sidebar", loadSidebarUser, 0),
            charger("Flux", loadGlobalFeed, 50),
            charger("Profil", loadSocialProfile, 150),
            charger("Notifs", loadNotifications, 300),
            charger("Messages", loadChatList, 450)
        ]);

    } catch (error) {
        // On ignore aussi ici les erreurs d'annulation globale
        if (error.name !== 'AbortError') {
            console.error("Erreur critique au démarrage :", error);
        }
    } finally {
        // 5. Afficher le contenu
        document.body.classList.remove('app-loading');
        await new Promise(resolve => requestAnimationFrame(() => requestAnimationFrame(resolve)));

        // 6. Cacher le loader
        const loader = document.getElementById('loader');
        if (loader) {
            loader.style.opacity = '0';
            setTimeout(() => { loader.style.display = 'none'; }, 500);
        }
    }
}

/* ==========================================================
   ÉCOUTEUR PRINCIPAL AU CHARGEMENT DE LA PAGE
   ========================================================== */
document.addEventListener('DOMContentLoaded', async () => {
    
    // --- 1. VÉRIFICATION DE SESSION ---
    const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();

    if (!session || sessionError) {
        console.log("Session expirée.");
        window.location.replace('login.html'); 
        return; 
    }

    // --- 2. CONFIGURATION INITIALE ---
    const savedLang = localStorage.getItem('printbam-lang') || 'fr';
    const langSelect = document.getElementById('language-select');
    if (langSelect) langSelect.value = savedLang;
    
    updateLanguage(savedLang);
    setTheme(localStorage.getItem('printbam-theme') || 'light', false);

    // --- 3. LANCEMENT DE L'APPLICATION ---
    await initialiserApplication();

    // --- 4. SERVICES D'ARRIERE-PLAN ---
    
    // A. Notifications globales (Realtime)
    if (typeof initGlobalRealtimeListeners === 'function') {
        initGlobalRealtimeListeners();
    }

    // B. Badges
    updateMessageBadge();
    updateNotificationBadge();

    // --- 5. FONCTIONNALITÉS D'INTERFACE ---

    // A. Scroll Infini
    if (typeof setupInfiniteScroll === 'function') {
        setupInfiniteScroll();
    }
    
    // B. Effets visuels
    if (typeof initScrollReveal === 'function') {
        initScrollReveal();
    }

    // C. Auto-Hide Header/Dock
    let lastScrollY = window.scrollY;
    window.addEventListener('scroll', () => {
        const currentScrollY = window.scrollY;
        const explorerBar = document.querySelector('.feed-sticky-header');
        const dock = document.querySelector('.mobile-dock');

        if (currentScrollY <= 10) return;

        if (currentScrollY > lastScrollY && currentScrollY > 50) {
            if (explorerBar) explorerBar.classList.add('nav-hidden');
            if (dock) dock.classList.add('nav-hidden');
        } else {
            if (explorerBar) explorerBar.classList.remove('nav-hidden');
            if (dock) dock.classList.remove('nav-hidden');
        }
        lastScrollY = currentScrollY;
    }, { passive: true });
    
    // D. Swipe Retour (Messages)
    const messagesView = document.getElementById('messages-view');
    if (messagesView) {
        let touchStartX = 0;
        messagesView.addEventListener('touchstart', function(event) {
            touchStartX = event.changedTouches[0].screenX;
        }, false);

        messagesView.addEventListener('touchend', function(event) {
            const touchEndX = event.changedTouches[0].screenX;
            if (touchStartX - touchEndX > 120) {
                switchPage('home');
            }
        }, false);
    }

    // ============================================================
    // --- E. GESTION DE LA PRÉSENCE EN LIGNE (STATUT) ---
    // ============================================================
    
    // 1. Mise à jour immédiate
    if (typeof updateMyPresence === 'function') {
        updateMyPresence(); 
    }

    // 2. Répétition toutes les 30 secondes
    setInterval(() => {
        if (typeof updateMyPresence === 'function') {
            updateMyPresence();
        }
    }, 30000);

    // 3. Mise à jour au retour sur l'onglet
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
            if (typeof updateMyPresence === 'function') {
                updateMyPresence();
            }
            updateMessageBadge();
        }
    });

});
            // --- ENREGISTREMENT PWA ---
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('✅ Service Worker enregistré', reg))
            .catch(err => console.error('❌ Erreur SW', err));
    });
}
</script>
</body>
</html>
