<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#f8fafc">
    <title>Printbam v3.5 Pro | Enterprise Cloud Printing</title>
    <link rel="apple-touch-icon" href="logo-printbam-icon2.png">
    <link rel="icon" type="image/png" href="print.png">
    <link rel="manifest" href="./manifest.json">
    <meta name="color-scheme" content="light dark">
    <meta name="description" content="Printbam est l'infrastructure d'impression cloud leader.">
    
    <!-- PRECHARGEMENT -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://checkout.flutterwave.com/v3.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --glass-bg: #ffffff;
            --glass-border: #e2e8f0;
            --accent-blue: #4f46e5;
            --accent-blue-hover: #4338ca;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --bg-body: #f8fafc;
            --shadow-soft: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --shadow-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --ease-elastic: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            transition: background-color 0.4s cubic-bezier(0.4, 0, 0.2, 1), color 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding-bottom: 90px;
        }
        @media (min-width: 769px) { body { padding-bottom: 0; } }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .bg-grid {
            position: fixed; inset: 0; z-index: -2;
            background-image: linear-gradient(to right, #e2e8f0 1px, transparent 1px), linear-gradient(to bottom, #e2e8f0 1px, transparent 1px);
            background-size: 48px 48px;
            mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
            opacity: 0.6;
            transition: opacity 0.5s ease;
        }

        .bg-glow {
            position: fixed; top: -20%; left: -10%; right: -10%; bottom: 0; z-index: -1;
            background: radial-gradient(circle at 50% 0%, #e0e7ff 0%, transparent 60%);
            opacity: 0.6;
            pointer-events: none;
        }

        .glass-header {
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: var(--shadow-soft);
            transition: padding 0.3s ease, box-shadow 0.3s ease;
        }

        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            border-radius: 16px;
            transition: transform 0.3s var(--ease-elastic), box-shadow 0.3s ease, border-color 0.3s ease;
            box-shadow: var(--shadow-soft);
        }

        .glass:hover { transform: translateY(-5px); border-color: #cbd5e1; box-shadow: var(--shadow-hover); }

        .btn-glow:focus-visible { box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.3); outline: none; }

        .nav-link-pro {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 16px; border-radius: 12px;
            color: #475569; font-size: 14px; font-weight: 500;
            text-decoration: none; transition: all 0.2s ease;
            cursor: pointer;
        }
        .nav-link-pro:hover { background: #f1f5f9; color: #0f172a; transform: translateX(4px); }
        .nav-link-pro.active { background: #eff6ff; color: #4f46e5; font-weight: 600; }

        .text-gradient {
            background: linear-gradient(135deg, #1e293b 0%, #4f46e5 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        #typewriter { border-right: 2px solid #4f46e5; animation: blink 1s step-end infinite; padding-right: 4px; }
        @keyframes blink { 50% { border-color: transparent; } }

        .reveal-up { opacity: 0; transform: translateY(30px); transition: all 0.8s cubic-bezier(0.5, 0, 0, 1); }
        .reveal-up.active { opacity: 1; transform: translateY(0); }

        .page-view { display: none; animation: fadeIn 0.4s ease-in-out; }
        .page-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* SKELETON LOADING */
        .skeleton {
            background: #e2e8f0;
            background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* DARK MODE */
        body.dark-mode {
            background: #0f172a !important;
            color: #f8fafc !important;
            --glass-bg: #1e293b;
            --glass-border: rgba(255,255,255,0.08);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --bg-body: #020617;
        }
        body.dark-mode .bg-grid { background-image: linear-gradient(to right, rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(to bottom, rgba(255,255,255,0.03) 1px, transparent 1px); opacity: 0.4; }
        body.dark-mode .bg-glow { background: radial-gradient(circle at 50% 0%, rgba(79, 70, 229, 0.15) 0%, transparent 60%); }
        body.dark-mode .glass-header { background: rgba(15, 23, 42, 0.85); border-bottom: 1px solid rgba(255,255,255,0.05); }
        body.dark-mode .glass { background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); }
        body.dark-mode .glass:hover { border-color: rgba(79, 70, 229, 0.3); background: rgba(30, 41, 59, 0.9); }
        body.dark-mode .text-gradient { background: linear-gradient(135deg, #fff 0%, #818cf8 100%) !important; -webkit-background-clip: text !important; -webkit-text-fill-color: transparent !important; }
        body.dark-mode .nav-link-pro { color: #94a3b8; }
        body.dark-mode .nav-link-pro:hover { background: rgba(255,255,255,0.05); color: #fff; }
        body.dark-mode .nav-link-pro.active { background: rgba(79, 70, 229, 0.2); color: #818cf8; }

        /* THEME ADAPTATIONS (FORCE VARIABLES ON ALL COMPONENTS) */
        #sidebar-panel, #settings-panel, #orders-panel, #support-panel, #track-modal div:last-child, .mobile-dock, #invoice-modal, #stats-dashboard {
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        /* Overrides pour le panneau latéral et dock en mode Sombre */
        body.dark-mode #sidebar-panel,
        body.dark-mode #settings-panel,
        body.dark-mode #orders-panel,
        body.dark-mode #support-panel,
        body.dark-mode #track-modal div:last-child,
        body.dark-mode .mobile-dock,
        body.dark-mode #invoice-modal,
        body.dark-mode #stats-dashboard {
            background-color: var(--glass-bg) !important;
            border-color: var(--glass-border) !important;
            color: var(--text-main) !important;
        }

        /* Overrides pour les textes dans les panneaux sombres */
        body.dark-mode #sidebar-panel h2,
        body.dark-mode #sidebar-panel p,
        body.dark-mode #sidebar-panel span,
        body.dark-mode #orders-panel h2,
        body.dark-mode #orders-panel span,
        body.dark-mode #settings-panel h2,
        body.dark-mode #settings-panel span,
        body.dark-mode #support-panel h2,
        body.dark-mode #support-panel span,
        body.dark-mode #track-modal h3,
        body.dark-mode #track-modal p,
        body.dark-mode #invoice-modal h3,
        body.dark-mode #invoice-modal td,
        body.dark-mode #stats-dashboard h3 {
            color: var(--text-main) !important;
        }

        /* Overrides pour les inputs dans les panneaux sombres */
        body.dark-mode #sidebar-panel input,
        body.dark-mode #sidebar-panel select,
        body.dark-mode #orders-panel input,
        body.dark-mode #settings-panel input,
        body.dark-mode #settings-panel select,
        body.dark-mode #support-panel input,
        body.dark-mode #track-modal input,
        body.dark-mode #track-modal textarea {
            background-color: rgba(15, 23, 42, 0.5) !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
            color: var(--text-main) !important;
        }
        
        /* Input Crystal Dark Mode Specifics */
        body.dark-mode #terminal-wrapper .input-crystal {
            background-color: rgba(0, 0, 0, 0.2) !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
            color: var(--text-main) !important;
        }

        /* Overrides pour les boutons secondaires (clairs) dans les panneaux */
        body.dark-mode button.bg-white {
            background-color: rgba(255,255,255,0.05) !important;
            border-color: rgba(255,255,255,0.1) !important;
            color: var(--text-main) !important;
        }
        body.dark-mode button.bg-slate-100 {
            background-color: rgba(255,255,255,0.05) !important;
            color: var(--text-main) !important;
        }
        body.dark-mode button.bg-slate-50 {
            background-color: rgba(255,255,255,0.05) !important;
            color: var(--text-main) !important;
        }

        /* TRACKING TIMELINE */
        .timeline { position: relative; padding-left: 30px; border-left: 2px solid #e2e8f0; }
        body.dark-mode .timeline { border-left-color: rgba(255,255,255,0.1); }
        .timeline-item { position: relative; margin-bottom: 24px; }
        .timeline-item::before { content: ''; position: absolute; left: -37px; top: 4px; width: 12px; height: 12px; background: #cbd5e1; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 0 1px #cbd5e1; }
        body.dark-mode .timeline-item::before { border-color: #0f172a; box-shadow: 0 0 0 1px #475569; }
        .timeline-item.active::before { background: #4f46e5; box-shadow: 0 0 0 1px #4f46e5; }
        .timeline-item.active .timeline-date { color: #4f46e5; font-weight: 700; }
        .timeline-date { font-size: 12px; color: #94a3b8; margin-bottom: 4px; }
        .timeline-content { font-size: 14px; font-weight: 500; color: var(--text-main); }

        /* TOASTS & TERMINAL & LOADER */
        .toast-container { position: fixed; bottom: 100px; right: 24px; z-index: 10000; display: flex; flex-direction: column; gap: 12px; }
        @media (max-width: 768px) { .toast-container { bottom: 100px; right: 12px; left: 12px; } }
        .toast { min-width: 300px; padding: 16px; border-radius: 12px; background: white; border-left: 4px solid; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between; animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); font-size: 14px; font-weight: 500; }
        .toast.success { border-color: #10b981; } .toast.error { border-color: #ef4444; }
        body.dark-mode .toast { background: #1e293b; color: white; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { to { transform: translateX(100%); opacity: 0; } }

        #loader { position: fixed; inset: 0; z-[99999]; background: #ffffff; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.8s ease-out, visibility 0.8s; }
        body.dark-mode #loader { background: #0f172a; }
        .loader-content { text-align: center; display: flex; flex-direction: column; align-items: center; animation: elasticZoom 1.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: scale(0.8); }
        .loader-icon { width: 64px; height: 64px; background: #4f46e5; border-radius: 16px; display: flex; align-items: center; justify-content: center; color: white; font-size: 28px; box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.3); }
        .loader-text { margin-top: 24px; font-size: 18px; font-weight: 800; color: #0f172a; letter-spacing: -0.5px; }
        body.dark-mode .loader-text { color: #f8fafc; }
        @keyframes elasticZoom { 0% { opacity: 0; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 1; transform: scale(1); } }
        .loader-dots { display: flex; gap: 8px; margin-top: 32px; }
        .dot { width: 8px; height: 8px; background-color: #cbd5e1; border-radius: 50%; animation: bounce 0.6s infinite alternate; }
        body.dark-mode .dot { background-color: #475569; }
        .dot:nth-child(2) { animation-delay: 0.1s; } .dot:nth-child(3) { animation-delay: 0.2s; }
        @keyframes bounce { from { transform: translateY(0); opacity: 0.4; } to { transform: translateY(-8px); opacity: 1; } }

        #main-content { transition: filter 0.3s ease; will-change: filter; }

        .mobile-dock { display: none; }
        @media (max-width: 768px) {
            .mobile-dock { display: flex !important; position: fixed !important; bottom: 24px !important; left: 50% !important; transform: translateX(-50%) !important; width: 90% !important; max-width: 400px !important; z-index: 9999 !important; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
            h1 { font-size: 1.75rem !important; } h2 { font-size: 1.5rem !important; }
            .glass:hover { transform: none !important; }
            .nav-desktop-container { display: none !important; } .mobile-hide { display: none !important; }
            body { overscroll-behavior-y: none; }
        }
        @media (min-width:769px) { .mobile-dock { display: none !important; } }

        /* TERMINAL STYLES */
        /* --- TERMINAL WRAPPER PRINCIPAL --- */
#terminal-wrapper { 
    display: none; 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100vw; 
    height: 100vh; 
    z-index: 20000; 
    background-color: var(--bg-body); 
    color: var(--text-main); 
    font-family: 'Plus Jakarta Sans', sans-serif; 
    overflow-y: auto; 
    overflow-x: hidden; 
    transition: background-color 0.4s ease, color 0.4s ease; 
    outline: none; /* Empêche le contour bleu sur le wrapper lui-même */
}

/* --- BOUTON FERMER --- */
#close-terminal-btn { 
    position: absolute; 
    top: 20px; 
    right: 20px; 
    z-index: 20050; 
    width: 40px; 
    height: 40px; 
    background: var(--glass-bg); 
    border: 1px solid var(--glass-border); 
    backdrop-filter: blur(10px); 
    -webkit-backdrop-filter: blur(10px); /* Pour Safari */
    border-radius: 50%; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    color: var(--text-main); 
    cursor: pointer; 
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
    box-shadow: var(--shadow-soft); 
}

#close-terminal-btn:hover { 
    background: rgba(239, 68, 68, 0.1); /* Rouge plus doux */
    color: #ef4444; 
    transform: rotate(90deg) scale(1.1); 
    border-color: rgba(239, 68, 68, 0.2);
}

/* --- ÉLÉMENTS VISUELS (Glassmorphism & Glow) --- */
#terminal-wrapper .bg-glow { 
    position: fixed; 
    inset: 0; 
    z-index: -1; 
    background: radial-gradient(circle at 50% -20%, var(--accent-blue) 0%, transparent 45%); 
    opacity: 0.1; 
    pointer-events: none; /* Sécurité : ne bloque pas les clics */
}

#terminal-wrapper .glass { 
    background: var(--glass-bg); 
    backdrop-filter: blur(30px); 
    -webkit-backdrop-filter: blur(30px);
    border: 1px solid var(--glass-border); 
    border-radius: 28px; 
    box-shadow: var(--shadow-soft); 
}

#terminal-wrapper .input-crystal { 
    background: rgba(255, 255, 255, 0.05); /* Plus subtil en mode sombre */
    border: 1px solid var(--glass-border); 
    border-radius: 16px; 
    color: var(--text-main); 
    transition: all 0.3s ease; 
    padding: 12px 16px;
}

#terminal-wrapper .input-crystal:focus {
    outline: none;
    border-color: var(--accent-blue);
    background: rgba(255, 255, 255, 0.1);
    box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
}

/* --- TYPOGRAPHIE --- */
#terminal-wrapper .text-gradient { 
    background: linear-gradient(to bottom, var(--text-main) 40%, var(--text-muted)); 
    -webkit-background-clip: text; 
    -webkit-text-fill-color: transparent; 
    background-clip: text;
}

body.dark-mode #terminal-wrapper .text-gradient { 
    background: linear-gradient(to bottom, #fff 40%, rgba(255,255,255,0.4)); 
}

/* --- LOGIQUE DE STEPS & PROGRESSION --- */
#terminal-wrapper .hidden-step { display: none; }

#terminal-wrapper .progress-bar-fill { 
    width: 0%; 
    height: 100%;
    transition: width 0.6s cubic-bezier(0.65, 0, 0.35, 1); 
    background: var(--accent-blue); 
    box-shadow: 0 0 15px rgba(79, 130, 246, 0.5); 
}

/* --- CARTES D'OPTIONS --- */
#terminal-wrapper .option-card { 
    cursor: pointer; 
    transition: all 0.3s ease; 
    border: 1px solid var(--glass-border); 
    background: var(--glass-bg); 
    user-select: none;
}

#terminal-wrapper .option-card:hover {
    transform: translateY(-2px);
    border-color: var(--accent-blue);
    background: rgba(79, 70, 229, 0.02);
}

#terminal-wrapper .option-card.active { 
    border-color: var(--accent-blue); 
    background: rgba(79, 70, 229, 0.05); 
    box-shadow: 0 0 20px rgba(79, 70, 229, 0.1);
}

/* --- ANIMATIONS D'ERREUR --- */
@keyframes terminalShake { 
    0%, 100% { transform: translateX(0); } 
    25% { transform: translateX(-5px); } 
    75% { transform: translateX(5px); } 
}

#terminal-wrapper .input-error { 
    animation: terminalShake 0.3s ease-in-out; 
    border-color: #ef4444 !important; 
    background: rgba(239, 68, 68, 0.05) !important;
}

/* --- FORMULAIRES & BOUTONS --- */
#terminal-wrapper input, 
#terminal-wrapper select, 
#terminal-wrapper textarea { 
    width: 100%; 
    display: block; 
    appearance: none; /* Nettoyage sur mobile */
}

#terminal-wrapper button { 
    cursor: pointer; 
    display: inline-flex; 
    align-items: center; 
    justify-content: center; 
    transition: all 0.2s ease;
}

#terminal-wrapper button:active { transform: scale(0.97); }

#terminal-wrapper .payment-btn { 
    background: var(--glass-bg); 
    border: 1px solid var(--glass-border); 
    font-weight: 600;
}
        /* PROFESSIONAL INVOICE MODAL */
        #invoice-modal { display: none; position: fixed; inset: 0; z-index: [9500]; backdrop-filter: blur(8px); background: rgba(0,0,0,0.6); align-items: center; justify-content: center; padding: 20px; }
        #invoice-modal.active { display: flex; }
        .invoice-paper { background: white; width: 100%; max-width: 800px; max-height: 90vh; overflow-y: auto; padding: 40px; border-radius: 4px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); position: relative; }
        .invoice-header { display: flex; justify-content: space-between; margin-bottom: 40px; border-bottom: 2px solid #f1f5f9; padding-bottom: 20px; }
        .invoice-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .invoice-table th { text-align: left; padding: 12px; background: #f8fafc; color: #64748b; font-size: 12px; text-transform: uppercase; }
        .invoice-table td { padding: 12px; border-bottom: 1px solid #e2e8f0; color: #0f172a; }
        .invoice-total { margin-top: 20px; text-align: right; font-size: 24px; font-weight: 800; color: #4f46e5; }
        @media print {
            body * { visibility: hidden; }
            #invoice-modal, #invoice-modal * { visibility: visible; }
            #invoice-modal { position: absolute; left: 0; top: 0; background: white; backdrop-filter: none; }
            .invoice-paper { box-shadow: none; max-width: 100%; padding: 0; }
            .no-print { display: none !important; }
        }
        /* STYLES POUR LE PROFIL UTILISATEUR */
        #profile-panel {
            /* Assure la transition et le fond glass */
            background-color: var(--glass-bg);
            border-color: var(--glass-border);
            color: var(--text-main);
        }
        
        /* Override Dark Mode spécifique pour le panneau profil */
        body.dark-mode #profile-panel {
            background-color: var(--glass-bg) !important;
            border-color: var(--glass-border) !important;
            color: var(--text-main) !important;
        }
        
        body.dark-mode #profile-panel h2, 
        body.dark-mode #profile-panel label,
        body.dark-mode #profile-panel p {
            color: var(--text-main) !important;
        }
        
        body.dark-mode #profile-panel input,
        body.dark-mode #profile-panel textarea {
            background-color: rgba(15, 23, 42, 0.5) !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
            color: var(--text-main) !important;
        }
        
        body.dark-mode #profile-role-display {
            color: #818cf8 !important; /* Indigo clair en mode sombre */
        }

/* --- ULTRA PRO CHAT STYLES --- */

/* Le panneau principal : Effet verre et bordure fine */
#chat-panel {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    box-shadow: -10px 0 40px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    height: 100%;
    border-left: 1px solid rgba(255, 255, 255, 0.5);
}

/* Header du chat */
#chat-panel .p-4 {
    background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
    box-shadow: 0 4px 20px -5px rgba(79, 70, 229, 0.4);
}

/* Container des messages */
#chat-messages {
    background-image: 
        radial-gradient(#e0e7ff 1px, transparent 1px), 
        radial-gradient(#e0e7ff 1px, transparent 1px);
    background-size: 20px 20px;
    background-position: 0 0, 10px 10px;
    background-color: #f8fafc;
    scroll-behavior: smooth;
}

/* Scrollbar fine et stylisée */
#chat-messages::-webkit-scrollbar { width: 6px; }
#chat-messages::-webkit-scrollbar-track { background: transparent; }
#chat-messages::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
#chat-messages::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

/* Structure de la ligne de message */
.chat-row {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
    align-items: flex-end; /* Aligne les bulles en bas */
    animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

@keyframes slideUpFade {
    from { opacity: 0; transform: translateY(15px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

/* Avatar */
.chat-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #e2e8f0;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 700;
    color: #64748b;
    border: 2px solid white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    overflow: hidden;
}
.chat-avatar img { width: 100%; height: 100%; object-fit: cover; }

/* Conteneur du contenu du message */
.chat-content {
    max-width: 75%;
    display: flex;
    flex-direction: column;
}

/* En-tête du message (Nom + Heure) */
.chat-header {
    display: flex;
    align-items: baseline;
    gap: 8px;
    margin-bottom: 4px;
    font-size: 0.75rem;
    font-weight: 600;
}

/* Bulle de message Autre (Gris/Blanc) */
.chat-bubble.other {
    background: white;
    color: #334155;
    padding: 12px 16px;
    border-radius: 4px 18px 18px 18px; /* Coin gauche plat */
    box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.1);
    border: 1px solid #f1f5f9;
    line-height: 1.5;
    font-size: 0.95rem;
}

/* Bulle de message Moi (Dégradé Pro) */
.chat-bubble.me {
    background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
    color: white;
    padding: 12px 16px;
    border-radius: 18px 4px 18px 18px; /* Coin droit plat */
    box-shadow: 0 4px 15px -3px rgba(79, 70, 229, 0.4);
    line-height: 1.5;
    font-size: 0.95rem;
    position: relative;
}

/* Petit indicateur de réception (optionnel) */
.chat-bubble.me::after {
    content: '';
    position: absolute;
    bottom: 8px;
    right: 8px;
    width: 6px;
    height: 6px;
    background: rgba(255,255,255,0.4);
    border-radius: 50%;
}

/* Zone de saisie (Style Search Bar) */
#chat-input {
    background: #f1f5f9;
    border: none;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
    transition: all 0.3s;
}
#chat-input:focus {
    background: white;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1), 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

/* Bouton d'envoi */
#chat-form button {
    background: linear-gradient(135deg, #4f46e5, #4338ca);
    transition: transform 0.2s;
}
#chat-form button:hover { transform: scale(1.05); }
#chat-form button:active { transform: scale(0.95); }

/* Dark Mode Adaptation */
body.dark-mode #chat-panel {
    background: rgba(15, 23, 42, 0.95);
    border-left-color: rgba(255,255,255,0.1);
}
body.dark-mode #chat-messages {
    background-color: #0f172a;
    background-image: radial-gradient(rgba(255,255,255,0.05) 1px, transparent 1px);
}
body.dark-mode .chat-bubble.other {
    background: #1e293b;
    color: #e2e8f0;
    border-color: #334155;
}
body.dark-mode #chat-input {
    background: #1e293b;
    color: white;
}
body.dark-mode .chat-header { color: #94a3b8; }
        /* Classe pour forcer le masquage du Dock (priorité maximale) */
.mobile-dock.dock-hidden {
    display: none !important; 
}
        /* --- ÉTAT DE CHARGEMENT GLOBAL --- */
/* Quand la classe .app-loading est présente, on cache tout sauf le loader */

.app-loading #main-content,
.app-loading .nav-desktop-container,
.app-loading #mobile-header,
.app-loading .mobile-dock,
.app-loading .bg-grid,
.app-loading .bg-glow,
.app-loading .page-view {
    opacity: 0 !important;
    visibility: hidden !important;
    pointer-events: none !important;
}

/* S'assurer que le Loader est bien au-dessus de tout */
#loader {
    z-index: 99999 !important; 
}
        /* SHORT VIDEO CONTAINER */
.short-video-container {
    position: relative;
    width: 100%;
    max-width: 300px; /* Largeur max sur mobile */
    aspect-ratio: 9 / 16; /* Ratio vertical TikTok/Insta */
    margin: 0 auto;
    background: #000;
    border-radius: 12px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
}

.short-video-container video {
    width: 100%;
    height: 100%;
    object-fit: contain; /* Garde la vidéo entière */
}
        /* --- ANIMATION AUTO-HIDE (STYLE TWITTER) --- */

/* Pour la Barre "Explorer" (Header) */
.feed-sticky-header {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Quand on ajoute la classe, ça remonte vers le haut */
/* Quand on ajoute la classe nav-hidden au header */
.feed-sticky-header.nav-hidden {
    transform: translateY(-500px) !important; 
}

/* Pour le Dock Mobile */
.mobile-dock {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s;
}

/* Quand on ajoute la classe, ça descend vers le bas */
.mobile-dock.nav-hidden {
    transform: translateY(100%);
    opacity: 0; /* Optionnel : pour qu'il disparaisse en fondu en même temps */
}
        /* --- SKELETON LOADING (Effet Pro) --- */

/* L'animation de brillance */
@keyframes shimmer {
    0% { background-position: -1000px 0; }
    100% { background-position: 1000px 0; }
}

/* La classe de base pour les blocs gris */
.skeleton {
    background-color: #e2e8f0; /* Slate-200 */
    background-image: linear-gradient(90deg, #e2e8f0 0%, #f1f5f9 50%, #e2e8f0 100%);
    background-size: 1000px 100%; /* Largeur pour l'animation */
    animation: shimmer 1.5s infinite linear; /* Durée et type d'animation */
}

/* Variante pour l'Avatar (Rond) */
.skeleton-avatar {
    width: 100%;
    height: 100%;
    border-radius: 50%;
}

/* Variante pour les Textes (Barres rectangulaires) */
.skeleton-text {
    height: 12px;
    margin-bottom: 6px;
    border-radius: 4px;
}
.skeleton-text.short { width: 30%; } /* Texte court */
.skeleton-text.long { width: 80%; } /* Texte long */
.skeleton-text.medium { width: 60%; }

/* Variante pour les Boutons (Forme de pilule) */
.skeleton-btn {
    height: 32px;
    width: 100px;
    border-radius: 16px;
}
        @keyframes heartPop {
    0% { transform: scale(1); }
    50% { transform: scale(1.4); }
    100% { transform: scale(1); }
}

.animate-heart-pop {
    animation: heartPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
        /* Bouton suivre type LinkedIn/Facebook */
.btn-follow-pro {
    @apply text-xs font-bold px-5 py-2 rounded-full transition-all duration-300
    bg-indigo-50 text-indigo-600 hover:bg-indigo-600 hover:text-white border border-indigo-100;
}

.btn-follow-pro.following {
    @apply bg-slate-100 text-slate-500 border-slate-200 hover:bg-red-50 hover:text-red-600 hover:border-red-100;
}

/* Scrollbar discrète pour les commentaires */
.custom-scrollbar::-webkit-scrollbar {
    width: 4px;
}
.custom-scrollbar::-webkit-scrollbar-thumb {
    @apply bg-slate-200 dark:bg-slate-700 rounded-full;
}

/* Animation de like */
.fa-heart.text-red-500 {
    animation: heartPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes heartPop {
    0% { transform: scale(1); }
    50% { transform: scale(1.4); }
    100% { transform: scale(1.1); }
}

        /* --- OPTIMISATION SCROLL (GPU) --- */

/* 1. Force le navigateur à créer une couche composite pour le flux principal */
#global-feed-container {
    /* Isolation : évite que le reste de la page soit redessiné quand le feed bouge */
    contain: layout style paint; 
    /* Prépare l'élément pour l'animation GPU */
    transform: translateZ(0); 
}

/* 2. Optimisation des cartes (Glassmorphism gourmand en ressources) */
.glass {
    /* Dit au navigateur : "Attention, cet élément va bouger ou changer, prépare-le" */
    will-change: transform; 
    /* Force la création d'une couche GPU */
    backface-visibility: hidden; 
    transform: translateZ(0);
}

/* 3. Optimisation des éléments Sticky (Header et Dock) */
.feed-sticky-header, .mobile-dock {
    /* Empêche le scintillement lors du scroll sur mobile */
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
    will-change: transform;
}

/* 4. Images : Empêche le saut de mise en page au chargement */
img {
    /* Laisse de l'espace pour l'image avant qu'elle ne charge */
    aspect-ratio: attr(width) / attr(height); 
}
        /* --- 1. REDUCTION DE L'ESPACE --- */
#home-view section {
    /* On réduit le padding en haut (pt-6 devient pt-2) */
    padding-top: 0.5rem; 
    padding-bottom: 80px;
}

/* --- 2. LAYOUT AUTEUR OVERLAY (Style TikTok/Insta Pro) --- */
article {
    position: relative; /* Important pour positionner l'avatar par-dessus */
}

/* Conteneur de l'Avatar et du Nom (Superposition) */
.post-header-overlay {
    position: absolute;
    top: 12px;
    left: 12px;
    display: flex;
    align-items: flex-end; /* Aligner le texte en bas de l'avatar */
    gap: 8px;
    z-index: 10;
    pointer-events: none; /* Laisser passer le clic sur l'image si besoin */
}

/* L'Avatar avec un fond sombre pour la lisibilité */
.avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid white; /* Bordure blanche pour le détacher */
    overflow: hidden;
    background: rgba(0, 0, 0, 0.5); /* Fond semi-transparent */
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    flex-shrink: 0;
}

/* Le Nom superposé */
.author-info-overlay {
    color: white;
    text-shadow: 0 1px 3px rgba(0,0,0,0.8);
    margin-bottom: 2px;
    pointer-events: auto; /* On réactive le clic sur le nom */
}

.author-name-overlay {
    font-weight: 700;
    font-size: 14px;
    line-height: 1.1;
    display: block;
}

.author-time-overlay {
    font-size: 11px;
    opacity: 0.9;
}

/* Image du post */
.post-media-img {
    width: 100%;
    height: auto;
    display: block;
    border-radius: 12px 12px 0 0; /* Coins arrondis en haut seulement */
}
    </style>
</head>
<body>

    <!-- PROFESSIONAL LOADER -->
    <div id="loader">
        <div class="loader-content">
            <div class="loader-icon"><i class="fas fa-print"></i></div>
            <div class="loader-text">Printbam</div>
        </div>
        <div class="loader-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-container" class="toast-container"></div>

    <!-- BACKGROUNDS -->
    <div class="bg-grid" id="parallax-bg"></div>
    <div class="bg-glow"></div>

    <!-- SIDEBAR OVERLAY -->
    <div id="sidebar-overlay" class="fixed inset-0 z-[5000] invisible transition-all duration-500" aria-hidden="true">
        <div id="sidebar-bg" class="absolute inset-0 bg-slate-900/20 backdrop-blur-sm opacity-0 transition-opacity duration-500" onclick="toggleSidebar()"></div>
        <div id="sidebar-panel" class="fixed top-0 left-0 h-full w-[300px] bg-white z-[5001] -translate-x-full opacity-0 transition-all duration-500 ease-[cubic-bezier(0.32,0.72,0,1)] flex flex-col shadow-2xl border-r border-slate-100">
            <div class="pt-10 pb-6 px-8 border-b border-slate-100 bg-white/50"><span class="text-2xl font-bold text-slate-900 tracking-tight">Print<span class="text-indigo-600">bam</span></span><p class="text-[10px] text-slate-400 mt-1 uppercase tracking-widest">v3.5 Pro</p></div>
            <nav class="flex-1 overflow-y-auto p-5">
    <!-- SECTION NAVIGATION -->
    <div class="mb-8">
        <p class="px-4 mb-3 text-[10px] font-bold text-slate-400 uppercase tracking-wider" data-i18n="nav_navigation">Navigation</p>
        <div class="flex flex-col gap-2">
            <a onclick="switchPage('home')" class="nav-link-pro active">
                <i class="fa-solid fa-house w-5 text-center text-sm"></i> 
                <span data-i18n="nav_home">Accueil</span>
            </a>
            <a onclick="switchPage('marketplace')" class="nav-link-pro">
                <i class="fa-solid fa-shop w-5 text-center text-sm"></i> 
                <span data-i18n="nav_market">Marketplace</span>
            </a>
            <a onclick="switchPage('services')" class="nav-link-pro">
                <i class="fa-solid fa-layer-group w-5 text-center text-sm"></i> 
                <span data-i18n="nav_services">Services & Tarifs</span>
            </a>
        </div>
    </div>

    <!-- SECTION COMPTE -->
    <div>
        <p class="px-4 mb-3 text-[10px] font-bold text-slate-400 uppercase tracking-wider" data-i18n="nav_account">Compte</p>
        <div class="flex flex-col gap-2">
            <a href="javascript:void(0)" onclick="switchPage('profile-social')" class="nav-link-pro">
                <i class="fa-solid fa-user-circle w-5 text-center text-sm"></i> 
                <span>Mon Profil</span>
            </a>
            <a href="javascript:void(0)" onclick="toggleOrders()" class="nav-link-pro">
                <i class="fa-solid fa-receipt w-5 text-center text-sm"></i> 
                <span data-i18n="nav_orders">Mes Commandes</span>
            </a>
        </div>
    </div>
    <!-- SECTION OUTILS -->
    <div>
        <p class="px-4 mb-3 text-[10px] font-bold text-slate-400 uppercase tracking-wider" data-i18n="nav_outils">Outils</p>
        <div class="flex flex-col gap-2">
            <!-- BOUTON CONVERTIR FICHIER -->
            <a href="javascript:void(0)" onclick="switchPage('convert')" class="nav-link-pro">
                <i class="fa-solid fa-file-import w-5 text-center text-sm"></i> 
                <span>Conversion fichiers</span>
            </a>
            <!-- BOUTON CONVERTIR FICHIER -->
            <a href="javascript:void(0)" onclick="switchPage('convert')" class="nav-link-pro">
                <i class="fa-solid fa-print w-5 text-center text-sm"></i> 
                <span>Impression</span>
            </a>
    </div>
    <!-- SECTION APPLICATION (NOUVEAU) -->
    <div class="mt-8">
        <p class="px-4 mb-3 text-[10px] font-bold text-slate-400 uppercase tracking-wider"data-i18n="nav_app">Application</p>
        <div class="flex flex-col gap-2">
            <a href="javascript:void(0)" onclick="toggleSettings()" class="nav-link-pro">
                <i class="fa-solid fa-gear w-5 text-center text-sm"></i> 
                <span data-i18n="nav_settings">Paramètres</span>
            </a>
            <a href="javascript:void(0)" onclick="toggleSupport()" class="nav-link-pro">
                <i class="fa-solid fa-headset w-5 text-center text-sm"></i> 
                <span data-i18n="nav_help">Aide</span>
            </a>
            <a href="javascript:void(0)" onclick="toggleAbout()" class="nav-link-pro">
                <i class="fa-solid fa-circle-info w-5 text-center text-sm"></i> 
                <span data-i18n="nav_about">À propos</span>
            </a>
            <!-- Lien Admin (Caché par défaut) -->
            <a href="javascript:void(0)" onclick="switchPage('admin')" id="nav-admin-link" class="nav-link-pro hidden">
                <i class="fa-solid fa-shield-halved w-5 text-center text-sm"></i> 
                <span>Espace Admin</span>
            </a>
        </div>
    </div>
</nav>
            <div class="p-5 border-t border-slate-100 bg-slate-50/50">
                <div class="flex bg-slate-200/50 p-1 rounded-xl">
                    <button onclick="setTheme('light')" id="btn-light" class="flex-1 py-2.5 text-xs font-semibold rounded-lg shadow-sm bg-white text-slate-800 transition-all flex justify-center items-center gap-2"><i class="fas fa-sun text-xs"></i> Light</button>
                    <button onclick="setTheme('dark')" id="btn-dark" class="flex-1 py-2.5 text-xs font-semibold rounded-lg text-slate-500 hover:text-slate-800 transition-all flex justify-center items-center gap-2"><i class="fas fa-moon text-xs"></i> Dark</button>
                </div>
            </div>
        </div>
    </div>

    <!-- HEADERS -->
    <!-- MOBILE HEADER -->
    <div class="sm:hidden fixed top-0 w-full z-[4000] px-4 py-4 transition-all duration-300" id="mobile-header">
        <div class="flex items-center justify-between gap-3">
            <button onclick="toggleSidebar()" class="flex items-center justify-center w-11 h-11 bg-white/90 border border-slate-200 rounded-xl shadow-sm backdrop-blur-md active:scale-95 transition-all group" aria-label="Menu"><i class="fas fa-bars text-slate-700 group-hover:text-indigo-600 transition-colors"></i></button>
            <div class="flex-1 h-11 bg-white/90 border border-slate-200 rounded-xl flex items-center justify-center px-4 shadow-sm backdrop-blur-md"><span class="font-bold text-lg tracking-tight"><span class="text-indigo-600">Print</span>bam</span></div>
            <!-- BOUTON NOTIFICATIONS (Remplace le bouton menu hamburger) -->
<button onclick="switchPage('notifications')" class="flex items-center justify-center w-11 h-11 bg-white/90 border border-slate-200 rounded-xl shadow-sm backdrop-blur-md active:scale-95 transition-all group relative" aria-label="Notifications">
    <i class="fas fa-bell text-slate-700 group-hover:text-indigo-600 transition-colors"></i>
    
    <!-- BADGE ROUGE (Caché par défaut) -->
    <span id="notif-badge-count" class="hidden absolute top-0 right-0 w-5 h-5 bg-red-500 text-white text-[10px] font-bold flex items-center justify-center rounded-full border-2 border-white shadow-sm">0</span>
</button>
        </div>
    </div>

    <!-- DESKTOP NAV -->
    <div class="nav-desktop-container fixed top-0 w-full z-[4000] px-6 py-6 transition-all duration-300">
        <nav id="nav-main" class="glass-header max-w-6xl mx-auto rounded-2xl px-6 h-16 flex justify-between items-center transition-all duration-300">
            <a onclick="switchPage('home')" class="flex items-center gap-2 group cursor-pointer">
                <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white text-xs shadow-lg shadow-indigo-200 group-hover:scale-110 transition-transform"><i class="fas fa-print"></i></div>
                <span class="text-xl font-bold text-slate-900 tracking-tight group-hover:text-indigo-600 transition-colors">Print<span class="text-slate-400 group-hover:text-indigo-400">bam</span></span>
            </a>
            <div class="hidden md:flex items-center gap-1">
                <a onclick="switchPage('home')" class="nav-link-pro rounded-lg"><span data-i18n="nav_home">Accueil</span></a>
                <a href="javascript:void(0)" onclick="toggleChat()" class="nav-link-pro rounded-lg">
                    <i class="fas fa-comments"></i> <span>Discussion</span>
                </a>
                <a onclick="switchPage('marketplace')" class="nav-link-pro rounded-lg"><span data-i18n="nav_market">Marketplace</span></a>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="md:hidden w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center text-slate-600 hover:bg-slate-200 transition-colors"><i class="fas fa-bars"></i></button>
                <a href="login.html" class="hidden md:block text-xs font-semibold text-slate-500 hover:text-indigo-600 transition-colors" data-i18n="nav_login">Connexion</a>
                <a href="javascript:void(0)" onclick="openTerminal()" class="bg-slate-900 text-white px-5 py-2.5 rounded-xl text-xs font-bold hover:bg-indigo-600 transition-all shadow-lg shadow-indigo-200/50 flex items-center gap-2 btn-glow" aria-label="Démarrer une commande"><span data-i18n="btn_start">Démarrer</span> <i class="fas fa-arrow-right text-[10px]"></i></a>
            </div>
        </nav>
    </div>
<br>
    <br>
    <br>
    <!-- MAIN CONTENT WRAPPER -->
   <!-- PAGE 1: ACCUEIL (FEED GLOBAL) -->
<div id="home-view" class="page-view">
    <section class="max-w-2xl mx-auto px-4 pt-10 pb-20">
        
        <!-- NOUVEAU WRAPPER STICKY -->
        <!-- NOUVEAU WRAPPER STICKY MODIFIÉ -->
<div class="sticky top-[75px] bg-white/95 dark:bg-slate-900/95 backdrop-blur-md z-[4100] mb-1 py-4 -mx-4 px-4 border-b border-slate-200/60 dark:border-slate-700/50 transition-all">
    
    <!-- HEADER DU FEED -->
    <div class="flex items-center justify-between mb-1"> <!-- mb-4 devient mb-1 -->
        <h1 class="text-0xl font-black text-slate-900 dark:text-white tracking-tight">
            Explorez
        </h1>
        
        <!-- BOUTON RECHERCHE (Remplace le bouton Publier) -->
        <button onclick="toggleSearch()" class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 px-4 py-2 rounded-full text-sm font-bold shadow-sm hover:bg-slate-200 transition flex items-center gap-2">
            <i class="fas fa-search"></i>
        </button>
    </div>

    <!-- BARRE DE RECHERCHE (Cachée par défaut) -->
    <div id="feed-search-bar" class="hidden mb-3 overflow-hidden transition-all duration-300">
        <div class="relative">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
            <input type="text" id="feed-search-input" placeholder="Rechercher des publications..." class="w-full bg-slate-100 dark:bg-slate-800 border-none rounded-full py-2 pl-9 pr-4 text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none transition-all placeholder-slate-400">
        </div>
    </div>

    <!-- BOUTONS DE TRI -->
    <div class="flex gap-2 border-b border-slate-100 dark:border-slate-700 pb-1 overflow-x-auto no-scrollbar">
        <button onclick="sortFeed('recent')" id="btn-sort-recent" class="text-sm font-bold pb-2 px-2 border-b-2 border-indigo-600 text-indigo-600 transition-colors whitespace-nowrap">
            Actualités
        </button>
        <button onclick="sortFeed('popular')" id="btn-sort-popular" class="text-sm font-bold pb-2 px-2 border-b-2 border-transparent text-slate-400 hover:text-slate-600 transition-colors whitespace-nowrap">
            <i class="fas fa-fire text-orange-500 mr-1"></i> Tendances
        </button>
        <button onclick="filterFeed('shorts')" id="btn-filter-shorts" class="text-sm font-bold pb-2 px-2 border-b-2 border-transparent text-slate-400 hover:text-pink-600 transition-colors whitespace-nowrap flex items-center gap-1">
            <i class="fas fa-play text-pink-500"></i> Shorts
        </button>
    </div>
</div> 
        <!-- FIN DU WRAPPER STICKY -->

        <!-- CONTENEUR DES POSTS -->
        <div id="global-feed-container" class="space-y-6">
             <!-- ... les posts ... -->
        </div>
        <!-- AJOUTEZ CE BLOC ICI (Le sentinelle de chargement) -->
<div id="feed-loader" class="hidden py-8 flex justify-center">
    <div class="flex items-center gap-2 text-slate-400 text-sm font-bold">
        <i class="fas fa-circle-notch fa-spin text-indigo-500"></i>
        Chargement...
    </div>
</div>
    </section>
</div>

        <!-- SPACER FOR HEADER -->
        <section class="max-w-2xl mx-auto px-4 pt-0 pb-20"> <!-- Changez pt-6 par pt-0 -->
        
        <div id="main-content">
        <!-- PAGE 2: MARKETPLACE -->
        <div id="marketplace-view" class="page-view">
            <section class="max-w-7xl mx-auto px-6 py-10">
                <div class="mb-10 text-center">
                    <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900 tracking-tight mb-4"><span class="text-gradient">Marketplace</span> Printbam</h1>
                    <p class="text-slate-500 max-w-2xl mx-auto text-lg" data-i18n="market_desc">Découvrez nos packs pré-configurés pour vos besoins professionnels et académiques.</p>
                </div>

                <!-- FILTRES & RECHERCHE -->
                <div class="glass p-4 mb-8 flex flex-col md:flex-row gap-4 items-center justify-between sticky top-24 z-30">
                    <div class="flex gap-2 w-full md:w-auto overflow-x-auto pb-2 md:pb-0 no-scrollbar">
                        <button onclick="filterMarket('all')" class="filter-btn active px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold shadow-md transition-colors whitespace-nowrap">Tout</button>
                        <button onclick="filterMarket('academique')" class="filter-btn px-4 py-2 bg-white border border-slate-200 text-slate-600 rounded-lg text-sm font-bold hover:bg-slate-50 transition-colors whitespace-nowrap">Académique</button>
                        <button onclick="filterMarket('corporate')" class="filter-btn px-4 py-2 bg-white border border-slate-200 text-slate-600 rounded-lg text-sm font-bold hover:bg-slate-50 transition-colors whitespace-nowrap">Corporate</button>
                        <button onclick="filterMarket('marketing')" class="filter-btn px-4 py-2 bg-white border border-slate-200 text-slate-600 rounded-lg text-sm font-bold hover:bg-slate-50 transition-colors whitespace-nowrap">Marketing</button>
                    </div>
                    <div class="relative w-full md:w-64">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                        <input type="text" id="market-search" oninput="searchMarketplace(this.value)" placeholder="Rechercher un produit..." class="w-full bg-slate-50 border border-slate-200 rounded-lg py-2 pl-9 pr-4 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                    </div>
                </div>

                <!-- GRID -->
                <div id="products-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Item 1 -->
                    <div class="market-item glass flex flex-col group overflow-hidden" data-category="academique">
                        <div class="h-48 bg-indigo-50 relative"><div class="absolute inset-0 flex items-center justify-center text-indigo-200 text-6xl"><i class="fas fa-file-pdf"></i></div><span class="absolute top-4 left-4 bg-indigo-600 text-white text-[10px] font-bold px-2 py-1 rounded uppercase">Populaire</span></div>
                        <div class="p-6 flex-1 flex flex-col">
                            <h3 class="font-bold text-lg mb-2" data-i18n="mkt_item1_title">Pack Mémoire Standard</h3>
                            <p class="text-sm text-slate-500 mb-4 flex-1" data-i18n="mkt_item1_desc">Impression N&B + Reliure Spirale + 2 Exemplaires.</p>
                            <div class="flex items-center justify-between mt-auto">
                                <span class="text-2xl font-black text-slate-900">25.000 <span class="text-xs text-slate-400 font-normal">FC</span></span>
                                <a href="javascript:void(0)" onclick="openTerminal()" class="w-10 h-10 rounded-full bg-slate-900 text-white flex items-center justify-center hover:bg-indigo-600 transition-colors"><i class="fas fa-arrow-right"></i></a>
                            </div>
                        </div>
                    </div>
                    <!-- Item 2 -->
                    <div class="market-item glass flex flex-col group overflow-hidden" data-category="corporate">
                        <div class="h-48 bg-emerald-50 relative"><div class="absolute inset-0 flex items-center justify-center text-emerald-200 text-6xl"><i class="fas fa-id-card"></i></div></div>
                        <div class="p-6 flex-1 flex flex-col">
                            <h3 class="font-bold text-lg mb-2" data-i18n="mkt_item2_title">Pack Badges Pro</h3>
                            <p class="text-sm text-slate-500 mb-4 flex-1" data-i18n="mkt_item2_desc">50 Cartes PVC recto-verso avec personnalisation.</p>
                            <div class="flex items-center justify-between mt-auto">
                                <span class="text-2xl font-black text-slate-900">45.000 <span class="text-xs text-slate-400 font-normal">FC</span></span>
                                <a href="javascript:void(0)" onclick="openTerminal()" class="w-10 h-10 rounded-full bg-slate-900 text-white flex items-center justify-center hover:bg-indigo-600 transition-colors"><i class="fas fa-arrow-right"></i></a>
                            </div>
                        </div>
                    </div>
                    <!-- Item 3 -->
                    <div class="market-item glass flex flex-col group overflow-hidden" data-category="marketing">
                        <div class="h-48 bg-orange-50 relative"><div class="absolute inset-0 flex items-center justify-center text-orange-200 text-6xl"><i class="fas fa-bullhorn"></i></div></div>
                        <div class="p-6 flex-1 flex flex-col">
                            <h3 class="font-bold text-lg mb-2" data-i18n="mkt_item3_title">Kit Communication</h3>
                            <p class="text-sm text-slate-500 mb-4 flex-1" data-i18n="mkt_item3_desc">100 Affiches A3 + 500 Flyers A5.</p>
                            <div class="flex items-center justify-between mt-auto">
                                <span class="text-2xl font-black text-slate-900">120.000 <span class="text-xs text-slate-400 font-normal">FC</span></span>
                                <a href="javascript:void(0)" onclick="openTerminal()" class="w-10 h-10 rounded-full bg-slate-900 text-white flex items-center justify-center hover:bg-indigo-600 transition-colors"><i class="fas fa-arrow-right"></i></a>
                            </div>
                        </div>
                    </div>
                    <!-- Item 4 -->
                    <div class="market-item glass flex flex-col group overflow-hidden" data-category="marketing">
                        <div class="h-48 bg-purple-50 relative"><div class="absolute inset-0 flex items-center justify-center text-purple-200 text-6xl"><i class="fas fa-tshirt"></i></div></div>
                        <div class="p-6 flex-1 flex flex-col">
                            <h3 class="font-bold text-lg mb-2" data-i18n="mkt_item4_title">Personnalisation</h3>
                            <p class="text-sm text-slate-500 mb-4 flex-1" data-i18n="mkt_item4_desc">T-shirts, Mugs et Objets publicitaires.</p>
                            <div class="flex items-center justify-between mt-auto">
                                <span class="text-2xl font-black text-slate-900">Sur devis</span>
                                <a href="javascript:void(0)" onclick="openTerminal()" class="w-10 h-10 rounded-full bg-slate-900 text-white flex items-center justify-center hover:bg-indigo-600 transition-colors"><i class="fas fa-arrow-right"></i></a>
                            </div>
                        </div>
                    </div>

                    <!-- NOUVEAUX PRODUITS (10+) -->
                    <!-- Item 5: Thèse Premium (Académique) -->
                    <div class="market-item glass flex flex-col group overflow-hidden" data-category="academique">
                        <div class="h-48 bg-rose-50 relative">
                            <div class="absolute inset-0 flex items-center justify-center text-rose-200 text-6xl"><i class="fas fa-graduation-cap"></i></div>
                            <span class="absolute top-4 left-4 bg-rose-600 text-white text-[10px] font-bold px-2 py-1 rounded uppercase">Premium</span>
                        </div>
                        <div class="p-6 flex-1 flex flex-col">
                            <h3 class="font-bold text-lg mb-2">Thèse de Doctorat</h3>
                            <p class="text-sm text-slate-500 mb-4 flex-1">Impression Couleur + Reliure Cuir Souple + Couverture Cartonnée.</p>
                            <div class="flex items-center justify-between mt-auto">
                                <span class="text-2xl font-black text-slate-900">50.000 <span class="text-xs text-slate-400 font-normal">FC</span></span>
                                <a href="javascript:void(0)" onclick="openTerminal()" class="w-10 h-10 rounded-full bg-slate-900 text-white flex items-center justify-center hover:bg-indigo-600 transition-colors"><i class="fas fa-arrow-right"></i></a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Item 6: Cartes de Visite Luxe (Corporate) -->
                    <div class="market-item glass flex flex-col group overflow-hidden" data-category="corporate">
                        <div class="h-48 bg-amber-50 relative">
                            <div class="absolute inset-0 flex items-center justify-center text-amber-200 text-6xl"><i class="fas fa-address-card"></i></div>
                        </div>
                        <div class="p-6 flex-1 flex flex-col">
                            <h3 class="font-bold text-lg mb-2">Cartes de Visite Luxe</h3>
                            <p class="text-sm text-slate-500 mb-4 flex-1">Papier Brillant 350g + Recto/Verso + Bords Arrondis.</p>
                            <div class="flex items-center justify-between mt-auto">
                                <span class="text-2xl font-black text-slate-900">30.000 <span class="text-xs text-slate-400 font-normal">FC</span></span>
                                <a href="javascript:void(0)" onclick="openTerminal()" class="w-10 h-10 rounded-full bg-slate-900 text-white flex items-center justify-center hover:bg-indigo-600 transition-colors"><i class="fas fa-arrow-right"></i></a>
                            </div>
                        </div>
                    </div>

                    <!-- Item 7: Roll-Up Bannière (Marketing) -->
                    <div class="market-item glass flex flex-col group overflow-hidden" data-category="marketing">
                        <div class="h-48 bg-blue-50 relative">
                            <div class="absolute inset-0 flex items-center justify-center text-blue-200 text-6xl"><i class="fas fa-flag"></i></div>
                        </div>
                        <div class="p-6 flex-1 flex flex-col">
                            <h3 class="font-bold text-lg mb-2">Roll-Up Bannière</h3>
                            <p class="text-sm text-slate-500 mb-4 flex-1">Support 85x200cm + Housse de transport + Impression Haute Déf.</p>
                            <div class="flex items-center justify-between mt-auto">
                                <span class="text-2xl font-black text-slate-900">40.000 <span class="text-xs text-slate-400 font-normal">FC</span></span>
                                <a href="javascript:void(0)" onclick="openTerminal()" class="w-10 h-10 rounded-full bg-slate-900 text-white flex items-center justify-center hover:bg-indigo-600 transition-colors"><i class="fas fa-arrow-right"></i></a>
                            </div>
                        </div>
                    </div>

                    <!-- Item 8: Notes de Cours (Académique) -->
                    <div class="market-item glass flex flex-col group overflow-hidden" data-category="academique">
                        <div class="h-48 bg-teal-50 relative">
                            <div class="absolute inset-0 flex items-center justify-center text-teal-200 text-6xl"><i class="fas fa-book-open"></i></div>
                            <span class="absolute top-4 left-4 bg-teal-600 text-white text-[10px] font-bold px-2 py-1 rounded uppercase">Éco</span>
                        </div>
                        <div class="p-6 flex-1 flex flex-col">
                            <h3 class="font-bold text-lg mb-2">Notes de Cours (Pack 10)</h3>
                            <p class="text-sm text-slate-500 mb-4 flex-1">Double photocopiage N&B + Agrafage central.</p>
                            <div class="flex items-center justify-between mt-auto">
                                <span class="text-2xl font-black text-slate-900">12.000 <span class="text-xs text-slate-400 font-normal">FC</span></span>
                                <a href="javascript:void(0)" onclick="openTerminal()" class="w-10 h-10 rounded-full bg-slate-900 text-white flex items-center justify-center hover:bg-indigo-600 transition-colors"><i class="fas fa-arrow-right"></i></a>
                            </div>
                        </div>
                    </div>

                    <!-- Item 9: En-Têtes Lettres (Corporate) -->
                    <div class="market-item glass flex flex-col group overflow-hidden" data-category="corporate">
                        <div class="h-48 bg-slate-50 relative">
                            <div class="absolute inset-0 flex items-center justify-center text-slate-200 text-6xl"><i class="fas fa-envelope-open-text"></i></div>
                        </div>
                        <div class="p-6 flex-1 flex flex-col">
                            <h3 class="font-bold text-lg mb-2">En-Têtes Lettres</h3>
                            <p class="text-sm text-slate-500 mb-4 flex-1">500 feuilles A4 80g + Logo en couleur + Typo standard.</p>
                            <div class="flex items-center justify-between mt-auto">
                                <span class="text-2xl font-black text-slate-900">15.000 <span class="text-xs text-slate-400 font-normal">FC</span></span>
                                <a href="javascript:void(0)" onclick="openTerminal()" class="w-10 h-10 rounded-full bg-slate-900 text-white flex items-center justify-center hover:bg-indigo-600 transition-colors"><i class="fas fa-arrow-right"></i></a>
                            </div>
                        </div>
                    </div>

                    <!-- Item 10: Flyers Triptyques (Marketing) -->
                    <div class="market-item glass flex flex-col group overflow-hidden" data-category="marketing">
                        <div class="h-48 bg-pink-50 relative">
                            <div class="absolute inset-0 flex items-center justify-center text-pink-200 text-6xl"><i class="fas fa-map"></i></div>
                        </div>
                        <div class="p-6 flex-1 flex flex-col">
                            <h3 class="font-bold text-lg mb-2">Flyers Triptyques</h3>
                            <p class="text-sm text-slate-500 mb-4 flex-1">Pliage en 3 (Roulé) + Papier 135g Mat.</p>
                            <div class="flex items-center justify-between mt-auto">
                                <span class="text-2xl font-black text-slate-900">8.000 <span class="text-xs text-slate-400 font-normal">FC</span></span>
                                <a href="javascript:void(0)" onclick="openTerminal()" class="w-10 h-10 rounded-full bg-slate-900 text-white flex items-center justify-center hover:bg-indigo-600 transition-colors"><i class="fas fa-arrow-right"></i></a>
                            </div>
                        </div>
                    </div>

                    <!-- Item 11: Cahier d'Entreprise (Corporate) -->
                    <div class="market-item glass flex flex-col group overflow-hidden" data-category="corporate">
                        <div class="h-48 bg-cyan-50 relative">
                            <div class="absolute inset-0 flex items-center justify-center text-cyan-200 text-6xl"><i class="fas fa-book"></i></div>
                        </div>
                        <div class="p-6 flex-1 flex flex-col">
                            <h3 class="font-bold text-lg mb-2">Cahier d'Entreprise</h3>
                            <p class="text-sm text-slate-500 mb-4 flex-1">Reliure spirale wire + Couverture personnalisée.</p>
                            <div class="flex items-center justify-between mt-auto">
                                <span class="text-2xl font-black text-slate-900">6.000 <span class="text-xs text-slate-400 font-normal">FC</span></span>
                                <a href="javascript:void(0)" onclick="openTerminal()" class="w-10 h-10 rounded-full bg-slate-900 text-white flex items-center justify-center hover:bg-indigo-600 transition-colors"><i class="fas fa-arrow-right"></i></a>
                            </div>
                        </div>
                    </div>

                    <!-- Item 12: Stickers Découpés (Marketing) -->
                    <div class="market-item glass flex flex-col group overflow-hidden" data-category="marketing">
                        <div class="h-48 bg-fuchsia-50 relative">
                            <div class="absolute inset-0 flex items-center justify-center text-fuchsia-200 text-6xl"><i class="fas fa-sticky-note"></i></div>
                        </div>
                        <div class="p-6 flex-1 flex flex-col">
                            <h3 class="font-bold text-lg mb-2">Stickers Ronds (Die-cut)</h3>
                            <p class="text-sm text-slate-500 mb-4 flex-1">Lot de 100 autocollants contours perdus.</p>
                            <div class="flex items-center justify-between mt-auto">
                                <span class="text-2xl font-black text-slate-900">20.000 <span class="text-xs text-slate-400 font-normal">FC</span></span>
                                <a href="javascript:void(0)" onclick="openTerminal()" class="w-10 h-10 rounded-full bg-slate-900 text-white flex items-center justify-center hover:bg-indigo-600 transition-colors"><i class="fas fa-arrow-right"></i></a>
                            </div>
                        </div>
                    </div>

                    <!-- Item 13: Rapport Annuel (Corporate) -->
                    <div class="market-item glass flex flex-col group overflow-hidden" data-category="corporate">
                        <div class="h-48 bg-stone-50 relative">
                            <div class="absolute inset-0 flex items-center justify-center text-stone-200 text-6xl"><i class="fas fa-building"></i></div>
                            <span class="absolute top-4 left-4 bg-stone-700 text-white text-[10px] font-bold px-2 py-1 rounded uppercase">Exclusif</span>
                        </div>
                        <div class="p-6 flex-1 flex flex-col">
                            <h3 class="font-bold text-lg mb-2">Rapport Annuel</h3>
                            <p class="text-sm text-slate-500 mb-4 flex-1">Design couverture + Impression Selective + Reliure Rigide.</p>
                            <div class="flex items-center justify-between mt-auto">
                                <span class="text-2xl font-black text-slate-900">80.000 <span class="text-xs text-slate-400 font-normal">FC</span></span>
                                <a href="javascript:void(0)" onclick="openTerminal()" class="w-10 h-10 rounded-full bg-slate-900 text-white flex items-center justify-center hover:bg-indigo-600 transition-colors"><i class="fas fa-arrow-right"></i></a>
                            </div>
                        </div>
                    </div>

                    <!-- Item 14: Affiches Événements (Marketing) -->
                    <div class="market-item glass flex flex-col group overflow-hidden" data-category="marketing">
                        <div class="h-48 bg-indigo-50 relative">
                            <div class="absolute inset-0 flex items-center justify-center text-indigo-200 text-6xl"><i class="fas fa-images"></i></div>
                        </div>
                        <div class="p-6 flex-1 flex flex-col">
                            <h3 class="font-bold text-lg mb-2">Affiches Événements</h3>
                            <p class="text-sm text-slate-500 mb-4 flex-1">Format A2 (50x70cm) + Papier Affiche 115g.</p>
                            <div class="flex items-center justify-between mt-auto">
                                <span class="text-2xl font-black text-slate-900">25.000 <span class="text-xs text-slate-400 font-normal">FC</span></span>
                                <a href="javascript:void(0)" onclick="openTerminal()" class="w-10 h-10 rounded-full bg-slate-900 text-white flex items-center justify-center hover:bg-indigo-600 transition-colors"><i class="fas fa-arrow-right"></i></a>
                            </div>
                        </div>
                    </div>

                </div>
            </section>
        </div>

        <!-- PAGE 3: SERVICES & TARIFS -->
        <div id="services-view" class="page-view">
            <section class="max-w-7xl mx-auto px-6 py-10">
                <div class="mb-10 text-center">
                    <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900 tracking-tight mb-4"><span class="text-gradient" data-i18n="services_title">Services & Tarifs</span></h1>
                    <p class="text-slate-500 max-w-2xl mx-auto text-lg" data-i18n="services_desc">Une tarification transparente et compétitive pour tous vos projets.</p>
                </div>

                <!-- TABLE SECTION -->
                <div class="glass overflow-hidden mb-12">
                    <div class="p-6 border-b border-slate-200">
                        <h3 class="text-xl font-bold text-slate-900" data-i18n="srv_pricing">Grille Tarifaire (Prix unitaire)</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead>
                                <tr class="bg-slate-50 text-slate-600 font-bold uppercase text-xs tracking-wider">
                                    <th class="px-6 py-4" data-i18n="srv_format">Format</th>
                                    <th class="px-6 py-4" data-i18n="srv_bw">Noir & Blanc</th>
                                    <th class="px-6 py-4" data-i18n="srv_color">Couleur</th>
                                    <th class="px-6 py-4 hidden md:table-cell" data-i18n="srv_premium">Premium</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                <tr class="hover:bg-indigo-50/50 transition-colors"><td class="px-6 py-4 font-bold text-slate-900">A5</td><td class="px-6 py-4 text-slate-600">200 FC</td><td class="px-6 py-4 text-slate-600">400 FC</td><td class="px-6 py-4 hidden md:table-cell text-indigo-600">-</td></tr>
                                <tr class="hover:bg-indigo-50/50 transition-colors bg-white"><td class="px-6 py-4 font-bold text-slate-900">A4</td><td class="px-6 py-4 text-slate-600">400 FC</td><td class="px-6 py-4 text-slate-600">700 FC</td><td class="px-6 py-4 hidden md:table-cell text-indigo-600">1.200 FC</td></tr>
                                <tr class="hover:bg-indigo-50/50 transition-colors"><td class="px-6 py-4 font-bold text-slate-900">A3</td><td class="px-6 py-4 text-slate-600">1.000 FC</td><td class="px-6 py-4 text-slate-600">1.800 FC</td><td class="px-6 py-4 hidden md:table-cell text-indigo-600">2.500 FC</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 bg-indigo-50 text-xs text-indigo-800 text-center font-bold">* Tarifs pour recto simple. Ajoutez 60% pour recto-verso.</div>
                </div>

                <!-- FINITIONS -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="glass p-8 text-center hover:border-indigo-500 transition-colors"><i class="fas fa-book text-4xl text-indigo-600 mb-4"></i><h3 class="font-bold text-lg mb-2" data-i18n="srv_binding">Reliure</h3><p class="text-sm text-slate-500 mb-4" data-i18n="srv_binding_desc">Spirale métallique, Thermocollée ou Cannelée.</p><p class="font-black text-slate-900">1.500 FC <span class="text-xs text-slate-400 font-normal">/ unité</span></p></div>
                    <div class="glass p-8 text-center hover:border-indigo-500 transition-colors"><i class="fas fa-shield-alt text-4xl text-indigo-600 mb-4"></i><h3 class="font-bold text-lg mb-2" data-i18n="srv_laminate">Plastification</h3><p class="text-sm text-slate-500 mb-4" data-i18n="srv_laminate_desc">Protection matte ou brillante.</p><p class="font-black text-slate-900">1.000 FC <span class="text-xs text-slate-400 font-normal">/ feuille</span></p></div>
                    <div class="glass p-8 text-center hover:border-indigo-500 transition-colors"><i class="fas fa-cut text-4xl text-indigo-600 mb-4"></i><h3 class="font-bold text-lg mb-2" data-i18n="srv_cut">Découpe & Massicot</h3><p class="text-sm text-slate-500 mb-4" data-i18n="srv_cut_desc">Découpe précise au millimètre.</p><p class="font-black text-slate-900">500 FC <span class="text-xs text-slate-400 font-normal">/ coupe</span></p></div>
                </div>
            </section>
        </div>
        <!-- PAGE 4: ESPACE ADMIN (Caché par défaut) -->
        <!-- PAGE 4: ESPACE ADMIN (À coller AVANT le footer) -->
        <div id="admin-view" class="page-view">
    <section class="max-w-7xl mx-auto px-6 py-10">
        <div class="flex justify-between items-end mb-10 border-b border-slate-200 pb-6">
            <div>
                <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900 tracking-tight mb-2"><span class="text-gradient">Espace Admin</span></h1>
                <p class="text-slate-500">Gérez le contenu de votre application.</p>
            </div>
            <button onclick="openArticleModal()" class="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition-all flex items-center gap-2">
                <i class="fas fa-plus"></i> Nouvel Article
            </button>
        </div>

        <!-- Liste des articles -->
        <div id="admin-articles-list" class="grid grid-cols-1 gap-6">
            <!-- Les articles s'afficheront ici via JS -->
            <div class="text-center py-10 text-slate-400">Chargement des articles...</div>
        </div>

        <!-- SECTION GESTION MEMBRES (BADGES) -->
        <div class="mt-12 border-t border-slate-200 pt-8">
            <h3 class="text-2xl font-black mb-6 flex items-center gap-2">
                <i class="fas fa-certificate text-amber-500"></i> Certification Membres
            </h3>
            
            <div class="glass overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-slate-600 uppercase font-bold text-xs">
                            <tr>
                                <th class="px-6 py-4">Utilisateur</th>
                                <th class="px-6 py-4">Email</th>
                                <th class="px-6 py-4 text-center">Statut Actuel</th>
                                <th class="px-6 py-4 text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="admin-users-list" class="divide-y divide-slate-100">
                            <!-- La liste se chargera via JS -->
                            <tr><td colspan="4" class="p-4 text-center text-slate-400">Chargement...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>
</div>
        
    <!-- PAGE 5: FLUX CONVERT (CONVERTISSEUR) -->
<div id="convert-view" class="page-view">
    
    <!-- STYLE SPÉCIFIQUE POUR ISOLER LE CONVERTISSEUR -->
    <!-- On force les variables et la position pour que cela ne touche pas au reste de Printbam -->
    <style>
        /* --- DESIGN TOKENS (SYSTEM) --- */
        :root {
            /* Palette "Slate" (Professional Dark Grey) */
            --bg-body: #f8fafc;
            --bg-surface: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #94a3b8;
            
            /* Brand Colors (Stripe-ish Blue) */
            --brand-50: #eff6ff;
            --brand-500: #3b82f6;
            --brand-600: #2563eb;
            --brand-900: #1e3a8a;
            
            /* Functional */
            --border-subtle: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            /* Animation Curve */
            --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
            
            /* Radius */
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --radius-full: 9999px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- HERO SECTION --- */
        .hero {
            padding-top: 10px;
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }
        .badge {
            display: inline-flex; align-items: center; gap: 6px;
            background: var(--brand-50);
            color: var(--brand-600);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 24px;
            border: 1px solid rgba(59, 130, 246, 0.1);
        }
        .hero p {
            font-size: 1.25rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 40px;
        }
        
        /* --- APP INTERFACE (The Core) --- */
        .app-wrapper {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 24px 80px 24px;
            position: relative;
            z-index: 10;
        }
        
        /* Tab Control (Segmented) */
        .control-panel {
            background: white;
            padding: 6px;
            border-radius: var(--radius-full);
            display: inline-flex;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-subtle);
            margin-bottom: 32px;
            position: relative;
        }
        .tab-btn {
            background: transparent;
            border: none;
            padding: 10px 24px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s var(--ease-out-expo);
            position: relative;
            z-index: 2;
        }
        .tab-btn.active {
            color: var(--text-primary);
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Tool Grid (Masonry-ish) */
        .grid-tools {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 40px;
            display: none; /* Hidden logic */
        }
        .grid-tools.active { display: grid; animation: fadeIn 0.5s var(--ease-out-expo); }

        .tool-card {
            background: white;
            padding: 20px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: all 0.2s var(--ease-out-expo);
            position: relative;
            overflow: hidden;
        }
        .tool-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--brand-200);
        }
        .tool-card.selected {
            background: var(--bg-body);
            border-color: var(--brand-500);
            box-shadow: 0 0 0 1px var(--brand-500);
        }
        .tool-header {
            display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;
        }
        .tool-icon {
            width: 32px; height: 32px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            color: white;
            font-size: 0.8rem;
            font-weight: 700;
        }
        .arrow-icon { color: var(--text-tertiary); transition: transform 0.2s; }
        .tool-card:hover .arrow-icon { transform: translateX(4px); color: var(--brand-500); }

        /* Main Converter Window */
        .converter-window {
            background: white;
            border-radius: 24px;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-subtle);
            overflow: hidden;
            position: relative;
            min-height: 500px;
            display: flex;
            flex-direction: column;
        }
        
        /* Upload State */
        .dropzone {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 60px;
            transition: background 0.3s;
            cursor: pointer;
            position: relative;
        }
        .dropzone.dragover { background: var(--brand-50); }
        .dropzone-content { pointer-events: none; }
        .dropzone-illustration {
            width: 100px; height: 100px;
            background: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 24px auto;
            box-shadow: var(--shadow-lg);
            color: var(--brand-500);
            transition: transform 0.3s var(--ease-out-expo);
        }
        .dropzone:hover .dropzone-illustration { transform: scale(1.05) rotate(5deg); }
        
        .btn-large-upload {
            background: var(--text-primary);
            color: white;
            padding: 14px 32px;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow-md);
            display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-large-upload:hover { transform: translateY(-1px); box-shadow: var(--shadow-lg); }

        /* File List (Pro Table Style) */
        .file-list-container {
            display: none;
            padding: 24px;
            flex: 1;
            overflow-y: auto;
        }
        .file-item {
            display: grid;
            grid-template-columns: 40px 1fr 100px 40px;
            align-items: center;
            padding: 16px;
            background: var(--bg-body);
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .file-item:hover { border-color: var(--brand-200); background: white; box-shadow: var(--shadow-sm); }
        
        .progress-container { height: 4px; background: #e2e8f0; border-radius: 2px; overflow: hidden; margin-top: 6px; }
        .progress-bar { height: 100%; background: var(--brand-500); width: 0%; transition: width 0.2s; }

        /* Success Screen */
        .success-screen {
            display: none;
            flex: 1;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px;
            animation: slideUp 0.6s var(--ease-out-expo);
        }
        .success-visual {
            width: 80px; height: 80px;
            background: #dcfce7; color: #16a34a;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 24px;
        }

        /* --- FEATURES SECTION (Trust) --- */
        .features-section {
            background: white;
            border-top: 1px solid var(--border-subtle);
            padding: 100px 24px;
        }
        .features-grid {
            max-width: 1200px; margin: 0 auto;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 60px;
        }
        .feature-item h3 { font-size: 1.25rem; font-weight: 700; margin-bottom: 12px; }
        .feature-item p { color: var(--text-secondary); line-height: 1.6; font-size: 1rem; }

        /* --- FOOTER (Minimalist) --- */
        footer {
            background: white;
            padding: 80px 24px 40px 24px;
            border-top: 1px solid var(--border-subtle);
        }
        .footer-container {
            max-width: 1200px; margin: 0 auto;
            display: grid; grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 40px;
        }
        .footer-logo { font-weight: 800; font-size: 1.5rem; margin-bottom: 20px; display: block; }
        .footer-heading {
            font-size: 0.85rem; font-weight: 600; color: var(--text-primary);
            margin-bottom: 20px; text-transform: uppercase; letter-spacing: 0.05em;
        }
        .footer-links a {
            display: block; color: var(--text-secondary);
            text-decoration: none; margin-bottom: 12px; font-size: 0.95rem;
        }
        .footer-links a:hover { color: var(--brand-600); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

        /* Utility */
        .hidden { display: none !important; }
        
        @media (max-width: 768px) {
            h1 { font-size: 2.5rem; }
            .footer-container { grid-template-columns: 1fr; }
            .file-item { grid-template-columns: 40px 1fr 30px; }
            .file-item div:nth-child(3) { display: none; } /* Hide status on mobile */
        }

        /* SCROLLBAR PRO POUR LE CHAT */
#chat-messages-container::-webkit-scrollbar {
    width: 6px;
}
#chat-messages-container::-webkit-scrollbar-track {
    background: transparent;
}
#chat-messages-container::-webkit-scrollbar-thumb {
    background-color: rgba(148, 163, 184, 0.3); /* Slate-400 transparent */
    border-radius: 10px;
}
#chat-messages-container::-webkit-scrollbar-thumb:hover {
    background-color: rgba(148, 163, 184, 0.6);
}

/* ANIMATION SOUPLE POUR L'INPUT */
.input-grow:focus-within {
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
    transform: translateY(-2px);
    transition: all 0.3s ease;
}
        /* Messages */
        <!-- --- STYLE EXCLUSIF POUR L'INTERFACE MESSAGES (WHATSAPP-LIKE) --- -->
    /* Fond spécifique "WhatsApp Beige" */
    .wa-bg {
        background-color: #efeae2; 
        background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0fea-9f38-9af3-4d37-073f64e4bc0.png"); /* Pattern subtil optionnel */
        background-size: 400px;
        background-position: center;
    }

    /* Bulle Reçue (Blanche, Queue pointue) */
    .msg-bubble-left {
        background-color: #ffffff;
        border-radius: 0 8px 8px 8px; /* Queue plate à gauche */
        position: relative;
        box-shadow: 0 1px 1px rgba(0,0,0,0.05);
    }

    /* Bulle Envoyée (Verte clair, Queue pointue) */
    .msg-bubble-right {
        background-color: #dcf8c6;
        border-radius: 8px 0 8px 8px; /* Queue plate à droite */
        position: relative;
        box-shadow: 0 1px 1px rgba(0,0,0,0.05);
    }

    /* Header Vert WhatsApp */
    .wa-header {
        background-color: #00a884;
        color: white;
    }
    </style>
    <!-- HERO -->
    <div class="hero">
        <div class="badge">
            <span style="width:6px; height:6px; background:currentColor; border-radius:50%;"></span>
            Printbam - Convert
        </div>
        <h1 H>La plateforme de conversion gratuit <br>pour les équipes modernes.</h1>
        <p>Convertissez, compressez et éditez des documents directement dans votre navigateur. Zéro installation, confidentialité absolue.</p>
    </div>

    <!-- APP -->
    <div class="app-wrapper">
        
        <!-- Control Tabs -->
        <div style="text-align:center; margin-bottom:24px;">
            <div class="control-panel">
                <button class="tab-btn active" onclick="switchCat('docs')">Documents</button>
                <button class="tab-btn" onclick="switchCat('images')">Images</button>
                <button class="tab-btn" onclick="switchCat('pdf')">PDF Tools</button>
            </div>
        </div>

        <!-- Grids -->
        <div id="grid-docs" class="grid-tools active">
            <div class="tool-card selected" onclick="setTool('word-pdf', '.doc,.docx', 'word')">
                <div class="tool-header">
                    <div class="tool-icon" style="background:#2563eb;">W</div>
                    <div class="arrow-icon">→</div>
                </div>
                <div style="font-weight:600; margin-bottom:4px;">Word vers PDF</div>
                <div style="font-size:0.8rem; color:var(--text-secondary);">.docx → .pdf</div>
            </div>
            <div class="tool-card" onclick="setTool('excel-pdf', '.xls,.xlsx', 'excel')">
                <div class="tool-header">
                    <div class="tool-icon" style="background:#16a34a;">X</div>
                    <div class="arrow-icon">→</div>
                </div>
                <div style="font-weight:600; margin-bottom:4px;">Excel vers PDF</div>
                <div style="font-size:0.8rem; color:var(--text-secondary);">.xlsx → .pdf</div>
            </div>
            <div class="tool-card" onclick="setTool('ppt-pdf', '.ppt,.pptx', 'ppt')">
                <div class="tool-header">
                    <div class="tool-icon" style="background:#f97316;">P</div>
                    <div class="arrow-icon">→</div>
                </div>
                <div style="font-weight:600; margin-bottom:4px;">PowerPoint vers PDF</div>
                <div style="font-size:0.8rem; color:var(--text-secondary);">.pptx → .pdf</div>
            </div>
            <div class="tool-card" onclick="setTool('pdf-word', '.pdf', 'pdf')">
                <div class="tool-header">
                    <div class="tool-icon" style="background:#ef4444;">PDF</div>
                    <div class="arrow-icon">→</div>
                </div>
                <div style="font-weight:600; margin-bottom:4px;">PDF vers Word</div>
                <div style="font-size:0.8rem; color:var(--text-secondary);">.pdf → .docx</div>
            </div>
        </div>

        <div id="grid-images" class="grid-tools">
            <div class="tool-card" onclick="setTool('img-pdf', '.jpg,.png,.webp', 'img')">
                <div class="tool-header">
                    <div class="tool-icon" style="background:#9333ea;">IMG</div>
                    <div class="arrow-icon">→</div>
                </div>
                <div style="font-weight:600; margin-bottom:4px;">Images vers PDF</div>
                <div style="font-size:0.8rem; color:var(--text-secondary);">.jpg, .png → .pdf</div>
            </div>
             <div class="tool-card" onclick="setTool('heic-jpg', '.heic,.heif', 'img')">
                <div class="tool-header">
                    <div class="tool-icon" style="background:#9333ea;">HEIC</div>
                    <div class="arrow-icon">→</div>
                </div>
                <div style="font-weight:600; margin-bottom:4px;">HEIC vers JPG</div>
                <div style="font-size:0.8rem; color:var(--text-secondary);">.heic → .jpg</div>
            </div>
        </div>

        <div id="grid-pdf" class="grid-tools">
             <div class="tool-card" onclick="setTool('pdf-compress', '.pdf', 'pdf')">
                <div class="tool-header">
                    <div class="tool-icon" style="background:#ef4444;">ZIP</div>
                    <div class="arrow-icon">→</div>
                </div>
                <div style="font-weight:600; margin-bottom:4px;">Compresser PDF</div>
                <div style="font-size:0.8rem; color:var(--text-secondary);">Réduire la taille</div>
            </div>
        </div>

        <!-- CONVERTER WINDOW -->
        <div class="converter-window">
            <input type="file" id="fileInput" hidden multiple>

            <!-- UPLOAD VIEW -->
            <div id="uploadView" class="dropzone">
                <div class="dropzone-content">
                    <div class="dropzone-illustration">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    </div>
                    <h3 style="font-size:1.5rem; margin-bottom:8px; font-weight:700;">Glissez vos fichiers</h3>
                    <p style="color:var(--text-secondary); margin-bottom:24px;">ou parcourir depuis votre ordinateur</p>
                    <button class="btn-large-upload" onclick="document.getElementById('fileInput').click()">
                        Sélectionner des fichiers
                    </button>
                    <div style="margin-top:16px; font-size:0.85rem; color:var(--text-tertiary);">
                        Max 100MB par fichier • Supporte <strong id="supportLabel">.doc, .docx</strong>
                    </div>
                </div>
            </div>

            <!-- LIST VIEW -->
            <div id="listView" class="file-list-container"></div>
            
            <!-- ACTIONS -->
            <div id="actionBar" class="hidden" style="padding:20px 24px; border-top:1px solid var(--border-subtle); display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.8);">
                <div style="font-size:0.9rem; color:var(--text-secondary);">
                    <span id="fileCount">0</span> fichiers prêts
                </div>
                <button class="btn-large-upload" onclick="startProcess()">
                    Convertir
                </button>
            </div>

            <!-- SUCCESS VIEW -->
            <div id="successView" class="success-screen">
                <div class="success-visual">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>
                </div>
                <h2 style="font-size:1.5rem; margin-bottom:8px;">Conversion terminée</h2>
                <p style="color:var(--text-secondary); margin-bottom:32px;">Vos fichiers ont été traités avec succès.</p>
                <a id="dlBtn" class="btn-large-upload" style="text-decoration:none; background:#16a34a;">
                    Télécharger tout
                </a>
                <button onclick="resetApp()" style="margin-top:16px; background:none; border:none; color:var(--text-secondary); cursor:pointer; font-size:0.9rem;">
                    Convertir d'autres fichiers
                </button>
            </div>

        </div>
    </div>

    <!-- FEATURES (On les cache ou on les garde ?) -->
    <!-- Je les laisse visibles car ça fait pro, mais je limite la hauteur -->
    <section class="features-section" id="features" style="padding: 40px 24px;">
        <div class="features-grid" style="display: grid; gap: 30px; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
            <div class="feature-item">
                <h3>🔒 Sécurité Bancaire</h3>
                <p>Chiffrement TLS 1.3 de bout en bout. Vos fichiers sont supprimés automatiquement de nos serveurs après 1 heure.</p>
            </div>
            <div class="feature-item">
                <h3>⚡ Vitesse Éclair</h3>
                <p>Infrastructure distribuée sur 5 continents. Latence moyenne inférieure à 200ms pour le traitement.</p>
            </div>
            <div class="feature-item">
                <h3>🏢 API Entreprise</h3>
                <p>Intégrez nos moteurs de conversion directement dans votre workflow CRM ou ERP via notre API REST.</p>
            </div>
        </div>
    </section>
</div>
    </div>
        
    <!-- MOBILE DOCK -->
    <div class="mobile-dock md:hidden bg-white rounded-2xl px-2 py-2 flex items-center justify-between shadow-xl border border-slate-100">
        <a onclick="switchPage('home')" class="flex flex-1 flex-col items-center gap-1 group cursor-pointer"><i class="fas fa-house text-lg text-indigo-600"></i><span class="text-[9px] font-medium text-indigo-600">Explorer</span></a>
        <a onclick="switchPage('marketplace')" class="flex flex-1 flex-col items-center gap-1 group cursor-pointer"><i class="fas fa-shopping-bag text-lg text-slate-400 group-hover:text-slate-600"></i><span class="text-[9px] font-medium text-slate-400">Marketplace</span></a>
        <!-- BOUTON CENTRAL DU DOCK MODIFIÉ -->
<div class="flex flex-1 justify-center -mt-6"> 
    <a href="javascript:void(0)" 
       onclick="openNewPostModal()" 
       class="relative group cursor-pointer">
        <div class="w-14 h-14 bg-indigo-600 rounded-full flex items-center justify-center shadow-lg shadow-indigo-200 border-4 border-slate-50">
            <!-- CHANGEZ L'ICÔNE ICI -->
            <i class="fas fa-plus text-white text-lg"></i>
        </div>
    </a>
</div>
        <!-- NOUVEAU CODE POUR L'ONGLET MESSAGES -->
<!-- LIEN MESSAGES AVEC BADGE -->
<a href="javascript:void(0)" onclick="switchPage('messages')" class="flex flex-1 flex-col items-center gap-1 group cursor-pointer relative">
    <div class="relative">
        <i class="far fa-paper-plane text-lg text-slate-400 group-hover:text-indigo-600 transition-colors"></i>
        <!-- LE BADGE (Caché par défaut) -->
        <span id="msg-badge-count" class="hidden absolute -top-1.5 -right-1.5 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full min-w-[18px] text-center shadow-sm border-2 border-white dark:border-slate-900">0</span>
    </div>
    <span class="text-[9px] font-medium text-slate-400">Messages</span>
</a>
        <!-- LIEN PROFIL MODIFIÉ -->
<a href="javascript:void(0)" onclick="switchPage('profile-social')" class="flex flex-1 flex-col items-center gap-1 group relative">
    
    <!-- Conteneur de l'avatar (Rond) -->
    <div class="w-10 h-10 rounded-full bg-indigo-100 border-2 border-indigo-600 overflow-hidden flex items-center justify-center relative shadow-md group-hover:scale-110 transition-transform">
        
        <!-- Image de l'utilisateur (Cachée par défaut) -->
        <img id="dock-avatar-img" src="" alt="Profil" class="w-full h-full object-cover hidden">
        
        <!-- Icône par défaut (Visible si pas de photo) -->
        <i id="dock-avatar-icon" class="fas fa-user text-indigo-600 text-sm"></i>
    </div>

    <!-- Texte -->
    <span class="text-[9px] font-bold text-indigo-600">Profil</span>
    
    <!-- Petit badge rouge si non lu (Optionnel, décochez pour l'enlever) -->
    <div class="absolute top-0 right-2 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-slate-50"></div>
</a>
    </div>

    <!-- SETTINGS, SUPPORT, ORDERS OVERLAYS -->
    <div id="settings-overlay" class="fixed inset-0 z-[6000] invisible transition-all duration-500">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm opacity-0 transition-opacity duration-500" onclick="toggleSettings()"></div>
        <div id="settings-panel" class="absolute right-0 top-0 h-full w-full md:w-[400px] translate-x-full transition-transform duration-500 ease-[cubic-bezier(0.23,1,0.32,1)] flex flex-col shadow-2xl bg-white border-l border-slate-100">
            <div class="p-6 border-b border-slate-100 flex items-center justify-between"><h2 class="text-xl font-bold text-slate-900" data-i18n="nav_settings">Paramètres</h2><button onclick="toggleSettings()" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center hover:bg-slate-200 transition-colors"><i class="fas fa-times text-slate-500"></i></button></div>
            <div class="flex-1 overflow-y-auto p-6 space-y-8">

                <section class="space-y-6 text-left"><div class="flex flex-col gap-2 pt-4 border-t border-slate-100"><span class="text-sm font-medium text-slate-700" data-i18n="settings_lang">Langue</span><select id="language-select" onchange="changeLanguage(this.value)" class="w-full bg-white border border-slate-200 rounded-xl py-3 px-4 text-sm text-slate-900 focus:outline-none focus:border-indigo-500 transition-all"><option value="fr">Français</option><option value="en">English</option><option value="ln">Lingala</option><option value="tu">Tshiluba</option><option value="sw">Swahili</option><option value="kg">Kikongo</option></select></div></section>
            </div>
            <div class="p-6 border-t border-slate-100 bg-slate-50"><button onclick="showToast('Paramètres sauvegardés', 'success')" class="w-full py-3 bg-white border border-slate-200 rounded-xl text-xs font-bold uppercase text-slate-600 hover:bg-slate-100 transition-all"><span data-i18n="settings_save">Sauvegarder</span></button></div>
        </div>
    </div>

        <!-- PAGE : PROFIL SOCIAL (DESIGN FLAT STYLE CAPTURE) -->
<div id="profile-social-view" class="page-view">
    <!-- Container principal fond blanc pour cacher le fond de l'app -->
    <div class="bg-white min-h-screen max-w-lg mx-auto shadow-sm relative z-20 pb-20">
        
        <!-- HEADER : Avatar + Nom + Stats -->
<div class="p-5 flex items-start gap-5 border-b border-gray-100">
   <!-- BOUTON DÉCONNEXION (Haut Droit) -->
    <!-- Il s'affiche en gris, devient rouge au survol -->
    <button onclick="confirmSocialLogout()" class="absolute top-4 right-4 w-10 h-10 flex items-center justify-center rounded-full hover:bg-red-50 text-gray-400 hover:text-red-500 transition-all" title="Déconnexion">
        <i class="fas fa-sign-out-alt text-lg"></i>
    </button> 
    <!-- 1. AVATAR (Sans le badge absolu dedans) -->
    <div class="relative">
        <div class="w-20 h-20 md:w-24 md:h-24 rounded-full border border-gray-200 p-1 bg-white">
            <img id="social-avatar" src="" alt="Profile" class="w-full h-full object-cover rounded-full hidden">
            <div id="social-avatar-placeholder" class="w-full h-full bg-gray-100 rounded-full flex items-center justify-center text-gray-300">
                <i class="fas fa-user text-2xl"></i>
            </div>
        </div>
    </div>

    <!-- 2. INFOS PRINCIPALES -->
    <div class="flex-1 pt-1">
        
        <!-- Conteneur Flex pour aligner le NOM et le BADGE -->
        <div class="flex items-center gap-1 mb-1">
            <h1 id="social-fullname" class="text-xl font-bold text-black leading-none">Chargement...</h1>
            
            <!-- LE BADGE EST MAINTENANT ICI (Style Facebook : Rond bleu + Check blanc) -->
            <span id="social-badge-inline" class="hidden ml-1">
    <!-- Couleur officielle Instagram : #0095F6 -->
    <i class="fas fa-check-circle text-[#0095F6] text-lg"></i>
</span>
        </div>
        
        <!-- Stats -->
        <div class="text-sm text-gray-600 font-medium mb-2">
            <span id="stat-following">0</span> suivis • 
            <span id="stat-followers">0</span> abonnés
        </div>
        
        <!-- Bouton Modifier -->
        <button onclick="toggleProfile()" class="px-3 py-1 bg-gray-100 text-xs font-bold text-gray-700 rounded hover:bg-gray-200 transition">
            Modifier le profil
        </button>
        <!-- NOUVEAU CONTENEUR POUR LE BOUTON FOLLOW (Caché par défaut) -->
        <div id="profile-follow-container" class="hidden">
            <!-- Le bouton sera injecté ici par JS -->
        </div>
    </div>
</div>

        <!-- SECTION INFOS (Liste grise comme sur la capture) -->
        <div class="bg-gray-50 px-5 py-4 space-y-3 border-b border-gray-200">
            <!-- Téléphone -->
            <div class="flex items-center gap-3">
                <i class="fas fa-phone text-gray-400 w-4 text-center"></i>
                <span id="social-phone" class="text-sm text-gray-700 font-medium">...</span>
            </div>
            <!-- Username -->
            <div class="flex items-center gap-3">
                <i class="fas fa-at text-gray-400 w-4 text-center"></i>
                <span id="social-username" class="text-sm text-gray-700 font-medium">...</span>
            </div>
            <!-- Date de naissance -->
            <div class="flex items-center gap-3">
                <i class="fas fa-birthday-cake text-gray-400 w-4 text-center"></i>
                <span id="social-dob" class="text-sm text-gray-700 font-medium">...</span>
            </div>
        </div>

        <!-- ONGLETS (Publications / Archivées) -->
        <div class="flex border-b border-gray-200">
            <button onclick="switchSocialTab('publications')" class="social-tab-btn flex-1 py-4 text-sm font-bold text-black border-b-2 border-black transition-colors">
                Publications
            </button>
            <button onclick="switchSocialTab('archives')" class="social-tab-btn flex-1 py-4 text-sm font-bold text-gray-400 border-b-2 border-transparent hover:text-gray-600 transition-colors">
                Publications archivées
            </button>
        </div>

        <!-- GRILLE DES PHOTOS (3 Colonnes, écart minime) -->
        <div id="social-posts-grid" class="grid grid-cols-3 gap-1 bg-gray-100">
            <!-- Les photos seront injectées ici par JS -->
            <div class="col-span-3 flex flex-col items-center justify-center py-20 text-gray-400">
                <i class="fas fa-camera text-3xl mb-2"></i>
                <p class="text-xs">Aucune publication</p>
            </div>
        </div>

        <!-- BOUTON AJOUTER FLOTTANT (En bas à droite ou fixe en bas) -->
        <!-- La capture montre un bouton en bas. Je le place fixe en bas à droite pour l'effet moderne -->
        <button onclick="openNewPostModal()" class="fixed bottom-6 right-6 md:absolute md:bottom-6 md:right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-blue-700 transition-all z-50">
            <i class="fas fa-plus text-xl"></i>
        </button>

    </div>
</div>

<!-- MODALE AJOUT PHOTO (Simple et blanche) -->
<div id="new-post-modal" class="fixed inset-0 z-[9500] hidden bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl">
        <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
            <h3 class="font-bold text-black">Nouvelle publication</h3>
            <button onclick="closeNewPostModal()" class="text-blue-500 font-bold text-sm">Annuler</button>
        </div>
        <div class="p-4">
          <form id="new-post-form" onsubmit="handleNewPost(event)" class="space-y-4">
    
    <!-- SÉLECTEUR DE TYPE -->
    <div class="flex p-1 bg-slate-100 rounded-lg mb-2">
        <button type="button" onclick="setPostType('image')" id="btn-type-image" class="flex-1 py-2 text-xs font-bold rounded-md bg-white shadow-sm text-slate-900 transition">
            Photo
        </button>
        <button type="button" onclick="setPostType('short')" id="btn-type-short" class="flex-1 py-2 text-xs font-bold rounded-md text-slate-500 hover:text-slate-900 transition">
            Short Vidéo
        </button>
    </div>

    <!-- INPUT IMAGE -->
    <div id="upload-image-box" class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:bg-gray-50 transition cursor-pointer" onclick="document.getElementById('post-file-input').click()">
        <input type="file" id="post-file-input" accept="image/*" class="hidden" onchange="previewFile(this, 'image')">
        <i class="fas fa-images text-3xl text-gray-400 mb-2"></i>
        <p class="text-xs text-gray-500 font-medium">Choisir une photo</p>
    </div>

    <!-- INPUT VIDÉO (Caché par défaut) -->
    <div id="upload-video-box" class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:bg-gray-50 transition cursor-pointer hidden" onclick="document.getElementById('post-video-input').click()">
        <input type="file" id="post-video-input" accept="video/mp4,video/quicktime,video/x-msvideo" class="hidden" onchange="previewFile(this, 'video')">
        <i class="fas fa-video text-3xl text-gray-400 mb-2"></i>
        <p class="text-xs text-gray-500 font-medium">Choisir une vidéo (Max 10 min)</p>
        <p id="video-error-msg" class="text-[10px] text-red-500 font-bold mt-2 hidden"></p>
    </div>

    <!-- ZONE DE PRÉVISUALISATION -->
    <div id="preview-area" class="w-full aspect-video bg-black rounded-lg hidden overflow-hidden relative flex items-center justify-center mb-2">
        <img id="preview-img-el" class="max-h-full object-contain hidden">
        <video id="preview-video-el" class="max-h-full object-contain hidden" controls></video>
    </div>

    <textarea id="post-caption" rows="3" placeholder="Écrivez une légende..." class="w-full text-sm p-3 border border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 resize-none"></textarea>
    
    <input type="hidden" id="current-post-type" value="image">
    
    <button onclick="handleNewPost(e)" type="submit" class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition">Publier</button>
</form>
        </div>
    </div>
</div>

    <!-- VUE : CENTRE DE NOTIFICATIONS -->
<div id="notifications-view" class="page-view">
    <section class="max-w-2xl mx-auto h-screen flex flex-col bg-white dark:bg-slate-900">
        
        <!-- Header -->
        <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center sticky top-0 bg-white/95 dark:bg-slate-900/95 backdrop-blur z-10">
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Notifications</h2>
            <button onclick="markAllNotificationsRead()" class="text-xs font-bold text-indigo-600 hover:underline">Tout marquer comme lu</button>
        </div>

        <!-- Liste des notifications -->
        <div id="notifications-list-container" class="flex-1 overflow-y-auto">
            <!-- Injecté par JS -->
        </div>
    </section>
</div>
        
    <!-- VUE 1 : LISTE DES MESSAGES (Style Photo 1) -->
<div id="messages-view" class="page-view">
    <section class="fixed inset-0 z-50 max-w-2xl mx-auto h-screen flex flex-col bg-white dark:bg-slate-900 translate-y-12">
        
        <!-- Header -->
        <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-white dark:bg-slate-900 sticky top-0 z-10">
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Discussions</h2>
            <button class="text-indigo-600"><i class="far fa-edit text-lg"></i></button>
        </div>

        <!-- Liste des conversations -->
        <div id="chat-list-container" class="flex-1 overflow-y-auto">
            <!-- Les éléments seront injectés ici par JS -->
            <div class="flex flex-col items-center justify-center h-full text-slate-400">
                <i class="fas fa-comments text-4xl mb-3 opacity-20"></i>
                <p>Aucune discussion pour le moment.</p>
            </div>
        </div>

        <!-- Barre de recherche (Optionnelle) -->
        <div class="px-4 -translate-y-14 bg-transparent">
            <div class="relative">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 z-10"></i>
            
            <input type="text" 
                   placeholder="Rechercher une discussion..." 
                   class="w-full pl-10 pr-4 py-2 rounded-full 
                          bg-white/70 dark:bg-slate-800/60 
                          backdrop-blur-md 
                          border border-white/20 dark:border-slate-700/50
                          text-sm shadow-xl 
                          focus:outline-none focus:ring-2 focus:ring-indigo-500/50 
                          dark:text-white transition-all">
        </div>
</div>
    </section>
</div>
<!-- ESPACE DES MESSAGES -->
<!-- VUE 1 : LISTE DES MESSAGES (Style WhatsApp) -->
<div id="messages-view" class="page-view">
    <section class="max-w-2xl mx-auto h-[calc(100vh-60px)] flex flex-col bg-white shadow-xl overflow-hidden relative">
        
        <!-- Header (Recherche) -->
        <div class="p-3 bg-[#f0f2f5] border-b border-gray-200 flex items-center gap-3">
            <button onclick="switchPage('home')" class="text-slate-400 hover:text-slate-800"><i class="fas fa-arrow-left"></i></button>
            <div class="flex-1 relative">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                <input type="text" placeholder="Rechercher une discussion..." class="w-full bg-white border border-gray-300 rounded-lg py-2 pl-9 text-sm focus:outline-none focus:border-emerald-500">
            </div>
        </div>

        <!-- Liste -->
        <div id="chat-list-container" class="flex-1 overflow-y-auto bg-white">
            <!-- Liste injectée par JS -->
             <div class="flex flex-col items-center justify-center h-full text-slate-400 text-sm">
                <p>Aucun message.</p>
            </div>
        </div>
    </section>
</div>

<!-- VUE 2 : DISCUSSION (Style WhatsApp Complet) -->
<div id="chat-view" class="page-view">
    <!-- WRAPPER POUR PRENDRE TOUT L'ÉCRAN (Z-INDEX ÉLEVÉ) -->
    <section class="fixed inset-0 max-w-2xl mx-auto w-full flex flex-col z-[10000] !important bg-white shadow-2xl">
        
        <!-- HEADER VERT -->
        <div class="wa-header p-3 flex items-center gap-3 shadow-sm z-20">
            <button onclick="switchPage('messages')" class="text-white/80 hover:text-white">
                <i class="fas fa-arrow-left text-lg"></i>
            </button>
            
            <div class="flex items-center gap-3 flex-1 cursor-pointer" onclick="viewUserProfile('${currentTargetUserId}')">
                <div class="relative">
                    <img id="chat-header-avatar" src="" class="w-10 h-10 rounded-full object-cover">
                    <div id="chat-status-dot" class="absolute bottom-0 right-0 w-3 h-3 bg-white rounded-full border-2 border-[#00a884]"></div>
                </div>
                <div class="flex flex-col justify-center">
                    <h3 id="chat-header-name" class="text-sm font-semibold text-white leading-tight">...</h3>
                    <p id="chat-header-status-text" class="text-[11px] text-emerald-100">En ligne</p>
                </div>
            </div>
            
            <div class="flex gap-4 text-white/90">
                <i class="fas fa-video cursor-pointer hover:text-white"></i>
                <i class="fas fa-phone cursor-pointer hover:text-white"></i>
                <i class="fas fa-ellipsis-v cursor-pointer hover:text-white"></i>
            </div>
        </div>

        <!-- MESSAGES (Fond Beurre) -->
        <div id="chat-messages-container" class="flex-1 overflow-y-auto p-4 wa-bg scroll-smooth bg-[#efeae2]">
            <!-- Messages injectés ici -->
        </div>

        <!-- ZONE DE SAISIE -->
        <div class="p-2 bg-[#f0f2f5] flex items-end gap-2 z-20">
            <!-- Boutons Annexes -->
            <div class="flex gap-1 text-slate-500">
                <button class="p-2 hover:bg-slate-200 rounded-full transition"><i class="far fa-smile text-xl"></i></button>
                <button class="p-2 hover:bg-slate-200 rounded-full transition"><i class="fas fa-paperclip text-xl"></i></button>
            </div>
            
            <!-- Input -->
            <form id="chat-form" onsubmit="sendChatMessage(event)" class="flex-1 relative bg-white border border-gray-300 rounded-xl items-center px-4 py-2 shadow-sm focus-within:shadow-md focus-within:border-emerald-500 transition-all">
                <input type="text" id="chat-input" placeholder="Écrivez un message..." autocomplete="off"
                       class="w-full bg-transparent border-none focus:outline-none text-sm text-slate-800">
            </form>
            
            <!-- Bouton Micro/Vocal -->
            <button class="p-2 bg-[#00a884] text-white rounded-full shadow-md hover:bg-[#008f6f] transition">
                <i class="fas fa-microphone"></i>
            </button>
        </div>
    </section>
</div>
    <!-- deuxième donné en haut -->

    <!-- MODALE AJOUT ARTICLE -->
    <div id="article-modal" class="fixed inset-0 z-[9500] hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeArticleModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-lg bg-white rounded-2xl shadow-2xl p-8 animate-fadeIn">
            <h3 class="text-2xl font-black mb-6 text-slate-900">Publier un article</h3>
            <form id="article-form" onsubmit="saveArticle(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Titre</label>
                    <input type="text" id="art-title" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Catégorie</label>
                    <!-- IMPORTANT : Les valeurs doivent correspondre aux boutons de filtre -->
                    <select id="art-category" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:border-indigo-500">
                        <option value="academique">Académique</option>
                        <option value="corporate">Corporate</option>
                        <option value="marketing">Marketing</option>
                        <option value="news">Actualité (Sans filtre)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Image (URL)</label>
                    <input type="url" id="art-image" placeholder="https://..." class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Contenu</label>
                    <textarea id="art-content" required rows="6" placeholder="Écrivez votre article ici..." class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:border-indigo-500"></textarea>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeArticleModal()" class="px-4 py-2 text-slate-500 font-bold hover:text-slate-900">Annuler</button>
                    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700">Publier</button>
                </div>
            </form>
        </div>
    </div>
    <!-- TERMINAL WRAPPER -->
    <div id="terminal-wrapper" class="p-4 md:p-10" aria-hidden="true">
        <div id="close-terminal-btn" onclick="closeTerminal()"><i class="fas fa-times"></i></div>
        <div class="bg-glow"></div>
        <div class="max-w-6xl mx-auto">
            <header class="flex flex-col md:flex-row justify-between items-center mb-12 gap-6"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-2xl shadow-indigo-500/40 italic font-black text-white">P</div><span class="text-2xl font-extrabold tracking-tighter">Print<span class="text-indigo-600">bam</span></span></div><div class="flex gap-2 p-1.5 glass border-white/5 rounded-full"><div id="pill-1" class="px-6 py-2 rounded-full text-[10px] font-black uppercase transition-all duration-300 bg-indigo-600 text-white" data-i18n="term_config">1. Config</div><div id="pill-2" class="px-6 py-2 rounded-full text-[10px] font-black uppercase transition-all duration-300 text-indigo-600/30" data-i18n="term_send">2. Envoi</div><div id="pill-3" class="px-6 py-2 rounded-full text-[10px] font-black uppercase transition-all duration-300 text-indigo-600/30" data-i18n="term_pay">3. Pay</div></div></header>
            <div class="grid lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 glass p-8 md:p-12">
                    <div id="step-1" class="space-y-8"><h2 class="text-3xl font-black tracking-tighter text-gradient" data-i18n="term_config_title">Configuration</h2>
                        <div id="uploadWrapper" class="relative">
                            <div id="uploadContainer" class="relative border border-dashed border-indigo-600/20 bg-indigo-50/30 rounded-3xl p-10 text-center group hover:border-indigo-500/50 transition-all"><input type="file" id="fileUpload" accept=".pdf,image/jpeg,image/png" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"><div id="uploadUI"><i class="fas fa-file-contract text-4xl text-indigo-600 mb-4"></i><p id="fileNameDisplay" class="text-sm font-bold text-indigo-900/60" data-i18n="term_upload_placeholder">Cliquez ou glissez votre document ici</p></div></div>
                            <div id="previewBox" class="hidden absolute inset-0 z-20 glass bg-slate-900/95 border-indigo-500/30 flex items-center justify-between px-6 py-4 rounded-3xl"><div class="flex items-center gap-4"><div class="w-16 h-20 bg-white rounded shadow-lg overflow-hidden flex items-center justify-center"><img id="imagePreview" class="hidden w-full h-full object-contain" /><canvas id="pdfPreview" class="hidden w-full h-full"></canvas></div><div class="text-left"><p class="text-[9px] font-black text-indigo-500 uppercase tracking-widest tracking-tighter" data-i18n="term_doc_detected">Document détecté</p><p id="previewName" class="text-sm text-white truncate w-40 font-bold"></p></div></div><button onclick="resetUpload()" class="w-12 h-12 rounded-full bg-red-500/10 border border-red-500/20 text-red-500 hover:bg-red-500 hover:text-white transition-all"><i class="fas fa-trash-can"></i></button></div>
                        </div>
                        <div class="grid md:grid-cols-2 gap-6"><div class="space-y-2"><label class="text-[10px] uppercase font-black tracking-widest text-indigo-600/50 ml-2" data-i18n="term_format">Format</label><select id="format" onchange="calculatePrice()" class="w-full input-crystal p-4 font-bold bg-slate-900"><option value="A5">A5</option><option value="A4" selected>A4</option><option value="A3">A3</option><option value="A2">A2</option><option value="A1">A1</option><option value="A0">A0</option></select></div><div class="space-y-2"><label class="text-[10px] uppercase font-black tracking-widest text-indigo-600/50 ml-2" data-i18n="term_color">Couleur</label><select id="couleur" onchange="calculatePrice()" class="w-full input-crystal p-4 font-bold bg-slate-900"><option value="NB" data-i18n="term_bw">Noir & Blanc</option><option value="CL" data-i18n="term_color_hd">Couleur HD</option></select></div></div>
                        <div class="space-y-4"><label class="text-[10px] uppercase font-black tracking-widest text-indigo-600/50 ml-2" data-i18n="term_finish">Finition & Protection</label><div class="grid grid-cols-2 gap-4"><div onclick="toggleOption('reliure')" id="opt-reliure" class="option-card p-4 rounded-2xl glass flex items-center gap-4"><div class="w-10 h-10 rounded-lg bg-indigo-500/10 flex items-center justify-center text-indigo-600"><i class="fas fa-book"></i></div><div><p class="text-xs font-black" data-i18n="term_binding">Reliure</p><p class="text-[10px] text-indigo-600/40">+1.500 FC</p></div></div><div onclick="toggleOption('plastique')" id="opt-plastique" class="option-card p-4 rounded-2xl glass flex items-center gap-4"><div class="w-10 h-10 rounded-lg bg-emerald-500/10 flex items-center justify-center text-emerald-600"><i class="fas fa-layer-group"></i></div><div><p class="text-xs font-black" data-i18n="term_laminate">Plastifier</p><p class="text-[10px] text-indigo-600/40">+1.000 FC / p</p></div></div></div></div>
                        <div class="grid md:grid-cols-3 gap-6"><div class="md:col-span-1 space-y-2"><label class="text-[10px] uppercase font-black tracking-widest text-indigo-600/50 ml-2" data-i18n="term_pages">Pages</label><input type="number" id="nbPages" value="1" min="1" oninput="calculatePrice()" class="w-full input-crystal p-4 font-bold bg-indigo-500/5"></div><div class="md:col-span-1 space-y-2"><label class="text-[10px] uppercase font-black tracking-widest text-indigo-600/50 ml-2" data-i18n="term_copies">Exemplaires</label><input type="number" id="nbExemplaires" value="1" min="1" oninput="calculatePrice()" class="w-full input-crystal p-4 font-bold"></div><div class="md:col-span-1 space-y-2"><label class="text-[10px] uppercase font-black tracking-widest text-indigo-600/50 ml-2" data-i18n="term_type">Type</label><button onclick="toggleRectoVerso()" id="btnRV" class="w-full input-crystal p-4 font-bold text-xs uppercase tracking-tighter" data-i18n="term_recto">Recto Seul</button><input type="hidden" id="rectoVerso" value="false"></div></div>
                    </div>
                    <div id="step-2" class="hidden-step space-y-8"><h2 class="text-3xl font-black tracking-tighter text-gradient" data-i18n="term_dest_title">Destination</h2><div class="space-y-4"><input type="text" id="custName" data-placeholder="term_ph_name" class="w-full input-crystal p-4 font-bold"><input type="tel" id="custTel" oninput="formatPhone(this)" maxlength="15" data-placeholder="term_ph_phone" class="w-full input-crystal p-4 font-bold"><textarea id="custAddr" data-placeholder="term_ph_addr" class="w-full input-crystal p-4 font-bold h-32"></textarea></div></div>
                    <div id="step-3" class="hidden-step space-y-8 text-center"><h2 class="text-3xl font-black tracking-tighter text-gradient mb-10" data-i18n="term_payment">Paiement</h2><div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="paymentMethods"><button onclick="selectMethod(this, 'Orange')" class="payment-btn glass p-4 flex flex-col items-center gap-3 grayscale opacity-50 transition-all"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c8/Orange_logo.svg/1200px-Orange_logo.svg.png" class="h-6"><span class="font-black text-[8px]">ORANGE</span></button><button onclick="selectMethod(this, 'Mpesa')" class="payment-btn glass p-4 flex flex-col items-center gap-3 grayscale opacity-50 transition-all"><img src="https://upload.wikimedia.org/wikipedia/commons/a/a2/M-Pesa_Logo.png" class="h-6"><span class="font-black text-[8px]">M-PESA</span></button><button onclick="selectMethod(this, 'Airtel')" class="payment-btn glass p-4 flex flex-col items-center gap-3 grayscale opacity-50 transition-all"><div class="text-red-500 font-bold">airtel</div><span class="font-black text-[8px]">AIRTEL</span></button><button onclick="selectMethod(this, 'Cashbam')" class="payment-btn glass p-4 flex flex-col items-center gap-3 grayscale opacity-50 transition-all border-dashed"><i class="fas fa-vault text-xl text-emerald-500"></i><span class="font-black text-[8px] text-emerald-500">CASHBAM</span></button></div><input type="hidden" id="selectedOperator" value=""></div>
                    <div class="mt-12 flex justify-between items-center"><button id="prevBtn" onclick="prevStep()" class="invisible text-xs font-black uppercase text-indigo-600/30 hover:text-indigo-600 transition" data-i18n="term_back">Retour</button><button id="nextBtn" onclick="handleNavigation()" class="px-10 py-5 bg-indigo-600 rounded-2xl font-black text-xs uppercase tracking-[0.2em] shadow-2xl shadow-indigo-500/20 hover:scale-105 transition-all" data-i18n="term_continue">Continuer</button></div>
                </div>
                <div class="glass p-8 h-fit lg:sticky lg:top-10 border-indigo-500/20"><span class="text-[10px] font-black uppercase tracking-[0.3em] text-indigo-600" data-i18n="term_total">Total Commande</span><div class="text-5xl font-extrabold text-slate-900 tracking-tighter my-6"><span id="totalDisplay">0</span> <span class="text-sm font-light text-slate-500" data-i18n="term_currency">FC</span></div><div class="space-y-4 border-t border-indigo-600/10 pt-6 text-[11px] font-bold uppercase text-indigo-600/40"><div class="flex justify-between"><span data-i18n="term_printing">Impression</span> <span id="resImpression" class="text-slate-900">-</span></div><div class="flex justify-between"><span data-i18n="term_finishes">Finitions</span> <span id="resFinition" class="text-slate-900">0 FC</span></div></div></div>
            </div>
        </div>
        <div id="uploadModal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 hidden"><div class="absolute inset-0 bg-black/90 backdrop-blur-xl"></div><div class="relative glass p-10 text-center max-w-sm w-full border-indigo-500/30"><i class="fas fa-cloud-arrow-up text-4xl text-indigo-600 animate-bounce mb-6"></i><h2 class="text-xl font-black text-slate-900 mb-6" data-i18n="term_uploading">Envoi sécurisé...</h2><div class="w-full bg-white/5 h-2 rounded-full overflow-hidden mb-2"><div id="progressBar" class="progress-bar-fill h-full w-0"></div></div><div id="progressPercent" class="text-[10px] font-black text-indigo-600 uppercase">0%</div></div></div>
        <div id="successModal" class="fixed inset-0 z-[110] flex items-center justify-center p-4 hidden"><div class="absolute inset-0 bg-black/80 backdrop-blur-2xl"></div><div class="relative glass p-10 text-center max-w-sm w-full border-emerald-500/30"><div class="w-20 h-20 bg-emerald-600 rounded-full flex items-center justify-center mx-auto mb-6 text-white text-3xl"><i class="fas fa-check"></i></div><h2 class="text-2xl font-black text-slate-900 tracking-tighter" data-i18n="term_confirmed">Confirmé !</h2><p class="text-slate-500 text-sm mt-2" data-i18n="term_redirect">Redirection vers l'accueil...</p></div></div>
        
        <script>

    // Variables pour la pagination infinie
let feedOffset = 0;          // Où on en est dans la liste
const FEED_BATCH_SIZE = 10;  // Combien de posts charger à la fois (ex: 10)
let isLoadingFeed = false;   // Empêcher de charger deux fois en même temps
let hasMorePosts = true;    // S'il reste des posts à charger
let feedObserver = null;    // L'observateur
            
            const SUPABASE_URL = 'https://lqqtvumwdixlhamwmqii.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxcXR2dW13ZGl4bGhhbXdtcWlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyOTQ1NjMsImV4cCI6MjA4NTg3MDU2M30.QKTBQbZ78iRVyM1o-hhtAPkWP23h_vXAMA3zrfuzipY'; // Votre clé

// On récupère la fonction createClient de la librairie globale
// const { createClient } = supabase;

// On crée notre instance client avec un nom différent pour éviter le conflit
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            if (typeof pdfjsLib !== 'undefined') { pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js'; }
            if (typeof emailjs !== 'undefined') { emailjs.init("thg5rkoV_YE3VuWnU"); }
            let currentStep = 1; let options = { reliure: false, plastique: false };
            const prices = { "A5": { "NB": 200, "CL": 400 }, "A4": { "NB": 400, "CL": 700 }, "A3": { "NB": 1000, "CL": 1800 }, "A2": { "NB": 4500, "CL": 7500 }, "A1": { "NB": 9000, "CL": 15000 }, "A0": { "NB": 18000, "CL": 25000 } };
            const fileInput = document.getElementById('fileUpload');
            if (fileInput) {
                fileInput.addEventListener('change', async function(e) {
                    const file = e.target.files[0]; if (!file) return;
                    document.getElementById('previewBox').classList.remove('hidden'); document.getElementById('previewName').innerText = file.name;
                    const imgT = document.getElementById('imagePreview'), canT = document.getElementById('pdfPreview'); imgT.classList.add('hidden'); canT.classList.add('hidden');
                    if (file.type.startsWith('image/')) { const r = new FileReader(); r.onload = (e) => { imgT.src = e.target.result; imgT.classList.remove('hidden'); }; r.readAsDataURL(file); document.getElementById('nbPages').value = 1; }
                    else if (file.type === "application/pdf" && typeof pdfjsLib !== 'undefined') { const r = new FileReader(); r.onload = async function() { const pdf = await pdfjsLib.getDocument(new Uint8Array(this.result)).promise; document.getElementById('nbPages').value = pdf.numPages; const page = await pdf.getPage(1); const vp = page.getViewport({ scale: 0.3 }); canT.height = vp.height; canT.width = vp.width; canT.classList.remove('hidden'); await page.render({canvasContext: canT.getContext('2d'), viewport: vp}).promise; calculatePrice(); }; r.readAsArrayBuffer(file); }
                    calculatePrice();
                });
            }
            function resetUpload() { document.getElementById('fileUpload').value = ""; document.getElementById('previewBox').classList.add('hidden'); calculatePrice(); }
            function toggleOption(opt) { options[opt] = !options[opt]; document.getElementById(`opt-${opt}`).classList.toggle('active'); calculatePrice(); }
            function toggleRectoVerso() {
                const val = document.getElementById('rectoVerso').value === "true"; document.getElementById('rectoVerso').value = !val; const btn = document.getElementById('btnRV');
                if(!val) btn.innerText = translations[localStorage.getItem('printbam-lang') || 'fr']?.term_recto_verso || "Recto / Verso"; else btn.innerText = translations[localStorage.getItem('printbam-lang') || 'fr']?.term_recto || "Recto Seul"; calculatePrice();
            }
            function calculatePrice() {
                const f = document.getElementById('format').value, c = document.getElementById('couleur').value, isV = document.getElementById('rectoVerso').value === "true", p = parseInt(document.getElementById('nbPages').value) || 1, e = parseInt(document.getElementById('nbExemplaires').value) ||1;
                let unitP = prices[f][c]; if(isV) unitP = Math.round(unitP * 1.6); const totalImp = unitP * p * e; let totalFin = 0; if(options.reliure) totalFin += 1500 * e; if(options.plastique) totalFin += (1000 * p) * e; const totalGlobal = totalImp + totalFin;
                const totalDisplay = document.getElementById('totalDisplay'); if(totalDisplay) totalDisplay.innerText = totalGlobal.toLocaleString('fr-FR');
                const resImpression = document.getElementById('resImpression'); if(resImpression) resImpression.innerText = `${f} ${c} (${p}p x ${e})`;
                const resFinition = document.getElementById('resFinition'); if(resFinition) resFinition.innerText = totalFin.toLocaleString('fr-FR') + " FC";
            }
            function handleNavigation() { if (currentStep < 3) nextStep(); else validateFinalProcess(); }
            function nextStep() {
                if (currentStep === 1 && !document.getElementById('fileUpload').files[0]) return showErrorAnimation(document.getElementById('uploadContainer'));
                if (currentStep === 2 && !['custName', 'custTel', 'custAddr'].every(id => document.getElementById(id).value.trim())) return;
                document.getElementById(`step-${currentStep}`).classList.add('hidden-step'); document.getElementById(`pill-${currentStep}`).className = "px-6 py-2 rounded-full text-[10px] font-black text-indigo-600/30"; currentStep++;
                document.getElementById(`step-${currentStep}`).classList.remove('hidden-step'); document.getElementById(`pill-${currentStep}`).className = "px-6 py-2 rounded-full text-[10px] font-black bg-indigo-600 text-white"; updateControls();
            }
            function prevStep() {
                document.getElementById(`step-${currentStep}`).classList.add('hidden-step'); document.getElementById(`pill-${currentStep}`).className = "px-6 py-2 rounded-full text-[10px] font-black text-indigo-600/30"; currentStep--;
                document.getElementById(`step-${currentStep}`).classList.remove('hidden-step'); document.getElementById(`pill-${currentStep}`).className = "px-6 py-2 rounded-full text-[10px] font-black bg-indigo-600 text-white"; updateControls();
            }
            function updateControls() {
                const prevBtn = document.getElementById('prevBtn'); const nextBtn = document.getElementById('nextBtn'); const lang = localStorage.getItem('printbam-lang') || 'fr';
                if(prevBtn) prevBtn.style.visibility = currentStep === 1 ? 'hidden' : 'visible';
                if(nextBtn) { if(currentStep === 3) nextBtn.innerText = translations[lang]?.term_confirm || "Confirmer le Paiement"; else nextBtn.innerText = translations[lang]?.term_continue || "Continuer"; }
            }
            function selectMethod(el, op) { document.querySelectorAll('.payment-btn').forEach(b => b.classList.add('grayscale', 'opacity-50')); el.classList.remove('grayscale', 'opacity-50'); el.classList.add('border-indigo-600', 'bg-indigo-600/10'); document.getElementById('selectedOperator').value = op; }
            async function validateFinalProcess() {
                const op = document.getElementById('selectedOperator').value; if (!op) return; let prog = 0; document.getElementById('uploadModal').classList.remove('hidden');
                const timer = setInterval(() => { if(prog < 90) { prog += 10; document.getElementById('progressBar').style.width = prog + "%"; document.getElementById('progressPercent').innerText = prog + "%"; } }, 400);
                try {
                    const url = await uploadToDrive(document.getElementById('fileUpload').files[0]); clearInterval(timer); document.getElementById('progressBar').style.width = "100%";
                    setTimeout(() => { document.getElementById('uploadModal').classList.add('hidden'); if (op === "Cashbam") finalizeOrder(url, "CASHBAM"); else startFlutterwave(url, op); }, 500);
                } catch (err) { clearInterval(timer); document.getElementById('uploadModal').classList.add('hidden'); alert("Erreur d'envoi"); }
            }
            async function uploadToDrive(file) {
                return new Promise((resolve) => {
                    const reader = new FileReader(); reader.readAsDataURL(file);
                    reader.onload = async () => {
                        const response = await fetch("https://script.google.com/macros/s/AKfycbzgcKmfauYb0i0hC2c72-WyBIsmL-gM__mJ4ESton4fHkWDBN07GGbLWflyuaHz-JK9/exec", { method: "POST", body: JSON.stringify({ base64: reader.result.split(',')[1], fileName: file.name, mimeType: file.type }) });
                        const res = await response.json(); resolve(res.url || "Erreur");
                    };
                });
            }
            function startFlutterwave(url, op) {
                if (typeof FlutterwaveCheckout !== 'undefined') {
                    FlutterwaveCheckout({
                        public_key: "FLWPUBK_TEST-025d82a383d1f6849351abbd725ffbe2-X",
                        tx_ref: "BAM-" + Date.now(),
                        amount: parseFloat(document.getElementById('totalDisplay').innerText.replace(/\s/g, '')),
                        currency: "CDF",
                        customer: { email: "cloud@printbam.com", phone_number: document.getElementById('custTel').value, name: document.getElementById('custName').value },
                        callback: (d) => { if (d.status === "successful") finalizeOrder(url, op); }
                    });
                } else { alert("Erreur de chargement du module de paiement"); }
            }
            function finalizeOrder(url, m) {
                const params = { nom: document.getElementById('custName').value, telephone: document.getElementById('custTel').value, adresse: document.getElementById('custAddr').value, details: `${document.getElementById('resImpression').innerText} | Reliure: ${options.reliure} | Plastique: ${options.plastique}`, total: document.getElementById('totalDisplay').innerText + " FC", file_link: url };
                // Save locally
                const totalAmount = parseInt(document.getElementById('totalDisplay').innerText.replace(/\s/g, ''));
                const itemName = "Impression " + document.getElementById('format').value;
                saveNewOrder(itemName, totalAmount);
                
                if (typeof emailjs !== 'undefined') {
                    emailjs.send("service_jecwp3m", "template_znjxx9s", params).then(() => {
                        document.getElementById('successModal').classList.remove('hidden'); setTimeout(() => { window.location.href = "index.html"; }, 3000);
                    });
                } else { alert("EmailJS non initialisé"); }
            }
            function showErrorAnimation(el) { el.classList.add('input-error'); setTimeout(() => el.classList.remove('input-error'), 400); }
            calculatePrice();
        </script>

    <!-- SCRIPT PRINCIPAL -->
    <script>
        /* --- PRO FEATURES VARIABLES --- */
        let currentInvoiceData = null;

        /* --- NAVIGATION SPA --- */
        function switchPage(pageId) {
            document.querySelectorAll('.nav-link-pro').forEach(link => link.classList.remove('active'));
            const links = document.querySelectorAll(`a[onclick="switchPage('${pageId}')"]`);
            links.forEach(l => l.classList.add('active'));
            document.querySelectorAll('.page-view').forEach(view => {
                view.classList.remove('active');
                setTimeout(() => { if(!view.classList.contains('active')) view.style.display = 'none'; }, 400);
            });
            const target = document.getElementById(pageId + '-view');
            if (target) {
                target.style.display = 'block'; setTimeout(() => target.classList.add('active'), 10); window.scrollTo(0, 0);
            }
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            if (!sidebarOverlay.classList.contains('invisible')) toggleSidebar();

            // --- AJOUTEZ CECI : GESTION DU DOCK (BARRE DU BAS) ---
    const dock = document.querySelector('.mobile-dock');

    if (pageId === 'messages' || pageId === 'chat') {
        // Si on est sur Messages ou Chat, on cache le dock
        dock.classList.add('dock-hidden');
    } else {
        // Sinon (Accueil, Profil, etc.), on l'affiche
        dock.classList.remove('dock-hidden');
    }
            
            if (pageId === 'admin') {
            loadAdminArticles(); // Charge les articles
            loadAdminUsers();   // <--- AJOUTEZ CETTE LIGNE C'EST CRUCIAL
        }
            if (pageId === 'profile-social') {
            loadSocialProfile();
        }
            // Chargement Notifications
    if (pageId === 'notifications') {
        loadNotifications();
    }
             // Charger le Feed si on va sur l'accueil
    if (pageId === 'home') {
        loadGlobalFeed();
    }

    // Charger le Profil Social si on va sur le profil
    if (pageId === 'profile-social') {
        loadSocialProfile();
    }

            // --- AJOUTEZ CECI POUR LES MESSAGES ---
    if (pageId === 'messages') {
        loadChatList(); // Charge la liste des discussions (Style Photo 1)
    }
            
            // --- FOOTER VISIBILITY LOGIC ---
        //     const footer = document.getElementById('main-footer');
        //     if(footer) {
        //         if(pageId === 'marketplace') {
        //             footer.style.display = 'none';
        //         } else {
        //             footer.style.display = 'block';
        //         }
        //     }
        }

        /* --- MARKETPLACE LOGIC --- */
        function filterMarket(category) {
            const items = document.querySelectorAll('.market-item');
            const btns = document.querySelectorAll('.filter-btn');
            
            btns.forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white', 'shadow-md');
                btn.classList.add('bg-white', 'border', 'border-slate-200', 'text-slate-600');
            });
            
            event.target.classList.remove('bg-white', 'border', 'border-slate-200', 'text-slate-600');
            event.target.classList.add('bg-indigo-600', 'text-white', 'shadow-md');

            items.forEach(item => {
                if (category === 'all' || item.getAttribute('data-category') === category) {
                    item.style.display = 'flex';
                    setTimeout(() => item.style.opacity = '1', 10);
                } else {
                    item.style.display = 'none';
                    item.style.opacity = '0';
                }
            });
        }

        function searchMarketplace(query) {
            const items = document.querySelectorAll('.market-item');
            const lowerQuery = query.toLowerCase();
            
            items.forEach(item => {
                const title = item.querySelector('h3').innerText.toLowerCase();
                const desc = item.querySelector('p').innerText.toLowerCase();
                
                if (title.includes(lowerQuery) || desc.includes(lowerQuery)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        /* --- TRACKING ORDER (AVEC DATE & WHATSAPP) --- */
        function openTrackModal(id, date) {
            // Store ID for invoice generation
            currentInvoiceData = orders.find(o => o.id === id);
            
            document.getElementById('track-id').innerText = id;
            document.getElementById('track-date').innerText = date;
            
            // CALCUL DE LA DATE DE LIVRAISON ESTIMÉE (+2 jours)
            try {
                // Conversion de la date FR (DD/MM/YYYY) vers ISO
                const orderDate = new Date(date.split('/').reverse().join('-')); 
                const estDate = new Date(orderDate);
                estDate.setDate(estDate.getDate() + 2); 
                
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('estimated-delivery-date').innerText = estDate.toLocaleDateString('fr-FR', options);
                
                // Mise à jour visuelle de la timeline
                document.getElementById('est-date-label').innerText = estDate.toLocaleDateString('fr-FR');
            } catch (e) {
                document.getElementById('estimated-delivery-date').innerText = "En attente de confirmation";
            }

            const modal = document.getElementById('track-modal');
            const bg = modal.querySelector('div:first-child');
            const panel = modal.querySelector('div:last-child');
            
            modal.classList.remove('invisible');
            setTimeout(() => {
                bg.classList.replace('opacity-0', 'opacity-100');
                panel.classList.replace('translate-x-full', 'translate-x-0');
            }, 10);
        }

        function closeTrackModal() {
            const modal = document.getElementById('track-modal');
            const bg = modal.querySelector('div:first-child');
            const panel = modal.querySelector('div:last-child');
            
            bg.classList.replace('opacity-100', 'opacity-0');
            panel.classList.replace('translate-x-0', 'translate-x-full');
            setTimeout(() => { modal.classList.add('invisible'); }, 500);
        }

        /* --- WHATSAPP INTEGRATION --- */
        function shareOrderOnWhatsApp() {
            // Numéro commercial par défaut
            const supportPhone = "243810000000"; 
            
            const orderId = document.getElementById('track-id').innerText;
            const clientName = currentInvoiceData ? currentInvoiceData.item : "Client";
            
            const message = `Bonjour Printbam,%0A%0AJe suis le client "${clientName}" concernant la commande *#${orderId}*.%0A%0APourriez-vous me donner des news sur l'avancement ?%0AMerci.`;
            
            const url = `https://wa.me/${supportPhone}?text=${message}`;
            window.open(url, '_blank');
        }

        /* --- INVOICE GENERATION --- */
        function openInvoice() {
            if(!currentInvoiceData) return;
            document.getElementById('inv-id').innerText = currentInvoiceData.id;
            document.getElementById('inv-date').innerText = currentInvoiceData.date;
            
            const detailStr = currentInvoiceData.details;
            let itemsHtml = '';
            let unitPrice = Math.round(currentInvoiceData.amount / 2); 
            
            itemsHtml += `<tr><td class="font-bold">${detailStr}</td><td class="text-center">1</td><td class="text-right">${unitPrice} FC</td><td class="text-right font-bold">${currentInvoiceData.amount} FC</td></tr>`;
            
            document.getElementById('inv-items').innerHTML = itemsHtml;
            document.getElementById('inv-total').innerText = currentInvoiceData.amount.toLocaleString() + " FC";
            
            const modal = document.getElementById('invoice-modal');
            modal.classList.add('active');
        }

        function closeInvoice() {
            document.getElementById('invoice-modal').classList.remove('active');
        }

        /* --- INPUT MASKING --- */
        function formatPhone(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 0 && !value.startsWith('243')) value = '243' + value;
            if (value.length > 12) value = value.substring(0, 12);
            
            let formatted = '';
            if (value.length > 0) formatted = '+' + value.substring(0, 3);
            if (value.length > 3) formatted += ' ' + value.substring(3, 6);
            if (value.length > 6) formatted += ' ' + value.substring(6, 9);
            if (value.length > 9) formatted += ' ' + value.substring(9, 12);
            
            input.value = formatted;
        }

        /* --- TERMINAL --- */
       function openTerminal() {
            const term = document.getElementById('terminal-wrapper');
            if (!term) return;
        
            // 1. On affiche et on débloque les interactions
            term.style.display = 'block';
            term.removeAttribute('inert'); 
            term.setAttribute('aria-hidden', 'false');
        
            // 2. On bloque le scroll du site derrière
            document.body.style.overflow = 'hidden';
        
            // 3. Sécurité : on force le focus sur le bouton de fermeture
            setTimeout(() => {
                const closeBtn = document.getElementById('close-terminal-btn');
                if (closeBtn) closeBtn.focus();
            }, 100);
        }
        
        function closeTerminal() {
            const term = document.getElementById('terminal-wrapper');
            if (!term) return;
        
            // 1. On cache et on verrouille
            term.style.display = 'none';
            term.setAttribute('inert', '');
            term.setAttribute('aria-hidden', 'true');
        
            // 2. On rend le scroll au site
            document.body.style.overflow = 'auto';
        
            // 3. On nettoie le focus pour éviter l'erreur console
            if (document.activeElement) document.activeElement.blur();
        }
        /* --- TRANSLATIONS --- */
        const translations = {
            fr: {
                nav_navigation: "Navigation", nav_home: "Accueil", nav_market: "Marketplace", nav_services: "Services", nav_account: "Compte", nav_orders: "Mes Commandes", nav_settings: "Paramètres", nav_help: "Aide", nav_login: "Connexion", btn_start: "Démarrer",
                hero_title_part1: "L'infrastructure", hero_title_part2: "documentaire", hero_title_highlight: "haute performance.", hero_desc: "Digitalisez vos flux, nous matérialisons l'excellence avec une", btn_print_now: "Imprimer maintenant", btn_demo: "Voir la démo", nav_about: "À propos",
                feat_arch_title: "Architecture Documentaire", feat_arch_desc: "Traitement architectural de vos documents. Précision au millimètre pour vos manuscrits exigeants et mémoires académiques.", feat_delivery: "Livraison Express", feat_badge_title: "Badges PVC", feat_badge_desc: "Cartes de service haute définition avec protection thermique et codage magnétique.", feat_cloud_title: "Infrastructure Cloud", feat_cloud_desc: "Envoyez vos fichiers de n'importe où. Notre réseau sécurisé s'occupe du traitement et de l'impression.",
                portfolio_title: "Standards d'Excellence.", card1_cat: "Rapports", card1_title: "Rapports Institutionnels", card1_desc: "Papier couché 120g avec reliure thermique invisible pour une finition premium.", card2_cat: "Identité Visuelle", card2_title: "Cartes de Membre", card2_desc: "Impression sublimation haute résistance avec hologramme de sécurité personnalisé.", card3_cat: "Technique", card3_title: "Plans & Blueprints", card3_desc: "Traçage grand format A0/A1 haute précision sur papier technique translucide.",
                cta_title: "Prêt pour l'impression ?", btn_launch_order: "Lancer une commande", footer_about: "L'infrastructure d'impression cloud leader en Afrique centrale. Fiabilité, rapidité et sécurité pour vos documents.", footer_services: "Services", footer_company: "Entreprise", footer_contact: "Contact", settings_profile: "Votre Profil", settings_notifs: "Notifications push", settings_lang: "Langue", settings_save: "Sauvegarder", btn_send: "Envoyer",
                market_desc: "Découvrez nos packs pré-configurés pour vos besoins professionnels et académiques. Une qualité constante, une livraison rapide.", mkt_item1_title: "Pack Mémoire Standard", mkt_item1_desc: "Impression N&B + Reliure Spirale + 2 Exemplaires.", mkt_item2_title: "Pack Badges Pro", mkt_item2_desc: "50 Cartes PVC recto-verso avec personnalisation.", mkt_item3_title: "Kit Communication", mkt_item3_desc: "100 Affiches A3 + 500 Flyers A5.", mkt_item4_title: "Personnalisation", mkt_item4_desc: "T-shirts, Mugs et Objets publicitaires.",
                services_title: "Services & Tarifs", services_desc: "Une tarification transparente et compétitive pour tous vos projets d'impression.", srv_pricing: "Grille Tarifaire (Prix unitaire)", srv_format: "Format", srv_bw: "Noir & Blanc", srv_color: "Couleur", srv_premium: "Premium", srv_binding: "Reliure", srv_binding_desc: "Spirale métallique, Thermocollée ou Cannelée.", srv_laminate: "Plastification", srv_laminate_desc: "Protection matte ou brillante.", srv_cut: "Découpe & Massicot", srv_cut_desc: "Découpe précise au millimètre.",
                term_config: "1. Config", term_send: "2. Envoi", term_pay: "3. Pay", term_config_title: "Configuration", term_upload_placeholder: "Cliquez ou glissez votre document ici", term_doc_detected: "Document détecté", term_format: "Format", term_color: "Couleur", term_bw: "Noir & Blanc", term_color_hd: "Couleur HD", term_finish: "Finition & Protection", term_binding: "Reliure", term_laminate: "Plastifier", term_pages: "Pages", term_copies: "Exemplaires", term_type: "Type", term_recto: "Recto Seul", term_recto_verso: "Recto / Verso", term_dest_title: "Destination", term_ph_name: "Nom complet", term_ph_phone: "WhatsApp (ex: +243...)", term_ph_addr: "Adresse complète de livraison", term_payment: "Paiement", term_total: "Total Commande", term_currency: "FC", term_printing: "Impression", term_finishes: "Finitions", term_back: "Retour", term_continue: "Continuer", term_confirm: "Confirmer le Paiement", term_uploading: "Envoi sécurisé...", term_confirmed: "Confirmé !", term_redirect: "Redirection vers l'accueil..."
            },
            en: {
                nav_navigation: "Navigation", nav_home: "Home", nav_market: "Marketplace", nav_services: "Services", nav_account: "Account", nav_orders: "My Orders", nav_settings: "Settings", nav_help: "Help", nav_login: "Login", btn_start: "Get Started",
                hero_title_part1: "The high-performance", hero_title_part2: "document", hero_title_highlight: "infrastructure.", hero_desc: "Digitize your workflows, we materialize excellence with", btn_print_now: "Print Now", btn_demo: "View Demo",
                feat_arch_title: "Document Architecture", feat_arch_desc: "Architectural processing of your documents. Millimeter precision for demanding manuscripts and academic theses.", feat_delivery: "Express Delivery", feat_badge_title: "PVC Badges", feat_badge_desc: "High definition service cards with thermal protection and magnetic coding.", feat_cloud_title: "Cloud Infrastructure", feat_cloud_desc: "Send files from anywhere. Our secure network takes care of processing and printing.",
                portfolio_title: "Standards of Excellence.", card1_cat: "Reports", card1_title: "Institutional Reports", card1_desc: "120g coated paper with invisible thermal binding for a premium finish.", card2_cat: "Visual Identity", card2_title: "Membership Cards", card2_desc: "High resistance sublimation printing with personalized security hologram.", card3_cat: "Technical", card3_title: "Plans & Blueprints", card3_desc: "Large format A0/A1 high precision tracing on translucent technical paper.",
                cta_title: "Ready to print?", btn_launch_order: "Launch an Order", footer_about: "The leading cloud printing infrastructure in Central Africa. Reliability, speed and security for your documents.", footer_services: "Services", footer_company: "Company", footer_contact: "Contact", settings_profile: "Your Profile", settings_notifs: "Push Notifications", settings_lang: "Language", settings_save: "Save", btn_send: "Send", nav_about: "About", 
                market_desc: "Discover our pre-configured packs for your professional and academic needs. Constant quality, rapid delivery.", mkt_item1_title: "Standard Thesis Pack", mkt_item1_desc: "B&W Printing + Spiral Binding + 2 Copies.", mkt_item2_title: "Pro Badges Pack", mkt_item2_desc: "50 Double-sided PVC cards with customization.", mkt_item3_title: "Communication Kit", mkt_item3_desc: "100 A3 Posters + 500 A5 Flyers.", mkt_item4_title: "Customization", mkt_item4_desc: "T-shirts, Mugs and Promotional items.",
                services_title: "Services & Pricing", services_desc: "Transparent and competitive pricing for all your printing projects.", srv_pricing: "Price Grid (Unit Price)", srv_format: "Format", srv_bw: "Black & White", srv_color: "Color", srv_premium: "Premium", srv_binding: "Binding", srv_binding_desc: "Metal spiral, Thermal or Canneled binding.", srv_laminate: "Lamination", srv_laminate_desc: "Matte or Glossy protection.", srv_cut: "Cutting & Guillotine", srv_cut_desc: "Precise cutting to millimeter.",
                term_config: "1. Config", term_send: "2. Send", term_pay: "3. Pay", term_config_title: "Configuration", term_upload_placeholder: "Click or drag your document here", term_doc_detected: "Document Detected", term_format: "Format", term_color: "Color", term_bw: "Black & White", term_color_hd: "Color HD", term_finish: "Finish & Protection", term_binding: "Binding", term_laminate: "Laminate", term_pages: "Pages", term_copies: "Copies", term_type: "Type", term_recto: "Single Sided", term_recto_verso: "Double Sided", term_dest_title: "Destination", term_ph_name: "Full Name", term_ph_phone: "WhatsApp (ex: +243...)", term_ph_addr: "Full Delivery Address", term_payment: "Payment", term_total: "Total Order", term_currency: "FC", term_printing: "Printing", term_finishes: "Finishes", term_back: "Back", term_continue: "Continue", term_confirm: "Confirm Payment", term_uploading: "Secure upload...", term_confirmed: "Confirmed!", term_redirect: "Redirecting to home..."
            },
            ln: { nav_navigation: "Boluki", nav_home: "Esika", nav_market: "Bisika", nav_services: "Misala", nav_account: "Bokomi", nav_orders: "Mikanda", nav_about: "Na ntina na biso", nav_settings: "Ndimi", nav_help: "Lisungi", nav_login: "Kokota", btn_start: "Yuka", hero_title_part1: "Bokoli ya", hero_title_part2: "bukundu", hero_title_highlight: "ya makasi.", hero_desc: "Botia bisusu na nzela ya électronique, biso tokobi kobimisa eloko ya makasi na", btn_print_now: "Kobima Sika", btn_demo: "Tala", feat_arch_title: "Bokoli ya Mbete", feat_arch_desc: "Botia ya mbete ya mikanda na yo.", feat_delivery: "Komesa Mbote", feat_badge_title: "Ba Badge PVC", feat_badge_desc: "Ba carte ya service.", feat_cloud_title: "Sistème ya Cloud", feat_cloud_desc: "Tinda ba fichier awa.", portfolio_title: "Ndimi ya Makasi.", cta_title: "Oyo ozali kokoba ?", btn_launch_order: "Sima Commande", term_config: "1. Config", term_send: "2. Tinda", term_pay: "3. Kobimisa", term_config_title: "Configuration", term_upload_placeholder: "Kokota kobimisa buku na awa", term_doc_detected: "Buku ekomi", term_format: "Format", term_color: "Couleur", term_bw: "Noir & Blanc", term_color_hd: "Couleur HD", term_finish: "Mikongo & Protection", term_binding: "Reliure", term_laminate: "Plastifier", term_pages: "Pages", term_copies: "Exemplaires", term_type: "Type", term_recto: "Recto Seul", term_recto_verso: "Recto / Verso", term_dest_title: "Destination", term_ph_name: "Nkombo mobimba", term_ph_phone: "WhatsApp", term_ph_addr: "Adrese", term_payment: "Kobimisa", term_total: "Total Commande", term_currency: "FC", term_printing: "Kobima", term_finishes: "Mikongo", term_back: "Kozwa", term_continue: "Kosukola", term_confirm: "Kobimisa", term_uploading: "Tinda...", term_confirmed: "Confirmé !", term_redirect: "Kozwa...", market_desc: "Bolia ba packs...", services_title: "Services & Tarifs", services_desc: "Prix transparente...", srv_pricing: "Grille Tarifaire", srv_format: "Format", srv_bw: "Noir & Blanc", srv_color: "Couleur", srv_premium: "Premium", srv_binding: "Reliure", srv_binding_desc: "Spirale, etc...", srv_laminate: "Plastification", srv_laminate_desc: "Protection...", srv_cut: "Découpe", srv_cut_desc: "Découpe...", mkt_item1_title: "Pack Mémoire", mkt_item1_desc: "Kobima + Reliure...", mkt_item2_title: "Pack Badges", mkt_item2_desc: "50 Cartes...", mkt_item3_title: "Kit Comm", mkt_item3_desc: "Affiches...", mkt_item4_title: "Perso", mkt_item4_desc: "T-shirts...", nav_orders: "Mikanda", nav_settings: "Ndimi", nav_help: "Aide", settings_lang: "Lokota", settings_save: "Tia", btn_send: "Tinda", settings_profile: "Lingomba na yo", settings_notifs: "Notifications", footer_about: "Bokoli...", footer_services: "Misala", footer_company: "Kompani", footer_contact: "Komisa" },
            tu: { nav_navigation: "Buvui", nav_about: "Bidi bitangila benu", nav_home: "Kadi", nav_market: "Kabuadi", nav_services: "Miyila", nav_account: "Ditumbu", nav_orders: "Babui", nav_settings: "Mwididi", nav_help: "Lubulayi", nav_login: "Kuluka", btn_start: "Yuka", term_config: "1. Config", term_send: "2. Tuma", term_pay: "3. Dija", term_config_title: "Configuration", term_upload_placeholder: "Kokota tuma buku na awa", term_doc_detected: "Buku dijwidi", term_format: "Format", term_color: "Couleur", term_bw: "Noir & Blanc", term_color_hd: "Couleur HD", term_finish: "Midi & Dija", term_binding: "Reliure", term_laminate: "Lamina", term_pages: "Makon", term_copies: "Kadisadi", term_type: "Mutundu", term_recto: "Tshitshi", term_recto_verso: "Tshitshi / Mutundu", term_dest_title: "Muadi", term_ph_name: "Dina mobimba", term_ph_phone: "WhatsApp", term_ph_addr: "Adrese", term_payment: "Kulipa", term_total: "Total Commande", term_currency: "FC", term_printing: "Kubaja", term_finishes: "Midi", term_back: "Kubajikula", term_continue: "Kosuka", term_confirm: "Kulipa", term_uploading: "Kutuma...", term_confirmed: "Bwakaji !", term_redirect: "Kujikula...", hero_title_part1: "Buvui ya", hero_title_part2: "mutundu", hero_title_highlight: "wa bule.", hero_desc: "Dija masalu a eletronique, twa ku buka butashi wa bule na", btn_print_now: "Bubaja Ubu", btn_demo: "Laja", portfolio_title: "Ndimi wa Bule.", cta_title: "Waba udi bubaja ?", btn_launch_order: "Simula Babui", term_config_title: "Configuration", term_upload_placeholder: "Kokota tuma buku na awa", term_doc_detected: "Buku dijwidi", term_format: "Format", term_color: "Couleur", term_bw: "Noir & Blanc", term_color_hd: "Couleur HD", term_finish: "Midi & Dija", term_binding: "Reliure", term_laminate: "Lamina", term_pages: "Makon", term_copies: "Kadisadi", term_type: "Mutundu", term_recto: "Tshitshi", term_recto_verso: "Tshitshi / Mutundu", term_dest_title: "Muadi", term_ph_name: "Dina mobimba", term_ph_phone: "WhatsApp", term_ph_addr: "Adrese", term_payment: "Kulipa", term_total: "Total Commande", term_currency: "FC", term_printing: "Kubaja", term_finishes: "Midi", term_back: "Kubajikula", term_continue: "Kosuka", term_confirm: "Kulipa", term_uploading: "Kutuma...", term_confirmed: "Bwakaji !", term_redirect: "Kujikula..." },
            sw: { nav_navigation: "Miondoko", nav_home: "Nyumbani", nav_about: "Kuhusu sisi", nav_market: "Soko", nav_services: "Huduma", nav_account: "Akaunti", nav_orders: "Oda", nav_settings: "Mipangilio", nav_help: "Msaada", nav_login: "Ingia", btn_start: "Anza", term_config: "1. Config", term_send: "2. Tuma", term_pay: "3. Lipia", term_config_title: "Mipangilio", term_upload_placeholder: "Bofya au paka faili hapa", term_doc_detected: "Faili Imeibainwa", term_format: "Ukubwa", term_color: "Rangi", term_bw: "Nyeusi & Njivu", term_color_hd: "Rangi HD", term_finish: "Maliza & Kinga", term_binding: "Uunganishaji", term_laminate: "Lamine", term_pages: "Ukurasa", term_copies: "Nakala", term_type: "Aina", term_recto: "Upande Mmoja", term_recto_verso: "Upande Wote", term_dest_title: "Mahali", term_ph_name: "Jina Kamili", term_ph_phone: "WhatsApp", term_ph_addr: "Anwani ya Kupokelea", term_payment: "Lipa", term_total: "Jumla ya Oda", term_currency: "FC", term_printing: "Uchapishaji", term_finishes: "Mikwabo", term_back: "Nyuma", term_continue: "Endelea", term_confirm: "Thibitisha Lipa", term_uploading: "Kutuma salama...", term_confirmed: "Imethibitishwa!", term_redirect: "Kurudi nyumbani...", hero_title_part1: "Miundombinu ya", hero_title_part2: "waraka", hero_title_highlight: "ya nguvu.", hero_desc: "Badilisha mtiririko wako, sisi tunato ubora wa", btn_print_now: "Chapisha Sasa", btn_demo: "Tazama Demo", portfolio_title: "Vigezo vya Ubora.", cta_title: "Uko tayari kuchapisha?", btn_launch_order: "Anza Oda", term_config_title: "Mipangilio", term_upload_placeholder: "Bofya au paka faili hapa", term_doc_detected: "Faili Imeibainwa", term_format: "Ukubwa", term_color: "Rangi", term_bw: "Nyeusi & Njivu", term_color_hd: "Rangi HD", term_finish: "Maliza & Kinga", term_binding: "Uunganishaji", term_laminate: "Lamine", term_pages: "Ukurasa", term_copies: "Nakala", term_type: "Aina", term_recto: "Upande Mmoja", term_recto_verso: "Upande Wote", term_dest_title: "Mahali", term_ph_name: "Jina Kamili", term_ph_phone: "WhatsApp", term_ph_addr: "Anwani ya Kupokelea", term_payment: "Lipa", term_total: "Jumla ya Oda", term_currency: "FC", term_printing: "Uchapishaji", term_finishes: "Mikwabo", term_back: "Nyuma", term_continue: "Endelea", term_confirm: "Thibitisha Lipa", term_uploading: "Kutuma salama...", term_confirmed: "Imethibitishwa!", term_redirect: "Kurudi nyumbani..." },
            kg: { nav_navigation: "Zina", nav_home: "Mboka", nav_market: "Mpemba", nav_services: "Nsadila", nav_account: "Ntangu", nav_orders: "Bisalu", nav_settings: "Nkidila", nav_help: "Lusadisu", nav_login: "Vata", btn_start: "Yuka", term_config: "1. Config", term_send: "2. Tuma", term_pay: "3. Lipa", term_config_title: "Configuration", term_upload_placeholder: "Kokota tuma buku na awa", term_doc_detected: "Buku dijwidi", term_format: "Format", term_color: "Couleur", term_bw: "Noir & Blanc", term_color_hd: "Couleur HD", term_finish: "Kusala & Kinga", term_binding: "Reliure", term_laminate: "Lamina", term_pages: "Makon", term_copies: "Kadisadi", term_type: "Aina", term_recto: "Tshitshi", term_recto_verso: "Tshitshi / Mutundu", term_dest_title: "Muadi", term_ph_name: "Dina mobimba", term_ph_phone: "WhatsApp", term_ph_addr: "Adrese", term_payment: "Lipa", term_total: "Total Commande", term_currency: "FC", term_printing: "Kubaja", term_finishes: "Midi", term_back: "Kubajikula", term_continue: "Kosuka", term_confirm: "Kulipa", term_uploading: "Kutuma...", term_confirmed: "Bwakaji !", term_redirect: "Kujikula...", hero_title_part1: "Bukundu wa", hero_title_part2: "nkandu", hero_title_highlight: "wa nene.", hero_desc: "Tia zina a eletronique, biso twa ku kanga mpete wa nene na", btn_print_now: "Buka Mboka", btn_demo: "Vata", portfolio_title: "Nkidila wa Nene.", cta_title: "Yaka udi buka ?", btn_launch_order: "Yuka Bisalu", term_config_title: "Configuration", term_upload_placeholder: "Kokota tuma buku na awa", term_doc_detected: "Buku dijwidi", term_format: "Format", term_color: "Couleur", term_bw: "Noir & Blanc", term_color_hd: "Couleur HD", term_finish: "Kusala & Kinga", term_binding: "Reliure", term_laminate: "Lamina", term_pages: "Makon", term_copies: "Kadisadi", term_type: "Aina", term_recto: "Tshitshi", term_recto_verso: "Tshitshi / Mutundu", term_dest_title: "Muadi", term_ph_name: "Dina mobimba", term_ph_phone: "WhatsApp", term_ph_addr: "Adrese", term_payment: "Lipa", term_total: "Total Commande", term_currency: "FC", term_printing: "Kubaja", term_finishes: "Midi", term_back: "Kubajikula", term_continue: "Kosuka", term_confirm: "Kulipa", term_uploading: "Kutuma...", term_confirmed: "Bwakaji !", term_redirect: "Kujikula..." }
        };

        // Initialisation de l'observateur au chargement de la page
function setupInfiniteScroll() {
    const loader = document.getElementById('feed-loader');
    
    // Si un observateur existe déjà, on le déconnecte
    if (feedObserver) {
        feedObserver.disconnect();
    }

    if (loader) {
        // Création de l'observateur
        feedObserver = new IntersectionObserver((entries) => {
            // Si le loader est visible dans l'écran
            if (entries[0].isIntersecting) {
                loadMoreFeed();
            }
        }, {
            rootMargin: '300px' // Déclenche 200px avant le vrai bas de page
        });

        feedObserver.observe(loader);
    }
}
        document.addEventListener('DOMContentLoaded', async () => {
    
    // --- 1. GARDE-FOU D'AUTHENTIFICATION ---
    const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();

    if (!session || sessionError) {
        console.log("Votre session a expiré. Veuillez vous reconnecter.");
        window.location.replace('login.html'); 
        return; 
    }

    // --- 2. CONFIGURATION INITIALE (UI) ---
    const savedLang = localStorage.getItem('printbam-lang') || 'fr';
    const langSelect = document.getElementById('language-select');
    if (langSelect) langSelect.value = savedLang;
    
    updateLanguage(savedLang);
    setTheme(localStorage.getItem('printbam-theme') || 'light', false);

    // --- 3. TÂCHES D'ARRIÈRE-PLAN (Non bloquantes) ---
    // On les lance en parallèle pour ne pas attendre
    updateMessageBadge();
    loadMarketplaceArticles();

    // --- 4. DÉFINITION DE LA FONCTION D'INITIALISATION ---
    // On place la définition complète ICI pour être sûr qu'elle existe quand on l'appelle
    async function initialiserApplication() {
        try {
            console.log("Démarrage progressif...");

            // On force la page d'accueil à être visible AVANT de charger le flux
            const homeView = document.getElementById('home-view');
            if (homeView) {
                homeView.style.display = 'block'; 
                setTimeout(() => homeView.classList.add('active'), 50);
            }

            // Petite fonction utilitaire pour attendre
            const wait = ms => new Promise(res => setTimeout(res, ms));

            // On lance les chargements avec un léger décalage entre chaque
            const charger = async (nom, fonction, delai) => {
                try {
                    await wait(delai);
                    await fonction();
                    console.log(`✅ ${nom} chargé`);
                } catch (e) {
                    console.warn(`⚠️ Échec ${nom}:`, e.message);
                }
            };

            // Lancement séquentiel cadencé
            await Promise.allSettled([
                charger("Flux", loadGlobalFeed, 0),       // Immédiat
                charger("Profil", loadSocialProfile, 150), // +150ms
                charger("Notifs", loadNotifications, 300), // +300ms
                charger("Messages", loadChatList, 450)     // +450ms
            ]);

        } catch (error) {
            if (error.name !== 'AbortError') {
                console.error("Erreur critique au démarrage :", error);
            }
        } finally {
            // 1. ON REND LE CONTENU VISIBLE
            document.body.classList.remove('app-loading');

            // 2. ATTENTE DU RENDU GRAPHIQUE
            await new Promise(resolve => requestAnimationFrame(() => requestAnimationFrame(resolve)));

            // 3. DISPARITION DU LOADER
            const loader = document.getElementById('loader');
            if (loader) {
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.style.display = 'none';
                }, 500);
            }
        }
    }

    // --- 5. LANCEMENT DE L'APPLICATION ---
    // On attend que tout soit prêt
    await initialiserApplication();

    // --- 6. ACTIVATION DU SCROLL INFINI ---
    // On appelle cela une fois que le premier batch de posts est chargé
    if (typeof setupInfiniteScroll === 'function') {
        setupInfiniteScroll();
    }
    
    // Initialisation des effets visuels
    if (typeof initScrollReveal === 'function') {
        initScrollReveal();
    }

   /* --- LOGIQUE DE SCROLL AUTO-HIDE --- */
    let lastScrollY = window.scrollY;

    window.addEventListener('scroll', () => {
        const currentScrollY = window.scrollY;
        const explorerBar = document.querySelector('.feed-sticky-header');
        const dock = document.querySelector('.mobile-dock');

        // On ignore si on est en haut de page (pour ne pas cacher au chargement)
        if (currentScrollY <= 10) return;

        // On vérifie la direction du scroll
        if (currentScrollY > lastScrollY && currentScrollY > 50) {
            // SCROLL VERS LE BAS : On cache tout
            if (explorerBar) explorerBar.classList.add('nav-hidden');
            if (dock) dock.classList.add('nav-hidden');
        } else {
            // SCROLL VERS LE HAUT : On réaffiche tout
            if (explorerBar) explorerBar.classList.remove('nav-hidden');
            if (dock) dock.classList.remove('nav-hidden');
        }

        // On met à jour la position précédente
        lastScrollY = currentScrollY;
    }, { passive: true });
    
    // Initialisation des effets visuels après chargement des données
    if (typeof initScrollReveal === 'function') {
        initScrollReveal();
    }

    // --- LOGIQUE DE SWIPE SUR MESSAGES (Désindenté) ---
    const messagesView = document.getElementById('messages-view');

    if (messagesView) {
        let touchStartX = 0;
        let touchEndX = 0;
        const seuil = 120; // Distance minimale en pixels pour déclencher l'action

        messagesView.addEventListener('touchstart', function(event) {
            // On enregistre la position où le doigt touche l'écran
            touchStartX = event.changedTouches[0].screenX;
        }, false);

        messagesView.addEventListener('touchend', function(event) {
            // On enregistre la position où le doigt quitte l'écran
            touchEndX = event.changedTouches[0].screenX;
            handleSwipe();
        }, false);

        function handleSwipe() {
            // Calcul de la distance
            const diff = touchStartX - touchEndX;

            // Si la différence est positive, c'est un glissement vers la GAUCHE
            if (diff > seuil) {
                // On déclenche le retour à l'accueil
                switchPage('home');
            }
        }
    }
});

        function changeLanguage(lang) {
            localStorage.setItem('printbam-lang', lang);
            updateLanguage(lang);
            const langNames = { 'fr': 'Français', 'en': 'English', 'ln': 'Lingala', 'tu': 'Tshiluba', 'sw': 'Swahili', 'kg': 'Kikongo' };
            showToast(`Langue : ${langNames[lang]}`, 'success');
        }

        function updateLanguage(lang) {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) el.textContent = translations[lang][key];
            });
            document.querySelectorAll('[data-placeholder]').forEach(el => {
                const key = el.getAttribute('data-placeholder');
                if (translations[lang] && translations[lang][key]) el.placeholder = translations[lang][key];
            });
            const terminalWrapper = document.getElementById('terminal-wrapper');
            if(terminalWrapper) {
                terminalWrapper.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (translations[lang] && translations[lang][key]) el.textContent = translations[lang][key];
                });
                const btnRV = document.getElementById('btnRV');
                if(btnRV) {
                     const isV = document.getElementById('rectoVerso').value === "true";
                     btnRV.innerText = isV ? (translations[lang]?.term_recto_verso || "Recto / Verso") : (translations[lang]?.term_recto || "Recto Seul");
                }
                updateControls();
            }
            if (translations[lang] && translations[lang].typewriter_words) window.currentWords = translations[lang].typewriter_words;
        }

        function setTheme(theme, save = true) {
            const btnLight = document.getElementById('btn-light');
            const btnDark = document.getElementById('btn-dark');
            const body = document.body;
            if (theme === 'dark') {
                body.classList.add('dark-mode');
                if(btnDark) { btnDark.classList.remove('text-slate-500', 'bg-transparent'); btnDark.classList.add('bg-white', 'text-slate-800', 'shadow-sm'); }
                if(btnLight) { btnLight.classList.add('text-slate-500', 'bg-transparent'); btnLight.classList.remove('bg-white', 'text-slate-800', 'shadow-sm'); }
            } else {
                body.classList.remove('dark-mode');
                if(btnLight) { btnLight.classList.remove('text-slate-500', 'bg-transparent'); btnLight.classList.add('bg-white', 'text-slate-800', 'shadow-sm'); }
                if(btnDark) { btnDark.classList.add('text-slate-500', 'bg-transparent'); btnDark.classList.remove('bg-white', 'text-slate-800', 'shadow-sm'); }
            }
            if (save) localStorage.setItem('printbam-theme', theme);
        }

        function toggleSidebar() {
            const mainContent = document.getElementById('main-content'); const panel = document.getElementById('sidebar-panel'); const overlay = document.getElementById('sidebar-overlay'); const bg = document.getElementById('sidebar-bg'); const dock = document.querySelector('.mobile-dock'); const isOpen = !overlay.classList.contains('invisible');
            if (!isOpen) {
                overlay.classList.remove('invisible');
                setTimeout(() => { bg.classList.replace('opacity-0', 'opacity-100'); panel.classList.replace('-translate-x-full', 'translate-x-0'); panel.classList.replace('opacity-0', 'opacity-100'); }, 10);
                // --- NOUVEAU CODE ---
if(mainContent) { 
    // On retire 'transform' pour que 'position: sticky' fonctionne !
    // mainContent.style.transform = 'translateX(280px) scale(0.95)'; // <-- Supprimez ou commentezz ceci
    
    mainContent.style.filter = 'blur(2px) brightness(0.9)'; 
    mainContent.style.pointerEvents = 'none'; // Important : empêche de cliquer sur le contenu flouté
}
                if(dock) dock.style.setProperty('display', 'none', 'important');
            } else {
                bg.classList.replace('opacity-100', 'opacity-0'); panel.classList.replace('translate-x-0', '-translate-x-full'); panel.classList.replace('opacity-100', 'opacity-0');
                if(mainContent) { mainContent.style.transform = ''; mainContent.style.filter = ''; mainContent.style.borderRadius = ''; mainContent.style.pointerEvents = 'auto'; }
                if(dock) dock.style.removeProperty('display');
                setTimeout(() => { overlay.classList.add('invisible'); }, 500);
            }
        }
        function genericToggle(overlayId, panelId, bgClass) {
            const overlay = document.getElementById(overlayId); const panel = document.getElementById(panelId); const bg = overlay.querySelector(bgClass);
            if (overlay.classList.contains('invisible')) {
                overlay.classList.remove('invisible');
                setTimeout(() => { bg.classList.replace('opacity-0', 'opacity-100'); panel.classList.replace('translate-x-full', 'translate-x-0'); }, 10);
            } else {
                bg.classList.replace('opacity-100', 'opacity-0'); panel.classList.replace('translate-x-0', 'translate-x-full');
                setTimeout(() => overlay.classList.add('invisible'), 500);
            }
        }
        function toggleSettings() { genericToggle('settings-overlay', 'settings-panel', 'div:first-child'); updateStats(); } 
        function toggleSupport() { genericToggle('support-overlay', 'support-panel', 'div:first-child'); }
        function toggleOrders() { renderOrders(); genericToggle('orders-overlay', 'orders-panel', 'div:first-child'); }
        function toggleAbout() {
            genericToggle('about-overlay', 'about-panel', 'div:first-child');
        }
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container'); const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            let icon = type === 'success' ? 'fa-check-circle text-green-500' : 'fa-exclamation-circle text-red-500';
            toast.innerHTML = `<div class="flex items-center gap-3"><i class="fas ${icon} text-lg"></i><span class="font-medium text-slate-700">${message}</span></div><button onclick="this.parentElement.remove()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.animation = 'slideOut 0.3s forwards'; setTimeout(() => toast.remove(), 300); }, 4000);
        }

        window.currentWords = window.currentWords || ["précision chirurgicale.", "vitesse absolue.", "sécurité bancaire.", "design élégant."];
        const typeTarget = document.getElementById('typewriter');
        if (typeTarget) {
            let wordIndex = 0, charIndex = 0, deleting = false;
            function typeLoop() {
                const words = window.currentWords; const word = words[wordIndex];
                typeTarget.textContent = deleting ? word.substring(0, --charIndex) : word.substring(0, ++charIndex);
                let delay = deleting ? 50 : 100;
                if (!deleting && charIndex === word.length) { deleting = true; delay = 2000; }
                if (deleting && charIndex === 0) { deleting = false; wordIndex = (wordIndex + 1) % words.length; delay = 500; }
                setTimeout(typeLoop, delay);
            }
            typeLoop();
        }

        function initScrollReveal() {
            const observer = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting) entry.target.classList.add('active'); }); }, { threshold: 0.1 });
            document.querySelectorAll('.reveal-up').forEach(el => observer.observe(el));
        }

        window.addEventListener('scroll', () => {
            const current = window.scrollY; const nav = document.getElementById('nav-main'); const mobileHeader = document.getElementById('mobile-header');
            if (nav) {
                if(current > 20) { nav.classList.add('py-3'); nav.classList.remove('py-6'); nav.style.boxShadow = "0 10px 15px -3px rgba(0,0,0,0.1)"; }
                else { nav.classList.remove('py-3'); nav.classList.add('py-6'); nav.style.boxShadow = "var(--shadow-soft)"; }
            }
            if(mobileHeader) { if(current > 20) mobileHeader.classList.add('header-scrolled'); else mobileHeader.classList.remove('header-scrolled'); }
        });

        const bgGrid = document.getElementById('parallax-bg');
        if(bgGrid) {
            window.addEventListener('mousemove', e => {
                const moveX = (e.clientX - window.innerWidth / 2) * 0.01;
                const moveY = (e.clientY - window.innerHeight / 2) * 0.01;
                bgGrid.style.transform = `translate(${moveX}px, ${moveY}px)`;
            });
        }

        let orders = JSON.parse(localStorage.getItem('printbam_orders')) || [];
        function saveNewOrder(docName, price) {
            const newOrder = { id: 'PB-' + Math.floor(Math.random() * 9000 + 1000), date: new Date().toLocaleDateString('fr-FR'), item: docName, amount: price, status: 'En cours' };
            orders.unshift(newOrder); localStorage.setItem('printbam_orders', JSON.stringify(orders));
        }
        function renderOrders() {
            const list = document.getElementById('orders-list'); const totalDisplay = document.getElementById('total-spent');
            if (orders.length === 0) { list.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-center space-y-4 opacity-40 pt-10"><i class="fas fa-box-open text-4xl text-slate-800"></i><p class="text-xs font-bold uppercase tracking-widest text-slate-800">Aucune commande</p></div>`; totalDisplay.innerText = "0 FC"; return; }
            list.innerHTML = ''; let total = 0;
            orders.forEach((order, index) => {
                total += order.amount;
                list.innerHTML += `
                    <div class="glass p-4 flex items-center justify-between group hover:border-indigo-200 transition-all cursor-pointer" onclick="openTrackModal('${order.id}', '${order.date}')" style="animation: slideIn 0.3s ease ${index * 0.1}s forwards; opacity: 0; transform: translateY(10px);">
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] font-black text-indigo-600 uppercase">${order.id}</span>
                            <span class="text-sm font-bold text-slate-900">${order.item}</span>
                            <span class="text-[10px] text-slate-400">${order.date}</span>
                        </div>
                        <div class="flex flex-col items-end gap-2">
                            <span class="text-sm font-black text-slate-900">${order.amount.toLocaleString()} FC</span>
                            <span class="px-2 py-0.5 rounded-md bg-indigo-50 text-indigo-700 text-[8px] font-bold uppercase tracking-tighter border border-indigo-100">${order.status}</span>
                        </div>
                    </div>`;
            });
            totalDisplay.innerText = total.toLocaleString() + " FC";
        }
        
        function updateStats() {
            const countDisplay = document.getElementById('stats-orders-count');
            const spentDisplay = document.getElementById('stats-total-spent');
            
            if(countDisplay) countDisplay.innerText = orders.length;
            
            let total = 0;
            orders.forEach(o => total += o.amount);
            if(spentDisplay) spentDisplay.innerText = total.toLocaleString('fr-FR');
        }

        let clearStep = 0;
        function confirmClearHistory() {
            const btn = document.getElementById('btn-clear-history');
            if (clearStep === 0) { clearStep = 1; btn.innerText = "Confirmer ?"; btn.classList.add('bg-red-50', 'border-red-200'); setTimeout(() => { if(clearStep === 1) resetClearBtn(); }, 3000); }
            else { orders = []; localStorage.removeItem('printbam_orders'); renderOrders(); showToast('Historique vidé', 'success'); resetClearBtn(); }
        }
        function resetClearBtn() {
            const btn = document.getElementById('btn-clear-history'); clearStep = 0;
            btn.innerText = "Vider l'historique"; btn.classList.remove('bg-red-50', 'border-red-200');
        }
        function handleSupportSubmit(event) {
            event.preventDefault(); const btn = document.getElementById('btn-send-support'); const form = document.getElementById('support-form'); const successMsg = document.getElementById('support-success');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-circle-notch animate-spin"></i> <span>Transmission...</span>';
            setTimeout(() => { form.classList.add('hidden'); successMsg.classList.remove('hidden'); form.reset(); btn.disabled = false; btn.innerHTML = '<span data-i18n="btn_send">Envoyer</span><i class="fas fa-paper-plane text-[10px]"></i>'; showToast("Message envoyé au support !", "success"); }, 1500);
        }

       /* --- GESTION DU PROFIL UTILISATEUR (AVEC SUPABASE) --- */

// Fonction pour ouvrir/fermer le panneau
async function toggleProfile() {
    // Vérification de sécurité via Supabase Auth
    const isConnected = await checkAuth();
    if (!isConnected) return;
    
    genericToggle('profile-overlay', 'profile-panel', 'div:first-child');
    
    // Charger les données si on ouvre le panneau
    const overlay = document.getElementById('profile-overlay');
    if (!overlay.classList.contains('invisible')) {
        await loadUserProfile();
    }
}

// Vérifie si l'utilisateur est connecté via Supabase
async function checkAuth() {
    const { data: { user }, error } = await supabaseClient.auth.getUser();
    
    if (error || !user) {
        showToast("Veuillez vous connecter pour accéder à cette page.", "error");
        setTimeout(() => { window.location.href = "login.html"; }, 1000);
        return false;
    }
    return true;
}

// Charger les infos du profil depuis Supabase
async function loadUserProfile() {
    try {
        // 1. Récupérer l'utilisateur connecté depuis la session
        const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
        
        if (authError || !user) {
            console.log("Utilisateur non connecté");
            return;
        }
        checkAdminStatus();

        // 2. Récupérer les données de la table 'profiles'
        // On utilise 'profile' comme nom de variable pour correspondre à votre suite de code
        const { data: profile, error } = await supabaseClient
            .from('profiles')
            .select('*')
            .eq('id', user.id) // CORRECTION : On utilise user.id ici
            .maybeSingle(); 

        if (error) {
            console.error("Erreur lors de la récupération :", error.message);
            return;
        }

        // 3. Mise à jour de l'interface (DOM)
        if (profile) {
            console.log("Profil trouvé :", profile);
            
            // Remplissage des champs (avec repli sur les métadonnées si profil incomplet)
            if (document.getElementById('p-name'))
                document.getElementById('p-name').value = profile.full_name || user.user_metadata.full_name || '';
            
            if (document.getElementById('p-email'))
                document.getElementById('p-email').value = user.email || '';
            
            if (document.getElementById('p-phone')) // Remplacez 'else if' par 'if'
                document.getElementById('p-phone').value = profile.phone || '';
                        
            if (document.getElementById('p-bio'))
                document.getElementById('p-bio').value = profile.bio || '';

            // Gestion de l'avatar (Image vs Icon)
            const imgDisplay = document.getElementById('profile-avatar-img');
            const iconDisplay = document.getElementById('profile-avatar-icon');

            if (profile.is_certified) {
                // Afficher l'icône bleue
                if(imgDisplay) imgDisplay.classList.remove('hidden');
                iconDisplay.classList.add('hidden');
            } else {
                imgDisplay.classList.add('hidden');
                iconDisplay.classList.remove('hidden');
            }
        } else {
            console.log("Aucun profil trouvé dans la table 'profiles' pour cet ID.");
        }
    } catch (err) {
        console.error("Erreur inattendue :", err);
    }
}

// Gestion de l'image de profil (Upload Supabase Storage)
let avatarFile = null; // Variable temporaire pour stocker le fichier choisi

function handleProfileImage(input) {
    if (input.files && input.files[0]) {
        avatarFile = input.files[0]; // On stocke le fichier pour l'upload plus tard
        const reader = new FileReader();
        reader.onload = function(e) {
            const imgDisplay = document.getElementById('profile-avatar-img');
            const iconDisplay = document.getElementById('profile-avatar-icon');
            
            imgDisplay.src = e.target.result;
            imgDisplay.classList.remove('hidden');
            iconDisplay.classList.add('hidden');
        }
        reader.readAsDataURL(input.files[0]);
    }
}
        
// Sauvegarder le profil (Upload image + Update BDD)
async function saveProfile(e) {
    e.preventDefault();
    
    // 1. Gestion de l'état du bouton
    const btn = e.target.querySelector('button[type="submit"]');
    const originalText = btn.innerHTML; // Utiliser innerHTML au cas où il y aurait des icônes
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';

    try {
        // 2. Vérification de l'utilisateur
        const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
        if (userError || !user) throw new Error("Session expirée. Veuillez vous reconnecter.");

        let avatarUrl = null;

        // 3. Gestion de l'Upload (si avatarFile existe dans votre scope global)
        // Note : assurez-vous que 'avatarFile' est bien défini quand l'utilisateur choisit un fichier
        if (typeof avatarFile !== 'undefined' && avatarFile) {
            const fileExt = avatarFile.name.split('.').pop();
            const fileName = `${user.id}/${Date.now()}.${fileExt}`;

            const { data: uploadData, error: uploadError } = await supabaseClient.storage
                .from('avatars')
                .upload(fileName, avatarFile, {
                    upsert: true
                });

            if (uploadError) throw new Error("Erreur d'upload : " + uploadError.message);

            // Récupérer l'URL publique
            const { data: publicUrlData } = supabaseClient.storage
                .from('avatars')
                .getPublicUrl(fileName);
            
            avatarUrl = publicUrlData.publicUrl;
        }

        // 4. Préparation des données pour la table 'profiles'
        const updates = {
            id: user.id,
            // Ne pas mettre à jour l'email si votre table 'profiles' ne le gère pas (l'email est déjà dans auth.users)
            full_name: document.getElementById('p-name').value.trim(),
            phone: document.getElementById('p-phone').value.trim(),
            bio: document.getElementById('p-bio').value.trim(),
            updated_at: new Date().toISOString()
        };

        if (avatarUrl) {
            updates.avatar_url = avatarUrl;
        }

        // 5. Mise à jour dans la base de données
        const { error: updateError } = await supabaseClient
            .from('profiles')
            .upsert(updates, { onConflict: 'id' }); 

        if (updateError) throw updateError;

        // 6. Succès
        showToast("Profil mis à jour avec succès ! ✅", "success");
        
        // Rafraîchir l'interface si la fonction existe
        if (typeof loadUserProfile === 'function') await loadUserProfile();
        if (typeof toggleProfile === 'function') toggleProfile();

    } catch (error) {
        console.error("Erreur saveProfile:", error);
        showToast(error.message, "error");
    } finally {
        // 7. Reset de l'état
        btn.innerHTML = originalText;
        btn.disabled = false;
        if (typeof avatarFile !== 'undefined') avatarFile = null; 
    }
}
        
        // Déconnexion
        async function logout() {
            if(confirm("Êtes-vous sûr de vouloir vous déconnecter ?")) {
                await supabaseClient.auth.signOut();
                showToast("Déconnexion...", "success");
                setTimeout(() => {
                    window.location.href = "login.html";
                }, 1000);
            }
        }
    
        /* --- MISE À JOUR DES BLOCAGES D'ACCÈS --- */
        
        // Surcharge de la fonction openTerminal
        const originalOpenTerminal = openTerminal;
        openTerminal = async function() {
            const isConnected = await checkAuth();
            if (!isConnected) return;
            originalOpenTerminal();
        }
        
        // Surcharge de toggleOrders
        const originalToggleOrders = toggleOrders;
        toggleOrders = async function() {
            const isConnected = await checkAuth();
            if (!isConnected) return;
            originalToggleOrders();
        }

               /* --- GESTION DE L'ESPACE ADMIN --- */

async function checkAdminStatus() {
    try {
        // Correction de la parenthèse et de l'accolade ici :
        const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
        
        if (authError || !user) return;

        const { data: profile, error } = await supabaseClient
            .from('profiles')
            .select('is_admin')
            .eq('id', user.id)
            .maybeSingle(); 

        if (profile && profile.is_admin) {
            isCurrentUserAdmin = true;
            const adminLink = document.getElementById('nav-admin-link');
            if (adminLink) adminLink.classList.remove('hidden');
        }
    } catch (error) {
        console.error("Erreur vérification admin :", error);
    }
}

// 2. Charger les articles dans la vue Admin
async function loadAdminArticles() {
    const list = document.getElementById('admin-articles-list');
    if (!list) return;

    // Loader initial
    list.innerHTML = '<div class="col-span-full text-center py-10"><i class="fas fa-circle-notch fa-spin text-2xl text-indigo-600"></i></div>';

    const { data: articles, error } = await supabaseClient
        .from('articles')
        .select('*')
        .order('created_at', { ascending: false });

    if (error) {
        list.innerHTML = `<p class="col-span-full text-red-500 text-center py-10">Erreur de chargement: ${error.message}</p>`;
        return;
    }

    if (!articles || articles.length === 0) {
        list.innerHTML = '<div class="col-span-full text-center py-10 text-slate-400">Aucun article pour le moment.</div>';
        return;
    }

    list.innerHTML = articles.map(art => {
        // Préparation de l'image pour éviter les erreurs de backticks imbriqués
        const imageContent = art.image_url 
            ? `<img src="${art.image_url}" class="w-20 h-20 object-cover rounded-lg bg-slate-100 shadow-sm">` 
            : `<div class="w-20 h-20 bg-slate-100 rounded-lg flex items-center justify-center text-slate-300 border border-slate-200"><i class="fas fa-image text-xl"></i></div>`;

        // Nettoyage du contenu (enlève les balises HTML si présentes)
        const plainText = art.content.replace(/<[^>]*>/g, '');
        const excerpt = plainText.length > 80 ? plainText.substring(0, 80) + '...' : plainText;

        return `
        <div class="glass p-6 flex flex-col sm:flex-row gap-4 items-start group hover:shadow-lg transition-all border border-white/20">
            <div class="flex-shrink-0">
                ${imageContent}
            </div>
            
            <div class="flex-1 flex flex-col h-full">
                <div class="mb-2">
                    <span class="text-[10px] font-bold text-indigo-600 uppercase bg-indigo-50 px-2 py-1 rounded-full border border-indigo-100 italic">
                        ${art.category || 'Général'}
                    </span>
                    <h3 class="text-lg font-extrabold text-slate-900 mt-2 leading-tight group-hover:text-indigo-600 transition-colors">
                        ${art.title}
                    </h3>
                </div>
                
                <p class="text-xs text-slate-500 mb-4 line-clamp-2">
                    ${excerpt}
                </p>
                
                <div class="flex items-center justify-between mt-auto pt-2 border-t border-slate-100/50">
                    <span class="text-xs font-medium text-slate-400">
                        <i class="far fa-calendar-alt mr-1"></i> 
                        ${new Date(art.created_at).toLocaleDateString('fr-FR')}
                    </span>
                    <a href="javascript:void(0)" 
                       onclick="editArticle('${art.id}')"
                       class="w-8 h-8 rounded-full bg-slate-900 text-white flex items-center justify-center hover:bg-indigo-600 hover:scale-110 transition-all">
                        <i class="fas fa-pencil-alt text-[10px]"></i>
                    </a>
                </div>
            </div>
        </div>
        `;
    }).join('');
}

// 3. Ouvrir/Fermermer la modale
function openArticleModal() {
    document.getElementById('article-modal').classList.remove('hidden');
    document.getElementById('article-form').reset();
}
function closeArticleModal() {
    document.getElementById('article-modal').classList.add('hidden');
}

// 4. Sauvegarder un nouvel article
async function saveArticle(e) {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    
    // État de chargement "Ultra Pro"
    const originalText = btn.innerText;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> Publication...';

    try {
        const title = document.getElementById('art-title').value;
        const content = document.getElementById('art-content').value;
        const category = document.getElementById('art-category').value;
        const image_url = document.getElementById('art-image').value;

        // CORRECTION : Ajout de la fermeture de l'objet et de la parenthèse
        const { data: { user }, error: authError } = await supabaseClient.auth.getUser();

        if (authError || !user) {
            throw new Error("Session expirée ou utilisateur non trouvé.");
        }

        // Insertion dans Supabase
        const { error } = await supabaseClient.from('articles').insert([{
            title,
            content,
            category,
            image_url,
            author_id: user.id,
            created_at: new Date().toISOString() // Bonne pratique pour le tri
        }]);

        if (error) throw error;

        // Succès
        showToast("Article publié avec succès !", "success");
        
        // Nettoyage et rafraîchissement
        if (typeof closeArticleModal === 'function') closeArticleModal();
        if (typeof loadAdminArticles === 'function') loadAdminArticles();
        
        e.target.reset(); // Vide le formulaire

    } catch (error) {
        console.error("Erreur publication:", error);
        alert("Erreur lors de la publication : " + error.message);
    } finally {
        // Dans tous les cas (succès ou erreur), on réactive le bouton
        btn.disabled = false;
        btn.innerText = originalText;
    }
}

// 5. Supprimer un article
async function deleteArticle(id) {
    if(!confirm("Êtes-vous sûr de vouloir supprimer cet article ?")) return;
    
    const { error } = await supabaseClient.from('articles').delete().eq('id', id);
    
    if (error) {
        showToast("Erreur de suppression", "error");
    } else {
        showToast("Article supprimé", "success");
        loadAdminArticles();
    }
}
        /* --- AFFICHER LES ARTICLES ADMIN DANS LA MARKETPLACE --- */

async function loadMarketplaceArticles() {
    try {
        // 1. Récupérer les articles depuis Supabase
        const { data: articles, error } = await supabaseClient
            .from('articles')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) {
            console.error("Erreur chargement articles marketplace :", error);
            return;
        }

        if (!articles || articles.length === 0) return;

        // 2. Le conteneur où l'on va mettre les articles
        const grid = document.getElementById('products-grid');
        
        // 3. Créer le HTML pour chaque article
        articles.forEach(art => {
            // Définition des couleurs d'arrière-plan selon la catégorie (comme vos produits fixes)
            let bgClass = 'bg-slate-50'; 
            let iconClass = 'fas fa-newspaper text-slate-200';
            
            if (art.category === 'academique') {
                bgClass = 'bg-indigo-50'; iconClass = 'fas fa-graduation-cap text-indigo-200';
            } else if (art.category === 'corporate') {
                bgClass = 'bg-emerald-50'; iconClass = 'fas fa-briefcase text-emerald-200';
            } else if (art.category === 'marketing') {
                bgClass = 'bg-orange-50'; iconClass = 'fa-bullhorn text-orange-200';
            }

            // Création de la Carte
            const articleHTML = `
        <div class="market-item glass flex flex-col group overflow-hidden" data-category="${art.category || 'all'}">
            <div class="h-48 ${bgClass || 'bg-slate-100'} relative overflow-hidden">
                ${art.image_url 
                    ? `<img src="${art.image_url}" class="w-full h-full object-cover transition-all duration-700 group-hover:scale-110">` 
                    : `<div class="absolute inset-0 flex items-center justify-center text-slate-300 text-5xl">
                         <i class="fas fa-image"></i>
                       </div>`
                }
                <span class="absolute top-4 left-4 bg-indigo-600 text-white text-[10px] font-bold px-2 py-1 rounded uppercase shadow-lg z-10">
                    Pub
                </span>
            </div>

            <div class="p-6 flex-1 flex flex-col">
                <h3 class="font-bold text-lg mb-2 text-slate-900 group-hover:text-indigo-600 transition-colors line-clamp-1">
                    ${art.title}
                </h3>
                
                <p class="text-sm text-slate-500 mb-4 flex-1 line-clamp-2">
                    ${art.content ? art.content.replace(/<[^>]*>/g, '').substring(0, 80) + '...' : ''}
                </p>

                <div class="flex items-center justify-between mt-auto pt-4 border-t border-slate-100">
                    <span class="text-xs font-bold uppercase tracking-wider text-slate-400 italic">Détails</span>
                    <a href="javascript:void(0)" 
                       onclick="openTerminal()" 
                       class="w-10 h-10 rounded-full bg-slate-900 text-white flex items-center justify-center hover:bg-indigo-600 hover:scale-110 transition-all shadow-md">
                        <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>
    `;

    // Injection au début de la grille
    grid.insertAdjacentHTML('afterbegin', articleHTML);
    
    });

} catch (err) {
        console.error("Erreur marketplace :", err);
        
        // Rendu visuel de l'erreur pour l'utilisateur
        const grid = document.getElementById('products-grid'); // Remplacez par votre ID réel
        if (grid) {
            grid.innerHTML = `
                <div class="col-span-full flex flex-col items-center py-12 text-slate-400">
                    <i class="fas fa-exclamation-circle text-3xl mb-3 opacity-20"></i>
                    <p class="text-sm font-medium">Impossible de charger les produits pour le moment.</p>
                    <button onclick="location.reload()" class="mt-4 text-xs font-bold text-indigo-600 hover:text-indigo-500 underline uppercase tracking-widest">
                        Réessayer
                    </button>
                </div>
            `;
        }
        
        // Optionnel : Notification Toast
        if (typeof showToast === 'function') {
            showToast("Problème de connexion à la marketplace", "error");
        }
    }
}
       /**
 * Génère le HTML de l'avatar de manière élégante
 * @param {string} userEmail - Email de l'utilisateur pour les initiales et la couleur
 * @param {string} avatarUrl - URL optionnelle de la photo de profil
 * @param {boolean} isMe - Optionnel : permet de styliser différemment mon propre avatar
 */
function getAvatarHtml(userEmail, avatarUrl, isMe = false) {
    // 1. Si on a une URL d'image valide
    if (avatarUrl && avatarUrl.trim() !== '') {
        return `<img src="${avatarUrl}" class="w-full h-full object-cover rounded-full" onerror="this.parentElement.innerHTML='${getAvatarHtml(userEmail, null, isMe)}'">`;
    }
    
    // 2. Préparation des initiales
    const initials = userEmail && userEmail.includes('@') 
        ? userEmail.split('@')[0].substring(0, 2).toUpperCase() 
        : (userEmail ? userEmail.substring(0, 2).toUpperCase() : '??');

    // 3. Palette de couleurs "Modern Business" (plus sobres et pros)
    const colors = [
        '#6366f1', // Indigo
        '#8b5cf6', // Violet
        '#ec4899', // Rose
        '#3b82f6', // Bleu
        '#06b6d4', // Cyan
        '#10b981', // Emeraude
        '#f59e0b', // Ambre
        '#64748b'  // Ardoise
    ];

    // Génération d'un index de couleur constant pour le même utilisateur
    const charCodeSum = userEmail ? userEmail.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) : 0;
    const colorIndex = charCodeSum % colors.length;
    const bgColor = colors[colorIndex];
    
    // 4. Retourne le span avec centrage Flexbox parfait
    return `
        <div class="w-full h-full flex items-center justify-center font-bold text-[11px] tracking-tighter rounded-full text-white shadow-inner" 
             style="background: linear-gradient(135deg, ${bgColor}CC, ${bgColor}); text-shadow: 0 1px 2px rgba(0,0,0,0.2);">
            ${initials}
        </div>
    `;
}

/* --- METTRE À JOUR L'AVATAR DU DOCK --- */
function updateDockAvatar(avatarUrl) {
    const img = document.getElementById('dock-avatar-img');
    const icon = document.getElementById('dock-avatar-icon');
    
    if (!img || !icon) return;

    if (avatarUrl && avatarUrl.trim() !== '') {
        // Si on a une photo : on l'affiche et on cache l'icône
        img.src = avatarUrl;
        img.classList.remove('hidden');
        icon.classList.add('hidden');
    } else {
        // Si pas de photo : on cache l'image et on affiche l'icône
        img.classList.add('hidden');
        icon.classList.remove('hidden');
    }
}
        /* --- GESTION DE L'OUVERTURE DU CHAT (MODIFIÉ) --- */
/* --- GESTION DE L'OUVERTURE DU CHAT (CORRIGÉ POUR LE DOCK) --- */
let chatInterval = null;

window.toggleChat = async function() {
    const { data: authData } = await supabaseClient.auth.getUser();
    const user = authData?.user;

    if (!user) {
        showToast("Veuillez vous connecter pour accéder au chat", "error");
        return;
    }

    const overlay = document.getElementById('chat-overlay');
    const panel = document.getElementById('chat-panel');
    const dock = document.querySelector('.mobile-dock');
    
    if (!overlay || !panel) return;
    
    if (overlay.classList.contains('invisible')) {
        // --- OUVERTURE ---
        overlay.classList.remove('invisible');
        setTimeout(() => {
            overlay.querySelector('div:first-child').classList.replace('opacity-0', 'opacity-100');
            panel.classList.replace('translate-x-full', 'translate-x-0');
        }, 10);

        loadChatMessages();
        if (!chatInterval) chatInterval = setInterval(loadChatMessages, 3000);

        // --- CACHER LE DOCK ---
        if (dock) dock.classList.add('dock-hidden');

        setTimeout(() => {
            const input = document.getElementById('chat-input');
            if (input) input.focus();
        }, 500);
    } else {
        // --- FERMETURE ---
        overlay.querySelector('div:first-child').classList.replace('opacity-100', 'opacity-0');
        panel.classList.replace('translate-x-0', 'translate-x-full');
        setTimeout(() => overlay.classList.add('invisible'), 500);

        if (chatInterval) {
            clearInterval(chatInterval);
            chatInterval = null;
        }

        // --- RÉAFFICHER LE DOCK ---
        if (dock) dock.classList.remove('dock-hidden');
    }
};

        /* --- ENVOI DE MESSAGE CHAT --- */
async function sendChatMessage(e) {
    e.preventDefault(); // Empêche le rechargement de la page

    const input = document.getElementById('chat-input');
    const content = input.value.trim();

    if (!content) return; // Ne rien faire si le message est vide

    // Vérifier que l'utilisateur est connecté
    const { data: { user }, error } = await supabaseClient.auth.getUser();
    if (error || !user) {
        showToast("Vous devez être connecté pour chatter.", "error");
        return;
    }

    // Petit effet visuel sur le bouton (optionnel)
    const btn = e.target.querySelector('button[type="submit"]');
    const originalIcon = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';

    try {
        // Insertion dans la table 'messages' de Supabase
        const { error: insertError } = await supabaseClient
            .from('messages')
            .insert([{
                user_id: user.id,
                user_email: user.email, // Important pour l'affichage
                content: content,
                created_at: new Date().toISOString()
            }]);

        if (insertError) throw insertError;

        // Succès
        input.value = ''; // Vider le champ
        await loadChatMessages(); // Recharger la liste pour voir son message

    } catch (err) {
        console.error("Erreur envoi message:", err);
        showToast("Erreur lors de l'envoi du message", "error");
    } finally {
        // Remettre l'icône du bouton
        btn.innerHTML = originalIcon;
    }
}
async function loadChatMessages() {
    const container = document.getElementById('chat-messages');
    if (!container) return;

    const { data: authData } = await supabaseClient.auth.getUser();
    const user = authData?.user;
    if(!user) return;

    const { data: messages, error } = await supabaseClient
        .from('messages')
        .select('*')
        .order('created_at', { ascending: true })
        .limit(50);

    if (error) return console.error("Erreur chat:", error);
    if (container.querySelectorAll('.chat-row').length === messages.length) return;

    container.innerHTML = '<div class="text-center my-6"><span class="inline-block bg-indigo-50 text-indigo-600 text-[10px] font-bold uppercase tracking-wider px-3 py-1 rounded-full border border-indigo-100">Discussion en direct</span></div>';

    messages.forEach(msg => {
        const isMe = msg.user_id === user.id;
        const row = document.createElement('div');
        row.className = `chat-row ${isMe ? 'flex-row-reverse' : 'flex-row'}`;
        
        const time = new Date(msg.created_at).toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
        const name = isMe ? 'Moi' : (msg.user_email?.split('@')[0] || 'Anonyme');

        row.innerHTML = `
            <div class="chat-avatar shadow-md border-2 ${isMe ? 'border-indigo-100' : 'border-white'}">
                ${getAvatarHtml(msg.user_email, null, isMe)}
            </div>
            <div class="chat-content ${isMe ? 'items-end' : 'items-start'}">
                <div class="chat-header ${isMe ? 'flex-row-reverse text-indigo-100' : 'text-indigo-600'}">
                    <span>${name}</span>
                    <span class="opacity-60 font-normal">${time}</span>
                </div>
                <div class="chat-bubble ${isMe ? 'me' : 'other'} shadow-sm">
                    ${msg.content}
                </div>
            </div>`;
        container.appendChild(row);
    });

    container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
}

/* --- GESTION DES BADGES (ADMIN) --- */

async function loadAdminUsers() {
    const list = document.getElementById('admin-users-list');
    if (!list) return;

    const { data: profiles, error } = await supabaseClient
        .from('profiles')
        .select('*')
        .order('created_at', { ascending: false });

    if (error) {
        list.innerHTML = `<tr><td colspan="4">Erreur: ${error.message}</td></tr>`;
        return;
    }

    list.innerHTML = profiles.map(p => {
        const isCert = Boolean(p.is_certified);
        return `
        <tr class="hover:bg-slate-50 border-b border-slate-100">
            <td class="px-6 py-4 flex items-center gap-3">
                <div class="w-8 h-8 rounded-full overflow-hidden border shadow-sm">
                     ${p.avatar_url ? `<img src="${p.avatar_url}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center bg-slate-100 text-slate-400"><i class="fas fa-user text-xs"></i></div>`}
                </div>
                <span class="font-bold text-slate-900">${p.full_name || 'Sans nom'}</span>
            </td>
            <td class="px-6 py-4 text-slate-500 text-xs">${p.email || 'N/A'}</td>
            <td class="px-6 py-4 text-center">
                ${isCert ? '<span class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full text-xs font-bold"><i class="fas fa-check-circle"></i> Certifié</span>' : '<span class="text-slate-400 text-xs">Standard</span>'}
            </td>
            <td class="px-6 py-4 text-center">
                <button onclick="toggleUserBadge('${p.id}', ${isCert})" class="px-3 py-1 text-xs font-bold border rounded ${isCert ? 'text-red-600 border-red-200' : 'text-green-600 border-green-200'}">
                    ${isCert ? 'Révoquer' : 'Certifier'}
                </button>
            </td>
        </tr>`;
    }).join('');
}

async function toggleUserBadge(userId, currentStatus) {
    const newStatus = !currentStatus;
    const { error } = await supabaseClient.from('profiles').update({ is_certified: newStatus, certification_badge: newStatus ? 'Vérifié' : null }).eq('id', userId);

    if (error) {
        showToast("Erreur: " + error.message, "error");
    } else {
        showToast(newStatus ? "Utilisateur certifié !" : "Badge révoqué.", "success");
        loadAdminUsers();
    }
}

/* --- MISE À JOUR DU JS POUR LE NOUVEAU DESIGN --- */

/* --- CHARGEMENT PROFIL (OPTIMISÉ) --- */
async function loadSocialProfile(targetUserId = null) {
    try {
        const { data: { user: currentUser }, error: authError } = await supabaseClient.auth.getUser();
        if (authError || !currentUser) return;

        let profileId = targetUserId || currentUser.id;
        let isMyProfile = (profileId === currentUser.id);

        // 1. Charger le profil
        const { data: profile, error } = await supabaseClient
            .from('profiles')
            .select('*')
            .eq('id', profileId)
            .maybeSingle();

        if (error) throw error;

        if (!profile) {
            const container = document.querySelector('#profile-social-view .max-w-2xl'); 
            if (container) container.innerHTML = `<div class="text-center py-20"><h2 class="text-xl font-bold text-slate-900">Profil introuvable</h2></div>`;
            return;
        }

        // 2. Mise à jour du DOM de base
        const updateText = (id, text) => {
            const el = document.getElementById(id);
            if(el) el.textContent = text;
        };

        updateText('social-fullname', profile.full_name || 'Utilisateur');
        updateText('social-username', profile.username ? `@${profile.username}` : '@utilisateur');

        // 3. Stats (Optimisation : Lancement des deux requêtes en même temps)
        const [followersRes, followingRes] = await Promise.all([
            supabaseClient.from('follows').select('*', { count: 'exact', head: true }).eq('following_id', profileId),
            supabaseClient.from('follows').select('*', { count: 'exact', head: true }).eq('follower_id', profileId)
        ]);

        const formatNumber = (num) => num >= 1000 ? (num / 1000).toFixed(1) + 'K' : (num || 0);
        updateText('stat-followers', formatNumber(followersRes.count));
        updateText('stat-following', formatNumber(followingRes.count));

        // 4. Gestion des éléments UI
        const editBtn = document.querySelector('button[onclick="toggleProfile()"]');
        const logoutBtn = document.querySelector('button[onclick="confirmSocialLogout()"]');
        const followContainer = document.getElementById('profile-follow-container');

        if (isMyProfile) {
            if(editBtn) editBtn.style.display = 'inline-block';
            if(logoutBtn) logoutBtn.style.display = 'flex';
            if(followContainer) {
                followContainer.style.display = 'none';
                followContainer.innerHTML = ''; 
            }
            updateDockAvatar(profile.avatar_url);
        } else {
            if(editBtn) editBtn.style.display = 'none';
            if(logoutBtn) logoutBtn.style.display = 'none';
            
            if (followContainer) {
                followContainer.style.display = 'flex';
                followContainer.innerHTML = ''; // On vide pour laisser la fonction suivante remplir
                
                // Appel de ta fonction de création de boutons (Abonnement + Message)
                // Assure-toi que cette fonction utilise followContainer pour injecter le HTML
                await initFollowButtonOnProfile(profileId, currentUser.id); 
            }
        }

        // 5. Avatar principal (Correction fallback)
        const imgEl = document.getElementById('social-avatar');
        const placeholder = document.getElementById('social-avatar-placeholder');
        
        if (imgEl && placeholder) {
            if (profile.avatar_url) {
                imgEl.src = profile.avatar_url;
                imgEl.classList.remove('hidden');
                placeholder.classList.add('hidden');
            } else {
                imgEl.classList.add('hidden');
                placeholder.classList.remove('hidden');
                // Optionnel : Mettre une initiale dans le placeholder
                placeholder.innerText = (profile.full_name || 'U').charAt(0).toUpperCase();
            }
        }

        // 6. Badge de certification
        const badgeInline = document.getElementById('social-badge-inline');
        if(badgeInline) {
            profile.is_certified ? badgeInline.classList.remove('hidden') : badgeInline.classList.add('hidden');
        }

        // 7. Charger les posts du profil
        loadSocialPosts(profileId);

    } catch (err) {
        if (err.name !== 'AbortError') {
            console.error("Erreur profil social:", err);
    loadSocialPosts(userId);
        }
    }
}

async function initFollowButtonOnProfile(targetUserId, myId) {
    const container = document.getElementById('profile-follow-container');
    if (!container) return;

    // 1. Sécurité : On définit cleanMyId proprement
    let cleanMyId = (typeof myId === 'object' && myId !== null) ? myId.id : myId;
    
    // Si cleanMyId est toujours invalide, on le récupère via la session
    if (!cleanMyId || typeof cleanMyId !== 'string') {
        const { data: { user } } = await supabaseClient.auth.getUser();
        cleanMyId = user?.id;
    }

    if (!cleanMyId || !targetUserId) return;

    try {
        // 2. Vérification de l'abonnement
        const { data: followCheck } = await supabaseClient
            .from('follows')
            .select('*')
            .eq('follower_id', cleanMyId)
            .eq('following_id', targetUserId)
            .maybeSingle();

        const isFollowing = !!followCheck;

        // 3. Rendu HTML (Bouton Follow + Bouton Message)
        container.style.display = 'flex';
        container.className = "flex items-center gap-2 w-full mt-4";
        
        container.innerHTML = `
            <button id="main-follow-btn" 
                onclick="toggleFollow('${targetUserId}', this)" 
                class="flex-1 text-xs font-bold px-6 py-2.5 rounded-full transition-all active:scale-95 ${
                    isFollowing 
                    ? 'bg-slate-100 text-slate-600 border border-slate-200' 
                    : 'bg-blue-600 text-white shadow-md hover:bg-blue-700'
                }">
                ${isFollowing ? 'Abonné' : 'S\'abonner'}
            </button>
            
            <button onclick="startChat('${targetUserId}')" 
                class="w-10 h-10 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center hover:bg-indigo-100 transition-all active:scale-90 shadow-sm border border-indigo-100">
                <i class="fas fa-comment-dots"></i>
            </button>
        `;
    } catch (err) {
        console.error("Erreur initFollowButton:", err);
    }
}

// 3. Chargement des Photos (Grille 3 colonnes)
async function loadSocialPosts(userId) {
    const grid = document.getElementById('social-posts-grid');
    try {
        const { data: posts, error } = await supabaseClient
            .from('posts')
            .select('*')
            .eq('user_id', userId)
            .order('created_at', { ascending: false });

        if (error) throw error;

        if (!posts || posts.length === 0) {
            grid.innerHTML = `
                <div class="col-span-3 flex flex-col items-center justify-center py-20 text-gray-400">
                    <i class="fas fa-camera text-3xl mb-2"></i>
                    <p class="text-xs">Aucune publication</p>
                </div>`;
            return;
        }

        // Génération HTML pour la grille (carrés parfaits)
        grid.innerHTML = posts.map(post => `
            <div class="aspect-square bg-gray-200 relative group cursor-pointer overflow-hidden">
                <img src="${post.image_url}" decoding="async" class="w-full h-full object-cover" loading="lazy">
                <!-- Overlay au survol (optionnel, style Instagram) -->
                <div class="absolute inset-0 bg-black/30 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2 text-white text-xs font-bold">
                    <span class="flex items-center gap-1"><i class="fas fa-heart"></i> 0</span>
                </div>
            </div>
        `).join('');

    } catch (err) {
        console.error("Erreur posts:", err);
    }
}

// 4. Gestion de la Modale de Publication
function openNewPostModal() { 
    // Afficher la modale
    const modal = document.getElementById('new-post-modal');
    if (modal) modal.classList.remove('hidden'); 

    // NOUVEAU : Cacher le Dock mobile pour libérer l'espace
    const dock = document.querySelector('.mobile-dock');
    if (dock) dock.classList.add('nav-hidden');
}

function closeNewPostModal() { 
    // Cacher la modale
    const modal = document.getElementById('new-post-modal');
    if (modal) modal.classList.add('hidden'); 

    // NOUVEAU : Réafficher le Dock mobile
    const dock = document.querySelector('.mobile-dock');
    if (dock) dock.classList.remove('nav-hidden');
}


        
// --- GESTION DU TYPE DE POST (IMAGE / SHORT) ---

let currentPostFile = null; // Stocke le fichier (image ou vidéo)

function setPostType(type) {
    const imgBox = document.getElementById('upload-image-box');
    const vidBox = document.getElementById('upload-video-box');
    const btnImg = document.getElementById('btn-type-image');
    const btnVid = document.getElementById('btn-type-short');
    const hiddenInput = document.getElementById('current-post-type');

    hiddenInput.value = type;
    currentPostFile = null; // Reset file
    resetPreview();

    if (type === 'image') {
        imgBox.classList.remove('hidden');
        vidBox.classList.add('hidden');
        btnImg.className = "flex-1 py-2 text-xs font-bold rounded-md bg-white shadow-sm text-slate-900 transition";
        btnVid.className = "flex-1 py-2 text-xs font-bold rounded-md text-slate-500 hover:text-slate-900 transition";
    } else {
        imgBox.classList.add('hidden');
        vidBox.classList.remove('hidden');
        btnImg.className = "flex-1 py-2 text-xs font-bold rounded-md text-slate-500 hover:text-slate-900 transition";
        btnVid.className = "flex-1 py-2 text-xs font-bold rounded-md bg-pink-50 shadow-sm text-pink-600 transition";
    }
}

function previewFile(input, type) {
    const file = input.files[0];
    if (!file) return;
    
    const errorMsg = document.getElementById('video-error-msg');
    const previewArea = document.getElementById('preview-area');
    const imgEl = document.getElementById('preview-img-el');
    const vidEl = document.getElementById('preview-video-el');

    errorMsg.classList.add('hidden');
    currentPostFile = file;
    previewArea.classList.remove('hidden');

    if (type === 'image') {
        const reader = new FileReader();
        reader.onload = (e) => {
            imgEl.src = e.target.result;
            imgEl.classList.remove('hidden');
            vidEl.classList.add('hidden');
        };
        reader.readAsDataURL(file);
    } else {
        // LOGIQUE VIDÉO : Vérifier la durée MAX 10 MIN
        const videoURL = URL.createObjectURL(file);
        vidEl.src = videoURL;
        
        vidEl.onloadedmetadata = function() {
            if (this.duration > 600) { // 600 secondes = 10 minutes
                errorMsg.innerText = "Erreur : La vidéo dépasse 10 minutes !";
                errorMsg.classList.remove('hidden');
                input.value = ""; // Reset
                currentPostFile = null;
                previewArea.classList.add('hidden');
            } else {
                // Durée OK
                vidEl.classList.remove('hidden');
                imgEl.classList.add('hidden');
            }
        };
    }
}

function resetPreview() {
    document.getElementById('preview-area').classList.add('hidden');
    document.getElementById('preview-img-el').src = '';
    document.getElementById('preview-video-el').src = '';
}// <--- C'est cette accolade qui ferme la fonction

        async function filterFeed(filter) {
    // Mise à jour visuelle des boutons
    const btnRecent = document.getElementById('btn-sort-recent');
    const btnPopular = document.getElementById('btn-sort-popular');
    const btnShorts = document.getElementById('btn-filter-shorts');

    // Reset classes
    [btnRecent, btnPopular, btnShorts].forEach(btn => {
        btn.className = "text-sm font-bold pb-2 px-2 border-b-2 border-transparent text-slate-400 hover:text-slate-600 transition-colors whitespace-nowrap";
    });

    // Active class pour le bouton cliqué
    if (filter === 'shorts') {
        btnShorts.className = "text-sm font-bold pb-2 px-2 border-b-2 border-pink-600 text-pink-600 transition-colors whitespace-nowrap flex items-center gap-1";
    } else if (filter === 'recent') {
        btnRecent.className = "text-sm font-bold pb-2 px-2 border-b-2 border-indigo-600 text-indigo-600 transition-colors whitespace-nowrap";
    } else if (filter === 'popular') {
        btnPopular.className = "text-sm font-bold pb-2 px-2 border-b-2 border-indigo-600 text-indigo-600 transition-colors whitespace-nowrap flex items-center gap-1";
    }

    // Charger le feed avec le filtre
    loadGlobalFeed('recent', filter);
}

        /* --- FONCTION DÉCONNEXION SOCIALE --- */
function confirmSocialLogout() {
    // 1. Demander confirmation
    if (confirm("Voulez-vous vraiment vous déconnecter ?")) {
        
        // 2. Appeler Supabase pour déconnecter
        supabaseClient.auth.signOut().then(({ error }) => {
            if (error) {
                console.error("Erreur déconnexion:", error.message);
                showToast("Erreur lors de la déconnexion", "error");
            } else {
                // 3. Rediriger vers la page de login
                showToast("Déconnexion !", "success");
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1000);
            }
        });
    }
}

        /* --- ALGORITHME DE TRI DES POSTS --- */

// Fonction pour calculer le score d'un post
function calculatePostScore(likes, comments, createdAt) {
    // 1. Score d'engagement (1 Like = 10pts, 1 Comment = 5pts)
    const engagementScore = (likes * 10) + (comments * 5);
    
    // 2. Calcul du temps écoulé (en heures)
    const now = new Date();
    const postDate = new Date(createdAt);
    const diffTime = Math.abs(now - postDate);
    const diffHours = diffTime / (1000 * 60 * 60);

    // 3. Formule de désintégration temporelle (Gravity)
    // Plus diffHours est grand, plus le dénominateur est grand, donc le score baisse.
    const gravity = 1.8;
    const timeDecay = Math.pow(diffHours + 2, gravity);

    // 4. Score final
    return engagementScore / timeDecay;
}

// Fonction de tri principal
// Fonction pour le TRI (Tendances)
function sortFeed(type) {
    // Mise à jour visuelle des boutons
    const btnRecent = document.getElementById('btn-sort-recent');
    const btnPopular = document.getElementById('btn-sort-popular');

    // Reset des styles
    if(btnRecent) { btnRecent.className = "text-sm font-bold pb-2 px-2 border-b-2 border-transparent text-slate-400 hover:text-slate-600 transition-colors whitespace-nowrap"; }
    if(btnPopular) { btnPopular.className = "text-sm font-bold pb-2 px-2 border-b-2 border-transparent text-slate-400 hover:text-slate-600 transition-colors whitespace-nowrap"; }

    // Activation du style du bouton cliqué
    if (type === 'popular') {
        if(btnPopular) btnPopular.className = "text-sm font-bold pb-2 px-2 border-b-2 border-indigo-600 text-indigo-600 transition-colors whitespace-nowrap flex items-center gap-1";
    } else {
        if(btnRecent) btnRecent.className = "text-sm font-bold pb-2 px-2 border-b-2 border-indigo-600 text-indigo-600 transition-colors whitespace-nowrap";
    }

    // --- LOGIQUE DE CHARGEMENT ---
    // Si on clique sur Tendances, on trie par popularité
    // Sinon on trie par Récent
    const sortMode = (type === 'popular') ? 'popular' : 'recent';
    
    // On recharge le feed avec le tri voulu (appendMode = false pour reset)
    loadGlobalFeed(sortMode, 'all', false);
}

// Fonction pour le FILTRE (Shorts)
function filterFeed(filterType) {
    const btnShorts = document.getElementById('btn-filter-shorts');
    
    // Reset style bouton Shorts
    if(btnShorts) btnShorts.className = "text-sm font-bold pb-2 px-2 border-b-2 border-transparent text-slate-400 hover:text-pink-600 transition-colors whitespace-nowrap flex items-center gap-1";

    // Activation style
    if (filterType === 'shorts') {
        if(btnShorts) btnShorts.className = "text-sm font-bold pb-2 px-2 border-b-2 border-pink-600 text-pink-600 transition-colors whitespace-nowrap flex items-center gap-1";
        
        // --- LOGIQUE DE CHARGEMENT ---
        // On charge le feed en filtrant uniquement les vidéos
        loadGlobalFeed('recent', 'shorts', false);
    }
}
        

/**
/**
 * CHARGEMENT DU FLUX GLOBAL (VERSION ULTRA PRO)
 */
async function loadGlobalFeed(sortBy = 'recent', filterType = 'all', appendMode = false) {
    const container = document.getElementById('global-feed-container');
    const loader = document.getElementById('feed-loader');
    if (!container) return;

    // Si ce n'est pas un mode "ajout" (c'est un reset/filtrage), on vide et on réinitialise
    if (!appendMode) {
        container.innerHTML = `<div class="flex justify-center py-12"><i class="fas fa-circle-notch animate-spin text-3xl text-indigo-600 opacity-20"></i></div>`;
        feedOffset = 0;           // On repart de 0
        hasMorePosts = true;      // On sait qu'il y a des posts
        // On recharge l'observateur si nécessaire (voir étape 5)
    } else {
        // Si on charge la suite, on affiche le petit loader en bas
        if (loader) loader.classList.remove('hidden');
    }

    // État de chargement
    if (appendMode) isLoadingFeed = true;

    try {
        // --- 1. CONTEXTE UTILISATEUR ---
        const { data: userData } = await supabaseClient.auth.getUser();
        const myId = userData?.user?.id || null;

        // --- 2. ABONNEMENTS ---
        let myFollowingSet = new Set();
        if (myId) {
            const { data: followingData } = await supabaseClient
                .from('follows')
                .select('following_id')
                .eq('follower_id', myId);
            if (followingData) myFollowingSet = new Set(followingData.map(f => f.following_id));
        }

        // --- 3. CHARGEMENT DES POSTS AVEC PAGINATION ---
        // On utilise .range(from, to) au lieu de .limit()
        // feedOffset est la variable globale que nous incrémenterons
        const { data: posts, error } = await supabaseClient
            .from('posts')
            .select(`
                *,
                profiles ( id, full_name, username, avatar_url, is_certified ),
                post_likes(count),
                post_comments(count)
            `)
            .order('created_at', { ascending: false })
            .range(feedOffset, feedOffset + FEED_BATCH_SIZE - 1); // Charge 10 posts à partir de l'offset

        if (error) throw error;

        if (!posts || posts.length === 0) {
            if (!appendMode) {
                container.innerHTML = `<div class="text-center py-20 text-slate-400"><i class="fas fa-newspaper text-4xl mb-3 opacity-20"></i><p>Aucune publication pour le moment.</p></div>`;
            } else {
                hasMorePosts = false; // Plus de posts
                if (loader) loader.classList.add('hidden'); // Cacher le loader
            }
            return;
        }

        // --- 4. LIKES (Optimisation) ---
        let myLikedPostIds = new Set();
        if (myId && posts.length > 0) {
            const postIds = posts.map(p => p.id);
            const { data: myLikes } = await supabaseClient
                .from('post_likes')
                .select('post_id')
                .eq('user_id', myId)
                .in('post_id', postIds);
            if (myLikes) myLikedPostIds = new Set(myLikes.map(l => l.post_id));
        }

        // --- 5. FILTRAGE & TRI ---
        let processedPosts = filterType === 'shorts' ? posts.filter(p => p.is_short) : posts;

        if (sortBy === 'popular' && typeof calculatePostScore === 'function') {
            processedPosts = processedPosts.map(post => ({
                ...post,
                calculatedScore: calculatePostScore(post.post_likes?.[0]?.count || 0, post.post_comments?.[0]?.count || 0, post.created_at)
            })).sort((a, b) => b.calculatedScore - a.calculatedScore);
        }

        // --- 6. GÉNÉRATION HTML ---
        const htmlString = processedPosts.map(post => {
    const profile = post.profiles || {};
    const avatarUrl = profile.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${profile.username || 'user'}`; 
    const userName = profile.full_name || 'Utilisateur';
    const isCertified = profile.is_certified;
    const timeAgo = typeof getTimeAgo === 'function' ? getTimeAgo(new Date(post.created_at)) : 'Récemment';
    
    const likeCount = post.post_likes?.[0]?.count || 0;
    const commentCount = post.post_comments?.[0]?.count || 0;
    const isLiked = myLikedPostIds.has(post.id);
    const isMyPost = (post.user_id === myId);

    let followBtn = '';
    if (!isMyPost && myId) {
        const isFollowing = myFollowingSet.has(post.user_id);
        followBtn = `
            <button onclick="toggleFollow('${post.user_id}', this)" 
                    class="text-xs font-bold px-4 py-1.5 rounded-full transition-all ${isFollowing ? 'border border-slate-200 text-slate-500' : 'bg-indigo-600 text-white hover:bg-indigo-700 shadow-sm'}">
                ${isFollowing ? 'Abonné' : 'Suivre'}
            </button>`;
    }

    let mediaHtml = '';
    if (post.is_short && post.video_url) {
        mediaHtml = `
            <div class="relative bg-black flex justify-center overflow-hidden group rounded-2xl mb-4">
                <video src="${post.video_url}" class="w-full max-h-[600px] object-contain" loop muted playsinline onclick="this.paused ? this.play() : this.pause()"></video>
                <div class="absolute bottom-4 right-4 bg-black/50 p-2 rounded-full text-white pointer-events-none opacity-0 group-hover:opacity-100 transition">
                    <i class="fas fa-play text-xs"></i>
                </div>
            </div>`;
    } else if (post.image_url) {
        mediaHtml = `<img src="${post.image_url}" class="w-full h-auto object-cover rounded-2xl" loading="lazy" alt="Post">`;
    }

    return `
    <article class="bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-800 rounded-3xl overflow-hidden mb-6 transition-all hover:shadow-xl hover:shadow-indigo-500/5">
        
        <!-- 1. EN-TÊTE (Avatar + Nom) -->
        <div class="p-4 flex items-center justify-between">
            <div class="flex items-center gap-3 cursor-pointer" onclick="viewUserProfile('${post.user_id}')">
                <img src="${avatarUrl}" class="w-11 h-11 rounded-full border-2 border-indigo-50 shadow-sm">
                <div>
                    <div class="flex items-center gap-1 font-bold text-sm text-slate-900 dark:text-white">
                        ${userName} 
                        ${isCertified ? '<i class="fas fa-check-circle text-blue-500 text-[10px]"></i>' : ''}
                    </div>
                    <div class="text-[11px] text-slate-400 font-medium">${timeAgo}</div>
                </div>
            </div>
            ${followBtn}
        </div>

        <!-- 2. TEXTE (Légende) - DÉPLACÉ ICI (Au-dessus de l'image) -->
        <div class="px-4 pb-2">
            ${post.caption ? `
                <p class="text-sm text-slate-700 dark:text-slate-300 leading-relaxed line-clamp-3">
                    <span class="font-extrabold mr-2 text-slate-900 dark:text-white">${userName}</span>${post.caption}
                </p>
            ` : ''}
        </div>

        <!-- 3. MÉDIA (Image/Vidéo) - DÉPLACÉ ICI (En dessous du texte) -->
        ${mediaHtml}
        
        <!-- 4. BOUTONS D'ACTION -->
        <div class="px-4 pb-3 pt-3">
            <div class="flex items-center gap-5">
                <button onclick="toggleLike('${post.id}', this)" class="flex items-center gap-1.5 group">
                    <i id="icon-like-${post.id}" class="${isLiked ? 'fas fa-heart text-red-500' : 'far fa-heart text-slate-400'} text-xl group-active:scale-125 transition-transform"></i>
                    <span id="count-like-${post.id}" data-raw-count="${likeCount}" class="text-xs font-bold ${isLiked ? 'text-slate-900' : 'text-slate-500'}">
                        ${formatNumber(likeCount)}
                    </span>
                </button>

                <button onclick="toggleCommentSection('${post.id}')" class="flex items-center gap-1.5 group">
                    <i class="fas fa-comment-dots text-slate-400 text-xl group-hover:text-indigo-500 transition-colors"></i>
                    <span id="count-comment-${post.id}" class="text-xs font-bold text-slate-500">
                        ${formatNumber(commentCount)}
                    </span>
                </button>

                <button onclick="sharePost('${post.id}')" class="ml-auto text-slate-400 hover:text-indigo-600 transition-colors">
                    <i class="fas fa-arrows-rotate text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Section Commentaires -->
        <div id="comments-${post.id}" class="hidden p-4 border-t border-slate-50 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-800/50">
            <div id="comment-list-${post.id}" class="space-y-3 mb-4 max-h-48 overflow-y-auto no-scrollbar"></div>
            <form onsubmit="submitComment(event, '${post.id}')" class="relative">
                <input type="text" name="content" placeholder="Ajouter un commentaire..." class="w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-full px-4 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all">
                <button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 text-indigo-600 font-bold text-xs px-2">Publier</button>
            </form>
        </div>
    </article>`;
}).join('');

        // --- 7. INJECTION HTML ---
        if (!appendMode) {
            // Premier chargement : on remplace tout le conteneur
            container.innerHTML = htmlString;
        } else {
            // Chargement infini : on AJOUTE à la fin (avant le loader)
            container.insertAdjacentHTML('beforeend', htmlString);
        }

        // --- 8. MISE À JOUR OFFSET ---
        feedOffset += posts.length;
        
        // Si on a reçu moins que la taille du batch, c'est qu'on a fini
        if (posts.length < FEED_BATCH_SIZE) {
            hasMorePosts = false;
            if (loader) loader.classList.add('hidden');
        }

    } catch (error) {
        if (error.name !== 'AbortError') {
            console.error("Erreur Feed:", error);
            if (!appendMode) {
                container.innerHTML = `<div class="p-8 text-center bg-red-50 text-red-600 rounded-2xl"><i class="fas fa-exclamation-triangle mb-2 text-xl"></i><p class="text-sm font-bold">Verifier votre connexion</p></div>`;
            }
        }
    } finally {
        isLoadingFeed = false;
        if (loader && !hasMorePosts) loader.classList.add('hidden');
        else if (loader) loader.classList.remove('hidden');
    }
}

        // Fonction déclenchée par l'observateur quand on arrive en bas
async function loadMoreFeed() {
    if (isLoadingFeed || !hasMorePosts) return;
    
    // On réutilise les filtres actuels (ou 'recent' par défaut)
    // On passe 'true' pour le mode append (ajout)
    await loadGlobalFeed('recent', 'all', true);
}
        
function initVideoObserver() {
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            const video = entry.target;
            if (entry.isIntersecting) {
                if (!video.src && video.dataset.src) video.src = video.dataset.src;
                video.play().catch(() => {});
            } else {
                video.pause();
            }
        });
    }, { threshold: 0.6 });

    document.querySelectorAll('.lazy-video').forEach(v => observer.observe(v));
}

function toggleCommentSection(postId) {
    const commentSection = document.getElementById(`comments-${postId}`);
    
    if (commentSection) {
        // On bascule la classe 'hidden' pour afficher ou cacher la section
        commentSection.classList.toggle('hidden');
        
        // Petit bonus : si on ouvre la section, on scrolle doucement vers elle
        if (!commentSection.classList.contains('hidden')) {
            commentSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }
}
        
        /* --- ACTIONS : LIKE, COMMENT, SHARE --- */

// 1. Gérer le Like
// 1. LIKE : Optimisé et robuste
// 1. Gérer le Like
// Variable pour empêcher le spamming de clics
const likeLocks = new Set();

async function toggleLike(postId, btnElement) {
    // Si une requête est déjà en cours pour ce post, on ignore le clic
    if (likeLocks.has(postId)) return;

    const icon = document.getElementById(`icon-like-${postId}`);
    const countSpan = document.getElementById(`count-like-${postId}`);
    if (!icon || !countSpan) return;

    try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
            showToast("Connectez-vous pour liker", "warning");
            return;
        }

        likeLocks.add(postId); // On verrouille

        // 1. État actuel
        const isCurrentlyLiked = icon.classList.contains('fas');
        
        // 2. Extraction du nombre actuel (on nettoie tout sauf les chiffres)
        // Note: Pour être précis à 100%, il vaudrait mieux stocker le nombre pur 
        // dans un attribut data-count="${likeCount}" sur le span.
        let currentCount = parseInt(countSpan.getAttribute('data-raw-count') || countSpan.innerText.replace(/\D/g,'')) || 0;

        // 3. UI Optimiste : Mise à jour visuelle immédiate
        if (isCurrentlyLiked) {
            icon.classList.replace('fas', 'far');
            icon.classList.remove('text-red-500', 'animate-heart-pop');
            currentCount = Math.max(0, currentCount - 1);
        } else {
            icon.classList.replace('far', 'fas');
            icon.classList.add('text-red-500', 'animate-heart-pop'); // Petite animation CSS
            currentCount += 1;
        }
        
        countSpan.innerText = formatNumber(currentCount);
        countSpan.setAttribute('data-raw-count', currentCount);

        // 4. Action Base de données
        if (isCurrentlyLiked) {
            const { error } = await supabaseClient
                .from('post_likes')
                .delete()
                .match({ post_id: postId, user_id: user.id });
            if (error) throw error;
        } else {
            const { error } = await supabaseClient
                .from('post_likes')
                .insert([{ post_id: postId, user_id: user.id }]);
            if (error) throw error;
        }

    } catch (err) {
        console.error("Erreur Like:", err);
        // Rollback : On remet l'état précédent si ça échoue
        const icon = document.getElementById(`icon-like-${postId}`);
        if (icon) {
            icon.classList.toggle('fas');
            icon.classList.toggle('far');
            icon.classList.toggle('text-red-500');
        }
        showToast("Échec de la mise à jour du like", "danger");
    } finally {
        likeLocks.delete(postId); // On déverrouille quoi qu'il arrive
    }
}

// 2. COMMENTAIRE : Corrigé
async function submitComment(e, postId) {
    e.preventDefault();
    const form = e.target;
    const content = form.content.value.trim();
    const listElement = document.getElementById(`comment-list-${postId}`);
    const countSpan = document.getElementById(`count-comment-${postId}`);

    if (!content) return;

    const { data: { user } } = await supabaseClient.auth.getUser();

    const { error } = await supabaseClient
        .from('post_comments')
        .insert([{ user_id: user.id, post_id: postId, content: content }]);

    if (!error) {
        // Ajout visuel
        const newComment = document.createElement('div');
        newComment.className = 'text-sm animate-fade-in'; // Petite animation si tu as le CSS
        newComment.innerHTML = `<span class="font-bold text-indigo-700">Vous</span> <span class="text-slate-600">${content}</span>`;
        listElement.appendChild(newComment);
        form.reset();
        
        // Mise à jour du compteur
        let rawText = countSpan.innerText.toUpperCase().replace(',', '.');
        let currentCount = rawText.includes('K') ? parseFloat(rawText) * 1000 : parseInt(rawText);
        countSpan.innerText = formatNumber(currentCount + 1);
    } else {
        console.error("Erreur Commentaire:", error);
    }
}
        // AVANT : function ajouterCommentaire() {
// APRÈS :
async function ajouterCommentaire(postId, content) {
    
    // Maintenant 'await' est autorisé ici
    const { data: postData, error: postError } = await supabaseClient
        .from('posts')
        .select('user_id')
        .eq('id', postId)
        .single();

    if (postData?.user_id && !postError) {
        sendNotification(postData.user_id, 'comment', postId, content);
    }
}

// 3. FONCTION FORMATNUMBER (Indispensable pour que le code ci-dessus fonctionne)
function formatNumber(num) {
    // Si la donnée est vide, null ou undefined, on affiche 0
    if (num === undefined || num === null) return '0';
    
    if (num >= 1000) {
        return (num / 1000).toFixed(1).replace('.0', '') + 'K';
    }
    return num.toString();
}
// 5. Partager (Simulation)
function sharePost(postId) {
    // Récupérer l'URL actuelle
    const url = window.location.href.split('#')[0] + '?post=' + postId;
    
    if (navigator.share) {
        navigator.share({
            title: 'Regarde cette publication sur Printbam',
            url: url,
        }).catch(console.error);
    } else {
        // Fallback : copier dans le presse-papier
        navigator.clipboard.writeText(url);
        showToast("Lien copié !", "success");
    }
}

// Fonction utilitaire pour le temps relatif (ex: 2h)
function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    let interval = seconds / 31536000;
    if (interval > 1) return Math.floor(interval) + " an";
    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + " mois";
    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + " j";
    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + " h";
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + " min";
    return "À l'instant";
}
        // Fonction pour formater 1200 en "1.2K"
function formatNumber(num) {
    if (!num) return '0';
    return num >= 1000 ? (num / 1000).toFixed(1) + 'K' : num;
}
       /* --- SYSTÈME D'ABONNEMENT (CORRIGÉ POUR ERREUR 409) --- */

/* --- SYSTÈME D'ABONNEMENT (VERSION FINALE) --- */

async function toggleFollow(targetUserId, btnElement) {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return showToast("Connectez-vous", "error");
    if (user.id === targetUserId) return;

    // On vérifie l'état actuel grâce à la classe CSS 'following'
    const isFollowing = btnElement.classList.contains('following');

    try {
        if (isFollowing) {
            // --- ACTION : SE DÉSABONNER ---
            const { error } = await supabaseClient
                .from('follows')
                .delete()
                .eq('follower_id', user.id)
                .eq('following_id', targetUserId);
            
            if (!error) {
                updateFollowButton(btnElement, false); // Repasse en "S'abonner"
                showToast("Désabonné", "success");
            }

        } else {
            // --- ACTION : S'ABONNER ---
            const { error } = await supabaseClient
                .from('follows')
                .insert([{ follower_id: user.id, following_id: targetUserId }]);

            if (error) {
                // Si erreur "Déjà abonné", on synchronise l'affichage
                if (error.code === '23505' || error.status === 409) {
                    updateFollowButton(btnElement, true); // Force l'état "Abonné"
                } else {
                    throw error;
                }
            } else {
                updateFollowButton(btnElement, true); // Passe en "Abonné"
                showToast("Abonné !", "success");
            }
        }
        
        // Rafraîchir les chiffres du profil
        loadSocialProfile(); 

    } catch (err) {
        console.error("Erreur:", err);
        showToast("Erreur", "error");
    }
}

// Fonction de mise à jour visuelle
function updateFollowButton(btn, isFollowing) {
    if (isFollowing) {
        // ÉTAT : ABONNÉ (Gris)
        btn.innerText = "Abonné";
        // On ajoute la classe 'following' pour que le bouton sache qu'il est actif
        btn.classList.add('following');
        btn.className = "text-xs font-bold px-4 py-1.5 rounded-full border border-gray-300 text-gray-600 bg-gray-100 transition following";
    } else {
        // ÉTAT : S'ABONNER (Bleu)
        btn.innerText = "S'abonner";
        // On retire la classe
        btn.classList.remove('following');
        btn.className = "text-xs font-bold px-4 py-1.5 rounded-full bg-blue-600 text-white hover:bg-blue-700 transition shadow";
    }
}

function resetProfileUI() {
    // On cible le conteneur blanc principal à l'intérieur de #profile-social-view
    const profileContainer = document.querySelector('#profile-social-view > div');
    
    if (profileContainer) {
        // On injecte le code HTML du Skeleton (L'animation CSS va faire le reste)
        profileContainer.innerHTML = getProfileSkeletonHTML();
    }
}

function getProfileSkeletonHTML() {
    return `
    <!-- CONTENEUR PRINCIPAL BLANC -->
    <div class="bg-white min-h-screen max-w-lg mx-auto shadow-sm relative z-20 pb-20">
        
        <!-- HEADER -->
        <div class="p-5 flex items-start gap-5 border-b border-gray-100">
            
            <!-- 1. AVATAR (Doit avoir l'ID 'social-avatar') -->
            <div class="relative">
                <div class="w-20 h-20 md:w-24 md:h-24 rounded-full border border-gray-200 p-1 bg-white">
                    <!-- On met l'ID sur l'image, le placeholder sera caché après -->
                    <img id="social-avatar" src="" alt="Profile" class="w-full h-full object-cover rounded-full hidden">
                    
                    <!-- Le placeholder affiché par défaut -->
                    <div id="social-avatar-placeholder" class="w-full h-full bg-gray-200 rounded-full flex items-center justify-center text-gray-300">
                        <!-- On met une fausse image animée dedans pour le loader -->
                        <div class="w-full h-full bg-gray-200 skeleton skeleton-avatar"></div>
                    </div>
                </div>
            </div>

            <!-- 2. INFOS PRINCIPALES (Doit avoir l'ID 'social-fullname') -->
            <div class="flex-1 pt-1">
                <div class="flex items-center gap-1 mb-1">
                    <!-- IMPORTANT : id="social-fullname" -->
                    <!-- On met le texte gris animé dans la balise H1 pour qu'il soit remplacé par le vrai nom -->
                    <h1 id="social-fullname" class="text-xl font-bold text-black leading-none opacity-50">
                        <div class="skeleton skeleton-text short" style="height: 20px; width: 140px; display: block;"></div>
                    </h1>
                    
                    <span id="social-badge-inline" class="hidden ml-1">
                        <!-- Contenu vide, il sera caché de toute façon -->
                    </span>
                </div>
                
                <!-- Stats (Doivent avoir les IDs 'stat-following' et 'stat-followers') -->
                <div class="text-sm text-gray-600 font-medium mb-2">
                    <span id="stat-following">
                         <div class="skeleton skeleton-text medium" style="display:inline-block; width: 20px;"></div>
                    </span> suivis • 
                    <span id="stat-followers">
                         <div class="skeleton skeleton-text medium" style="display:inline-block; width: 20px;"></div>
                    </span> abonnés
                </div>
                
                <!-- Bouton Modifier -->
                <button class="px-3 py-1 bg-gray-100 text-xs font-bold text-gray-700 rounded hover:bg-gray-200 transition skeleton-btn"></button>
                
                <!-- Conteneur Follow -->
                <div id="profile-follow-container" class="hidden"></div>
            </div>
        </div>

        <!-- SECTION INFOS (Doivent avoir les IDs 'social-phone', 'social-username', 'social-dob') -->
        <div class="bg-gray-50 px-5 py-4 space-y-3 border-b border-gray-200">
            <!-- Téléphone -->
            <div class="flex items-center gap-3">
                <div class="skeleton skeleton-avatar" style="width: 16px; height: 16px;"></div>
                <span id="social-phone" class="text-sm text-gray-700 font-medium">
                     <div class="skeleton skeleton-text long"></div>
                </span>
            </div>
            <!-- Username -->
            <div class="flex items-center gap-3">
                <div class="skeleton skeleton-avatar" style="width: 16px; height: 16px;"></div>
                <span id="social-username" class="text-sm text-gray-700 font-medium">
                     <div class="skeleton skeleton-text medium"></div>
                </span>
            </div>
            <!-- Date de naissance -->
            <div class="flex items-center gap-3">
                <div class="skeleton skeleton-avatar" style="width: 16px; height: 16px;"></div>
                <span id="social-dob" class="text-sm text-gray-700 font-medium">
                     <div class="skeleton skeleton-text short"></div>
                </span>
            </div>
        </div>

        <!-- ONGLETS -->
        <div class="flex border-b border-gray-200">
            <button onclick="switchSocialTab('publications')" class="social-tab-btn flex-1 py-4 text-sm font-bold text-black border-b-2 border-black transition-colors">
                Publications
            </button>
            <button onclick="switchSocialTab('archives')" class="social-tab-btn flex-1 py-4 text-sm font-bold text-gray-400 border-b-2 border-transparent hover:text-gray-600 transition-colors">
                Publications archivées
            </button>
        </div>

        <!-- GRILLE DES PHOTOS (Doit avoir l'ID 'social-posts-grid') -->
        <div id="social-posts-grid" class="grid grid-cols-3 gap-1 bg-gray-100">
             <!-- 6 Blocs animés -->
             ${Array(6).fill(0).map(() => `
                <div class="aspect-square bg-gray-200 skeleton"></div>
             `).join('')}
        </div>

        <!-- BOUTON AJOUTER FLOTTANT -->
        <button class="fixed bottom-6 right-6 md:absolute md:bottom-6 md:right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-blue-700 transition-all z-50 skeleton" style="border-radius: 50%; width: 56px; height: 56px;">
            <div style="width: 20px; height: 20px; background: rgba(255,255,255,0.4); border-radius: 50%;"></div>
        </button>

    </div>
    `;
}
        
        /* --- NAVIGATION VERS UN AUTRE PROFIL --- */
function viewUserProfile(userId) {
    // 1. On change de vue
    switchPage('profile-social');
    
    // 2. RESET IMMÉDIAT (C'est ça qui efface votre profil avant qu'il ne s'affiche)
    resetProfileUI();
    
    // 3. On charge les données de CET utilisateur
    loadSocialProfile(userId);
}
        /* --- SYSTÈME DE MESSAGERIE --- */

let currentChatId = null;
let currentTargetUserId = null;
let lastMessageCount = 0; // Pour éviter le clignotement au rechargement

// 1. Démarrer une conversation
async function startChat(targetUserId) {
    if (!targetUserId) return;
    
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user || user.id === targetUserId) return;

    showToast("Ouverture de la discussion...", "success");

    try {
        // Correction : .maybeSingle() au lieu de .single()
        const { data: existingChat } = await supabaseClient
            .from('chats')
            .select('*')
            .or(`and(user_1_id.eq.${user.id},user_2_id.eq.${targetUserId}),and(user_1_id.eq.${targetUserId},user_2_id.eq.${user.id})`)
            .maybeSingle();

        let chatId;

        if (existingChat) {
            chatId = existingChat.id;
        } else {
            const { data: newChat, error } = await supabaseClient
                .from('chats')
                .insert([{
                    user_1_id: user.id,
                    user_2_id: targetUserId
                }])
                .select()
                .single();
            
            if (error) throw error;
            chatId = newChat.id;
        }

        openChatRoom(chatId, targetUserId);

    } catch (err) {
        console.error("Erreur startChat:", err);
        showToast("Erreur de connexion", "error");
    }
}

// 2. Charger la liste des discussions
async function loadChatList() {
    const container = document.getElementById('chat-list-container');
    if (!container) return;

    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return;

    try {
        const { data: chats, error } = await supabaseClient
            .from('chats')
            .select(`
                id, user_1_id, user_2_id, updated_at,
                messages(content, created_at)
            `)
            .or(`user_1_id.eq.${user.id},user_2_id.eq.${user.id}`)
            .order('updated_at', { ascending: false });

        if (error) throw error;

        if (!chats || chats.length === 0) {
            container.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-slate-400 p-8 text-center"><p>Aucune discussion pour le moment.</p></div>`;
            return;
        }

        const userIds = chats.map(c => c.user_1_id === user.id ? c.user_2_id : c.user_1_id);
        const { data: profiles } = await supabaseClient
            .from('profiles')
            .select('id, full_name, avatar_url, is_certified')
            .in('id', userIds);

        const profileMap = new Map(profiles?.map(p => [p.id, p]));

        container.innerHTML = chats.map(chat => {
            const otherUserId = chat.user_1_id === user.id ? chat.user_2_id : chat.user_1_id;
            const profile = profileMap.get(otherUserId) || { full_name: 'Utilisateur', avatar_url: null };
            
            const lastMsg = chat.messages && chat.messages.length > 0 
                ? chat.messages[chat.messages.length - 1].content 
                : 'Nouvelle discussion';
            const time = chat.messages && chat.messages[0] ? getTimeAgo(new Date(chat.messages[0].created_at)) : '';


            return `
            <div onclick="openChatRoom('${chat.id}', '${otherUserId}')" 
                 class="flex items-center gap-4 p-4 hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer border-b border-slate-100 dark:border-slate-800 transition">
                <img src="${profile.avatar_url || 'https://ui-avatars.com/api/?name=' + profile.full_name}" class="w-12 h-12 rounded-full object-cover bg-slate-200">
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-baseline mb-1">
                        <h4 class="font-bold text-slate-900 dark:text-white truncate">${profile.full_name} ${profile.is_certified ? '<i class="fas fa-check-circle text-blue-500 text-xs ml-1"></i>' : ''}</h4>
                        <span class="text-xs text-slate-400">${time}</span>
                    </div>
                    <p class="text-sm text-slate-500 dark:text-slate-400 truncate">${lastMsg}</p>
                </div>
            </div>`;
        }).join('');

    } catch (err) {
        console.error("Erreur liste chat:", err);
    }
} // <--- L'accolade qui manquait était ici !

// 3. Ouvrir la salle de discussion
async function openChatRoom(chatId, targetUserId) {
    currentChatId = chatId;
    currentTargetUserId = targetUserId;
    lastMessageCount = 0; // Reset pour forcer le premier affichage

    switchPage('chat'); 

    const { data: profile } = await supabaseClient
        .from('profiles')
        .select('full_name, avatar_url, is_certified')
        .eq('id', targetUserId)
        .maybeSingle();
    
    if (profile) {
    document.getElementById('chat-header-name').innerHTML = `
        ${profile.full_name}
        ${profile.is_certified ? '<i class="fas fa-check-circle text-blue-500 text-xs ml-1"></i>' : ''}
    `;
    document.getElementById('chat-header-avatar').src = profile.avatar_url || 'https://api.dicebear.com/7.x/identicon/svg?seed=NomUtilisateur';
}

    loadChatMessages(chatId);
    
// Marquer tout de suite comme lu
markChatAsRead(chatId);
    
    // Dans openChatRoom ...
if (chatInterval) clearInterval(chatInterval);
chatInterval = setInterval(() => {
    // 1. Charger les nouveaux messages
    loadChatMessages(currentChatId);
    // 2. Vérifier le badge (pour s'il y a des messages dans d'autres chats)
    updateMessageBadge();
}, 3000);
    // 1. Afficher le statut immédiatement
refreshChatStatus(targetUserId);

// 2. Mettre à jour le statut toutes les 30 secondes
const statusInterval = setInterval(() => {
    refreshChatStatus(targetUserId);
}, 30000);
    setInterval(() => {
    updateMessageBadge();
}, 5000); 
    // Rafraîchir les notifications toutes les 10 secondes
setInterval(() => {
    updateNotificationBadge();
}, 10000);
}

// 5. Charger les messages (AVEC GROUPING PAR DATE)
async function loadChatMessages(chatId) {
    const container = document.getElementById('chat-messages-container');
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return;

    try {
        const { data: messages, error } = await supabaseClient
            .from('messages')
            .select('*')
            .eq('chat_id', chatId)
            .order('created_at', { ascending: true });

        if (error) throw error;
        if (!messages || messages.length === 0) {
            container.innerHTML = '<div class="text-center py-10 text-slate-400 text-xs">Commencez la conversation !</div>';
            return;
        }

        // On vide le conteneur
        container.innerHTML = '';

        // Variable pour mémoriser la date du message précédent
        let lastDate = null;

        messages.forEach(msg => {
            // 1. Récupérer la date "pure" (sans l'heure), ex: "12/10/2024"
            const msgDate = new Date(msg.created_at).toLocaleDateString('fr-FR');

            // 2. Si la date change par rapport au message précédent, on affiche le séparateur
            if (lastDate !== msgDate) {
                const dateSeparator = document.createElement('div');
                dateSeparator.className = 'text-center my-4';
                dateSeparator.innerHTML = `<span class="text-[10px] font-bold text-slate-400 uppercase bg-slate-200 dark:bg-slate-800 px-3 py-1 rounded-full">${msgDate}</span>`;
                container.appendChild(dateSeparator);

                // On met à jour la mémoire
                lastDate = msgDate;
            }

            // 3. Affichage de la bulle de message (On garde l'heure dedans)
            const isMe = msg.sender_id === user.id;
            const bubbleClass = isMe 
                ? 'bg-gradient-to-r from-indigo-600 to-blue-600 text-white rounded-2xl rounded-tr-sm shadow-md' 
                : 'bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200 rounded-2xl rounded-tl-sm shadow-sm border border-slate-100 dark:border-slate-700';

            const row = document.createElement('div');
            row.className = `flex w-full mb-4 ${isMe ? 'justify-end' : 'justify-start'}`;
            row.innerHTML = `
                <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} max-w-[75%]">
                    <div class="${bubbleClass} px-4 py-2 text-sm leading-relaxed break-words">
                        ${msg.content}
                    </div>
                    <span class="text-[10px] text-slate-400 mt-1 mx-1">
                        ${new Date(msg.created_at).toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'})}
                    </span>
                </div>
            `;
            container.appendChild(row);
        });

        // Scroll en bas
        container.scrollTop = container.scrollHeight;

    } catch (err) {
        console.error("Erreur loadMessages:", err);
    }
}
// 5. Envoyer un message
async function sendChatMessage(e) {
    if(e) e.preventDefault();
    const input = document.getElementById('chat-input');
    const content = input.value.trim();
    
    if (!content || !currentChatId) return;

    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return;

    input.value = ''; // On vide tout de suite pour l'effet de vitesse

    const { error } = await supabaseClient
        .from('messages')
        .insert([{
            chat_id: currentChatId,
            sender_id: user.id,
            content: content
        }]);

    if (error) {
        showToast("Erreur d'envoi", "error");
        console.error(error);
    } else {
        loadChatMessages(currentChatId);
    }
}

// Nettoyage lors du changement de page
const originalSwitchPage = window.switchPage;
window.switchPage = function(pageId) {
    if (pageId !== 'chat' && chatInterval) {
        clearInterval(chatInterval);
        chatInterval = null;
    }
    if (typeof originalSwitchPage === 'function') {
        originalSwitchPage(pageId);
    }
};
        /* --- LOGIQUE DU BADGE (UNIQUEMENT SI NON LU) --- */

async function updateMessageBadge() {
    const badge = document.getElementById('msg-badge-count');
    if (!badge) return;

    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return;

    try {
        // 1. Récupérer tous les chats où je suis impliqué
        const { data: myChats } = await supabaseClient
            .from('chats')
            .select('id')
            .or(`user_1_id.eq.${user.id},user_2_id.eq.${user.id}`);

        if (!myChats || myChats.length === 0) {
            badge.classList.add('hidden'); // Cacher si pas de chats
            return;
        }

        const myChatIds = myChats.map(c => c.id);

        // 2. Compter uniquement les messages NON LUS envoyés par L'AUTRE
        const { count } = await supabaseClient
            .from('messages')
            .select('*', { count: 'exact', head: true })
            .in('chat_id', myChatIds)          // Dans mes chats
            .neq('sender_id', user.id)        // Pas envoyé par moi
            .eq('is_read', false);           // ET qui est NON LU (Ici c'est la clé)

        const unreadCount = count || 0;

        // 3. Afficher ou Cacher le badge selon le résultat
        if (unreadCount > 0) {
            badge.innerText = unreadCount > 99 ? '99+' : unreadCount;
            badge.classList.remove('hidden'); // Afficher
        } else {
            badge.classList.add('hidden');    // Cacher
        }

    } catch (err) {
        console.error("Erreur update badge:", err);
    }
}

// 2. Marquer une conversation comme lue
async function markChatAsRead(chatId) {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return;

    try {
        // Mettre à jour tous les messages de ce chat envoyés par l'autre
        await supabaseClient
            .from('messages')
            .update({ is_read: true })
            .eq('chat_id', chatId)
            .neq('sender_id', user.id); // On ne marque pas les miens comme lus
        
        // Mettre à jour le badge immédiatement
        updateMessageBadge();
    } catch (err) {
        console.error("Erreur mark read:", err);
    }
}
        /* --- LOGIQUE DE NOTIFICATION --- */

async function sendNotification(targetUserId, type, postId, contentPreview = null) {
    const { data: { user: actor } } = await supabaseClient.auth.getUser();
    if (!actor || actor.id === targetUserId) return; // Ne pas se notifier soi-même

    try {
        await supabaseClient
            .from('notifications')
            .insert([{
                recipient_id: targetUserId,
                actor_id: actor.id,
                type: type, // 'like' ou 'comment'
                post_id: postId,
                content_preview: contentPreview
            }]);
    } catch (err) {
        console.error("Erreur envoi notification:", err);
    }
}
        /* --- AFFICHAGE DES NOTIFICATIONS --- */

// 1. Charger la liste
async function loadNotifications() {
    const container = document.getElementById('notifications-list-container');
    if (!container) return;

    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return;

    try {
        // Récupérer les notifications triées par date récente
        const { data: notifs, error } = await supabaseClient
            .from('notifications')
            .select(`
                *,
                profiles ( full_name, avatar_url )
            `)
            .eq('recipient_id', user.id)
            .order('created_at', { ascending: false });

        if (error) throw error;

        if (!notifs || notifs.length === 0) {
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-slate-400">
                    <i class="far fa-bell-slash text-4xl mb-3 opacity-20"></i>
                    <p>Aucune notification pour le moment.</p>
                </div>`;
            return;
        }

        container.innerHTML = notifs.map(notif => {
            const actor = notif.profiles || {};
            const avatar = actor.avatar_url || 'https://api.dicebear.com/7.x/avataaars/svg?seed=Felix';
            const name = actor.full_name || 'Utilisateur';
            const timeAgo = getTimeAgo(new Date(notif.created_at));
            
            let message = '';
            let icon = '';
            let color = '';

            if (notif.type === 'like') {
                message = 'a aimé votre publication.';
                icon = 'fa-heart';
                color = 'text-red-500';
            } else if (notif.type === 'comment') {
                message = `a commenté : "${notif.content_preview || '...'}"`;
                icon = 'fa-comment';
                color = 'text-blue-500';
            }

            // Style si non lu
            const bgClass = notif.is_read ? 'bg-white dark:bg-slate-900' : 'bg-indigo-50 dark:bg-slate-800';
            const fontClass = notif.is_read ? 'text-slate-800 dark:text-slate-200' : 'text-slate-900 dark:text-white font-bold';

            return `
            <div class="flex items-center gap-4 p-4 border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800 transition ${bgClass}">
                <img src="${avatar}" class="w-12 h-12 rounded-full object-cover">
                <div class="flex-1">
                    <p class="text-sm ${fontClass}">
                        <span class="font-bold">${name}</span> ${message}
                    </p>
                    <span class="text-[10px] text-slate-400">${timeAgo}</span>
                </div>
                <i class="fas ${icon} ${color}"></i>
            </div>
            `;
        }).join('');

    } catch (err) {
        console.error("Erreur notifs:", err);
    }
}

// 2. Mettre à jour le badge rouge
async function updateNotificationBadge() {
    const badge = document.getElementById('notif-badge-count');
    if (!badge) return;

    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return;

    try {
        const { count } = await supabaseClient
            .from('notifications')
            .select('*', { count: 'exact', head: true })
            .eq('recipient_id', user.id)
            .eq('is_read', false);

        const unreadCount = count || 0;

        if (unreadCount > 0) {
            badge.innerText = unreadCount > 99 ? '99+' : unreadCount;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    } catch (err) { console.error(err); }
}

// 3. Tout marquer comme lu
async function markAllNotificationsRead() {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if(!user) return;

    await supabaseClient
        .from('notifications')
        .update({ is_read: true })
        .eq('recipient_id', user.id);
    
    updateNotificationBadge();
    loadNotifications();
}
        async function handleNewPost(e) {
    if (e) e.preventDefault();
    
    // 1. Capture sécurisée des éléments UI
    const form = e.target;
    const btn = form.querySelector('button[type="submit"]');
    const originalText = btn ? btn.innerHTML : "Publier";
    const captionEl = document.getElementById('post-caption');
    const typeEl = document.getElementById('current-post-type');

    // 2. Validation immédiate (Early Return)
    if (!currentPostFile) {
        showToast("Veuillez choisir un média avant de publier", "warning");
        return;
    }

    // Blocage du bouton pour éviter le double-clic
    if (btn) {
        btn.innerHTML = `<i class="fas fa-spinner animate-spin mr-2"></i> Envoi...`;
        btn.disabled = true;
    }

    try {
        // 3. Identification de l'utilisateur
        const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
        if (authError || !user) throw new Error("Session expirée. Veuillez vous reconnecter.");

        const mediaType = typeEl ? typeEl.value : 'image';
        const fileExt = currentPostFile.name.split('.').pop();
        const fileName = `${user.id}/${Date.now()}.${fileExt}`; // Dossier par user_id pour meilleure organisation

        // 4. Upload Supabase Storage
        const { data: uploadData, error: uploadError } = await supabaseClient.storage
            .from('posts')
            .upload(fileName, currentPostFile, { cacheControl: '3600', upsert: false });

        if (uploadError) throw new Error(`Stockage : ${uploadError.message}`);

        // 5. Récupération de l'URL publique
        const { data: publicUrlData } = supabaseClient.storage
            .from('posts')
            .getPublicUrl(fileName);

        if (!publicUrlData || !publicUrlData.publicUrl) {
            throw new Error("Impossible de générer l'URL publique du média.");
        }

        // 6. Préparation des données pour la table 'posts'
        const insertData = {
            user_id: user.id,
            caption: captionEl ? captionEl.value.trim() : "",
            is_short: (mediaType === 'short'),
            created_at: new Date().toISOString()
        };

        // Attribution de l'URL selon le type
        if (mediaType === 'short') {
            const videoEl = document.getElementById('preview-video-el');
            insertData.video_url = publicUrlData.publicUrl;
            insertData.video_duration = videoEl ? Math.floor(videoEl.duration) : 0;
            // Optionnel: On met null dans image_url si votre DB est stricte
            insertData.image_url = null; 
        } else {
            insertData.image_url = publicUrlData.publicUrl;
            insertData.video_url = null;
        }

        // 7. Insertion en Base de données
        const { error: insertError } = await supabaseClient
            .from('posts')
            .insert([insertData]);

        if (insertError) {
            // Tentative de suppression du fichier uploadé si l'insertion BDD échoue (nettoyage)
            await supabaseClient.storage.from('posts').remove([fileName]);
            throw new Error(`Base de données : ${insertError.message}`);
        }

        // 8. Succès : Feedback et nettoyage
        showToast("Votre publication est en ligne !", "success");
        closeNewPostModal();
        
        // Rafraîchir les flux si les fonctions existent
        if (typeof loadGlobalFeed === 'function') loadGlobalFeed();
        if (typeof loadSocialProfile === 'function') loadSocialProfile(user.id);

    } catch (error) {
        console.error("ERREUR PUBLICATION :", error);
        showToast(error.message, "danger");
    } finally {
        // 9. Reset de l'état (TOUJOURS exécuté)
        if (btn) {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
        
        // On ne reset le formulaire que si tout est fini
        if (form) form.reset();
        
        // Fonctions utilitaires de votre app
        if (typeof resetPreview === 'function') resetPreview();
        if (typeof setPostType === 'function') setPostType('image');
        
        currentPostFile = null; 
    }
}
            function getTimeAgoSimple(date) {
    if (!date) return "Hors ligne";
    const seconds = Math.floor((new Date() - new Date(date)) / 1000);
    
    if (seconds < 60) return "En ligne";
    if (seconds < 3600) return `En ligne il y a ${Math.floor(seconds / 60)} min`;
    if (seconds < 86400) return `En ligne il y a ${Math.floor(seconds / 3600)} h`;
    if (seconds < 604800) return `En ligne il y a ${Math.floor(seconds / 86400)} j`;
    
    return new Date(date).toLocaleDateString(); // Affiche la date si + de 7 jours
}
        async function refreshChatStatus(userId) {
    const statusText = document.getElementById('chat-header-status-text');
    const statusDot = document.getElementById('chat-status-dot');
    
    if (!statusText || !userId) return;

    try {
        const { data: profile, error } = await supabaseClient
            .from('profiles')
            .select('last_seen')
            .eq('id', userId)
            .maybeSingle(); // Plus sûr que .single()

        if (error || !profile) {
            statusText.innerText = "Hors ligne";
            return;
        }

        const lastSeen = profile.last_seen;
        const diffInSeconds = lastSeen ? Math.floor((new Date() - new Date(lastSeen)) / 1000) : 999999;

        // Logique visuelle pro
        if (diffInSeconds < 120) { 
            statusText.innerText = "En ligne";
            statusText.classList.add('text-green-500'); // Si tu utilises Tailwind
            statusDot.className = "w-3 h-3 rounded-full border-2 border-white bg-green-500 shadow-sm";
        } else {
            statusText.innerText = getTimeAgoSimple(lastSeen);
            statusText.classList.remove('text-green-500');
            statusDot.className = "w-3 h-3 rounded-full border-2 border-white bg-slate-400 shadow-sm";
        }

    } catch (err) {
        console.error("Erreur statut:", err);
    }
}
        // 1. Fonction pour ouvrir/fermer la barre de recherche
function toggleSearch() {
    const searchBar = document.getElementById('feed-search-bar');
    const searchInput = document.getElementById('feed-search-input');
    
    if (searchBar.classList.contains('hidden')) {
        // Ouvrir
        searchBar.classList.remove('hidden');
        // Petit délai pour que l'animation fonctionne avant le focus
        setTimeout(() => searchInput.focus(), 100);
    } else {
        // Fermer
        searchBar.classList.add('hidden');
        searchInput.value = ''; // Vider la recherche
        searchFeed(''); // Réinitialiser le feed
    }
}

// 2. Fonction pour filtrer les posts en temps réel (Recherche Facebook-like)
document.getElementById('feed-search-input')?.addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();
    searchFeed(query);
});

function searchFeed(query) {
    const container = document.getElementById('global-feed-container');
    const articles = container.querySelectorAll('article'); // On cible chaque post

    articles.forEach(article => {
        // On cherche dans le texte de la légende et le nom de l'auteur
        const caption = article.querySelector('p')?.innerText.toLowerCase() || '';
        const author = article.querySelector('h4')?.innerText.toLowerCase() || ''; // Note: ajustez le sélecteur si besoin
        
        // Si la recherche est vide ou si le texte contient la recherche
        if (query === '' || caption.includes(query) || author.includes(query)) {
            article.style.display = 'block'; // On affiche
        } else {
            article.style.display = 'none'; // On cache
        }
    });
}
</script>
</body>
</html>
